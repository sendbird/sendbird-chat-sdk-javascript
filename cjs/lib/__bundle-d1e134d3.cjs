var e,t,s,n,i,a,r,o,l,d=require("./__bundle-64a7bbb4.cjs"),h=require("./__bundle-cb4f4d03.cjs"),c=require("./__bundle-55d2a339.cjs"),u=require("./__bundle-21df2b2e.cjs"),_=require("./__bundle-201d63bd.cjs");exports.MemberState=void 0,(e=exports.MemberState||(exports.MemberState={})).NONE="none",e.JOINED="joined",e.INVITED="invited",e.LEFT="left";class p extends h.RestrictedUser{constructor(e,t){super(e,t),this.state=null,this.role=null,this.isMuted=!1,this.isBlockedByMe=!1,this.isBlockingMe=!1,this.state=d.isEnumOf(exports.MemberState,t.state)?t.state:null,this.role=d.isEnumOf(d.Role,t.role)?t.role:null,"boolean"==typeof t.is_muted&&(this.isMuted=t.is_muted),"boolean"==typeof t.is_blocked_by_me&&(this.isBlockedByMe=t.is_blocked_by_me),"boolean"==typeof t.is_blocking_me&&(this.isBlockingMe=t.is_blocking_me)}static payloadify(e){return d.deundefined(d.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{state:e.state,role:e.role,is_muted:e.isMuted,is_blocked_by_me:e.isBlockedByMe,is_blocking_me:e.isBlockingMe})))}}class m extends d.InstancedObject{constructor(e,t){var s,n;super(e),this.channelUrl=null!==(s=t.channel_url)&&void 0!==s?s:"",this.channelType=null!==(n=t.channel_type)&&void 0!==n?n:d.ChannelType.GROUP,this.member=new d.User(this._iid,t.user),this.deliveryAt=t.ts}}exports.PublicChannelFilter=void 0,(t=exports.PublicChannelFilter||(exports.PublicChannelFilter={})).ALL="all",t.PUBLIC="public",t.PRIVATE="private",exports.MyMemberStateFilter=void 0,(s=exports.MyMemberStateFilter||(exports.MyMemberStateFilter={})).ALL="all",s.JOINED="joined_only",s.INVITED="invited_only",s.INVITED_BY_FRIEND="invited_by_friend",s.INVITED_BY_NON_FRIEND="invited_by_non_friend",exports.SuperChannelFilter=void 0,(n=exports.SuperChannelFilter||(exports.SuperChannelFilter={})).ALL="all",n.SUPER="super",n.NON_SUPER="nonsuper",n.BROADCAST_ONLY="broadcast_only",n.EXCLUSIVE_ONLY="exclusive_only",exports.UnreadChannelFilter=void 0,(i=exports.UnreadChannelFilter||(exports.UnreadChannelFilter={})).ALL="all",i.UNREAD_MESSAGE="unread_message",exports.HiddenChannelFilter=void 0,(a=exports.HiddenChannelFilter||(exports.HiddenChannelFilter={})).ALL="all",a.UNHIDDEN="unhidden_only",a.HIDDEN="hidden_only",a.HIDDEN_ALLOW_AUTO_UNHIDE="hidden_allow_auto_unhide",a.HIDDEN_PREVENT_AUTO_UNHIDE="hidden_prevent_auto_unhide",exports.OperatorFilter=void 0,(r=exports.OperatorFilter||(exports.OperatorFilter={})).ALL="all",r.OPERATOR="operator",r.NONOPERATOR="nonoperator",exports.QueryType=void 0,(o=exports.QueryType||(exports.QueryType={})).AND="AND",o.OR="OR",exports.GroupChannelSearchField=void 0,(l=exports.GroupChannelSearchField||(exports.GroupChannelSearchField={})).MEMBER_NICKNAME="member_nickname",l.CHANNEL_NAME="channel_name";class g{constructor(e){var t,s,n,i,a,r,o,l,d,h,c,u,_,p,m;this._searchFilter=null,this._userIdsFilter=null,this.includeEmpty=null!==(t=null==e?void 0:e.includeEmpty)&&void 0!==t&&t,this.nicknameContainsFilter=null!==(s=null==e?void 0:e.nicknameContainsFilter)&&void 0!==s?s:null,this.nicknameStartsWithFilter=null!==(n=null==e?void 0:e.nicknameStartsWithFilter)&&void 0!==n?n:null,this.nicknameExactMatchFilter=null!==(i=null==e?void 0:e.nicknameExactMatchFilter)&&void 0!==i?i:null,this.channelNameContainsFilter=null!==(a=null==e?void 0:e.channelNameContainsFilter)&&void 0!==a?a:"",this.myMemberStateFilter=null!==(r=null==e?void 0:e.myMemberStateFilter)&&void 0!==r?r:exports.MyMemberStateFilter.ALL,this.customTypesFilter=null!==(o=null==e?void 0:e.customTypesFilter)&&void 0!==o?o:null,this.channelUrlsFilter=null!==(l=null==e?void 0:e.channelUrlsFilter)&&void 0!==l?l:null,this.superChannelFilter=null!==(d=null==e?void 0:e.superChannelFilter)&&void 0!==d?d:exports.SuperChannelFilter.ALL,this.publicChannelFilter=null!==(h=null==e?void 0:e.publicChannelFilter)&&void 0!==h?h:exports.PublicChannelFilter.ALL,this.customTypeStartsWithFilter=null!==(c=null==e?void 0:e.customTypeStartsWithFilter)&&void 0!==c?c:null,this.unreadChannelFilter=null!==(u=null==e?void 0:e.unreadChannelFilter)&&void 0!==u?u:exports.UnreadChannelFilter.ALL,this.hiddenChannelFilter=null!==(_=null==e?void 0:e.hiddenChannelFilter)&&void 0!==_?_:exports.HiddenChannelFilter.UNHIDDEN,this.includeFrozen=null===(p=null==e?void 0:e.includeFrozen)||void 0===p||p,(null==e?void 0:e.createdAfter)&&(this.createdAfter=e.createdAfter),(null==e?void 0:e.createdBefore)&&(this.createdBefore=e.createdBefore),this.includeMetaData=null===(m=null==e?void 0:e.includeMetaData)||void 0===m||m}_isFriend(e){return!(!e||!e.friendDiscoveryKey&&!e.friendName)}get searchFilter(){return this._searchFilter}setSearchFilter(e,t){Array.isArray(e)&&0!==e.length&&"string"==typeof t&&t&&(this._searchFilter={query:t,fields:e})}get userIdsFilter(){return this._userIdsFilter}setUserIdsFilter(e,t,s=exports.QueryType.AND){this._userIdsFilter={userIds:e,includeMode:t,queryType:s}}clone(){var e;const t=new g;this.searchFilter&&t.setSearchFilter(this.searchFilter.fields,null!==(e=this.searchFilter.query)&&void 0!==e?e:void 0),this.userIdsFilter&&t.setUserIdsFilter(this.userIdsFilter.userIds,this.userIdsFilter.includeMode,this.userIdsFilter.queryType);const s=JSON.parse(JSON.stringify(this));return Object.keys(s).forEach((e=>{t[e]=s[e]})),t}match(e,t){if(this._searchFilter){const{query:t,fields:s}=this._searchFilter;if(t&&s&&s.length>0&&!s.some((s=>{switch(s){case exports.GroupChannelSearchField.CHANNEL_NAME:return e.name.toLowerCase().includes(t.toLowerCase());case exports.GroupChannelSearchField.MEMBER_NICKNAME:return e.members.some((e=>e.nickname.toLowerCase().includes(t.toLowerCase())));default:return!0}})))return!1}if(this._userIdsFilter){const{userIds:s,includeMode:n,queryType:i}=this._userIdsFilter,a=e.members.map((e=>e.userId));if(n){if(s.length>0)switch(i){case exports.QueryType.AND:if(s.some((e=>!a.includes(e))))return!1;break;case exports.QueryType.OR:if(s.every((e=>!a.includes(e))))return!1}}else{if(s.includes(t)||s.push(t),e.members.length>s.length)return!1;if(!d.hasSameMembers(s,a))return!1}}if(!this.includeEmpty&&!e.lastMessage)return!1;if(!this.includeFrozen&&e.isFrozen)return!1;if(this.customTypesFilter&&this.customTypesFilter.length>0&&!this.customTypesFilter.includes("*")&&!this.customTypesFilter.includes(e.customType))return!1;if(this.customTypeStartsWithFilter&&!new RegExp(`^${this.customTypeStartsWithFilter}`).test(e.customType))return!1;if(this.channelNameContainsFilter&&!e.name.toLowerCase().includes(this.channelNameContainsFilter.toLowerCase()))return!1;if(this.nicknameContainsFilter){const s=this.nicknameContainsFilter.toLowerCase();if(!e.members.some((e=>e.userId!==t&&e.nickname.toLowerCase().includes(s))))return!1}if(this.nicknameStartsWithFilter){const s=this.nicknameStartsWithFilter.toLowerCase();if(!e.members.some((e=>e.userId!==t&&e.nickname.toLowerCase().startsWith(s))))return!1}if(this.nicknameExactMatchFilter){const s=this.nicknameExactMatchFilter.toLowerCase();if(!e.members.some((e=>e.userId!==t&&e.nickname.toLowerCase()!=s)))return!1}if(this.channelUrlsFilter&&this.channelUrlsFilter.length>0&&!this.channelUrlsFilter.includes(e.url))return!1;if(this.myMemberStateFilter)switch(this.myMemberStateFilter){case exports.MyMemberStateFilter.ALL:if("none"===e.myMemberState)return!1;break;case exports.MyMemberStateFilter.JOINED:if("joined"!==e.myMemberState)return!1;break;case exports.MyMemberStateFilter.INVITED:if("invited"!==e.myMemberState)return!1;break;case exports.MyMemberStateFilter.INVITED_BY_FRIEND:if("invited"!==e.myMemberState||!this._isFriend(e.inviter))return!1;break;case exports.MyMemberStateFilter.INVITED_BY_NON_FRIEND:if("invited"!==e.myMemberState||this._isFriend(e.inviter))return!1}if(this.hiddenChannelFilter)switch(this.hiddenChannelFilter){case exports.HiddenChannelFilter.UNHIDDEN:if(e.isHidden||"unhidden"!==e.hiddenState)return!1;break;case exports.HiddenChannelFilter.HIDDEN:if(!e.isHidden)return!1;break;case exports.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:if(!e.isHidden||"hidden_allow_auto_unhide"!==e.hiddenState)return!1;break;case exports.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:if(!e.isHidden||"hidden_prevent_auto_unhide"!==e.hiddenState)return!1}if(this.unreadChannelFilter&&this.unreadChannelFilter===exports.UnreadChannelFilter.UNREAD_MESSAGE)if(0===e.unreadMessageCount)return!1;if(this.publicChannelFilter)switch(this.publicChannelFilter){case exports.PublicChannelFilter.PUBLIC:if(!e.isPublic)return!1;break;case exports.PublicChannelFilter.PRIVATE:if(e.isPublic)return!1}if(this.superChannelFilter)switch(this.superChannelFilter){case exports.SuperChannelFilter.SUPER:if(!e.isSuper)return!1;break;case exports.SuperChannelFilter.NON_SUPER:if(e.isSuper)return!1}return!(this.createdAfter&&e.createdAt<this.createdAfter)&&!(this.createdBefore&&e.createdAt>this.createdBefore)}}class C extends d.InstancedObject{constructor(e,{sdkState:t,cacheContext:s}){super(e),this._channels=new Map,this._sdkState=t,this._cacheContext=s}get collection(){const{nestdb:e}=this._cacheContext;return d.unless(!!e).throw(d.SendbirdError.databaseError),e.collection(h.NESTDB_GROUPCHANNEL_COLLECTION_NAME)}get localCacheEnabled(){const{localCacheEnabled:e}=this._cacheContext;return e&&!!this.collection}_serialize(e,t=0){return Object.assign(Object.assign({},e.serialize()),{lastMessageUpdatedAt:e.lastMessage?e.lastMessage.createdAt:0,syncIndex:t})}_deserialize(e){return Ne.of(this._iid).buildGroupChannelFromSerializedData(e)}get channels(){return[...this._channels.values()]}isCachedInMemory(e){return this._channels.has(e)}filterOffsetChanged(e){return e.filter((e=>{if(this._channels.has(e.url)){return this._channels.get(e.url).messageOffsetTimestamp<e.messageOffsetTimestamp}}))}get(e){return d.__awaiter(this,void 0,void 0,(function*(){if(this._channels.has(e))return this._channels.get(e);if(this.localCacheEnabled){const t=yield this.collection.getByKey(e);if(t){const s=this._deserialize(t);return this._channels.set(e,s),s}}}))}fetch({token:e,limit:t=h.DEFAULT_GROUPCHANNEL_LIMIT,backward:s=!1,filter:n=new g,order:i=c.GroupChannelListOrder.LATEST_LAST_MESSAGE,borderlineChannelUrl:a}){return d.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){let r=!!a;const o={where:t=>{if(e)switch(i){case c.GroupChannelListOrder.CHANNEL_NAME_ALPHABETICAL:if(!s&&t.name.localeCompare(e)<0||s&&t.name.localeCompare(e)>0)return!1;break;case c.GroupChannelListOrder.CHRONOLOGICAL:if(!s&&t.createdAt>e||s&&t.createdAt<e)return!1;break;case c.GroupChannelListOrder.LATEST_LAST_MESSAGE:if(!s&&t.lastMessageUpdatedAt>e||s&&t.lastMessageUpdatedAt<e)return!1}return r&&a&&a===t.url?(r=!1,!1):!r&&n.match(this._deserialize(t),this._sdkState.userId)},index:c.getGroupChannelIndexBy(i),backward:s},l=yield this.collection.query(o),d=(yield l.fetch({limit:t})).map((e=>this._deserialize(e)));return d.forEach((e=>{!n.includeMetaData&&e.cachedMetaData&&e._clearCachedMetaData(),this._channels.has(e.url)||this._channels.set(e.url,e)})),d}return[]}))}upsert(e,t){return d.__awaiter(this,void 0,void 0,(function*(){const s=[];if(e.forEach((e=>{if(this._channels.has(e.url)){const n=this._channels.get(e.url);if(n._pinnedMessagesUpdatedAt<e._pinnedMessagesUpdatedAt&&(n._pinnedMessagesUpdatedAt=e._pinnedMessagesUpdatedAt),n._messageCollectionLastAccessedAt>e._messageCollectionLastAccessedAt&&(e._messageCollectionLastAccessedAt=n._messageCollectionLastAccessedAt),e.cachedMetaData instanceof Map&&e.cachedMetaData.size>0&&t){const{isUpdated:s}=n._updateCachedMetaData(e.cachedMetaData,t);s||Object.assign(e,{_cachedMetaData:n.cachedMetaData})}n._update(e),s.push(n)}else this._channels.set(e.url,e),s.push(e)})),this.localCacheEnabled){const e=[];for(let t=0;t<s.length;t++)e.push(this._serialize(s[t],t));yield this.collection.upsertMany(e)}return s}))}remove(e){return d.__awaiter(this,void 0,void 0,(function*(){for(const t of e)this._channels.delete(t),this.localCacheEnabled&&(yield this.collection.remove(t))}))}clear(){return d.__awaiter(this,void 0,void 0,(function*(){this.clearMemoryCache(),this.localCacheEnabled&&(yield this.collection.clear())}))}clearMemoryCache(){this._channels.clear()}_setBlockStateOfAllChannels(e,t,s){return d.__awaiter(this,void 0,void 0,(function*(){const n=[];if(e===this._sdkState.userId){for(const e of this._channels.values())for(const i of e.members)if(i.userId===t){i.isBlockedByMe=s,n.push(e);break}}else if(t===this._sdkState.userId)for(const t of this._channels.values())for(const i of t.members)if(i.userId===e){i.isBlockingMe=s,n.push(t);break}n.length>0&&(yield this.upsert(n))}))}block(e,t){return d.__awaiter(this,void 0,void 0,(function*(){yield this._setBlockStateOfAllChannels(e,t,!0)}))}unblock(e,t){return d.__awaiter(this,void 0,void 0,(function*(){yield this._setBlockStateOfAllChannels(e,t,!1)}))}markAsRead(e,t=[...this._channels.keys()]){return d.__awaiter(this,void 0,void 0,(function*(){const s=[];for(const n of t){const t=yield this.get(n);(null==t?void 0:t._updateUnreadMemberState(this._sdkState.userId,e))&&(t._updateUnreadCount(0,0),s.push(t))}s.length>0&&(yield this.upsert(s))}))}}const E={invitedUserIds:void 0,channelUrl:void 0,coverUrl:void 0,coverImage:void 0,isDistinct:void 0,isSuper:void 0,isBroadcast:void 0,isExclusive:void 0,isPublic:void 0,isDiscoverable:void 0,isStrict:void 0,isEphemeral:void 0,accessCode:void 0,name:void 0,data:void 0,customType:void 0,operatorUserIds:void 0,messageSurvivalSeconds:void 0},v=e=>d.isArrayOf("string",e.invitedUserIds,!0)&&d.isTypeOf("string",e.channelUrl,!0)&&d.isTypeOf("string",e.coverUrl,!0)&&(d.isFile(e.coverImage)||d.isTypeOf("string",e.coverImage,!0))&&d.isTypeOf("boolean",e.isDistinct,!0)&&d.isTypeOf("boolean",e.isSuper,!0)&&d.isTypeOf("boolean",e.isBroadcast,!0)&&d.isTypeOf("boolean",e.isExclusive,!0)&&d.isTypeOf("boolean",e.isPublic,!0)&&d.isTypeOf("boolean",e.isStrict,!0)&&d.isTypeOf("boolean",e.isDiscoverable,!0)&&d.isTypeOf("boolean",e.isEphemeral,!0)&&d.isTypeOf("string",e.accessCode,!0)&&d.isTypeOf("string",e.name,!0)&&d.isTypeOf("string",e.data,!0)&&d.isTypeOf("string",e.customType,!0)&&d.isArrayOf("string",e.operatorUserIds,!0)&&d.isTypeOf("number",e.messageSurvivalSeconds,!0),f={customTypes:void 0,includeEmpty:!1,includeFrozen:!0,includeMetaData:!0,includeChatNotification:!1},M=e=>d.isArrayOf("string",e.customTypes,!0)&&d.isTypeOf("boolean",e.includeEmpty,!0)&&d.isTypeOf("boolean",e.includeFrozen,!0)&&d.isTypeOf("boolean",e.includeMetaData,!0)&&d.isTypeOf("boolean",e.includeChatNotification,!0),S={myMemberStateFilter:exports.MyMemberStateFilter.ALL},y=e=>d.isEnumOf(exports.MyMemberStateFilter,e.myMemberStateFilter);var A;exports.UnreadItemKey=void 0,(A=exports.UnreadItemKey||(exports.UnreadItemKey={})).GROUP_CHANNEL_UNREAD_MENTION_COUNT="group_channel_unread_mention_count",A.NONSUPER_UNREAD_MENTION_COUNT="non_super_group_channel_unread_mention_count",A.SUPER_UNREAD_MENTION_COUNT="super_group_channel_unread_mention_count",A.GROUP_CHANNEL_UNREAD_MESSAGE_COUNT="group_channel_unread_message_count",A.NONSUPER_UNREAD_MESSAGE_COUNT="non_super_group_channel_unread_message_count",A.SUPER_UNREAD_MESSAGE_COUNT="super_group_channel_unread_message_count",A.GROUP_CHANNEL_INVITATION_COUNT="group_channel_invitation_count",A.NONSUPER_INVITATION_COUNT="non_super_group_channel_invitation_count",A.SUPER_INVITATION_COUNT="super_group_channel_invitation_count";const b={keys:[exports.UnreadItemKey.GROUP_CHANNEL_UNREAD_MENTION_COUNT,exports.UnreadItemKey.NONSUPER_UNREAD_MENTION_COUNT,exports.UnreadItemKey.SUPER_UNREAD_MENTION_COUNT,exports.UnreadItemKey.GROUP_CHANNEL_UNREAD_MESSAGE_COUNT,exports.UnreadItemKey.NONSUPER_UNREAD_MESSAGE_COUNT,exports.UnreadItemKey.SUPER_UNREAD_MESSAGE_COUNT,exports.UnreadItemKey.GROUP_CHANNEL_INVITATION_COUNT,exports.UnreadItemKey.NONSUPER_INVITATION_COUNT,exports.UnreadItemKey.SUPER_INVITATION_COUNT],customTypeFilters:void 0,customTypesFilter:void 0},N={channelCustomTypesFilter:void 0,superChannelFilter:exports.SuperChannelFilter.ALL},T=e=>d.isArrayOf("string",e.channelCustomTypesFilter,!0)&&d.isEnumOf(exports.SuperChannelFilter,e.superChannelFilter),U={channelUrl:void 0,scheduledStatus:void 0,messageTypeFilter:d.MessageTypeFilter.ALL},I=Object.assign({},d.CollectionEventSource),x=e=>e.startsWith("EVENT_")||e===d.CollectionEventSource.SYNC_CHANNEL_CHANGELOGS||e===d.CollectionEventSource.REFRESH_CHANNEL;class P extends d.BaseCommand{constructor({channels:e,context:t,isWebSocketEventComing:s=!1,ts:n}){super(),this.channels=e,this.context=t,this.isWebSocketEventComing=s,this.ts=n}}class R extends d.BaseCommand{constructor({channelUrls:e,context:t,isWebSocketEventComing:s=!1}){super(),this.channelUrls=e,this.context=t,this.isWebSocketEventComing=s}}class O extends d.BaseCommand{constructor({channel:e}){super(),this.channel=e}}class L{constructor({groupChannelCache:e,userInfoCache:t,messageCache:s,unsentMessageCache:n,dispatcher:i}){this._observers=new Map,i.on((i=>d.__awaiter(this,void 0,void 0,(function*(){if(i instanceof P){const{channels:t,context:n,isWebSocketEventComing:a}=i,r=t.filter((e=>e instanceof ft));if(n.source===d.CollectionEventSource.EVENT_CHANNEL_RESET_HISTORY||n.source===d.CollectionEventSource.EVENT_CHANNEL_HIDDEN)for(const e of r)yield s.removeUnderOffset(e.url,e.messageOffsetTimestamp);else{const t=e.filterOffsetChanged(r);for(const e of t)yield s.removeUnderOffset(e.url,e.messageOffsetTimestamp)}const o=yield e.upsert(r,i.ts);a||this._broadcastUpdateEvent(o,n)}else if(i instanceof R){const{channelUrls:t,context:a,isWebSocketEventComing:r}=i;yield e.remove(t),yield d.runOrNothing((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of t)yield s.removeMessagesOfChannel(e),yield n.removeMessagesOfChannel(e)})))),r||this._broadcastRemoveEvent(t,a)}else i instanceof c.DatabaseOpenCommand&&(yield e.fetch({token:Number.MAX_SAFE_INTEGER,limit:Number.MAX_SAFE_INTEGER}),yield t.fetch({limit:Number.MAX_SAFE_INTEGER}))}))))}_broadcastUpdateEvent(e,t){for(const s of this._observers.values())s.onUpdate&&s.onUpdate(e,t)}_broadcastRemoveEvent(e,t){for(const s of this._observers.values())s.onRemove&&s.onRemove(e,t)}subscribe(e,t){this._observers.set(e,t)}unsubscribe(e){this._observers.delete(e)}unsubscribeAll(){this._observers.clear()}}class w extends d.APIRequestCommand{constructor({userId:e,ts:t,token:s,filter:n,includeChatNotification:i=!1}){super();const{customTypes:a,includeEmpty:r,includeFrozen:o}=Object.assign(Object.assign({},f),n);this.method=d.APIRequestMethod.GET,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(e)}/my_group_channels/changelogs`,this.params=d.deundefined(d.undefineNullProps({show_delivery_receipt:!0,show_member:!0,show_read_receipt:!0,change_ts:t||null,token:s,custom_types:a,show_empty:r,show_frozen:o,include_chat_notification:i}))}}class F extends d.APIResponseCommand{constructor(e,t){super(e,t),this.updatedChannels=t.updated.map((s=>new ft(e,Object.assign(s,{ts:t.ts})))),this.deletedChannelUrls=t.deleted,this.hasMore=t.has_more,this.token=t.next,this.ts=t.ts}}class D extends d.APIRequestCommand{constructor({channelUrl:e,isInternalCall:t,showLatestMessage:s}){super(),this.method=d.APIRequestMethod.GET,this.path=`${t?d.API_PATH_GROUP_CHANNELS_INTERNAL:d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(e)}`,this.params={show_member:!0,show_read_receipt:!0,show_delivery_receipt:!0,show_latest_message:null!=s&&s}}}class k extends d.APIResponseCommand{constructor(e,t){super(e,t),this.channel=new ft(e,t)}}const H={includeEmpty:!1,includeFrozen:!0,includeMetaData:!0,includeChatNotification:!1,channelUrlsFilter:void 0,customTypesFilter:void 0,customTypeStartsWithFilter:void 0,nicknameContainsFilter:void 0,nicknameStartsWithFilter:void 0,nicknameExactMatchFilter:void 0,channelNameContainsFilter:void 0,myMemberStateFilter:exports.MyMemberStateFilter.ALL,unreadChannelFilter:exports.UnreadChannelFilter.ALL,superChannelFilter:exports.SuperChannelFilter.ALL,publicChannelFilter:exports.PublicChannelFilter.ALL,hiddenChannelFilter:exports.HiddenChannelFilter.ALL,userIdsFilter:{userIds:[],includeMode:!0,queryType:exports.QueryType.AND},searchFilter:{query:void 0,fields:[]},metadataKey:void 0,metadataValues:void 0,metadataOrderKeyFilter:void 0,metadataValueStartsWith:void 0,order:c.GroupChannelListOrder.LATEST_LAST_MESSAGE,createdAfter:void 0,createdBefore:void 0};class V extends d.APIRequestCommand{constructor(e){const{userId:t,token:s,limit:n,order:i,includeEmpty:a,myMemberStateFilter:r,superChannelFilter:o,publicChannelFilter:l,unreadChannelFilter:h,nicknameContainsFilter:c,nicknameStartsWithFilter:u,nicknameExactMatchFilter:_,channelNameContainsFilter:p,channelUrlsFilter:m,customTypesFilter:g,customTypeStartsWithFilter:C,hiddenChannelFilter:E,metadataOrderKeyFilter:v,metadataKey:f,metadataValues:M,metadataValueStartsWith:S,includeFrozen:y,includeMetaData:A,searchFilter:b,userIdsFilter:N,includeChatNotification:T=!1,includeLeftChannel:U=!1,createdAfter:I,createdBefore:x}=e;super(),this.method=d.APIRequestMethod.GET,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(t)}/my_group_channels`,this.params=d.deundefined({token:s,limit:n,order:null!=i?i:H.order,show_member:!0,show_read_receipt:!0,show_delivery_receipt:!0,show_empty:null!=a?a:H.includeEmpty,member_state_filter:null!=r?r:H.myMemberStateFilter,super_mode:null!=o?o:H.superChannelFilter,public_mode:null!=l?l:H.publicChannelFilter,unread_filter:null!=h?h:H.unreadChannelFilter,members_nickname_contains:c,members_nickname_startswith:u,members_nickname:_,name_contains:p,channel_urls:m,custom_types:g,custom_type_startswith:C,hidden_mode:E,metadata_order_key:v,metadata_key:f,metadata_values:M,metadata_value_startswith:S,show_frozen:y,show_metadata:A,include_chat_notification:T,include_left_channel:U,created_after:I,created_before:x}),b&&b.query&&b.fields&&(this.params.search_query=b.query,this.params.search_fields=b.fields),N&&N.userIds&&N.userIds.length>0&&(N.includeMode?(this.params.members_include_in=N.userIds,this.params.query_type=N.queryType.toUpperCase()):this.params.members_exactly_in=N.userIds)}}class G extends d.APIResponseCommand{constructor(e,t){super(e,t),this.channels=[];const{next:s,channels:n,ts:i}=t;this.token=s,n&&n.length>0&&(this.channels=n.map((t=>(t.ts=i,new ft(e,t))))),this.ts=null!=i?i:0}}class q extends d.APIRequestCommand{constructor({userId:e,filter:t}){super();const{myMemberStateFilter:s}=t;this.method=d.APIRequestMethod.GET,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(e)}/group_channel_count`,this.params={state:null!=s?s:exports.MyMemberStateFilter.ALL}}}class B extends d.APIResponseCommand{constructor(e,t){super(e,t),this.groupChannelCount=t.group_channel_count}}class j extends d.APIRequestCommand{constructor({userId:e,filter:t}){super();const{keys:s,customTypeFilters:n,customTypesFilter:i}=t;this.method=d.APIRequestMethod.GET,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(e)}/unread_item_count`,this.params=d.deundefined({item_keys:s,custom_types:null!=i?i:n})}}class z extends d.APIResponseCommand{constructor(e,t){super(e,t),"number"==typeof t[exports.UnreadItemKey.GROUP_CHANNEL_UNREAD_MENTION_COUNT]&&(this.groupChannelUnreadMentionCount=t[exports.UnreadItemKey.GROUP_CHANNEL_UNREAD_MENTION_COUNT]),"number"==typeof t[exports.UnreadItemKey.GROUP_CHANNEL_UNREAD_MESSAGE_COUNT]&&(this.groupChannelUnreadMessageCount=t[exports.UnreadItemKey.GROUP_CHANNEL_UNREAD_MESSAGE_COUNT]),"number"==typeof t[exports.UnreadItemKey.GROUP_CHANNEL_INVITATION_COUNT]&&(this.groupChannelInvitationCount=t[exports.UnreadItemKey.GROUP_CHANNEL_INVITATION_COUNT]),"number"==typeof t[exports.UnreadItemKey.SUPER_UNREAD_MENTION_COUNT]&&(this.superGroupChannelUnreadMentionCount=t[exports.UnreadItemKey.SUPER_UNREAD_MENTION_COUNT]),"number"==typeof t[exports.UnreadItemKey.SUPER_UNREAD_MESSAGE_COUNT]&&(this.superGroupChannelUnreadMessageCount=t[exports.UnreadItemKey.SUPER_UNREAD_MESSAGE_COUNT]),"number"==typeof t[exports.UnreadItemKey.SUPER_INVITATION_COUNT]&&(this.superGroupChannelInvitationCount=t[exports.UnreadItemKey.SUPER_INVITATION_COUNT]),"number"==typeof t[exports.UnreadItemKey.NONSUPER_UNREAD_MENTION_COUNT]&&(this.nonSuperGroupChannelUnreadMentionCount=t[exports.UnreadItemKey.NONSUPER_UNREAD_MENTION_COUNT]),"number"==typeof t[exports.UnreadItemKey.NONSUPER_UNREAD_MESSAGE_COUNT]&&(this.nonSuperGroupChannelUnreadMessageCount=t[exports.UnreadItemKey.NONSUPER_UNREAD_MESSAGE_COUNT]),"number"==typeof t[exports.UnreadItemKey.NONSUPER_INVITATION_COUNT]&&(this.nonSuperGroupChannelInvitationCount=t[exports.UnreadItemKey.NONSUPER_INVITATION_COUNT])}}class W extends d.APIRequestCommand{constructor({userId:e}){super(),this.method=d.APIRequestMethod.GET,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(e)}/unread_channel_count`}}class $ extends d.APIResponseCommand{constructor(e,t){super(e,t),this.unreadCount=t.unread_count}}class K extends d.APIRequestCommand{constructor({userId:e,filter:t,includeFeedChannel:s=!1}){super();const{channelCustomTypesFilter:n,superChannelFilter:i}=t;this.method=d.APIRequestMethod.GET,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(e)}/unread_message_count`,this.params={super_mode:null!=i?i:exports.SuperChannelFilter.ALL,custom_types:n,include_feed_channel:s}}}class Q extends d.APIResponseCommand{constructor(e,t){super(e,t),this.unreadCount=t.unread_count,this.unreadFeedCount=t.unread_feed_count}}class Y extends d.APIRequestCommand{constructor({channelUrl:e,scheduledStatus:t,messageTypeFilter:s}){super(),this.method=d.APIRequestMethod.GET,this.path=`${d.API_PATH_SCHEDULED_MESSAGES}/count`,this.params={channel_url:e,status:X(t)},s&&(this.params.message_type=s)}}class J extends d.APIResponseCommand{constructor(e,t){super(e,t),this.count=t.count}}const X=e=>{if(!e)return[];const t=[];return e.forEach((e=>{switch(e){case h.ScheduledStatus.PENDING:t.push(h.InternalScheduledStatus.PENDING);break;case h.ScheduledStatus.SENT:t.push(h.InternalScheduledStatus.IN_QUEUE),t.push(h.InternalScheduledStatus.SENT);break;case h.ScheduledStatus.CANCELED:t.push(h.InternalScheduledStatus.CANCELED);break;case h.ScheduledStatus.FAILED:t.push(h.InternalScheduledStatus.FAILED)}})),t};class Z extends d.APIRequestCommand{constructor(e){const{userId:t,channelUrl:s,coverUrl:n,coverImage:i,isDistinct:a,isSuper:r,isBroadcast:o,isPublic:l,isExclusive:h,isDiscoverable:c,isStrict:u,isEphemeral:_,accessCode:p,name:m,data:g,customType:C,messageSurvivalSeconds:E,invitedUserIds:v,operatorUserIds:f}=e;super(),this.method=d.APIRequestMethod.POST,this.path=d.API_PATH_GROUP_CHANNELS,this.params=d.deundefined({user_ids:[t,...null!=v?v:[]].filter(((e,t,s)=>t===s.indexOf(e))),channel_url:s,cover_url:n,cover_file:i,is_distinct:a,is_super:r,is_broadcast:o,is_exclusive:h,is_public:l,is_discoverable:c,strict:u,is_ephemeral:_,access_code:p,name:m,data:g,custom_type:C,operator_ids:f,message_survival_seconds:E})}}class ee extends d.APIResponseCommand{constructor(e,t){var s;super(e,t),this.channel=new ft(e,t),this.isCreated=null===(s=t.is_created)||void 0===s||s}}class te extends d.APIRequestCommand{constructor({userId:e,channelUrls:t}){super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(e)}/mark_as_read_all`,this.params={channel_urls:t}}}class se extends d.APIRequestCommand{constructor(e){const{channelUrl:t,userId:s,accessCode:n}=e;super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/join`,this.params={user_id:s,access_code:n}}}class ne extends d.APIResponseCommand{constructor(e,t){super(e,t),this.channel=new ft(e,t)}}class ie extends u.ChannelEventCommand{constructor(e,t,s){super(e,t,s);const{member_count:n=0,joined_member_count:i=0,users:a=null}=s.data;this.memberCount=n,this.joinedMemberCount=i,this.members=Array.isArray(a)?a.map((t=>new p(e,t))):[new p(e,s.data)]}}class ae extends d.APIRequestCommand{constructor(e){const{channelUrl:t,userId:s,shouldRemoveOperatorStatus:n}=e;super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/leave`,this.params={user_id:s,should_remove_operator_status:n}}}class re extends u.ChannelEventCommand{constructor(e,t,s){super(e,t,s);const{member_count:n=0,joined_member_count:i=0}=s.data;this.memberCount=n,this.joinedMemberCount=i,this.member=new p(this._iid,s.data)}}class oe extends d.APIRequestCommand{constructor(e){const{channelUrl:t,userIds:s}=e;super(),this.method=d.APIRequestMethod.POST,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/invite`,this.params={user_ids:s}}}class le extends d.APIResponseCommand{constructor(e,t){super(e,t),this.channel=new ft(e,t)}}class de extends u.ChannelEventCommand{constructor(e,t,s){super(e,t,s),this.inviter=null;const{member_count:n=0,joined_member_count:i=0,inviter:a,invitees:r=[]}=s.data;this.memberCount=n,this.joinedMemberCount=i,a&&Object.keys(a).length>0&&(this.inviter=new d.User(e,a)),this.invitees=r.map((t=>new p(e,t)))}}class he extends d.APIRequestCommand{constructor(e){const{channelUrl:t,userId:s}=e;super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/decline`,this.params={user_id:s}}}class ce extends u.ChannelEventCommand{constructor(e,t,s){super(e,t,s);const{member_count:n,joined_member_count:i,inviter:a,invitee:r}=s.data;this.memberCount=null!=n?n:0,this.joinedMemberCount=null!=i?i:0,this.inviter=new d.User(e,a),this.invitee=new p(e,r)}}const ue={hidePreviousMessages:!1,allowAutoUnhide:!0};class _e extends d.APIRequestCommand{constructor(e){const{channelUrl:t,userId:s,hidePreviousMessages:n,allowAutoUnhide:i}=e;super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/hide`,this.params={user_id:s,hide_previous_messages:null!=n?n:ue.hidePreviousMessages,allow_auto_unhide:null!=i?i:ue.allowAutoUnhide}}}class pe extends d.APIResponseCommand{constructor(e,t){super(e,t);const{ts_message_offset:s}=t;this.messageOffsetTimestamp=s}}class me extends d.WebSocketEventCommand{constructor(e,t,s){var n,i,a;super(e,"SYEV",s),this.allowAutoUnhide=null,this.hidePreviousMessages=null,this.messageOffsetTimestamp=null,s.data&&(this.allowAutoUnhide=null!==(n=s.data.allow_auto_unhide)&&void 0!==n?n:null,this.hidePreviousMessages=null!==(i=s.data.hide_previous_messages)&&void 0!==i?i:null),this.messageOffsetTimestamp=null!==(a=s.ts_message_offset)&&void 0!==a?a:null}}class ge extends d.WebSocketRequestCommand{constructor({channelUrl:e,time:t}){super({code:"TPST",ackRequired:!1,payload:{channel_url:e,time:t}})}}class Ce extends d.WebSocketEventCommand{constructor(e,t,s){super(e,"SYEV",s),this.user=new d.User(e,s.data)}}class Ee extends d.WebSocketRequestCommand{constructor({channelUrl:e,time:t}){super({code:"TPEN",ackRequired:!1,payload:{channel_url:e,time:t}})}}class ve extends d.WebSocketEventCommand{constructor(e,t,s){super(e,"SYEV",s),this.user=new d.User(e,s.data)}}class fe extends d.WebSocketRequestCommand{constructor({channelUrl:e,messageId:t}){super({code:"MACK",ackRequired:!1,payload:{channel_url:e,msg_id:t}})}}class Me extends d.BaseListQuery{constructor(e,t){var s,n,i,a,r,o,l,d,h,u,_,p,m,g,C,E,v,f,M,S,y,A,b;super(e,t),this.includeEmpty=!1,this.includeFrozen=!0,this.includeMetaData=!0,this.includeChatNotification=!1,this.channelUrlsFilter=null,this.customTypesFilter=null,this.customTypeStartsWithFilter=null,this.nicknameContainsFilter=null,this.nicknameStartsWithFilter=null,this.nicknameExactMatchFilter=null,this.channelNameContainsFilter="",this.myMemberStateFilter=exports.MyMemberStateFilter.ALL,this.unreadChannelFilter=exports.UnreadChannelFilter.ALL,this.superChannelFilter=exports.SuperChannelFilter.ALL,this.publicChannelFilter=exports.PublicChannelFilter.ALL,this.hiddenChannelFilter=exports.HiddenChannelFilter.UNHIDDEN,this.searchFilter={fields:[],query:null},this.userIdsFilter={userIds:[],includeMode:!0,queryType:exports.QueryType.AND},this.metadataKey=null,this.metadataValues=null,this.metadataOrderKeyFilter=null,this.metadataValueStartsWith=null,this.order=c.GroupChannelListOrder.LATEST_LAST_MESSAGE,this.includeEmpty=null!==(s=t.includeEmpty)&&void 0!==s&&s,this.includeFrozen=null===(n=t.includeFrozen)||void 0===n||n,this.includeMetaData=null===(i=t.includeMetaData)||void 0===i||i,this.includeChatNotification=null!==(a=t.includeChatNotification)&&void 0!==a&&a,this.channelUrlsFilter=null!==(r=t.channelUrlsFilter)&&void 0!==r?r:null,this.customTypesFilter=null!==(o=t.customTypesFilter)&&void 0!==o?o:null,this.customTypeStartsWithFilter=null!==(l=t.customTypeStartsWithFilter)&&void 0!==l?l:"",this.nicknameContainsFilter=null!==(d=t.nicknameContainsFilter)&&void 0!==d?d:null,this.nicknameStartsWithFilter=null!==(h=t.nicknameStartsWithFilter)&&void 0!==h?h:null,this.nicknameExactMatchFilter=null!==(u=t.nicknameExactMatchFilter)&&void 0!==u?u:null,this.channelNameContainsFilter=null!==(_=t.channelNameContainsFilter)&&void 0!==_?_:"",this.myMemberStateFilter=null!==(p=t.myMemberStateFilter)&&void 0!==p?p:exports.MyMemberStateFilter.ALL,this.unreadChannelFilter=null!==(m=t.unreadChannelFilter)&&void 0!==m?m:exports.UnreadChannelFilter.ALL,this.superChannelFilter=null!==(g=t.superChannelFilter)&&void 0!==g?g:exports.SuperChannelFilter.ALL,this.publicChannelFilter=null!==(C=t.publicChannelFilter)&&void 0!==C?C:exports.PublicChannelFilter.ALL,this.hiddenChannelFilter=null!==(E=t.hiddenChannelFilter)&&void 0!==E?E:exports.HiddenChannelFilter.UNHIDDEN,this.searchFilter=null!==(v=t.searchFilter)&&void 0!==v?v:{fields:[],query:null},this.userIdsFilter=null!==(f=t.userIdsFilter)&&void 0!==f?f:{userIds:[],includeMode:!0,queryType:exports.QueryType.AND},this.metadataKey=null!==(M=t.metadataKey)&&void 0!==M?M:null,this.metadataValues=null!==(S=t.metadataValues)&&void 0!==S?S:null,this.metadataOrderKeyFilter=null!==(y=t.metadataOrderKeyFilter)&&void 0!==y?y:null,this.metadataValueStartsWith=null!==(A=t.metadataValueStartsWith)&&void 0!==A?A:null,this.order=null!==(b=t.order)&&void 0!==b?b:c.GroupChannelListOrder.LATEST_LAST_MESSAGE,t.createdAfter&&(this.createdAfter=t.createdAfter),t.createdBefore&&(this.createdBefore=t.createdBefore)}_validate(){return super._validate()&&d.isTypeOf("boolean",this.includeEmpty)&&d.isTypeOf("boolean",this.includeFrozen)&&d.isTypeOf("boolean",this.includeMetaData)&&d.isTypeOf("string",this.channelNameContainsFilter)&&d.isArrayOf("string",this.channelUrlsFilter,!0)&&d.isArrayOf("string",this.customTypesFilter,!0)&&d.isTypeOf("string",this.customTypeStartsWithFilter)&&d.isTypeOf("string",this.nicknameContainsFilter,!0)&&d.isTypeOf("string",this.nicknameStartsWithFilter,!0)&&d.isTypeOf("string",this.nicknameExactMatchFilter,!0)&&d.isEnumOf(exports.MyMemberStateFilter,this.myMemberStateFilter)&&d.isEnumOf(exports.SuperChannelFilter,this.superChannelFilter)&&d.isEnumOf(exports.PublicChannelFilter,this.publicChannelFilter)&&d.isEnumOf(exports.UnreadChannelFilter,this.unreadChannelFilter)&&d.isEnumOf(exports.HiddenChannelFilter,this.hiddenChannelFilter)&&d.isArrayOf(exports.GroupChannelSearchField,this.searchFilter.fields)&&d.isTypeOf("string",this.searchFilter.query,!0)&&d.isArrayOf("string",this.userIdsFilter.userIds)&&d.isTypeOf("boolean",this.userIdsFilter.includeMode)&&d.isEnumOf(exports.QueryType,this.userIdsFilter.queryType)&&d.isEnumOf(c.GroupChannelListOrder,this.order)&&d.isTypeOf("string",this.metadataOrderKeyFilter,!0)&&d.isTypeOf("string",this.metadataKey,!0)&&d.isArrayOf("string",this.metadataValues,!0)&&d.isTypeOf("string",this.metadataValueStartsWith,!0)&&d.isMilliSecondOf(this.createdAfter,!0)&&d.isMilliSecondOf(this.createdBefore,!0)}serialize(){return d.serialize(this)}next(){return d.__awaiter(this,void 0,void 0,(function*(){if(this._validate()){if(this._isLoading)throw d.SendbirdError.queryInProgress;if(this._hasNext){this._isLoading=!0;const e=Ne.of(this._iid),{channels:t,token:s}=yield e.getMyGroupChannels(this._token,d.undefineNullProps(Object.assign({},this)),this.limit,d.CollectionEventSource.REQUEST_CHANNEL,!0);return this._token=s,this._hasNext=!!s,this._isLoading=!1,t}return[]}throw d.SendbirdError.invalidParameters}))}}class Se extends d.APIRequestCommand{constructor({channelUrl:e,userId:t}){super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(e)}/messages/mark_as_delivered`,this.params=d.deundefined({user_id:t})}}class ye extends d.WebSocketEventCommand{constructor(e,t,s){super(e,"DLVR",s),this.channelUrl=s.channel_url,this.deliveredStateUpdate=s.updated}}class Ae{constructor({top:e=Number.MAX_SAFE_INTEGER,bottom:t=0}){this.top=e,this.bottom=t}includes(...e){return e.every((e=>this.top<=e&&e<=this.bottom))}overlap(e){return this.includes(e.top)||this.includes(e.bottom)}intersect(...e){return e.some((e=>this.top<=e&&e<=this.bottom))}extends(...e){this.top=Math.min(this.top,...e),this.bottom=Math.max(this.bottom,...e)}}const be={};class Ne extends u.BaseChannelManager{get _messageCache(){return h.MessageCache.of(this._iid)}get _unsentMessageCache(){return h.UnsentMessageCache.of(this._iid)}constructor(e,t){var s;super(e,Object.assign(Object.assign({},t),{channelType:d.ChannelType.GROUP})),this._leftChannels=new Map,this._markAsReadAllLastSentAt=0,this._forceDisableMack=null!==(s=t.forceDisableMack)&&void 0!==s&&s,this._groupChannelHandlers=new Map,this._groupChannelCache=new C(this._iid,{sdkState:t.sdkState,cacheContext:t.cacheContext}),this._userInfoCache=new h.UserInfoCache(this._iid,{sdkState:t.sdkState,cacheContext:t.cacheContext}),this._groupChannelBroadcast=new L({dispatcher:t.dispatcher,groupChannelCache:this._groupChannelCache,userInfoCache:this._userInfoCache,messageCache:h.MessageCache.of(this._iid),unsentMessageCache:h.UnsentMessageCache.of(this._iid)}),setInterval((()=>{for(const e of this._groupChannelCache.channels)e.invalidateTypingStatus()&&(this._dispatcher.dispatch(new P({channels:[e],context:{source:d.CollectionEventSource.EVENT_CHANNEL_TYPING_STATUS_UPDATE}})),this._groupChannelHandlers.forEach((t=>{t.onTypingStatusUpdated&&t.onTypingStatusUpdated(e)})))}),1e3),this._dispatcher.on((e=>{if(e instanceof d.WebSocketEventCommand)this._handleEvent(e).catch((e=>{if(d.isThrowingOutside(e)&&"foreground"===this._sdkState.appState)throw e}));else if(e instanceof c.AutoResendRequestCommand)(()=>{d.__awaiter(this,void 0,void 0,(function*(){const{message:t}=e;let s=yield this.getChannelFromCache(t.channelUrl);s&&!s.isFrozen||(s=yield this.getChannelWithoutCache(t.channelUrl,!0)),s.isFrozen||(t instanceof h.UserMessage?s._autoResendUserMessage(t):t instanceof h.FileMessage&&s._autoResendFileMessage(t))}))})();else if(e instanceof c.ReduceDBSizeEventCommand)this.reduceDBSize();else if(e instanceof c.ApplyAppConfigsInfoEventCommand){const{appConfigsInfo:t,configTs:s}=e,n=t.message_purge_offset;n&&this._messageDataRetention(n),this._dispatcher.dispatch(new c.SaveAppConfigsInfoEventCommand({configTs:s}))}else e instanceof h.MessageThreadInfoUpdatedEventCommand&&(()=>{d.__awaiter(this,void 0,void 0,(function*(){const{channelUrl:t,channelType:s,parentMessage:n}=e,i=new h.ThreadInfoUpdateEvent(this._iid,{channel_type:d.ChannelType.GROUP,channel_url:t,parent_message_id:n.messageId,thread_info:h.ThreadInfo.payloadify(n.threadInfo)});if(s===d.ChannelType.GROUP){const e=yield this.getChannel(t,!0);d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const t of this._groupChannelHandlers.values())t.onThreadInfoUpdated&&t.onThreadInfoUpdated(e,i)}))))}}))})()})),be[e]||(be[e]=this)}static of(e){return be[e]||(be[e]=new Ne(e,d.Vault.of(e))),be[e]}static clear(e){be[e]&&delete be[e]}get handlers(){return[...this._groupChannelHandlers.values()]}buildGroupChannelFromSerializedData(e){const t=d.deserialize(e);return new ft(this._iid,ft.payloadify(t))}buildGroupChannelListQueryFromSerializedData(e){const t=d.deserialize(e);return new Me(this._iid,t)}buildMemberFromSerializedData(e){const t=d.deserialize(e);return new p(this._iid,p.payloadify(t))}getChannelFromCache(e){var t;return d.__awaiter(this,void 0,void 0,(function*(){return null!==(t=yield this._groupChannelCache.get(e))&&void 0!==t?t:null}))}getChannelsFromCache(e,t,s,n,i){return d.__awaiter(this,void 0,void 0,(function*(){return yield this._groupChannelCache.fetch({token:e,filter:t,order:s,limit:n,borderlineChannelUrl:i})}))}upsertChannelsToCache(e){return d.__awaiter(this,void 0,void 0,(function*(){return yield this._groupChannelCache.upsert(e)}))}removeChannelsFromCache(e){return d.__awaiter(this,void 0,void 0,(function*(){yield this._groupChannelCache.remove(e)}))}clearChannelsFromCache(){return d.__awaiter(this,void 0,void 0,(function*(){yield this._groupChannelCache.clear()}))}reduceDBSize(){return d.__awaiter(this,void 0,void 0,(function*(){const e=h.MessageCache.of(this._iid),{cacheContext:t}=d.Vault.of(this._iid),{localCacheConfig:s,nestdb:n}=t;if(!t.localCacheEnabled||!n||n.state!=h.NestDBState.OPENED)return;const i=1024*s.maxSize*1024;let a=yield n.estimateUsage();if(a<i)return;const r=[],o=this._groupChannelCache.channels,l={};for(let e=0;e<o.length;e++){const t=yield this.getMessagesFromCache(o[e].url,0,"prev",new h.MessageFilter);l[o[e].url]=JSON.stringify(t).length;const s=new d.CachedChannelInfo({channel:o[e],cachedMessageCount:t.length});r.push(s)}const c=r.sort(s.clearOrderComparator);for(let t=0;t<c.length;t++){yield e.removeMessagesOfChannel(c[t].channel.url);const s=yield e._getGroupChannelPreferenceSize(c[t].channel.url);if(a-=l[c[t].channel.url]+s,a<i)break}const u=h.UserInfoCache.of(this._iid);yield u.clear()}))}_messageDataRetention(e){var t;return d.__awaiter(this,void 0,void 0,(function*(){const s=[],n=h.MessageCache.of(this._iid);for(const i of this._groupChannelCache.channels){const a=i.customType,r=null!==(t=e[a])&&void 0!==t?t:e.global;yield n.removeUnderOffset(i.url,r,!0),i.lastMessage&&i.lastMessage.createdAt<=r&&(i.lastMessage=null,s.push(i),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(i)}))))),this._dispatcher.dispatch(new d.MessageRetentionEventCommand({channelUrl:i.url,messageDeletionTimestamp:r,source:d.CollectionEventSource.EVENT_MESSAGE_OFFSET_UPDATED}))}s.length>0&&this._dispatcher.dispatch(new P({channels:s,context:{source:d.CollectionEventSource.EVENT_CHANNEL_UPDATED}}))}))}_isSuperGroupMackDisabled(e){const{appInfo:t}=d.Vault.of(this._iid);return!(!e.isSuper||e.isBroadcast||!(null==t?void 0:t.disableSuperGroupMack))}_getCachedUserInfo(e){return this._userInfoCache.getUserInfoFromCache(e)}_upsertCachedUserInfo(e,t){const{useMemberInfoInMessage:s}=d.Vault.of(this._iid);s&&this._userInfoCache.upsert(e,t)}_handleEvent(e){var t,s;return d.__awaiter(this,void 0,void 0,(function*(){try{switch(e.code){case"MESG":case"FILE":case"ADMM":case"BRDM":{let s=null;if("MESG"===e.code?s=e.as(h.UserMessageEventCommand):"FILE"===e.code?s=e.as(h.FileMessageEventCommand):"ADMM"!==e.code&&"BRDM"!=e.code||(s=e.as(u.AdminMessageEventCommand)),s){const{message:e,isMentioned:n,forceUpdateLastMessage:i}=s;if(e.channelType===d.ChannelType.GROUP){const s=this._groupChannelCache.isCachedInMemory(e.channelUrl),a=e instanceof h.SendableMessage&&e.sender.userId===this._sdkState.userId,r=yield this.getChannel(e.channelUrl,!0),{useMemberInfoInMessage:o}=d.Vault.of(this._iid);if(this._forceDisableMack||this._isSuperGroupMackDisabled(r)||e instanceof h.AdminMessage||a||d.runOrNothing((()=>d.__awaiter(this,void 0,void 0,(function*(){const t=new fe(e);yield this._requestQueue.send(t)})))),e instanceof h.SendableMessage){const s=e.sender;r.isSuper&&this._upsertCachedUserInfo(s,e.createdAt);for(const t of r.members)if(t.userId===e.sender.userId){o&&(t.nickname=e.sender.nickname,t.plainProfileUrl=e.sender.plainProfileUrl,t.metaData=e.sender.metaData,t.isBlockedByMe=e.sender.isBlockedByMe);break}if(o&&n&&(null===(t=e.mentionedUsers)||void 0===t||t.forEach((e=>{for(const t of r.members)if(e.userId===t.userId){t.nickname=e.nickname,t.plainProfileUrl=e.plainProfileUrl,t.metaData=e.metaData;break}}))),a){const{currentUser:t}=this._sessionManager;t&&(t.nickname=e.sender.nickname,t.plainProfileUrl=e.sender.plainProfileUrl,t.metaData=e.sender.metaData)}}e.silent&&!a||(r.isEphemeral||s)&&(r._updateLastMessage(e),a||r._shouldUpdateUnreadCountWith(e)&&r._updateUnreadCount(r.unreadMessageCount+1,r.unreadMentionCount+(n?1:0))),i&&r._updateLastMessage(e),this._dispatcher.dispatch(new P({channels:[r],context:{source:d.CollectionEventSource.EVENT_MESSAGE_RECEIVED}})),e.silent&&!a||d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(r)})))),this._dispatcher.dispatch(new d.MessageUpdateEventCommand({messages:[e],source:d.CollectionEventSource.EVENT_MESSAGE_RECEIVED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const t of this._groupChannelHandlers.values())t.onMessageReceived&&t.onMessageReceived(r,e),n&&t.onMentionReceived&&t.onMentionReceived(r,e)}))))}}break}case"MEDI":case"FEDI":case"AEDI":{let t=null;if("MEDI"===e.code?t=e.as(h.UpdateUserMessageEventCommand):"FEDI"===e.code?t=e.as(h.UpdateFileMessageEventCommand):"AEDI"===e.code&&(t=e.as(u.UpdateAdminMessageEventCommand)),t){const{message:e,mentionCountChange:n}=t,{useMemberInfoInMessage:i}=d.Vault.of(this._iid);if(e.threadInfo&&(e.threadInfo.unreadReplyCount=void 0),e.channelType===d.ChannelType.GROUP){const t=this._groupChannelCache.isCachedInMemory(e.channelUrl),a=yield this.getChannel(e.channelUrl,!0);let r=!1;if(e instanceof h.SendableMessage){r=e.sender.userId===this._sdkState.userId,a.isSuper&&this._upsertCachedUserInfo(e.sender,e.updatedAt);for(const t of a.members)if(t.userId===e.sender.userId){i&&(t.nickname=e.sender.nickname,t.plainProfileUrl=e.sender.plainProfileUrl,t.metaData=e.sender.metaData,t.isBlockedByMe=e.sender.isBlockedByMe);break}}let o=!1;if(r){const t=e.sender,{currentUser:s}=this._sessionManager;s&&(s.nickname=t.nickname,s.plainProfileUrl=t.plainProfileUrl,s.metaData=t.metaData)}else a.isReadMessage(e)||0!==n&&!e.silent&&t&&(a._updateUnreadCount(a.unreadMessageCount,a.unreadMentionCount+n),o=!0);a._updateLastMessage(e)?o=!0:(null===(s=a.lastMessage)||void 0===s?void 0:s.isIdentical(e))&&(t?a._updateLastMessage(e)&&(o=!0):o=!0);let l=!1;a.lastPinnedMessage&&a.lastPinnedMessage.messageId===e.messageId&&(a.lastPinnedMessage=e,o=!0,l=!0),o&&(this._dispatcher.dispatch(new P({channels:[a],context:{source:l?d.CollectionEventSource.EVENT_PINNED_MESSAGE_UPDATED:d.CollectionEventSource.EVENT_MESSAGE_UPDATED}})),e.silent&&!r||d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(a)})))),l&&d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onPinnedMessageUpdated&&e.onPinnedMessageUpdated(a)}))))),this._dispatcher.dispatch(new d.MessageUpdateEventCommand({messages:[e],source:d.CollectionEventSource.EVENT_MESSAGE_UPDATED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const t of this._groupChannelHandlers.values())t.onMessageUpdated&&t.onMessageUpdated(a,e),n>0&&t.onMentionReceived&&t.onMentionReceived(a,e)}))))}}break}case"DELM":{const{channelUrl:t,channelType:s,messageId:n,silent:i,messageCreatedAt:a,senderId:r}=e.as(d.DeleteMessageEventCommand);if(s===d.ChannelType.GROUP){const e=yield this.getChannel(t,!0),s=r===this._sdkState.userId;i||s||a>0&&e.myLastRead<a&&e.unreadMessageCount>0&&e._updateUnreadCount(e.unreadMessageCount-1,0),this._dispatcher.dispatch(new d.MessageRemoveEventCommand({messageIds:[n],source:d.CollectionEventSource.EVENT_MESSAGE_DELETED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const t of this._groupChannelHandlers.values())t.onMessageDeleted&&t.onMessageDeleted(e,n)}))))}break}case"READ":{const{readStatus:t}=e.as(h.ReadEventCommand);if(t.channelType===d.ChannelType.GROUP){const e=this._groupChannelCache.isCachedInMemory(t.channelUrl),s=yield this.getChannel(t.channelUrl,!0);e&&s._updateUnreadMemberState(t.reader.userId,t.readAt),t.reader.userId===this._sdkState.userId?e?(s.unreadMessageCount>0||s.unreadMentionCount>0)&&(s._updateUnreadCount(0,0),this._dispatcher.dispatch(new P({channels:[s],context:{source:d.CollectionEventSource.EVENT_CHANNEL_READ}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(s)}))))):0!==s.unreadMessageCount&&0!==s.unreadMentionCount||(this._dispatcher.dispatch(new P({channels:[s],context:{source:d.CollectionEventSource.EVENT_CHANNEL_READ}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(s)}))))):(this._dispatcher.dispatch(new P({channels:[s],context:{source:d.CollectionEventSource.EVENT_CHANNEL_READ}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onUnreadMemberStatusUpdated&&e.onUnreadMemberStatusUpdated(s)})))))}break}case"DLVR":{const{channelUrl:t,deliveredStateUpdate:s={}}=e.as(ye),n=this._groupChannelCache.isCachedInMemory(t),i=yield this.getChannel(t,!0);n&&Object.keys(s).forEach((e=>{i._updateUndeliveredMemberState(e,s[e])})),Object.keys(s).some((e=>e!==this._sdkState.userId))&&(this._dispatcher.dispatch(new P({channels:[i],context:{source:d.CollectionEventSource.EVENT_CHANNEL_DELIVERED}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onUndeliveredMemberStatusUpdated&&e.onUndeliveredMemberStatusUpdated(i)})))));break}case"MRCT":{const{channelUrl:t,channelType:s,event:n}=e.as(u.ReactionEventCommand);if(s===d.ChannelType.GROUP){const e=yield this.getChannel(t,!0),s=yield this.getMessageFromCache(n.messageId);if(e.isSuper)for(const e of Object.keys(n._sampledUserInfoList)){const t=yield this._userInfoCache.get(e);if(t)t.plainProfileUrl=n._sampledUserInfoList[e].profile_url,t.nickname=n._sampledUserInfoList[e].nickname,this._upsertCachedUserInfo(t,n.updatedAt);else{const t=new d.User(this._iid,{user_id:e,nickname:n._sampledUserInfoList[e].nickname,profile_url:n._sampledUserInfoList[e].profile_url,require_auth_for_profile_image:n._sampledUserInfoList[e].require_auth_for_profile_image});this._upsertCachedUserInfo(t,n.updatedAt)}}s?s instanceof h.BaseMessage&&(s.applyReactionEvent(n),this._dispatcher.dispatch(new d.MessageUpdateEventCommand({messages:[s],source:d.CollectionEventSource.EVENT_MESSAGE_REACTION_UPDATED}))):this._dispatcher.dispatch(new d.ReactionUpdateEventCommand({event:n,source:d.CollectionEventSource.EVENT_MESSAGE_REACTION_UPDATED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const t of this._groupChannelHandlers.values())t.onReactionUpdated&&t.onReactionUpdated(e,n)}))))}break}case"MTHD":{const{event:t}=e.as(u.ThreadInfoUpdateEventCommand);if(t.channelType===d.ChannelType.GROUP){const e=yield this.getChannel(t.channelUrl,!0),s=yield this.getMessageFromCache(t.targetMessageId);if(s?s instanceof h.BaseMessage&&(s.applyThreadInfoUpdateEvent(t),this._dispatcher.dispatch(new d.MessageUpdateEventCommand({messages:[s],source:d.CollectionEventSource.EVENT_MESSAGE_THREADINFO_UPDATED}))):this._dispatcher.dispatch(new d.ThreadUpdateEventCommand({event:t,source:d.CollectionEventSource.EVENT_MESSAGE_THREADINFO_UPDATED})),e.isSuper)for(const e of t.threadInfo.mostRepliedUsers)this._upsertCachedUserInfo(e,t.threadInfo.updatedAt);d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const s of this._groupChannelHandlers.values())s.onThreadInfoUpdated&&s.onThreadInfoUpdated(e,t)}))))}break}case"MCNT":{const{groupChannelMemberCounts:t}=e.as(u.MemberCountUpdateEventCommand),s=[];for(const e of t){const{channelUrl:t,memberCount:n,joinedMemberCount:i,updatedAt:a}=e,r=yield this.getChannelFromCache(t);r&&r._setLatestMemberCount(n,i,a)&&s.push(r)}s.length>0&&(this._dispatcher.dispatch(new P({channels:s,context:{source:d.CollectionEventSource.EVENT_CHANNEL_MEMBER_COUNT_UPDATED}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelMemberCountChanged&&e.onChannelMemberCountChanged(s)})))));break}case"PEDI":{const{event:t,status:s,channelUrl:n,channelType:i}=e.as(u.PollUpdateEventCommand);if(n&&i===d.ChannelType.GROUP){const e=yield this.getChannel(n,!0);this._dispatcher.dispatch(new d.PollUpdateInternalEventCommand({event:t,source:d.CollectionEventSource.EVENT_POLL_UPDATED})),s===d.POLL_REMOVED_STATUS?d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const s of this._groupChannelHandlers.values())s.onPollDeleted&&s.onPollDeleted(e,t.pollId)})))):d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const s of this._groupChannelHandlers.values())s.onPollUpdated&&s.onPollUpdated(e,t)}))))}break}case"VOTE":{const{event:t,channelUrl:s,channelType:n}=e.as(h.PollVoteEventCommand);if(s&&n===d.ChannelType.GROUP){const e=yield this.getChannel(s,!0);this._dispatcher.dispatch(new d.PollVoteInternalEventCommand({event:t,source:d.CollectionEventSource.EVENT_POLL_VOTED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const s of this._groupChannelHandlers.values())s.onPollVoted&&s.onPollVoted(e,t)}))))}break}case"SYEV":{const{event:t}=e.as(u.ChannelEventCommand);if(t.isGroupChannelEvent)switch(t.category){case u.ChannelEventCategory.CHANNEL_JOIN:{const s=yield this.getChannel(t.channelUrl,!0),{memberCount:n,joinedMemberCount:i,members:a}=e.as(ie);let r=!1;if(a.forEach((e=>{s.isExclusive||s.isSuper||s.isBroadcast?r=r||s._setLatestMemberCount(n,i,t.ts):(e.state=exports.MemberState.JOINED,s.addMember(e,t.ts),this._updateJoinedMemberCount(s)),e.userId===this._sdkState.userId&&(s.myMemberState=exports.MemberState.JOINED)})),s.isSuper)for(const e of a)this._upsertCachedUserInfo(e,t.ts);this._dispatcher.dispatch(new P({channels:[s],context:{source:d.CollectionEventSource.EVENT_CHANNEL_JOINED,users:a}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{for(const t of a)e.onUserJoined&&e.onUserJoined(s,t);s.isBroadcast&&r&&e.onChannelMemberCountChanged&&e.onChannelMemberCountChanged([s])}))}))));break}case u.ChannelEventCategory.CHANNEL_LEAVE:{const s=this._leftChannels.get(t.channelUrl),n=s?s.channel:yield this.getChannel(t.channelUrl,!0),{memberCount:i,joinedMemberCount:a,member:r}=e.as(re);let o=!1;const{appInfo:l}=d.Vault.of(this._iid);if(n.isExclusive||n.isSuper||n.isBroadcast)o=n._setLatestMemberCount(i,a,t.ts);else{if(null==l?void 0:l.enabledChannelMemberShipHistory){const e=n.members.find((e=>e.userId===r.userId));e&&(e.state=exports.MemberState.LEFT),n.memberCount=i}else n.removeMember(r);this._updateJoinedMemberCount(n)}r.userId===this._sdkState.userId?(n.myMemberState=exports.MemberState.NONE,n.invitedAt=0,n.joinedAt=0,n._updateUnreadCount(0,0),n.isPublic?this._dispatcher.dispatch(new P({channels:[n],context:{source:d.CollectionEventSource.EVENT_CHANNEL_LEFT,user:r}})):(this._markAsLeave(n),this._dispatcher.dispatch(new R({channelUrls:[n.url],context:{source:d.CollectionEventSource.EVENT_CHANNEL_LEFT,user:r}})))):this._dispatcher.dispatch(new P({channels:[n],context:{source:d.CollectionEventSource.EVENT_CHANNEL_LEFT,user:r}})),n.isSuper&&this._upsertCachedUserInfo(r,t.ts),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onUserLeft&&e.onUserLeft(n,r),n.isBroadcast&&o&&e.onChannelMemberCountChanged&&e.onChannelMemberCountChanged([n])}))}))));break}case u.ChannelEventCategory.CHANNEL_OPERATOR_UPDATE:{const s=yield this.getChannel(t.channelUrl,!0),{operators:n}=e.as(u.OperatorUpdateEventCommand),i=n.map((e=>e.userId));for(const e of s.members)e.role=i.includes(e.userId)?d.Role.OPERATOR:d.Role.NONE;s.myRole=i.includes(this._sdkState.userId)?d.Role.OPERATOR:d.Role.NONE,this._dispatcher.dispatch(new P({channels:[s],context:{source:d.CollectionEventSource.EVENT_CHANNEL_OPERATOR_UPDATED,operators:n}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onOperatorUpdated&&e.onOperatorUpdated(s,n)}))}))));break}case u.ChannelEventCategory.CHANNEL_INVITE:{const s=yield this.getChannel(t.channelUrl,!0),{memberCount:n,joinedMemberCount:i,inviter:a,invitees:r}=e.as(de);r.forEach((e=>e.state=exports.MemberState.INVITED));for(const e of r)s.isExclusive||s.isSuper||s.isBroadcast?(s.isSuper&&this._userInfoCache.upsert(e,t.ts),s._setLatestMemberCount(n,i,t.ts)):s.addMember(e,t.ts),this._sdkState.userId===e.userId&&(s.hiddenState=exports.HiddenState.UNHIDDEN,s.myMemberState!==exports.MemberState.JOINED&&(s.myMemberState=exports.MemberState.INVITED),s.invitedAt=t.ts);this._dispatcher.dispatch(new P({channels:[s],context:{source:d.CollectionEventSource.EVENT_CHANNEL_INVITED,inviter:a,invitees:r}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onUserReceivedInvitation&&e.onUserReceivedInvitation(s,a,r)}))}))));break}case u.ChannelEventCategory.CHANNEL_DECLINE_INVITE:{const s=yield this.getChannel(t.channelUrl,!0),{memberCount:n,joinedMemberCount:i,inviter:a,invitee:r}=e.as(ce);s.isExclusive||s.isSuper||s.isBroadcast?(s.isSuper&&this._userInfoCache.upsert(r,t.ts),s._setLatestMemberCount(n,i,t.ts)):s.removeMember(r),this._sdkState.userId===r.userId?(s.invitedAt=0,s.myMemberState=exports.MemberState.NONE,s.isPublic?this._dispatcher.dispatch(new P({channels:[s],context:{source:d.CollectionEventSource.EVENT_CHANNEL_DECLINED_INVITE,inviter:a,invitee:r}})):this._dispatcher.dispatch(new R({channelUrls:[s.url],context:{source:d.CollectionEventSource.EVENT_CHANNEL_DECLINED_INVITE,inviter:a,invitee:r}}))):this._dispatcher.dispatch(new P({channels:[s],context:{source:d.CollectionEventSource.EVENT_CHANNEL_DECLINED_INVITE,inviter:a,invitee:r}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onUserDeclinedInvitation&&e.onUserDeclinedInvitation(s,a,r)}))}))));break}case u.ChannelEventCategory.TYPING_START:case u.ChannelEventCategory.TYPING_END:{const s=yield this.getChannel(t.channelUrl,!0),n=t.category===u.ChannelEventCategory.TYPING_START,{user:i}=e.as(n?Ce:ve);s._updateTypingStatus(i,n?t.ts:0),this._dispatcher.dispatch(new P({channels:[s],context:{source:d.CollectionEventSource.EVENT_CHANNEL_TYPING_STATUS_UPDATE}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onTypingStatusUpdated&&e.onTypingStatusUpdated(s)}))}))));break}case u.ChannelEventCategory.USER_CHANNEL_MUTE:case u.ChannelEventCategory.USER_CHANNEL_UNMUTE:{const s=yield this.getChannel(t.channelUrl,!0),n=t.category===u.ChannelEventCategory.USER_CHANNEL_MUTE,{user:i}=e.as(n?h.MuteUserEventCommand:h.UnmuteUserEventCommand);i.userId===this._sdkState.userId&&(s.myMutedState=n?d.MutedState.MUTED:d.MutedState.UNMUTED,s._myMutedRemainingTime=i.restrictionInfo.remainingDuration);for(const e of s.members)if(e.userId===i.userId){e.isMuted=n;break}s.isSuper&&this._userInfoCache.upsert(i,t.ts),this._dispatcher.dispatch(new P({channels:[s],context:{source:n?d.CollectionEventSource.EVENT_CHANNEL_MUTED:d.CollectionEventSource.EVENT_CHANNEL_UNMUTED,user:i}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{n?e.onUserMuted&&e.onUserMuted(s,i):e.onUserUnmuted&&e.onUserUnmuted(s,i)}))}))));break}case u.ChannelEventCategory.USER_CHANNEL_BAN:{const s=this._leftChannels.get(t.channelUrl),n=s?s.channel:yield this.getChannel(t.channelUrl,!0);this._markAsLeave(n);const{user:i}=e.as(h.BanUserEventCommand),a=i.userId===this._sdkState.userId;n.isSuper&&this._userInfoCache.upsert(i,t.ts),a&&this._dispatcher.dispatch(new R({channelUrls:[n.url],context:{source:d.CollectionEventSource.EVENT_CHANNEL_BANNED,user:i}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onUserBanned&&e.onUserBanned(n,i)}))}))));break}case u.ChannelEventCategory.USER_CHANNEL_UNBAN:{const s=yield this.getChannel(t.channelUrl,!0),{user:n}=e.as(h.UnbanUserEventCommand),i=n.userId===this._sdkState.userId;s.isSuper&&this._userInfoCache.upsert(n,t.ts),i&&this._dispatcher.dispatch(new R({channelUrls:[s.url],context:{source:d.CollectionEventSource.EVENT_CHANNEL_UNBANNED,user:n}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onUserUnbanned&&e.onUserUnbanned(s,n)}))}))));break}case u.ChannelEventCategory.CHANNEL_FREEZE:case u.ChannelEventCategory.CHANNEL_UNFREEZE:{const s=yield this.getChannel(t.channelUrl,!0),{freeze:n}=e.as(h.FreezeEventCommand);s.isFrozen=n,this._dispatcher.dispatch(new P({channels:[s],context:{source:n?d.CollectionEventSource.EVENT_CHANNEL_FROZEN:d.CollectionEventSource.EVENT_CHANNEL_UNFROZEN}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{n?e.onChannelFrozen&&e.onChannelFrozen(s):e.onChannelUnfrozen&&e.onChannelUnfrozen(s)}))}))));break}case u.ChannelEventCategory.CHANNEL_HIDE:{const s=yield this.getChannel(t.channelUrl,!0),{allowAutoUnhide:n,hidePreviousMessages:i,messageOffsetTimestamp:a}=e.as(me);null!==n&&(s.hiddenState=n?exports.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE:exports.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE),null!==i&&i&&s._updateUnreadCount(0,0),null!==a&&(s.messageOffsetTimestamp=a),this._dispatcher.dispatch(new P({channels:[s],context:{source:d.CollectionEventSource.EVENT_CHANNEL_HIDDEN}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onChannelHidden&&e.onChannelHidden(s)}))}))));break}case u.ChannelEventCategory.CHANNEL_UNHIDE:{const e=yield this.getChannel(t.channelUrl,!0);e.hiddenState=exports.HiddenState.UNHIDDEN,this._dispatcher.dispatch(new P({channels:[e],context:{source:d.CollectionEventSource.EVENT_CHANNEL_UNHIDDEN}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((t=>{t.onChannelChanged&&t.onChannelChanged(e)}))}))));break}case u.ChannelEventCategory.CHANNEL_DELETED:{const e=yield this.getChannel(t.channelUrl,!0);this._dispatcher.dispatch(new R({channelUrls:[t.channelUrl],context:{source:d.CollectionEventSource.EVENT_CHANNEL_DELETED}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((t=>{t.onChannelDeleted&&t.onChannelDeleted(e.url,e.channelType)}))}))));break}case u.ChannelEventCategory.CHANNEL_PROP_CHANGED:{const e=yield this.getChannelWithoutCache(t.channelUrl,!0);this._dispatcher.dispatch(new P({channels:[e],context:{source:d.CollectionEventSource.EVENT_CHANNEL_UPDATED}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((t=>{t.onChannelChanged&&t.onChannelChanged(e)}))}))));break}case u.ChannelEventCategory.CHANNEL_META_DATA_CHANGED:{const s=yield this.getChannel(t.channelUrl,!0),{created:n,updated:i,deleted:a}=e.as(h.UpdateMetaDataEventCommand);n&&(s._upsertCachedMetaData(n,t.ts),this._dispatcher.dispatch(new P({channels:[s],context:{source:d.CollectionEventSource.EVENT_CHANNEL_METADATA_CREATED,metaData:n},ts:t.ts}))),i&&(s._upsertCachedMetaData(i,t.ts),this._dispatcher.dispatch(new P({channels:[s],context:{source:d.CollectionEventSource.EVENT_CHANNEL_METADATA_UPDATED,metaData:i},ts:t.ts}))),a&&(s._removeFromCachedMetaData(a,t.ts),this._dispatcher.dispatch(new P({channels:[s],context:{source:d.CollectionEventSource.EVENT_CHANNEL_METADATA_DELETED,metaDataKeys:a},ts:t.ts}))),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{n&&e.onMetaDataCreated&&e.onMetaDataCreated(s,n),i&&e.onMetaDataUpdated&&e.onMetaDataUpdated(s,i),a&&e.onMetaDataDeleted&&e.onMetaDataDeleted(s,a)}))}))));break}case u.ChannelEventCategory.CHANNEL_META_COUNTERS_CHANGED:{const s=yield this.getChannel(t.channelUrl,!0),{created:n,updated:i,deleted:a}=e.as(h.UpdateMetaCounterEventCommand);n&&this._dispatcher.dispatch(new P({channels:[s],context:{source:d.CollectionEventSource.EVENT_CHANNEL_METACOUNTER_CREATED,metaCounters:n}})),i&&this._dispatcher.dispatch(new P({channels:[s],context:{source:d.CollectionEventSource.EVENT_CHANNEL_METACOUNTER_UPDATED,metaCounters:i}})),a&&this._dispatcher.dispatch(new P({channels:[s],context:{source:d.CollectionEventSource.EVENT_CHANNEL_METACOUNTER_DELETED,metaCounterKeys:a}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{n&&e.onMetaCounterCreated&&e.onMetaCounterCreated(s,n),i&&e.onMetaCounterUpdated&&e.onMetaCounterUpdated(s,i),a&&e.onMetaCounterDeleted&&e.onMetaCounterDeleted(s,a)}))}))));break}case u.ChannelEventCategory.PINNED_MESSAGE_CHANGED:{const s=yield this.getChannel(t.channelUrl,!0),{pinnedMessageIds:n,latestPinnedMessage:i,ts:a}=e.as(u.UpdatePinnedMessageEventCommand);a>s._pinnedMessagesUpdatedAt&&(s.pinnedMessageIds=null!=n?n:[],s.lastPinnedMessage=i,s._pinnedMessagesUpdatedAt=a,this._dispatcher.dispatch(new P({channels:[s],context:{source:d.CollectionEventSource.EVENT_PINNED_MESSAGE_UPDATED}})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(s)})))),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onPinnedMessageUpdated&&e.onPinnedMessageUpdated(s)}))})))));break}}break}case"USEV":{const{event:t}=e.as(c.UserEventCommand);switch(t.category){case c.UserEventCategory.USER_BLOCK:{const{blocker:e,blockee:s}=c.UserEvent.getDataAsUserBlockEvent(this._iid,t);this._groupChannelCache.block(e.userId,s.userId);break}case c.UserEventCategory.USER_UNBLOCK:{const{blocker:e,blockee:s}=c.UserEvent.getDataAsUserBlockEvent(this._iid,t);this._groupChannelCache.unblock(e.userId,s.userId);break}}break}}}catch(e){if(d.isThrowingOutside(e))throw e}}))}_markAsLeave(e){var t;const s=null!==(t=this._leftChannels.get(e.url))&&void 0!==t?t:{channel:e,ref:0};s.ref++,this._leftChannels.set(e.url,s),setTimeout((()=>{s.ref--,0===s.ref&&this._leftChannels.delete(e.url)}),1e4)}addHandler(e,t){this._groupChannelHandlers.set(e,t)}removeHandler(e){this._groupChannelHandlers.delete(e)}clearHandler(){this._groupChannelHandlers.clear()}subscribeChannelEvent(e,t){this._groupChannelBroadcast.subscribe(e,t)}unsubscribeChannelEvent(e){this._groupChannelBroadcast.unsubscribe(e)}_updateJoinedMemberCount(e){e.joinedMemberCount=e.members.filter((e=>e.state===exports.MemberState.JOINED)).length}getChannel(e,t=!1){return d.__awaiter(this,void 0,void 0,(function*(){d.unless(d.isTypeOf("string",e)).throw(d.SendbirdError.invalidParameters);try{const t=yield this.getChannelFromCache(e);if(t)return t}catch(e){}return yield this.getChannelWithoutCache(e,t)}))}getChannelWithoutCache(e,t=!1){return d.__awaiter(this,void 0,void 0,(function*(){d.unless(d.isTypeOf("string",e)).throw(d.SendbirdError.invalidParameters);const s=new D({channelUrl:e,isInternalCall:t}),n=yield this._requestQueue.send(s),{channel:i}=n.as(k);let{unreadMessageCount:a,unreadMentionCount:r}=i;switch(i.myCountPreference){case exports.CountPreference.UNREAD_MESSAGE_COUNT_ONLY:r=0;break;case exports.CountPreference.UNREAD_MENTION_COUNT_ONLY:a=0;break;case exports.CountPreference.OFF:a=0,r=0}return i._updateUnreadCount(a,r),(yield this.upsertChannelsToCache([i]))[0]}))}refreshChannel(e,t=!0,s=d.CollectionEventSource.REFRESH_CHANNEL,n=!1){return d.__awaiter(this,void 0,void 0,(function*(){try{const i=new D({channelUrl:e,isInternalCall:t,showLatestMessage:n}),a=yield this._requestQueue.send(i),{channel:r}=a.as(k);if(r.myMemberState===exports.MemberState.NONE)this._dispatcher.dispatch(new R({channelUrls:[r.url],context:{source:s}}));else{const e=yield this.upsertChannelsToCache([r]);this._dispatcher.dispatch(new P({channels:e,context:{source:s}}))}}catch(t){t.code!==d.SendbirdErrorCode.NON_AUTHORIZED&&t.code!==d.SendbirdErrorCode.NOT_FOUND_IN_DATABASE||this._dispatcher.dispatch(new R({channelUrls:[e],context:{source:s}}))}}))}getMyGroupChannels(e,t,s,n=d.CollectionEventSource.REQUEST_CHANNEL,i=!1){return d.__awaiter(this,void 0,void 0,(function*(){t.createdAfter&&(t.createdAfter=Math.floor(t.createdAfter/1e3)),t.createdBefore&&(t.createdBefore=Math.floor(t.createdBefore/1e3));let a=!1;if(i){const{appInfo:e,cacheContext:t}=d.Vault.of(this._iid);t&&!t.localCacheEnabled&&(null==e?void 0:e.enabledChannelMemberShipHistory)&&(null==e?void 0:e.applicationAttributes.includes("left_user_view_support"))&&(a=!0)}const r=new V(Object.assign(Object.assign({},t),{userId:this._sdkState.userId,token:e,limit:s,includeLeftChannel:i&&a})),o=yield this._requestQueue.send(r),{channels:l,token:h}=o.as(G);return this._dispatcher.dispatch(new P({channels:l,context:{source:n}})),{channels:l,token:h}}))}getMyGroupChannelChangeLogs(e,t,s=d.CollectionEventSource.REQUEST_CHANNEL_CHANGELOGS){return d.__awaiter(this,void 0,void 0,(function*(){const n=Object.assign(Object.assign({},f),t);d.unless((d.isTypeOf("string",e)||d.isTypeOf("number",e))&&M(n)).throw(d.SendbirdError.invalidParameters);const i=new w(d.undefineNullProps({userId:this._sdkState.userId,ts:"number"==typeof e?e:null,token:"string"==typeof e?e:null,filter:n})),a=(yield this._requestQueue.send(i)).as(F),{updatedChannels:r,deletedChannelUrls:o,hasMore:l,ts:h}=a;return r.length>0&&this._dispatcher.dispatch(new P({channels:r,context:{source:s},ts:h})),o.length>0&&this._dispatcher.dispatch(new R({channelUrls:o,context:{source:s}})),{updatedChannels:r,deletedChannelUrls:o,hasMore:l,token:a.token}}))}getGroupChannelCount(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},S),e);d.unless(y(t)).throw(d.SendbirdError.invalidParameters);const s=new q({userId:this._sdkState.userId,filter:t}),n=yield this._requestQueue.send(s),{groupChannelCount:i}=n.as(B);return i}))}getUnreadItemCount(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},b),e);d.unless((e=>d.isArrayOf(exports.UnreadItemKey,e.keys)&&d.isArrayOf("string",e.customTypeFilters,!0)&&d.isArrayOf("string",e.customTypesFilter,!0))(t)).throw(d.SendbirdError.invalidParameters);const{sdkState:s,requestQueue:n}=d.Vault.of(this._iid),i=new j({userId:s.userId,filter:t}),a=yield n.send(i),{groupChannelUnreadMentionCount:r,groupChannelUnreadMessageCount:o,groupChannelInvitationCount:l,superGroupChannelUnreadMentionCount:h,superGroupChannelUnreadMessageCount:c,superGroupChannelInvitationCount:u,nonSuperGroupChannelUnreadMentionCount:_,nonSuperGroupChannelUnreadMessageCount:p,nonSuperGroupChannelInvitationCount:m}=a.as(z);return d.deundefined({groupChannelUnreadMentionCount:r,groupChannelUnreadMessageCount:o,groupChannelInvitationCount:l,superGroupChannelUnreadMentionCount:h,superGroupChannelUnreadMessageCount:c,superGroupChannelInvitationCount:u,nonSuperGroupChannelUnreadMentionCount:_,nonSuperGroupChannelUnreadMessageCount:p,nonSuperGroupChannelInvitationCount:m})}))}getTotalUnreadChannelCount(){return d.__awaiter(this,void 0,void 0,(function*(){const{sdkState:e,requestQueue:t}=d.Vault.of(this._iid),s=new W({userId:e.userId}),n=yield t.send(s),{unreadCount:i}=n.as($);return i}))}getTotalUnreadMessageCount(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},N),e);d.unless(T(t)).throw(d.SendbirdError.invalidParameters);const{sdkState:s,requestQueue:n}=d.Vault.of(this._iid),i=new K({userId:s.userId,filter:t}),a=yield n.send(i),{unreadCount:r}=a.as(Q);return r}))}getTotalScheduledMessageCount(e={}){return d.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},U),e);d.unless((e=>d.isTypeOf("string",e.channelUrl,!0)&&d.isArrayOf(h.ScheduledStatus,e.scheduledStatus,!0)&&d.isEnumOf(d.MessageTypeFilter,e.messageTypeFilter))(t)).throw(d.SendbirdError.invalidParameters);const{requestQueue:s}=d.Vault.of(this._iid),n=new Y(t),i=yield s.send(n),{count:a}=i.as(J);return a}))}getSubscribedTotalUnreadMessageCount(){const{subscribedUnreadMessageCount:e}=d.Vault.of(this._iid);return e.all>=0?e.all:0}getSubscribedCustomTypeTotalUnreadMessageCount(){let e=0;const{subscribedUnreadMessageCount:t}=d.Vault.of(this._iid);return Object.keys(t.customTypes).forEach((s=>{e+=t.customTypes[s]})),e}getSubscribedCustomTypeUnreadMessageCount(e){var t;const{subscribedUnreadMessageCount:s}=d.Vault.of(this._iid);return null!==(t=s.customTypes[e])&&void 0!==t?t:0}createChannel(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},E),e);d.unless(v(t)).throw(d.SendbirdError.invalidParameters),t.isPublic||(t.accessCode=void 0);const s=new Z(Object.assign({userId:this._sdkState.userId},t)),n=yield this._requestQueue.send(s),{channel:i}=n.as(ee);return yield this.upsertChannelsToCache([i]),i}))}markAsReadAll(){return d.__awaiter(this,void 0,void 0,(function*(){const e=Date.now();d.unless(e-this._markAsReadAllLastSentAt>=1e3).throw(d.SendbirdError.markAsReadAllRateLimitExceeded),this._markAsReadAllLastSentAt=e;const t=new te({userId:this._sdkState.userId});yield this._requestQueue.send(t);const s=this._groupChannelCache.channels;for(const t of s)t._updateUnreadMemberState(this._sdkState.userId,e),t._updateUnreadCount(0,0);s.length>0&&(yield this.upsertChannelsToCache(s))}))}markAsReadWithChannelUrls(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=Date.now();d.unless(d.isArrayOf("string",e)&&t-this._markAsReadAllLastSentAt>=1e3).throw(d.SendbirdError.markAsReadAllRateLimitExceeded),this._markAsReadAllLastSentAt=t;const s=new te({userId:this._sdkState.userId,channelUrls:e});yield this._requestQueue.send(s);const n=this._groupChannelCache.channels,i=[];for(const s of n)e.includes(s.url)&&(s._updateUnreadMemberState(this._sdkState.userId,t),s._updateUnreadCount(0,0),i.push(s));i.length>0&&(yield this.upsertChannelsToCache(i))}))}markAsDelivered(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=yield this.getChannel(e);yield t.markAsDelivered()}))}getMessageFromCache(e){var t;return d.__awaiter(this,void 0,void 0,(function*(){return null!==(t=yield this._messageCache.get(e))&&void 0!==t?t:null}))}getExactlyMatchingMessagesForTokenFromCache(e,t,s){return d.__awaiter(this,void 0,void 0,(function*(){return yield this._messageCache.fetch({channelUrl:e,token:t,filter:s,exactMatch:!0})}))}getMessagesFromCache(e,t,s,n,i=h.DEFAULT_MESSAGE_LIMIT,a=!0){return d.__awaiter(this,void 0,void 0,(function*(){return yield this._messageCache.fetch({channelUrl:e,token:t,limit:i,filter:n,backward:"next"===s,inclusive:a})}))}getPollMessagesFromCache(e,t,s,n){return d.__awaiter(this,void 0,void 0,(function*(){return yield this._messageCache.fetch({channelUrl:e,token:t,limit:n,filter:s,backward:!1,isPollOnly:!0})}))}getCachedMessageCountBetween(e,t,s,n){return d.__awaiter(this,void 0,void 0,(function*(){return yield this._messageCache.countBetween(e,t,new Ae({top:s,bottom:n}))}))}getUnsentMessagesFromCache(e,t){return d.__awaiter(this,void 0,void 0,(function*(){return yield this._unsentMessageCache.fetch({channelUrl:e,filter:t})}))}removeFailedMessageFromCache(e){return d.__awaiter(this,void 0,void 0,(function*(){yield this._unsentMessageCache.remove([e])}))}}const Te=(e,t)=>t instanceof h.SendableMessage?e.findIndex((e=>e instanceof h.SendableMessage&&t.isIdentical(e))):e.findIndex((e=>e.isIdentical(t))),Ue=(e,t)=>e.findIndex((e=>e instanceof h.BaseMessage?e.messageId===t:e instanceof h.NotificationMessage?e.notificationId===t:void 0)),Ie=(e,t)=>{if(e.length>0){let s=0,n=e.length-1,i=Math.floor((s+n)/2);for(;s<n;){const a=e[i].createdAt-t.createdAt;if(a>0)n=i,i=Math.floor((s+n)/2);else{if(!(a<0))return i;s=i+1,i=Math.floor((s+n)/2)}}return e[i].createdAt>t.createdAt?i:i+1}return e.length},xe={};class Pe{constructor({_iid:e,channel:t,limit:s=100}){this.ref=0,this._iid=e,this._channel=t,this._limit=s,this._prevSyncLoopCount=0;const{sdkState:n,cacheContext:i,dispatcher:a,logger:r,statManager:o,messageBackgroundSyncThrottleController:l}=d.Vault.of(this._iid);var u,_;this._metadataKey=(u=n.userId,_=t.url,`sendbird:${u}@groupchannel/${_}/message/sync.meta`);const p=((e,t)=>`sendbird:${e}@groupchannel/${t}/message/sync`)(n.userId,t.url);this._prevSync=new c.Sync(p,(e=>d.__awaiter(this,void 0,void 0,(function*(){return yield l.run(`message-background-sync-${t.url}-prev`,(()=>d.__awaiter(this,void 0,void 0,(function*(){var s,n,a,l,c,u,_;const p={hasNext:!0,nextToken:0};if(this._prevSyncLoopCount++,yield this.loadMetadata(),r.debug("message background prev sync from",null===(s=this._metadata)||void 0===s?void 0:s.range.top),null===(n=this._metadata)||void 0===n?void 0:n.previousComplete)p.hasNext=!1;else try{const t=h.MessageManager.of(this._iid),{messages:s}=yield t._getMessagesByTimestampForCollection(this._channel.url,this._channel.channelType,(null===(l=null===(a=this._metadata)||void 0===a?void 0:a.range)||void 0===l?void 0:l.top)?this._metadata.range.top:e,{prevResultSize:this._limit,nextResultSize:0,replyType:d.ReplyType.ALL,includeReactions:!0,includeMetaArray:!0,includeParentMessageInfo:!0,includeThreadInfo:!0,isInclusive:!0},d.CollectionEventSource.SYNC_MESSAGE_BACKGROUND,!1,!1,h.SDKSource.INTERNAL_BACKSYNC);if(s.length>0){const e=s.map((e=>e.createdAt));(null===(c=this._metadata)||void 0===c?void 0:c.range.intersect(...e))?this.extendRange(s):this._metadata={range:new Ae({top:Math.min(...e),bottom:Math.max(...e)}),previousComplete:!1}}p.hasNext=s.length>=this._limit&&this._prevSyncLoopCount<1,this._metadata&&(p.nextToken=this._metadata.range.top,this._metadata.previousComplete=s.length<this._limit),r.debug("message background prev sync progress",p),yield this.saveMetadata()}catch(e){throw r.debug("message background prev sync error",e),e instanceof d.SendbirdError&&e.isInvalidTokenError&&(yield this.clearMetadata()),e}finally{o.put(new d.StatLog({type:d.StatType.FEATURE_LOCALCACHE_EVENT,ts:Date.now(),data:{channel_url:t.url,measured_on:"back_sync",event:"cache_fetch",max_db_size:null!==(_=null===(u=i.localCacheConfig)||void 0===u?void 0:u.maxSize)&&void 0!==_?_:0,use_local_cache:i.localCacheEnabled,starting_point:0,message_init_policy:""}}))}return p}))))})))),this._nextSync=new c.Sync(p,(e=>d.__awaiter(this,void 0,void 0,(function*(){return yield l.run(`message-background-sync-${t.url}-next`,(()=>d.__awaiter(this,void 0,void 0,(function*(){var s,n,a,l,c,u;const _={hasNext:!0,nextToken:0};yield this.loadMetadata(),r.debug("message background next sync from",null===(s=this._metadata)||void 0===s?void 0:s.range.bottom);try{const t=h.MessageManager.of(this._iid),{messages:s}=yield t._getMessagesByTimestampForCollection(this._channel.url,this._channel.channelType,(null===(a=null===(n=this._metadata)||void 0===n?void 0:n.range)||void 0===a?void 0:a.bottom)?this._metadata.range.bottom:e,{prevResultSize:0,nextResultSize:this._limit,replyType:d.ReplyType.ALL,includeReactions:!0,includeMetaArray:!0,includeParentMessageInfo:!0,includeThreadInfo:!0,isInclusive:!0},d.CollectionEventSource.SYNC_MESSAGE_BACKGROUND,!1,!1,h.SDKSource.INTERNAL_BACKSYNC);if(s.length>0){const e=s.map((e=>e.createdAt));(null===(l=this._metadata)||void 0===l?void 0:l.range.intersect(...e))?this.extendRange(s):this._metadata={range:new Ae({top:Math.min(...e),bottom:Math.max(...e)}),previousComplete:!1}}_.hasNext=s.length>=this._limit,this._metadata&&(_.nextToken=this._metadata.range.bottom),r.debug("message background next sync progress",_),yield this.saveMetadata()}catch(e){throw r.debug("message background next sync error",e),e}finally{o.put(new d.StatLog({type:d.StatType.FEATURE_LOCALCACHE_EVENT,ts:Date.now(),data:{channel_url:t.url,measured_on:"back_sync",event:"cache_fetch",max_db_size:null!==(u=null===(c=i.localCacheConfig)||void 0===c?void 0:c.maxSize)&&void 0!==u?u:0,use_local_cache:i.localCacheEnabled,starting_point:0,message_init_policy:""}}))}return _}))))})))),this._connectionEventContext=a.on((e=>{if(e instanceof d.ConnectionStateChangeCommand)if(e.stateType===d.ConnectionStateType.CONNECTED)this.resume();else this.pause()}))}static of(e,t){return xe[e]||(xe[e]={}),xe[e][t.url]||(xe[e][t.url]=new Pe({_iid:e,channel:t})),xe[e][t.url].ref++,xe[e][t.url]}static clear(e,t){xe[e]&&xe[e][t]&&(xe[e][t].close(),delete xe[e])}get range(){var e,t;return null!==(t=null===(e=this._metadata)||void 0===e?void 0:e.range)&&void 0!==t?t:new Ae({})}get previousComplete(){var e;return!!(null===(e=this._metadata)||void 0===e?void 0:e.previousComplete)}isWrappingMessages(e){var t;return null===(t=this.range)||void 0===t?void 0:t.includes(...e.map((e=>e.createdAt)))}extendRange(e){this._metadata&&this._metadata.range.extends(...e.map((e=>e.createdAt)))}loadMetadata(){return d.__awaiter(this,void 0,void 0,(function*(){if(!this._metadata){const{cacheContext:e}=d.Vault.of(this._iid),t=yield e.preference.get(this._metadataKey);this._metadata=t?{range:new Ae(t.range),previousComplete:t.previousComplete}:{range:new Ae({}),previousComplete:!1}}return this._metadata}))}saveMetadata(){return d.__awaiter(this,void 0,void 0,(function*(){if(this._metadata){const{cacheContext:e}=d.Vault.of(this._iid);return yield e.preference.set(this._metadataKey,this._metadata),!0}return!1}))}clearMetadata(){return d.__awaiter(this,void 0,void 0,(function*(){const{cacheContext:e}=d.Vault.of(this._iid);yield e.preference.remove(this._metadataKey),this._metadata=void 0}))}resume(e=Date.now()){var t,s,n,i;const{logger:a,sessionManager:r,cacheContext:o}=d.Vault.of(this._iid);o.localCacheEnabled&&r.session.hasSession&&(a.debug("message background sync resume()"),this._prevSyncLoopCount=0,this._metadata&&this._metadata.previousComplete||this._prevSync.start(null!==(s=null===(t=this._metadata)||void 0===t?void 0:t.range.top)&&void 0!==s?s:e),this._nextSync.start(null!==(i=null===(n=this._metadata)||void 0===n?void 0:n.range.bottom)&&void 0!==i?i:e))}pause(){const{logger:e}=d.Vault.of(this._iid);e.debug("message background sync stop()"),this._prevSync.stop(),this._nextSync.stop()}close(){this.ref--,this.ref<=0&&(this.ref=0,this.pause(),this._connectionEventContext.close(),delete xe[this._iid][this._channel.url])}}const Re={};class Oe{constructor({_iid:e,channel:t,includeParams:s}){this.ref=0,this._iid=e,this._channel=t,this._includeParams=s;const{logger:n,sdkState:i,dispatcher:a}=d.Vault.of(this._iid);var r,o;this._metadataKey=(r=i.userId,o=t.url,`sendbird:${r}@groupchannel/${o}/message/changelogs.meta`);const l=((e,t)=>`sendbird:${e}@groupchannel/${t}/message/changelogs`)(i.userId,this._channel.url);this._sync=new c.Sync(l,(()=>d.__awaiter(this,void 0,void 0,(function*(){var e;const t={hasNext:!0,nextToken:0};yield this.loadMetadata(),n.debug("message changelog sync from",null===(e=this._metadata)||void 0===e?void 0:e.token);try{const e=h.MessageManager.of(this._iid),{updatedMessages:s,deletedMessageIds:i,hasMore:a,token:r,forceUseNextToken:o}=yield e.getMessageChangelogs(this._channel.url,this._channel.channelType,this._metadata.token,Object.assign({replyType:d.ReplyType.ALL},this._includeParams),d.CollectionEventSource.SYNC_MESSAGE_CHANGELOGS);t.hasNext=a,t.nextToken=r,s.length>0||i.length>0?this._metadata&&(this._metadata.token=r):o&&this._metadata&&(this._metadata.token=r),n.debug("message changelog sync progress",t),yield this.saveMetadata()}catch(e){throw n.debug("message changelog sync error",e),e instanceof d.SendbirdError&&e.isInvalidTokenError&&(yield this.clearMetadata()),e}return t})))),this._connectionEventContext=a.on((e=>{if(e instanceof d.ConnectionStateChangeCommand)if(e.stateType===d.ConnectionStateType.CONNECTED)this.resume();else this.pause()}))}static of(e,t,s){return Re[e]||(Re[e]={}),Re[e][t.url]||(Re[e][t.url]=new Oe({_iid:e,channel:t,includeParams:s})),Re[e][t.url].ref++,Re[e][t.url]}static clear(e,t){Re[e]&&Re[e][t]&&(Re[e][t].close(),delete Re[e])}loadMetadata(){return d.__awaiter(this,void 0,void 0,(function*(){if(!this._metadata){const{cacheContext:e,firstConnectedAt:t}=d.Vault.of(this._iid),s=yield e.preference.get(this._metadataKey);this._metadata={token:s?s.token:t}}return this._metadata}))}saveMetadata(){return d.__awaiter(this,void 0,void 0,(function*(){if(this._metadata){const{cacheContext:e}=d.Vault.of(this._iid);return yield e.preference.set(this._metadataKey,this._metadata),!0}return!1}))}clearMetadata(){return d.__awaiter(this,void 0,void 0,(function*(){const{cacheContext:e}=d.Vault.of(this._iid);yield e.preference.remove(this._metadataKey),this._metadata=void 0}))}resume(){const{logger:e,sessionManager:t}=d.Vault.of(this._iid);t.session.hasSession&&(e.debug("message changelog sync resume()"),this._sync.start(0))}pause(){const{logger:e}=d.Vault.of(this._iid);e.debug("message changelog sync pause()"),this._sync.stop()}close(){this.ref--,this.ref<=0&&(this.ref=0,this.pause(),this._connectionEventContext.close(),delete Re[this._iid][this._channel.url])}}const Le={};class we{constructor({_iid:e,channel:t,hasPollMessage:s}){this.ref=0,this._iid=e,this._channel=t;const{logger:n,sdkState:i,dispatcher:a}=d.Vault.of(this._iid);var r,o;this._metadataKey=(r=i.userId,o=t.url,`sendbird:${r}@groupchannel/${o}/poll/changelogs.meta`);const l=((e,t)=>`sendbird:${e}@groupchannel/${t}/poll/changelogs`)(i.userId,this._channel.url);this._sync=new c.Sync(l,(()=>d.__awaiter(this,void 0,void 0,(function*(){var e;const t={hasNext:!0,nextToken:0};if(yield this.loadMetadata(),n.debug("poll changelog sync from",null===(e=this._metadata)||void 0===e?void 0:e.token),!(this._metadata&&this._metadata.token||(yield s()))){return{hasNext:!1,nextToken:0}}if(!this._metadata){const{firstConnectedAt:e}=d.Vault.of(this._iid);this._metadata={token:e}}try{const e=d.PollManager.of(this._iid),{hasMore:s,token:i}=yield e.getPollChangeLogs(this._channel.url,this._channel.channelType,this._metadata.token);t.hasNext=s,t.nextToken=i,this._metadata.token=i,n.debug("poll changelog sync progress",t),yield this.saveMetadata()}catch(e){throw n.debug("poll changelog sync error",e),e instanceof d.SendbirdError&&e.isInvalidTokenError&&(yield this.clearMetadata()),e}return t})))),this._connectionEventContext=a.on((e=>{if(e instanceof d.ConnectionStateChangeCommand)if(e.stateType===d.ConnectionStateType.CONNECTED)this.resume();else this.pause()}))}static of(e,t,s){return Le[e]||(Le[e]={}),Le[e][t.url]||(Le[e][t.url]=new we({_iid:e,channel:t,hasPollMessage:s})),Le[e][t.url].ref++,Le[e][t.url]}loadMetadata(){return d.__awaiter(this,void 0,void 0,(function*(){if(!this._metadata){const{cacheContext:e}=d.Vault.of(this._iid),t=yield e.preference.get(this._metadataKey);this._metadata=t?{token:t.token}:void 0}}))}saveMetadata(){return d.__awaiter(this,void 0,void 0,(function*(){if(this._metadata){const{cacheContext:e}=d.Vault.of(this._iid);yield e.preference.set(this._metadataKey,this._metadata)}}))}clearMetadata(){return d.__awaiter(this,void 0,void 0,(function*(){const{cacheContext:e}=d.Vault.of(this._iid);yield e.preference.remove(this._metadataKey),this._metadata=void 0}))}resume(){const{logger:e}=d.Vault.of(this._iid);e.debug("poll changelog sync resume()"),this._sync.start(0)}pause(){const{logger:e}=d.Vault.of(this._iid);e.debug("poll changelog sync pause()"),this._sync.stop()}close(){this.ref--,this.ref<=0&&(this.ref=0,this.pause(),this._connectionEventContext.close(),delete Le[this._iid][this._channel.url])}}class Fe extends d.APIRequestCommand{constructor(e){var t,s,n,i,a,r,o,l,h,c;super(),this.method=d.APIRequestMethod.GET,this.path=`${d.getChannelApiPathByType(e.channelType)}/${e.channelUrl}/messages_gap`,this.params=d.deundefined({prev_start_ts:e.prevStart,prev_end_ts:e.prevEnd,prev_cache_count:e.prevCount,next_start_ts:e.nextStart,next_end_ts:e.nextEnd,next_cache_count:e.nextCount,huge_gap_threshold:null!==(t=e.threshold)&&void 0!==t?t:null,reverse:!0,custom_types:null!==(s=e.customTypes)&&void 0!==s?s:["*"],message_type:null!==(n=e.messageType)&&void 0!==n?n:null,include_reply_type:null!==(i=e.replyType)&&void 0!==i?i:d.ReplyType.NONE,include_reactions_summary:null===(a=e.includeReactions)||void 0===a||a,include_meta_array:null===(r=e.includeMetaArray)||void 0===r||r,include_thread_info:null===(o=e.includeThreadInfo)||void 0===o||o,include_parent_message_info:null===(l=e.includeParentMessageInfo)||void 0===l||l,with_sorted_meta_array:null===(h=e.includeMetaArray)||void 0===h||h,show_subchannel_messages_only:null!==(c=e.showSubchannelMessagesOnly)&&void 0!==c&&c,include_poll_details:!0,checking_continuous_messages:e.checkingContinuousMessages})}}class De extends d.APIResponseCommand{constructor(e,t){var s,n,i,a,r,o;super(e,t),this.isHugeGap=t.is_huge_gap,this.prevMessages=(null!==(s=t.prev_messages)&&void 0!==s?s:[]).map((t=>h.parseMessagePayload(e,t))),this.prevHasMore=null!==(n=t.prev_hasmore)&&void 0!==n&&n,this.isContinuousPrevMessages=null!==(i=t.is_continuous_prev_messages)&&void 0!==i&&i,this.nextMessages=(null!==(a=t.next_messages)&&void 0!==a?a:[]).map((t=>h.parseMessagePayload(e,t))),this.nextHasmore=null!==(r=t.next_hasmore)&&void 0!==r&&r,this.isContinuousNextMessages=null!==(o=t.is_continuous_next_messages)&&void 0!==o&&o}}const ke={includeMetaArray:!0,includeReactions:!0,includeThreadInfo:!0,includeParentMessageInfo:!0};exports.MessageCollectionInitPolicy=void 0,(exports.MessageCollectionInitPolicy||(exports.MessageCollectionInitPolicy={})).CACHE_AND_REPLACE_BY_API="cache_and_replace_by_api";class He{constructor(){this._onCacheResult=d.noop,this._onApiResult=d.noop}_invokeResponse(e,t,s){d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){switch(e){case"local":this._onCacheResult(t,s);break;case"remote":this._onApiResult(t,s)}}))))}onCacheResult(e){return this._onCacheResult=e,this}onApiResult(e){return this._onApiResult=e,this}}class Ve{keyOf(e){return 0}get changelogIncludeParams(){return{includeReactions:!0,includeThreadInfo:!0,includeMetaArray:!0,includeParentMessageInfo:!0}}_postprocessChannelUpdateEvent(e,t){}_postprocessChannelRemoveEvent(e){}_postprocessMessageUpdateEvent(e,t){}_postprocessMessageRemoveEvent(e){}constructor(e,{filter:t,startingPoint:s,limit:n,prevResultLimit:i,nextResultLimit:a,channel:r,channelManager:o,disableBackgroundSync:l=!1}){this._messages=[],this._unsentMessages=[],this._isLoadingPrevious=!1,this._isLoadingNext=!1,this._iid=e,this._key=`mc-${d.uuid()}`,this._isDisposed=!1,this.filter=null!=t?t:new h.MessageFilter,this._channel=r,this._syncRange=new Ae({}),this._hasPrevious=!0,this._hasNext=!0,this._startingPoint="number"==typeof s&&Number.isFinite(s)?s:Number.MAX_SAFE_INTEGER,this._limit=n||h.DEFAULT_MESSAGE_LIMIT,this._prevResultLimit=null!=i?i:Math.floor(this._limit/2),this._nextResultLimit=null!=a?a:Math.floor(this._limit/2),this._channelManager=o;const{statManager:u}=d.Vault.of(this._iid);this._channelManager.subscribeChannelEvent(this._key,{onUpdate:(e,t)=>{const{source:s}=t,n=e.findIndex((e=>e.isIdentical(this.channel)));n>=0&&(this._replaceChannelOfCollection(e[n]),this.channel._runIfHandleableWithGroupChannel((e=>{switch(s){case d.CollectionEventSource.EVENT_CHANNEL_UPDATED:{let t=!1;for(let s=0;s<this._messages.length;s++){if(this._messages[s].createdAt>=e.messageOffsetTimestamp){t=!0;const e=s;if(e>0){const t=this._messages.splice(0,e);this._removeMessagesFromView(t.map((e=>this.keyOf(e))),d.CollectionEventSource.EVENT_MESSAGE_OFFSET_UPDATED)}break}}!t&&this._messages.length>0&&this._removeMessagesFromView(this._messages.map((e=>this.keyOf(e))),d.CollectionEventSource.EVENT_MESSAGE_OFFSET_UPDATED);break}case d.CollectionEventSource.EVENT_CHANNEL_UNMUTED:{const{sdkState:e}=d.Vault.of(this._iid),{user:s}=t;e.userId===s.userId&&this._clearCheckMyMutedTimer();break}case d.CollectionEventSource.EVENT_CHANNEL_MUTED:{const{sdkState:s}=d.Vault.of(this._iid),{user:n}=t;s.userId===n.userId&&-1!==e._myMutedRemainingTime&&this._startCheckMyMutedTimer(e._myMutedRemainingTime);break}case d.CollectionEventSource.EVENT_CHANNEL_LEFT:e.isPublic&&this._clearCheckMyMutedTimer()}d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e;x(s)&&(null===(e=this._handler)||void 0===e?void 0:e.onChannelUpdated)&&this._handler.onChannelUpdated(t,this.channel)}))))})),this._postprocessChannelUpdateEvent(e[n],s))},onRemove:(e,t)=>{const s=e.indexOf(this.channel.url);s>=0&&this._channel._runIfHandleableWithGroupChannel((n=>{n.myMemberState=exports.MemberState.NONE,this._clearCheckMyMutedTimer(),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e;(null===(e=this._handler)||void 0===e?void 0:e.onChannelDeleted)&&this._handler.onChannelDeleted(t,this.channel.url)})))),this._postprocessChannelRemoveEvent(e[s])}))}}),this._channelManager.subscribeMessageEvent(this._key,{onUpdate:(e,t)=>{const s=[],n=[];for(const t of e)t.channelUrl===this._channel.url&&(this.filter.match(t)?s.push(t):n.push(this.keyOf(t)));if(d.shouldGiveEvent(t)){if(s.length>0)switch(t){case d.CollectionEventSource.LOCAL_MESSAGE_CANCELED:case d.CollectionEventSource.LOCAL_MESSAGE_RESEND_STARTED:case d.CollectionEventSource.EVENT_MESSAGE_SENT_FAILED:case d.CollectionEventSource.EVENT_MESSAGE_SENT_SUCCESS:case d.CollectionEventSource.EVENT_MESSAGE_UPDATED:case d.CollectionEventSource.EVENT_MESSAGE_THREADINFO_UPDATED:case d.CollectionEventSource.EVENT_MESSAGE_REACTION_UPDATED:case d.CollectionEventSource.EVENT_MESSAGE_FEEDBACK_ADDED:case d.CollectionEventSource.EVENT_MESSAGE_FEEDBACK_UPDATED:case d.CollectionEventSource.EVENT_MESSAGE_FEEDBACK_DELETED:case d.CollectionEventSource.SYNC_MESSAGE_CHANGELOGS:this._updateMessagesToView(s,t);break;case d.CollectionEventSource.EVENT_MESSAGE_SENT_PENDING:this._addMessagesToView(s,t);break;case d.CollectionEventSource.EVENT_MESSAGE_RECEIVED:this.hasNext||this._addMessagesToView(s,t);break;case d.CollectionEventSource.SYNC_MESSAGE_FILL:this._addMessagesToView(s,t)}n.length>0&&this._removeMessagesFromView(n,t)}this._postprocessMessageUpdateEvent(e,t)},onRemove:(e,t)=>{this._removeMessagesFromView(e,t),this._postprocessMessageRemoveEvent(e)},onRemoveUnsent:(e,t)=>{this._removeUnsentMessageFromView(e,t)},onPollChangeLogUpdate:(e,t)=>{this._updatePollsToView(e,t)},onPollUpdate:(e,t)=>{this._applyPollUpdateEventToView(e,t)},onPollVote:(e,t)=>{this._applyPollVoteEventToView(e,t)},onReactionUpdate:(e,t)=>{this._applyReactionEventToView(e,t)},onThreadInfoUpdate:(e,t)=>{this._applyThreadInfoEventToView(e,t)},onDeletedByRetentionPolicy:(e,t,s)=>{t===this.channel.url&&this._messageRetention(e,s)}});const{cacheContext:_,dispatcher:p,messageBackgroundSyncThrottleController:m}=d.Vault.of(this._iid);this._channel._updateMessageCollectionLastAccessedAt(),p.dispatch(new P({channels:[this._channel],context:{source:d.CollectionEventSource.CHANNEL_LASTACCESSEDAT_UPDATED}})),this._backgroundSync=Pe.of(this._iid,this._channel),!l&&this._shouldStartBackgroundSync()&&this._backgroundSync.resume(this._startingPoint),this._changelogSync=Oe.of(this._iid,this._channel,this.changelogIncludeParams),this._changelogSync.resume(),this._pollChangelogSync=we.of(this._iid,this._channel,this._hasPollMessage.bind(this)),this._pollChangelogSync.resume(),this._prevFill=new c.Sync(this._key,(e=>d.__awaiter(this,void 0,void 0,(function*(){return yield m.run(`message-fill-sync-${r.url}-prev`,(()=>d.__awaiter(this,void 0,void 0,(function*(){var t,s,n;const{messages:i,isContinuousMessages:a}=yield this._getRemoteMessages(e,{prevLimit:this._prevResultLimit,source:d.CollectionEventSource.SYNC_MESSAGE_FILL,checkingContinuousMessages:_.localCacheEnabled,sdkSource:h.SDKSource.INTERNAL_FILL_GAP});if(i.length>0){const e=Math.min(...i.map((e=>e.createdAt)));return this._syncRange.extends(e),a&&(null===(t=this._backgroundSync)||void 0===t||t.range.extends(e)),{hasNext:i.length>=this._prevResultLimit&&this.viewTop<e,nextToken:this._syncRange.top}}return _.localCacheEnabled&&u.put(new d.StatLog({type:d.StatType.FEATURE_LOCALCACHE_EVENT,ts:Date.now(),data:{channel_url:this.channel.url,measured_on:"gap_check",event:"cache_fetch",max_db_size:null!==(n=null===(s=_.localCacheConfig)||void 0===s?void 0:s.maxSize)&&void 0!==n?n:0,use_local_cache:_.localCacheEnabled,starting_point:0,message_init_policy:""}})),{hasNext:!1,nextToken:0}}))))})))),this._nextFill=new c.Sync(this._key,(e=>d.__awaiter(this,void 0,void 0,(function*(){return yield m.run(`message-fill-sync-${r.url}-next`,(()=>d.__awaiter(this,void 0,void 0,(function*(){var t,s,n;const{messages:i,isContinuousMessages:a,hasNext:r}=yield this._getRemoteMessages(e,{nextLimit:this._nextResultLimit,source:d.CollectionEventSource.SYNC_MESSAGE_FILL,checkingHasNext:!0,checkingContinuousMessages:_.localCacheEnabled,sdkSource:h.SDKSource.INTERNAL_FILL_GAP});if(i.length>0){const e=Math.max(...i.map((e=>e.createdAt)));return this._syncRange.extends(e),a&&(null===(t=this._backgroundSync)||void 0===t||t.range.extends(e)),{hasNext:r,nextToken:this._syncRange.bottom}}return _.localCacheEnabled&&u.put(new d.StatLog({type:d.StatType.FEATURE_LOCALCACHE_EVENT,ts:Date.now(),data:{channel_url:this.channel.url,measured_on:"gap_check",event:"cache_fetch",max_db_size:null!==(n=null===(s=_.localCacheConfig)||void 0===s?void 0:s.maxSize)&&void 0!==n?n:0,use_local_cache:_.localCacheEnabled,starting_point:0,message_init_policy:""}})),{hasNext:!1,nextToken:0}}))))})))),this._connectionEventContext=p.on((e=>{if(e instanceof d.ConnectionStateChangeCommand)switch(e.stateType){case d.ConnectionStateType.CONNECTED:d.runOrNothing((()=>d.__awaiter(this,void 0,void 0,(function*(){this._activate()}))));break;case d.ConnectionStateType.LOGOUT:this.dispose();break;default:this._clearCheckMyMutedTimer(),this._prevFill.stop(),this._nextFill.stop()}}))}get channel(){return this._channel}get succeededMessages(){return[...this._messages]}get failedMessages(){return this._unsentMessages.filter((e=>e.sendingStatus===d.SendingStatus.FAILED))}get pendingMessages(){return this._unsentMessages.filter((e=>e.sendingStatus===d.SendingStatus.PENDING))}get hasPrevious(){return this._hasPrevious}get hasNext(){return this._hasNext}get viewTop(){return Math.min(...this._messages.map((e=>e.createdAt)),Number.MAX_SAFE_INTEGER)}get viewBottom(){return Math.max(...this._messages.map((e=>e.createdAt)),0)}_activate(){return d.__awaiter(this,void 0,void 0,(function*(){const{logger:e}=d.Vault.of(this._iid);e.debug("check huge gap"),this._checkHugeGap(),yield this._refreshChannel(d.CollectionEventSource.SYNC_CHANNEL_CHANGELOGS)}))}_replaceChannelOfCollection(e){this._channel.isGroupChannel()?this._channel=e:this._channel.isFeedChannel()&&(this._channel._groupChannel=e._groupChannel)}_shouldStartBackgroundSync(){const{cacheContext:e}=d.Vault.of(this._iid);return this.channel.isGroupChannel()?e.localCacheEnabled&&!this.channel.isSuper:e.localCacheEnabled}_setBaseMessageCollectionHandler(e){this._handler=e}_filterUnderOffsetMessage(e){return e}_updateChildMessagesInView(e){const t=[];return this._messages.forEach((s=>{s instanceof h.BaseMessage&&s.parentMessageId===e.messageId&&s.applyParentMessage(e)&&t.push(s)})),t}_updatePollsToView(e,t){const s=[];for(const t of e){const e=Ue(this._messages,t.messageId);if(e>=0){const n=this._messages[e];n.isUserMessage()&&n.applyPoll(t),s.push(n)}}return s.length>0&&d.shouldGiveEvent(t)&&d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e,n;const i={source:t};s.length>0&&(null===(n=(e=this._handler).onMessagesUpdated)||void 0===n||n.call(e,i,this.channel,s))})))),s}_applyPollUpdateEventToView(e,t){const s=Ue(this._messages,e.messageId);if(s>=0){const n=this._messages[s];n&&n.isUserMessage()&&n.poll&&n.poll.applyPollUpdateEvent(e)&&d.shouldGiveEvent(t)&&d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e,s;const i={source:t};null===(s=null===(e=this._handler)||void 0===e?void 0:e.onMessagesUpdated)||void 0===s||s.call(e,i,this.channel,[n])}))))}}_applyPollVoteEventToView(e,t){const s=Ue(this._messages,e.messageId);if(s>=0){const n=this._messages[s];n&&n.isUserMessage()&&n.poll&&n.poll.applyPollVoteEvent(e)&&d.shouldGiveEvent(t)&&d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e,s;const i={source:t};null===(s=null===(e=this._handler)||void 0===e?void 0:e.onMessagesUpdated)||void 0===s||s.call(e,i,this.channel,[n])}))))}}_applyReactionEventToView(e,t){const s=Ue(this._messages,e.messageId);if(s>=0){const n=this._messages[s];n&&(n.isUserMessage()||n.isFileMessage()||n.isMultipleFilesMessage())&&d.shouldGiveEvent(t)&&(n.applyReactionEvent(e),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e,s;const i={source:t};null===(s=null===(e=this._handler)||void 0===e?void 0:e.onMessagesUpdated)||void 0===s||s.call(e,i,this.channel,[n])})))))}}_applyThreadInfoEventToView(e,t){const s=Ue(this._messages,e.targetMessageId);if(s>=0){const n=this._messages[s];n&&(n.isUserMessage()||n.isFileMessage()||n.isMultipleFilesMessage())&&d.shouldGiveEvent(t)&&(n.applyThreadInfoUpdateEvent(e),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e,s;const i={source:t};null===(s=null===(e=this._handler)||void 0===e?void 0:e.onMessagesUpdated)||void 0===s||s.call(e,i,this.channel,[n])})))))}}_removeMessagesFromView(e,t){const s=[],n=[];for(const t of e){const e=this._messages.findIndex((e=>this.keyOf(e)===t));if(e>=0){const t=this._messages[e];s.push(this.keyOf(t)),n.push(t),this._messages.splice(e,1)}}return d.shouldGiveEvent(t)&&n.length>0&&d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e,i;const a={source:t};null===(i=null===(e=this._handler)||void 0===e?void 0:e.onMessagesDeleted)||void 0===i||i.call(e,a,this.channel,s,n)})))),s}_messageRetention(e,t){const s=[];for(const t of this._messages)t.createdAt<=e&&s.push(this.keyOf(t));s.length>0&&this._removeMessagesFromView(s,t)}_removeUnsentMessageFromView(e,t){const s=this._unsentMessages.findIndex((t=>t.reqId===e));s>=0&&this._unsentMessages.splice(s,1)}_getLocalMessages(e,{prevLimit:t=0,nextLimit:s=0,inclusive:n=!0}){return d.__awaiter(this,void 0,void 0,(function*(){let i=[];n&&(i=yield this._channelManager.getExactlyMatchingMessagesForTokenFromCache(this._channel.url,e,this.filter));const a=t>0?yield this._channelManager.getMessagesFromCache(this._channel.url,e,"prev",this.filter,t,!1):[],r=s>0?yield this._channelManager.getMessagesFromCache(this._channel.url,e,"next",this.filter,s,!1):[];return{messages:[...i,...a,...r].sort(((e,t)=>t.createdAt-e.createdAt)),prevMessagesCount:a.length,nextMessagesCount:r.length}}))}_getRemoteMessages(e,{prevLimit:t=0,nextLimit:s=0,source:n=d.CollectionEventSource.REQUEST_MESSAGE,reverse:i=!1,checkingHasNext:a=!1,checkingContinuousMessages:r=!1,sdkSource:o}){return d.__awaiter(this,void 0,void 0,(function*(){const l=h.MessageManager.of(this._iid);return t>0||s>0?yield l._getMessagesByTimestampForCollection(this._channel.url,this._channel.channelType,e,d.undefineNullProps(Object.assign(Object.assign(Object.assign({},this.filter),ke),{isInclusive:!0,reverse:i,prevResultSize:t,nextResultSize:s})),n,a,r,o):{messages:[],isContinuousMessages:!1}}))}_checkHugeGap(){var e,t,s,n,i;return d.__awaiter(this,void 0,void 0,(function*(){const{dispatcher:a,requestQueue:r,cacheContext:o,statManager:l,logger:c}=d.Vault.of(this._iid);if(this._messages.length>0){const s=this._syncRange.top,n=this.viewTop,i=this._syncRange.bottom,h=this.hasNext?this.viewBottom:Number.MAX_SAFE_INTEGER,u=yield this._channelManager.getCachedMessageCountBetween(this._channel.url,this.filter,n,s),_=yield this._channelManager.getCachedMessageCountBetween(this._channel.url,this.filter,i,h);try{yield d.asyncRetry((()=>d.__awaiter(this,void 0,void 0,(function*(){var e;const t=new Fe(Object.assign(Object.assign({channelUrl:this._channel.url,channelType:this._channel.channelType,prevStart:n,prevEnd:s,prevCount:u,nextStart:i,nextEnd:h,nextCount:_,checkingContinuousMessages:o.localCacheEnabled},this.filter),ke)),l=yield r.send(t),{isHugeGap:c,prevMessages:p=[],prevHasMore:m,isContinuousPrevMessages:g,nextMessages:C=[],nextHasmore:E,isContinuousNextMessages:v}=l.as(De);if(c)d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e;(null===(e=this._handler)||void 0===e?void 0:e.onHugeGapDetected)&&this._handler.onHugeGapDetected()}))));else{const t=this.viewTop,s=this.viewBottom,n=Math.min(Number.MAX_SAFE_INTEGER,t,...p.map((e=>e.createdAt))),i=Math.max(0,s,...C.map((e=>e.createdAt)));a.dispatch(new d.MessageUpdateEventCommand({messages:p,source:d.CollectionEventSource.SYNC_MESSAGE_FILL})),a.dispatch(new d.MessageUpdateEventCommand({messages:C,source:d.CollectionEventSource.SYNC_MESSAGE_FILL})),this._syncRange.extends(n,i),(g||v)&&(null===(e=this._backgroundSync)||void 0===e||e.range.extends(n,i)),m&&this._prevFill.start(n),E&&this._nextFill.start(i)}}))),1)}catch(e){c.debug("Failed HugeGap Check ",e)}finally{o.localCacheEnabled&&l.put(new d.StatLog({type:d.StatType.FEATURE_LOCALCACHE_EVENT,ts:Date.now(),data:{channel_url:this.channel.url,measured_on:"gap_check",event:"cache_fetch",max_db_size:null!==(t=null===(e=o.localCacheConfig)||void 0===e?void 0:e.maxSize)&&void 0!==t?t:0,use_local_cache:o.localCacheEnabled,starting_point:0,message_init_policy:""}}))}}else{const e=Date.now();try{const{messages:t,isContinuousMessages:n,hasNext:i}=yield this._getRemoteMessages(e,{prevLimit:this._prevResultLimit,nextLimit:this._nextResultLimit,source:d.CollectionEventSource.SYNC_MESSAGE_FILL,checkingHasNext:!0,checkingContinuousMessages:o.localCacheEnabled,sdkSource:h.SDKSource.INTERNAL_FILL_GAP});if(t.length>0){const a=t.map((e=>e.createdAt));let r=0,o=0;for(let t=0;t<a.length;t++){const s=a[t];s<=e?r++:s>=e&&o++}this._hasPrevious=r>=this._prevResultLimit,this._hasNext=null!=i?i:o>=this._nextResultLimit,this._syncRange.extends(...a),n&&(null===(s=this._backgroundSync)||void 0===s||s.range.extends(this._syncRange.top,this._syncRange.bottom)),this._addMessagesToView(t,d.CollectionEventSource.SYNC_MESSAGE_FILL)}else this._hasPrevious=!1,this._hasNext=!1}catch(e){e instanceof d.SendbirdError&&e.code===d.SendbirdErrorCode.NOT_FOUND_IN_DATABASE&&(this._hasPrevious=!1,this._hasNext=!1)}finally{o.localCacheEnabled&&l.put(new d.StatLog({type:d.StatType.FEATURE_LOCALCACHE_EVENT,ts:Date.now(),data:{channel_url:this.channel.url,measured_on:"gap_check",event:"cache_fetch",max_db_size:null!==(i=null===(n=o.localCacheConfig)||void 0===n?void 0:n.maxSize)&&void 0!==i?i:0,use_local_cache:o.localCacheEnabled,starting_point:0,message_init_policy:""}}))}}}))}_loadUnsentMessages(){return d.__awaiter(this,void 0,void 0,(function*(){this._unsentMessages=yield this._channelManager.getUnsentMessagesFromCache(this._channel.url,this.filter)}))}_hasPollMessage(){return d.__awaiter(this,void 0,void 0,(function*(){return(yield this._channelManager.getPollMessagesFromCache(this._channel.url,Date.now()+6e5,this.filter,1)).length>0}))}_refreshChannel(e,t=!1){return d.__awaiter(this,void 0,void 0,(function*(){const{logger:s}=d.Vault.of(this._iid);try{yield this._channelManager.refreshChannel(this.channel.url,!0,e,t),this.channel._runIfHandleableWithGroupChannel((e=>{e.myMutedState===d.MutedState.MUTED&&d.runOrNothing((()=>d.__awaiter(this,void 0,void 0,(function*(){const e=yield this.channel.getMyMutedInfo();e.isMuted&&-1!==e.remainingDuration&&this._startCheckMyMutedTimer(e.remainingDuration)}))))}))}catch(e){s.warn("Failed to refresh channel",e)}}))}_startCheckMyMutedTimer(e){this._clearCheckMyMutedTimer(),this._checkMyMutedStateTimer=setTimeout((()=>d.__awaiter(this,void 0,void 0,(function*(){this._checkMyMutedStateTimer=void 0;let e=!0;try{e=!(yield this._channel.getMyMutedInfo()).isMuted}catch(t){e=!0}finally{if(e){const{sessionManager:e}=d.Vault.of(this._iid);this.channel._runIfHandleableWithGroupChannel((t=>{var s,n;t.myMutedState=d.MutedState.UNMUTED;const i={source:d.CollectionEventSource.EVENT_CHANNEL_UNMUTED,user:e.currentUser};null===(n=null===(s=this._handler)||void 0===s?void 0:s.onChannelUpdated)||void 0===n||n.call(s,i,this.channel)}))}}}))),e+1e3)}_clearCheckMyMutedTimer(){this._checkMyMutedStateTimer&&(clearTimeout(this._checkMyMutedStateTimer),this._checkMyMutedStateTimer=void 0)}_setHasNextAndHasPrevious(e,t){const s=e.map((e=>e.createdAt));let n=0,i=0;for(let e=0;e<s.length;e++){const t=s[e];t<this._startingPoint?n++:t>this._startingPoint&&i++}this._hasPrevious=n>=this._prevResultLimit,this._hasNext=null!=t?t:i>=this._nextResultLimit}initialize(e){const t=new He;this._messages=[],this._unsentMessages=[],this._syncRange=new Ae({}),this._hasNext=!0,this._hasPrevious=!0;let s=[],n={messages:[],prevMessagesCount:0,nextMessagesCount:0};return d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var i;const a=yield null===(i=this._backgroundSync)||void 0===i?void 0:i.loadMetadata(),{cacheContext:r,statManager:o}=d.Vault.of(this._iid);if(e===exports.MessageCollectionInitPolicy.CACHE_AND_REPLACE_BY_API)this._getLocalMessages(this._startingPoint,{prevLimit:this._prevResultLimit,nextLimit:this._nextResultLimit}).then((e=>d.__awaiter(this,void 0,void 0,(function*(){n=e,s=this._filterUnderOffsetMessage(n.messages),this._addMessagesToView(s,d.CollectionEventSource.REQUEST_MESSAGE),yield this._loadUnsentMessages(),t._invokeResponse("local",null,s)})))).catch((e=>{if(d.isThrowingOutside(e))throw e;t._invokeResponse("local",e,null)})).finally((()=>d.__awaiter(this,void 0,void 0,(function*(){var i,r;const{cacheContext:l}=d.Vault.of(this._iid);let c=!0,u=!0,_=!1;l.localCacheEnabled&&s.length>0&&a.range.includes(...s.map((e=>e.createdAt)))&&(!a.previousComplete&&n.prevMessagesCount<this._prevResultLimit?u=!0:this._startingPoint>a.range.bottom||n.nextMessagesCount<this._nextResultLimit?_=!0:u=!1),yield this._refreshChannel(d.CollectionEventSource.REFRESH_CHANNEL,_),_&&this._channel._runIfHandleableWithGroupChannel((e=>{const t=Math.max(...s.map((e=>e.createdAt)));e._latestMessageInfo&&t>=e._latestMessageInfo.createdAt&&(u=!1)})),u?(c=!1,this._getRemoteMessages(this._startingPoint,{prevLimit:this._prevResultLimit,nextLimit:this._nextResultLimit,reverse:!0,checkingHasNext:!0,checkingContinuousMessages:l.localCacheEnabled,sdkSource:h.SDKSource.EXTERNAL_COLLECTION}).then((({messages:e,isContinuousMessages:s,hasNext:n})=>{var i,a;const r=this._filterUnderOffsetMessage(e);this._messages=[],r.length>0?(this._setHasNextAndHasPrevious(r,n),this._syncRange.extends(...r.map((e=>e.createdAt))),s&&(null===(i=this._backgroundSync)||void 0===i?void 0:i.range.overlap(this._syncRange))&&(null===(a=this._backgroundSync)||void 0===a||a.range.extends(this._syncRange.top,this._syncRange.bottom)),this._addMessagesToView(r,d.CollectionEventSource.REQUEST_MESSAGE)):(this._hasPrevious=!1,this._hasNext=!1),t._invokeResponse("remote",null,r)})).catch((e=>{if(d.isThrowingOutside(e))throw e;t._invokeResponse("remote",e,null)}))):(this._setHasNextAndHasPrevious(s),t._invokeResponse("remote",null,s)),l.localCacheEnabled&&o.put(new d.StatLog({type:d.StatType.FEATURE_LOCALCACHE_EVENT,ts:Date.now(),data:{channel_url:this.channel.url,starting_point:this._startingPoint,measured_on:"initial_load",event:c?"cache_hit":"cache_miss",max_db_size:null!==(r=null===(i=l.localCacheConfig)||void 0===i?void 0:i.maxSize)&&void 0!==r?r:0,message_init_policy:e,use_local_cache:l.localCacheEnabled,collection_id:this._key}}))}))));o.put(new d.DailyRecordStatLog({type:d.StatType.FEATURE_LOCALCACHE,data:{use_local_cache:r.localCacheEnabled,collection_interface:{message_init_policy:e,message:!0}}}))})))),t}loadPrevious(){var e,t,s;return d.__awaiter(this,void 0,void 0,(function*(){if(this._isDisposed)throw new d.SendbirdError({code:d.SendbirdErrorCode.COLLECTION_DISPOSED,message:"Collection has been disposed."});const{cacheContext:n,statManager:i,logger:a}=d.Vault.of(this._iid);if(!this._hasPrevious)return[];if(this._isLoadingPrevious)return a.warn("Messages are already fetching."),[];this._isLoadingPrevious=!0;const r=this.viewTop;let o=[];yield d.runOrNothing((()=>d.__awaiter(this,void 0,void 0,(function*(){const e=yield this._getLocalMessages(r,{prevLimit:this._prevResultLimit,inclusive:!1});o=this._filterUnderOffsetMessage(e.messages)}))));const l=o.length>=this._prevResultLimit;if(n.localCacheEnabled&&i.put(new d.StatLog({type:d.StatType.FEATURE_LOCALCACHE_EVENT,ts:Date.now(),data:{channel_url:this.channel.url,starting_point:this._startingPoint,measured_on:"load_prev",event:l?"cache_hit":"cache_miss",max_db_size:null!==(t=null===(e=n.localCacheConfig)||void 0===e?void 0:e.maxSize)&&void 0!==t?t:0,use_local_cache:n.localCacheEnabled,collection_id:this._key,message_init_policy:""}})),l&&(null===(s=this._backgroundSync)||void 0===s?void 0:s.isWrappingMessages(o)))this._hasPrevious=o.length>=this._prevResultLimit,o.length>0&&this._addMessagesToView(o,d.CollectionEventSource.REQUEST_MESSAGE);else{let e=!1;yield d.runOrNothing((()=>d.__awaiter(this,void 0,void 0,(function*(){var t,s,n,a;const{cacheContext:l}=d.Vault.of(this._iid),c=yield this._getRemoteMessages(r,{prevLimit:this._prevResultLimit,reverse:!0,checkingContinuousMessages:l.localCacheEnabled,sdkSource:h.SDKSource.EXTERNAL_COLLECTION});o=this._filterUnderOffsetMessage(c.messages),o.length>0&&(this._syncRange.extends(...o.map((e=>e.createdAt))),(null===(t=this._backgroundSync)||void 0===t?void 0:t.range.overlap(this._syncRange))&&c.isContinuousMessages&&(e=!0,null===(s=this._backgroundSync)||void 0===s||s.range.extends(this._syncRange.top))),o=o.filter((e=>Te(this._messages,e)<0)),this._hasPrevious=o.length>=this._prevResultLimit,e&&i.put(new d.StatLog({type:d.StatType.FEATURE_LOCALCACHE_EVENT,ts:Date.now(),data:{channel_url:this.channel.url,starting_point:this._startingPoint,measured_on:"load_prev",event:"cache_fetch",max_db_size:null!==(a=null===(n=l.localCacheConfig)||void 0===n?void 0:n.maxSize)&&void 0!==a?a:0,use_local_cache:l.localCacheEnabled,collection_id:this._key,message_init_policy:""}}))})))),this._addMessagesToView(o,d.CollectionEventSource.REQUEST_MESSAGE)}return this._isLoadingPrevious=!1,o}))}loadNext(){var e,t,s;return d.__awaiter(this,void 0,void 0,(function*(){if(this._isDisposed)throw new d.SendbirdError({code:d.SendbirdErrorCode.COLLECTION_DISPOSED,message:"Collection has been disposed."});const{cacheContext:n,statManager:i,logger:a}=d.Vault.of(this._iid);if(!this._hasNext)return[];if(this._isLoadingNext)return a.warn("Messages are already fetching."),[];this._isLoadingNext=!0;const r=this.viewBottom;let o=[];yield d.runOrNothing((()=>d.__awaiter(this,void 0,void 0,(function*(){const e=yield this._getLocalMessages(r,{nextLimit:this._nextResultLimit,inclusive:!1});o=this._filterUnderOffsetMessage(e.messages)}))));const l=o.length>=this._nextResultLimit;if(n.localCacheEnabled&&i.put(new d.StatLog({type:d.StatType.FEATURE_LOCALCACHE_EVENT,ts:Date.now(),data:{channel_url:this.channel.url,starting_point:this._startingPoint,measured_on:"load_next",event:l?"cache_hit":"cache_miss",max_db_size:null!==(t=null===(e=n.localCacheConfig)||void 0===e?void 0:e.maxSize)&&void 0!==t?t:0,use_local_cache:n.localCacheEnabled,collection_id:this._key,message_init_policy:""}})),l&&(null===(s=this._backgroundSync)||void 0===s?void 0:s.isWrappingMessages(o)))this._hasNext=o.length>=this._nextResultLimit,o.length>0&&this._addMessagesToView(o,d.CollectionEventSource.REQUEST_MESSAGE);else{let e=!1;yield d.runOrNothing((()=>d.__awaiter(this,void 0,void 0,(function*(){var t,s,n,a,l;const{cacheContext:c}=d.Vault.of(this._iid),u=yield this._getRemoteMessages(r,{nextLimit:this._nextResultLimit,reverse:!0,checkingHasNext:!0,checkingContinuousMessages:c.localCacheEnabled,sdkSource:h.SDKSource.EXTERNAL_COLLECTION});o=this._filterUnderOffsetMessage(u.messages),o.length>0&&(this._syncRange.extends(...o.map((e=>e.createdAt))),(null===(t=this._backgroundSync)||void 0===t?void 0:t.range.overlap(this._syncRange))&&u.isContinuousMessages&&(e=!0,null===(s=this._backgroundSync)||void 0===s||s.range.extends(this._syncRange.bottom))),o=o.filter((e=>Te(this._messages,e)<0)),this._hasNext=null!==(n=u.hasNext)&&void 0!==n?n:o.length>=this._nextResultLimit,e&&i.put(new d.StatLog({type:d.StatType.FEATURE_LOCALCACHE_EVENT,ts:Date.now(),data:{channel_url:this.channel.url,starting_point:this._startingPoint,measured_on:"load_next",event:"cache_fetch",max_db_size:null!==(l=null===(a=c.localCacheConfig)||void 0===a?void 0:a.maxSize)&&void 0!==l?l:0,use_local_cache:c.localCacheEnabled,collection_id:this._key,message_init_policy:""}}))})))),this._addMessagesToView(o,d.CollectionEventSource.REQUEST_MESSAGE)}return this._isLoadingNext=!1,o}))}removeFailedMessage(e){return d.__awaiter(this,void 0,void 0,(function*(){if(this._isDisposed)throw new d.SendbirdError({code:d.SendbirdErrorCode.COLLECTION_DISPOSED,message:"Collection has been disposed."});yield this._channelManager.removeFailedMessageFromCache(e);const t=this._unsentMessages.findIndex((t=>t.reqId===e));t>-1&&this._unsentMessages.splice(t,1)}))}dispose(){var e,t,s;if(this._isDisposed)return;this._isDisposed=!0;const{cacheContext:n,dispatcher:i}=d.Vault.of(this._iid);this._messages=[],this._clearCheckMyMutedTimer(),this._channel._runIfHandleableWithGroupChannel((e=>{e.myMemberState!==exports.MemberState.NONE&&(this._channel._updateMessageCollectionLastAccessedAt(),i.dispatch(new P({channels:[this._channel],context:{source:d.CollectionEventSource.CHANNEL_LASTACCESSEDAT_UPDATED}})))})),n.localCacheEnabled&&(this._prevFill.stop(),this._nextFill.stop()),null===(e=this._backgroundSync)||void 0===e||e.close(),null===(t=this._changelogSync)||void 0===t||t.close(),null===(s=this._pollChangelogSync)||void 0===s||s.close(),this._channelManager.unsubscribeChannelEvent(this._key),this._channelManager.unsubscribeMessageEvent(this._key),this._connectionEventContext&&this._connectionEventContext.close()}}class Ge extends Ve{keyOf(e){return e.messageId}constructor(e,t){super(e,Object.assign(Object.assign({},t),{channelManager:Ne.of(e)}))}initialize(e){return super.initialize(e)}setMessageCollectionHandler(e){this._setBaseMessageCollectionHandler(e)}_addMessagesToView(e,t){const s=this._filterUnderOffsetMessage(e),n=[],i=[];for(const e of s)if(t===d.CollectionEventSource.SYNC_MESSAGE_FILL){if(e.messageId>0){if(Te(this._messages,e)<0){Te(this._unsentMessages,e)<0&&n.push(e);const t=Ie(this._messages,e);this._messages.splice(t,0,e)}}else if(e instanceof h.SendableMessage){Te(this._unsentMessages,e)<0&&Te(this._messages,e)<0&&(this._unsentMessages.push(e),n.push(e))}}else if(e.messageId>0){const t=Te(this._messages,e);if(t<0){const t=Te(this._unsentMessages,e);t<0?n.push(e):(this._unsentMessages.splice(t,1),i.push(e));const s=Ie(this._messages,e);this._messages.splice(s,0,e)}else i.push(e),this._messages[t]=e;if(e.updatedAt>0){const t=this._updateChildMessagesInView(e);i.push(...t)}}else if(e instanceof h.SendableMessage){const t=Te(this._unsentMessages,e);t<0?Te(this._messages,e)<0&&(this._unsentMessages.push(e),n.push(e)):(i.push(e),this._unsentMessages[t]=e)}d.shouldGiveEvent(t)&&d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e,s,a,r;const o={source:t};n.length>0&&(null===(s=null===(e=this._handler)||void 0===e?void 0:e.onMessagesAdded)||void 0===s||s.call(e,o,this.channel,n)),i.length>0&&(null===(r=null===(a=this._handler)||void 0===a?void 0:a.onMessagesUpdated)||void 0===r||r.call(a,o,this.channel,i))}))))}_updateMessagesToView(e,t){const s=[],n=[],i=[];for(const t of e)if(t.messageId>0){const e=Te(this._messages,t);if(e>=0)n.push(t),this._messages[e]=t;else{const e=Te(this._unsentMessages,t);if(e>=0){const[s]=this._unsentMessages.splice(e,1);if(this.hasNext&&s)i.push(s);else{n.push(t);const e=Ie(this._messages,t);this._messages.splice(e,0,t)}}else{const e=this._messages.map((e=>e.createdAt));(t.createdAt<Math.min(...e)&&!this._hasPrevious||t.createdAt>Math.max(...e)&&!this._hasNext)&&s.push(t)}}}else if(t instanceof h.SendableMessage){const e=Te(this._unsentMessages,t);e>=0&&(n.push(t),this._unsentMessages[e]=t)}return d.shouldGiveEvent(t)&&d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e,a,r,o;const l={source:t};n.length>0?null===(a=null===(e=this._handler)||void 0===e?void 0:e.onMessagesUpdated)||void 0===a||a.call(e,l,this.channel,n):i.length>0?null===(o=null===(r=this._handler)||void 0===r?void 0:r.onMessagesDeleted)||void 0===o||o.call(r,l,this.channel,[],i):s.length>0&&this._addMessagesToView(s,t)})))),n}}const qe={coverUrl:void 0,coverImage:void 0,isDistinct:void 0,isPublic:void 0,isDiscoverable:void 0,accessCode:void 0,name:void 0,data:void 0,customType:void 0,operatorUserIds:void 0,messageSurvivalSeconds:void 0};class Be extends d.APIRequestCommand{constructor(e){const{channelUrl:t,token:s,limit:n,order:i,mutedMemberFilter:a,memberStateFilter:r,nicknameStartsWithFilter:o,operatorFilter:l}=e;super(),this.method=d.APIRequestMethod.GET,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/members`,this.params={token:s,limit:n,order:i,muted_member_filter:a,member_state_filter:r,nickname_startswith:o,operator_filter:l,show_member_is_muted:!0,show_read_receipt:!0,show_delivery_receipt:!0}}}class je extends d.APIResponseCommand{constructor(e,t){super(e,t),this.members=[];const{next:s,members:n}=t;this.token=s,n&&n.length>0&&(this.members=n.map((t=>new p(e,t))))}}var ze,We,$e;exports.MutedMemberFilter=void 0,(ze=exports.MutedMemberFilter||(exports.MutedMemberFilter={})).ALL="all",ze.MUTED="muted",ze.UNMUTED="unmuted",exports.MemberListOrder=void 0,(We=exports.MemberListOrder||(exports.MemberListOrder={})).MEMBER_NICKNAME_ALPHABETICAL="member_nickname_alphabetical",We.OPERATOR_THEN_MEMBER_ALPHABETICAL="operator_then_member_alphabetical",exports.MemberStateFilter=void 0,($e=exports.MemberStateFilter||(exports.MemberStateFilter={})).ALL="all",$e.JOINED="joined_only",$e.INVITED="invited_only",$e.INVITED_BY_FRIEND="invited_by_friend",$e.INVITED_BY_NON_FRIEND="invited_by_non_friend";class Ke extends d.ChannelDataListQuery{constructor(e,t,s){var n,i,a,r;super(e,t,d.ChannelType.GROUP,s),this.mutedMemberFilter=exports.MutedMemberFilter.ALL,this.memberStateFilter=exports.MemberStateFilter.ALL,this.nicknameStartsWithFilter=null,this.operatorFilter=exports.OperatorFilter.ALL,this.order=exports.MemberListOrder.MEMBER_NICKNAME_ALPHABETICAL,this.mutedMemberFilter=null!==(n=s.mutedMemberFilter)&&void 0!==n?n:exports.MutedMemberFilter.ALL,this.memberStateFilter=null!==(i=s.memberStateFilter)&&void 0!==i?i:exports.MemberStateFilter.ALL,this.nicknameStartsWithFilter=null!==(a=s.nicknameStartsWithFilter)&&void 0!==a?a:null,this.order=null!==(r=s.order)&&void 0!==r?r:exports.MemberListOrder.MEMBER_NICKNAME_ALPHABETICAL}_validate(){return super._validate()&&d.isEnumOf(exports.MutedMemberFilter,this.mutedMemberFilter)&&d.isEnumOf(exports.MemberStateFilter,this.memberStateFilter)&&(d.isTypeOf("string",this.nicknameStartsWithFilter)||null===this.nicknameStartsWithFilter)&&d.isEnumOf(exports.OperatorFilter,this.operatorFilter)&&d.isEnumOf(exports.MemberListOrder,this.order)}next(){return d.__awaiter(this,void 0,void 0,(function*(){if(this._validate()){if(this._isLoading)throw d.SendbirdError.queryInProgress;if(this._hasNext){this._isLoading=!0;const{requestQueue:e}=d.Vault.of(this._iid),t=new Be(d.undefineNullProps(Object.assign(Object.assign({},this),{token:this._token}))),s=yield e.send(t),{members:n,token:i}=s.as(je);return this._token=i,this._hasNext=!!i,this._isLoading=!1,n}return[]}throw d.SendbirdError.invalidParameters}))}}class Qe extends d.APIRequestCommand{constructor(e){const{channelUrl:t,userId:s,accessCode:n}=e;super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/accept`,this.params={user_id:s,access_code:n}}}class Ye extends d.APIResponseCommand{constructor(e,t){super(e,t),this.channel=new ft(e,t),this.channel.myMemberState=exports.MemberState.JOINED}}class Je extends d.APIRequestCommand{constructor(e){const{channelUrl:t,isDistinct:s,isPublic:n,isDiscoverable:i,coverUrl:a,coverImage:r,accessCode:o,name:l,data:h,customType:c,operatorUserIds:u,messageSurvivalSeconds:_}=e;super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}`,this.params=d.deundefined({is_distinct:s,is_public:n,is_discoverable:i,name:l,data:h,custom_type:c,cover_url:a,cover_file:r,access_code:o,operator_ids:u,message_survival_seconds:_})}}class Xe extends d.APIResponseCommand{constructor(e,t){super(e,t),this.channel=new ft(e,t)}}class Ze extends d.APIRequestCommand{constructor(e){const{channelUrl:t}=e;super(),this.method=d.APIRequestMethod.DELETE,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}`}}class et extends d.APIRequestCommand{constructor(e){const{channelUrl:t}=e;super(),this.method=d.APIRequestMethod.DELETE,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/hide`}}class tt extends d.APIRequestCommand{constructor({userId:e,channelUrl:t,countPreference:s}){super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(e)}/count_preference/${encodeURIComponent(t)}`,this.params={count_preference:s}}}class st extends d.APIResponseCommand{constructor(e,t){super(e,t),this.countPreference=t.count_preference}}class nt extends d.APIRequestCommand{constructor(e){const{channelUrl:t,locale:s}=e;super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/reset_user_history`,this.params=d.deundefined({locale:s})}}class it extends d.APIResponseCommand{constructor(e,t){super(e,t);const{ts_message_offset:s}=t;this.messageOffsetTimestamp=s}}const at=Object.assign(Object.assign({},h.BaseMessageUpdateParamsDefault),{scheduledAt:void 0,file:void 0,fileUrl:void 0,fileName:void 0,mimeType:void 0,fileSize:void 0,thumbnailSizes:void 0,requireAuth:!1}),rt=Object.assign(Object.assign({},h.UserMessageUpdateParamsDefault),{scheduledAt:void 0});class ot extends d.APIRequestCommand{constructor(e){var t,s;super();let n=[];e.mentionType===d.MentionType.USERS&&(e.mentionedUserIds?n=e.mentionedUserIds:e.mentionedUsers&&(n=e.mentionedUsers.map((e=>e.userId))));const{channelType:i,channelUrl:a,scheduledMessageId:r}=e;this.method=d.APIRequestMethod.PUT,this.path=`${d.getChannelApiPathByType(i)}/${encodeURIComponent(a)}/scheduled_messages/${encodeURIComponent(r)}`,this.params=d.deundefined(d.undefineNullProps({req_id:e.reqId,scheduled_at:e.scheduledAt,message_type:d.ServerSideMessageType.FILE,url:e.fileUrl,file_name:e.fileName,file_size:e.fileSize,file_type:e.mimeType,thumbnails:null===(t=e._thumbnails)||void 0===t?void 0:t.map((e=>h.Thumbnail.payloadify(e))),custom_type:e.customType,data:e.data,require_auth:e.requireAuth,mention_type:e.mentionType,mentioned_user_ids:n,sorted_metaarray:null===(s=e.metaArrays)||void 0===s?void 0:s.map((e=>h.MessageMetaArray.payloadify(e))),apple_critical_alert_options:e.appleCriticalAlertOptions?h.AppleCriticalAlertOptions.payloadify(e.appleCriticalAlertOptions):null,push_option:e.pushNotificationDeliveryOption}))}}class lt extends d.APIResponseCommand{constructor(e,t){super(e,t),this.message=new h.FileMessage(e,t)}}class dt extends d.APIRequestCommand{constructor(e){var t;super();let s=[];e.mentionType===d.MentionType.USERS&&(e.mentionedUserIds?s=e.mentionedUserIds:e.mentionedUsers&&(s=e.mentionedUsers.map((e=>e.userId))));const{channelType:n,channelUrl:i,scheduledMessageId:a}=e;this.method=d.APIRequestMethod.PUT,this.path=`${d.getChannelApiPathByType(n)}/${encodeURIComponent(i)}/scheduled_messages/${encodeURIComponent(a)}`,this.params=d.deundefined(d.undefineNullProps({req_id:e.reqId,scheduled_at:e.scheduledAt,message_type:d.ServerSideMessageType.USER,message:e.message,custom_type:e.customType,data:e.data,mention_type:e.mentionType,mentioned_user_ids:s,sorted_metaarray:null===(t=e.metaArrays)||void 0===t?void 0:t.map((e=>h.MessageMetaArray.payloadify(e))),apple_critical_alert_options:e.appleCriticalAlertOptions?h.AppleCriticalAlertOptions.payloadify(e.appleCriticalAlertOptions):null,target_langs:e.translationTargetLanguages,push_option:e.pushNotificationDeliveryOption}))}}class ht extends d.APIRequestCommand{constructor(e){super();const{channelType:t,channelUrl:s,scheduledMessageId:n}=e;this.method=d.APIRequestMethod.DELETE,this.path=`${d.getChannelApiPathByType(t)}/${encodeURIComponent(s)}/scheduled_messages/${encodeURIComponent(n)}`}}class ct extends d.APIRequestCommand{constructor(e){super();const{channelType:t,channelUrl:s,scheduledMessageId:n}=e;this.method=d.APIRequestMethod.POST,this.path=`${d.getChannelApiPathByType(t)}/${encodeURIComponent(s)}/scheduled_messages/${encodeURIComponent(n)}/send_now`}}class ut extends d.APIRequestCommand{constructor({userId:e,channelUrl:t,pushTriggerOption:s}){super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(e)}/push_preference/${encodeURIComponent(t)}`,this.params={push_trigger_option:s}}}class _t extends d.APIResponseCommand{constructor(e,t){super(e,t),this.pushTriggerOption=t.push_trigger_option,this.enabled=t.enable}}class pt extends d.APIRequestCommand{constructor({userId:e,channelUrl:t}){super(),this.method=d.APIRequestMethod.GET,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(e)}/push_preference/${encodeURIComponent(t)}`}}class mt extends d.APIResponseCommand{constructor(e,t){super(e,t),this.pushTriggerOption=t.push_trigger_option,this.enabled=t.enable}}class gt extends d.APIRequestCommand{constructor(e){const{channelUrl:t,channelType:s}=e;super(),this.method=d.APIRequestMethod.GET,this.path=`${d.getChannelApiPathByType(s)}/${encodeURIComponent(t)}/message_purge_offset`}}class Ct extends d.APIResponseCommand{constructor(e,t){super(e,t);const{message_purge_offset:s}=t;this.messageDeletionTimestamp=s}}var Et,vt;exports.CountPreference=void 0,(Et=exports.CountPreference||(exports.CountPreference={})).ALL="all",Et.UNREAD_MESSAGE_COUNT_ONLY="unread_message_count_only",Et.UNREAD_MENTION_COUNT_ONLY="unread_mention_count_only",Et.OFF="off",exports.HiddenState=void 0,(vt=exports.HiddenState||(exports.HiddenState={})).UNHIDDEN="unhidden",vt.HIDDEN_ALLOW_AUTO_UNHIDE="hidden_allow_auto_unhide",vt.HIDDEN_PREVENT_AUTO_UNHIDE="hidden_prevent_auto_unhide";class ft extends h.BaseChannel{constructor(e,t){var s,n,i,a,r,o,l,c,u,_,m,g,C,E,v,f,M,S,y,A;super(e,t),this._unreadMemberStateMap=new Map,this._undeliveredMemberStateMap=new Map,this._typingStatus=new Map,this._lastMemberCountUpdated=0,this._typingStarted=0,this._typingEnded=0,this._hasBotInfo={general:!1,ai:!1},this.isDistinct=!1,this.isSuper=!1,this.isBroadcast=!1,this.isExclusive=!1,this.isPublic=!1,this.isDiscoverable=!0,this.isChatNotification=!1,this.isAccessCodeRequired=!1,this.isPushEnabled=!1,this.unreadMessageCount=0,this.unreadMentionCount=0,this.totalUnreadReplyCount=0,this.members=[],this.memberCount=0,this.joinedMemberCount=0,this.hiddenState=exports.HiddenState.UNHIDDEN,this.lastMessage=null,this.messageOffsetTimestamp=0,this.messageSurvivalSeconds=-1,this.myMemberState=exports.MemberState.NONE,this.myRole=d.Role.NONE,this.myMutedState=d.MutedState.UNMUTED,this.myLastRead=0,this.myCountPreference=exports.CountPreference.ALL,this.myPushTriggerOption=d.PushTriggerOption.DEFAULT,this.inviter=null,this.invitedAt=0,this.joinedAt=0,this.lastPinnedMessage=null,this._latestMessageInfo=null,this._pinnedMessagesUpdatedAt=0,this._myMutedRemainingTime=-1,this._messageDeletionTimestamp=0,this.channelType=d.ChannelType.GROUP,this.isDistinct=null!==(s=t.is_distinct)&&void 0!==s&&s,this.isSuper=null!==(n=t.is_super)&&void 0!==n&&n,this.isBroadcast=null!==(i=t.is_broadcast)&&void 0!==i&&i,this.isExclusive=null!==(a=t.is_exclusive)&&void 0!==a&&a,this.isPublic=null!==(r=t.is_public)&&void 0!==r&&r,this.isDiscoverable=null!==(o=t.is_discoverable)&&void 0!==o?o:this.isPublic,this.isChatNotification=null!==(l=t.is_chat_notification)&&void 0!==l&&l,this.isAccessCodeRequired=null!==(c=t.is_access_code_required)&&void 0!==c&&c,this.isPushEnabled=null!==(u=t.is_push_enabled)&&void 0!==u&&u,Array.isArray(t.members)&&this.members.push(...t.members.map((e=>new p(this._iid,e)))),this.memberCount=null!==(_=t.member_count)&&void 0!==_?_:0,this.joinedMemberCount=null!==(m=t.joined_member_count)&&void 0!==m?m:0,this.hiddenState=d.isEnumOf(exports.HiddenState,t.hidden_state)?t.hidden_state:exports.HiddenState.UNHIDDEN,this.messageOffsetTimestamp=null!==(g=t.ts_message_offset)&&void 0!==g?g:0,this.messageSurvivalSeconds=null!==(C=t.message_survival_seconds)&&void 0!==C?C:-1,this.lastMessage=t.last_message?h.parseMessagePayload(this._iid,Object.assign({channel_type:this.channelType},t.last_message)):null,t.read_receipt&&Object.keys(t.read_receipt).forEach((e=>{d.isTypeOf("number",t.read_receipt[e])&&this._updateUnreadMemberState(e,t.read_receipt[e])})),t.delivery_receipt&&Object.keys(t.delivery_receipt).forEach((e=>{d.isTypeOf("number",t.delivery_receipt[e])&&this._updateUndeliveredMemberState(e,t.delivery_receipt[e])})),this.myMemberState=d.isEnumOf(exports.MemberState,t.member_state)?t.member_state:exports.MemberState.NONE,this.myRole=d.isEnumOf(d.Role,t.my_role)?t.my_role:d.Role.NONE,d.isEnumOf(d.MutedState,t.is_muted)?this.myMutedState=t.is_muted:d.isTypeOf("boolean",t.is_muted)?this.myMutedState=t.is_muted?d.MutedState.MUTED:d.MutedState.UNMUTED:this.myMutedState=d.MutedState.UNMUTED,this.myCountPreference=d.isEnumOf(exports.CountPreference,t.count_preference)?t.count_preference:exports.CountPreference.ALL,this.myPushTriggerOption=d.isEnumOf(d.PushTriggerOption,t.push_trigger_option)?t.push_trigger_option:d.PushTriggerOption.ALL,this.myLastRead=null!==(E=t.user_last_read)&&void 0!==E?E:0,this.inviter=t.inviter?new d.User(this._iid,t.inviter):null,this.invitedAt=null!==(v=t.invited_at)&&void 0!==v?v:0,this.joinedAt=null!==(f=t.joined_ts)&&void 0!==f?f:0,this._updateUnreadCount(null!==(M=t.unread_message_count)&&void 0!==M?M:0,null!==(S=t.unread_mention_count)&&void 0!==S?S:0),this.totalUnreadReplyCount=null!==(y=t.total_unread_thread_message_count)&&void 0!==y?y:0,this.lastPinnedMessage=t.latest_pinned_message?h.parseMessagePayload(this._iid,Object.assign({channel_type:this.channelType},t.latest_pinned_message)):null,t.latest_message&&(this._latestMessageInfo={messageId:t.latest_message.message_id,createdAt:t.latest_message.created_at}),this._hasBotInfo={general:!!t.has_bot,ai:!!t.has_ai_bot},this._messageDeletionTimestamp=null!==(A=t.message_purge_offset)&&void 0!==A?A:0}get isHidden(){return this.hiddenState!==exports.HiddenState.UNHIDDEN}get isTyping(){return this._typingStatus.size>0}get cachedUnreadMemberState(){const e={};for(const[t,s]of this._unreadMemberStateMap)e[t]=s;return e}get cachedUndeliveredMemberState(){const e={};for(const[t,s]of this._undeliveredMemberStateMap)e[t]=s;return e}get hasBot(){return this._hasBotInfo.general}get hasAiBot(){return this._hasBotInfo.ai}get messageDeletionTimestamp(){return this._messageDeletionTimestamp}static payloadify(e){return d.deundefined(d.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{is_access_code_required:e.isAccessCodeRequired,is_distinct:e.isDistinct,is_super:e.isSuper,is_broadcast:e.isBroadcast,is_exclusive:e.isExclusive,is_public:e.isPublic,is_discoverable:e.isDiscoverable,is_muted:e.myMutedState,is_push_enabled:e.isPushEnabled,unread_message_count:e.unreadMessageCount,unread_mention_count:e.unreadMentionCount,total_unread_thread_message_count:e.totalUnreadReplyCount,push_trigger_option:e.myPushTriggerOption,count_preference:e.myCountPreference,hidden_state:e.hiddenState,member_count:e.memberCount,joined_member_count:e.joinedMemberCount,member_state:e.myMemberState,my_role:e.myRole,user_last_read:e.myLastRead,ts_message_offset:e.messageOffsetTimestamp,message_survival_seconds:e.messageSurvivalSeconds,read_receipt:e.cachedUnreadMemberState,delivery_receipt:e.cachedUndeliveredMemberState,members:e.members.map((e=>p.payloadify(e))),last_message:e.lastMessage?h.payloadifyMessage(e.lastMessage):null,inviter:e.inviter?d.User.payloadify(e.inviter):null,invited_at:e.invitedAt,joined_ts:e.joinedAt,latest_pinned_message:e.lastPinnedMessage?h.payloadifyMessage(e.lastPinnedMessage):null,latest_message:e._latestMessageInfo?{message_id:e._latestMessageInfo.messageId,created_at:e._latestMessageInfo.createdAt}:null,has_bot:e.hasBot,has_ai_bot:e.hasAiBot,message_purge_offset:e.messageDeletionTimestamp})))}_shouldUpdateLastMessageWith(e){if(e.silent)return!1;const{appInfo:t}=d.Vault.of(this._iid);switch(null==t?void 0:t.lastMessageThreadingPolicy){case d.LastMessageThreadingPolicy.NONE:case d.LastMessageThreadingPolicy.INCLUDE_REPLY:break;case d.LastMessageThreadingPolicy.EXCLUDE_REPLY:if(e.parentMessageId>0)return!1;break;case d.LastMessageThreadingPolicy.INCLUDE_REPLY_TO_CHANNEL:if(e instanceof h.SendableMessage&&e.parentMessageId>0&&!e.replyToChannel)return!1}return!this.lastMessage||this.lastMessage.createdAt<e.createdAt||this.lastMessage.createdAt===e.createdAt&&this.lastMessage.messageId===e.messageId&&this.lastMessage.updatedAt<e.updatedAt}_tryUpdateLastMessageAndCallEvents(e,t){const{dispatcher:s}=d.Vault.of(this._iid),n=Ne.of(this._iid);this._updateLastMessage(t),n.handlers.map((t=>{t.onChannelChanged&&t.onChannelChanged(e)})),s.dispatch(new P({channels:[e],context:{source:d.CollectionEventSource.EVENT_MESSAGE_SENT}}))}_shouldUpdateUnreadCountWith(e){const{appInfo:t}=d.Vault.of(this._iid);switch(null==t?void 0:t.unreadCountThreadingPolicy){case d.UnreadCountThreadingPolicy.NONE:case d.UnreadCountThreadingPolicy.INCLUDE_REPLY:break;case d.UnreadCountThreadingPolicy.EXCLUDE_REPLY:if(e.parentMessageId>0)return!1;break;case d.UnreadCountThreadingPolicy.INCLUDE_REPLY_TO_CHANNEL:if(e instanceof h.SendableMessage&&e.parentMessageId>0&&!e.replyToChannel)return!1}return!0}_updateLastMessage(e){return!!this._shouldUpdateLastMessageWith(e)&&(this.lastMessage=e,!0)}_updateUnreadCount(e,t){if("number"==typeof e&&e>=0)if(this.myCountPreference===exports.CountPreference.ALL||this.myCountPreference===exports.CountPreference.UNREAD_MESSAGE_COUNT_ONLY)if(this.isExclusive||this.isSuper||this.isBroadcast){const{maxSuperGroupChannelUnreadCount:t}=d.Vault.of(this._iid);this.unreadMessageCount=t&&e>=t?t:e}else this.unreadMessageCount=e;else this.unreadMessageCount=0;else this.unreadMessageCount=0;"number"==typeof t&&t>=0&&(this.myCountPreference===exports.CountPreference.ALL||this.myCountPreference===exports.CountPreference.UNREAD_MENTION_COUNT_ONLY)?this.unreadMentionCount=t:this.unreadMentionCount=0}_updateUnreadMemberState(e,t){const s=this._unreadMemberStateMap.get(e);if(!s||s<t){this._unreadMemberStateMap.set(e,t);const{sdkState:s}=d.Vault.of(this._iid);return s.userId===e&&(this.myLastRead=t),!0}return!1}_updateUndeliveredMemberState(e,t){const s=this._undeliveredMemberStateMap.get(e);return(!s||s<t)&&(this._undeliveredMemberStateMap.set(e,t),!0)}_updateTypingStatus(e,t=(new Date).getTime()){t>0?this._typingStatus.set(e.userId,{user:e,ts:t}):this._typingStatus.delete(e.userId)}_clearTypingStatus(){this._typingStatus.clear(),this._typingStarted=0,this._typingEnded=0}_setLatestMemberCount(e,t,s){let n=!1;return s>=this._lastMemberCountUpdated&&(this._lastMemberCountUpdated=s,n=e!==this.memberCount||t!==this.joinedMemberCount,this.memberCount=e,this.joinedMemberCount=t),n}isReadMessage(e){const{sdkState:t}=d.Vault.of(this._iid),s=this._unreadMemberStateMap.get(t.userId);return!!s&&s>=e.createdAt}serialize(){return d.serialize(this,(e=>{e.cachedUnreadMemberState=this.cachedUnreadMemberState,e.cachedUndeliveredMemberState=this.cachedUndeliveredMemberState,Object.assign(e,this._serializeCachedMetaData())}))}createMessageCollection(e={}){return new Ge(this._iid,Object.assign(Object.assign({},e),{channel:this}))}createMemberListQuery(e={}){return new Ke(this._iid,this.url,e)}createThreadedParentMessageListQuery(e={}){return new _.ThreadedParentMessageListQuery(this._iid,this.url,this.channelType,e)}addMember(e,t=0){if(!this.isExclusive&&!this.isSuper&&!this.isBroadcast){const s=this.members.findIndex((t=>t.userId===e.userId));if(s>-1){const t=this.members[s];t.state===exports.MemberState.JOINED&&(e.state=t.state),this.members.splice(s,1),this.memberCount--}this.members.push(e),this.memberCount++,this._updateUnreadMemberState(e.userId,t),this._updateUndeliveredMemberState(e.userId,t)}}removeMember(e){if(!this.isExclusive&&!this.isSuper&&!this.isBroadcast){const t=e instanceof p?e.userId:e,s=this.members.findIndex((e=>e.userId===t));if(s>-1)return this.members.splice(s,1),this.memberCount--,!0}return!1}getUnreadMemberCount(e){if(e instanceof h.SendableMessage&&!this.isExclusive&&!this.isSuper&&!this.isBroadcast){const{sdkState:t}=d.Vault.of(this._iid),s=e.createdAt;let n=0;for(const i of this.members)if(t.userId!==i.userId&&i.state===exports.MemberState.JOINED&&e.sender.userId!==i.userId){(this.cachedUnreadMemberState[i.userId]||0)<s&&n++}return n}return 0}getUndeliveredMemberCount(e){if(e instanceof h.SendableMessage&&!this.isExclusive&&!this.isSuper&&!this.isBroadcast){const{sdkState:t}=d.Vault.of(this._iid),s=e.createdAt;let n=0;for(const i of this.members)if(t.userId!==i.userId&&i.state===exports.MemberState.JOINED&&e.sender.userId!==i.userId){(this.cachedUndeliveredMemberState[i.userId]||0)<s&&n++}return n}return 0}getReadMembers(e,t=!1){const{sdkState:s}=d.Vault.of(this._iid);if(!s.userId||this.isExclusive||this.isSuper||this.isBroadcast)return[];const n=e instanceof h.SendableMessage?e.sender:null,i=[];return this.members.forEach((a=>{if(t||a.userId!==s.userId&&a.userId!==(null==n?void 0:n.userId)){const t=this._unreadMemberStateMap.get(a.userId);t&&t>=e.createdAt&&i.push(a)}})),i}getUnreadMembers(e,t=!1){const{sdkState:s}=d.Vault.of(this._iid);if(!s.userId||this.isExclusive||this.isSuper||this.isBroadcast)return[];const n=e instanceof h.SendableMessage?e.sender:null,i=[];return this.members.forEach((a=>{if(t||a.userId!==s.userId&&a.userId!==(null==n?void 0:n.userId)){const t=this._unreadMemberStateMap.get(a.userId);t&&t<e.createdAt&&i.push(a)}})),i}getReadStatus(e=!1){const{sdkState:t}=d.Vault.of(this._iid);if(!t.userId||this.isExclusive||this.isSuper||this.isBroadcast)return null;const s={};return this.members.forEach((n=>{if(e||n.userId!==t.userId){const e=this._unreadMemberStateMap.get(n.userId);s[n.userId]=new h.ReadStatus(this._iid,{channel_url:this.url,channel_type:this.channelType,user:p.payloadify(n),ts:null!=e?e:0})}})),s}getDeliveryStatus(e=!0){const{sdkState:t}=d.Vault.of(this._iid);if(!t.userId||this.isExclusive||this.isSuper||this.isBroadcast)return null;const s={};return this.members.forEach((n=>{if(e||n.userId!==t.userId){const e=this._undeliveredMemberStateMap.get(n.userId);s[n.userId]=new m(this._iid,{channel_url:this.url,channel_type:this.channelType,user:p.payloadify(n),ts:null!=e?e:0})}})),s}getTypingUsers(){const e=[];return this._typingStatus.forEach((t=>{const{user:s}=t;e.push(s)})),e}invalidateTypingStatus(){const{typingIndicatorInvalidateTime:e}=d.Vault.of(this._iid),t=Date.now();let s=!1;return this._typingStatus.forEach(((n,i)=>{const{ts:a}=n;t-a>=e&&(this._typingStatus.delete(i),s=!0)})),s}refresh(){return d.__awaiter(this,void 0,void 0,(function*(){return this._refresh()}))}_refresh(e=!1){return d.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:t,dispatcher:s}=d.Vault.of(this._iid),n=new D({channelUrl:this.url}),i=yield t.send(n),{channel:a}=i.as(k);return this._update(a),e||s.dispatch(new P({channels:[a],context:{source:d.CollectionEventSource.REFRESH_CHANNEL}})),this}))}freeze(){const e=Object.create(null,{freeze:{get:()=>super.freeze}});return d.__awaiter(this,void 0,void 0,(function*(){yield e.freeze.call(this);const{dispatcher:t}=d.Vault.of(this._iid);t.dispatch(new P({channels:[this],context:{source:d.CollectionEventSource.EVENT_CHANNEL_FROZEN},isWebSocketEventComing:!0}))}))}unfreeze(){const e=Object.create(null,{unfreeze:{get:()=>super.unfreeze}});return d.__awaiter(this,void 0,void 0,(function*(){yield e.unfreeze.call(this);const{dispatcher:t}=d.Vault.of(this._iid);t.dispatch(new P({channels:[this],context:{source:d.CollectionEventSource.EVENT_CHANNEL_UNFROZEN},isWebSocketEventComing:!0}))}))}updateChannel(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},qe),e);d.unless((e=>d.isTypeOf("string",e.coverUrl,!0)&&(d.isFile(e.coverImage)||d.isTypeOf("string",e.coverImage,!0))&&d.isTypeOf("boolean",e.isDistinct,!0)&&d.isTypeOf("boolean",e.isPublic,!0)&&d.isTypeOf("boolean",e.isDiscoverable,!0)&&d.isTypeOf("string",e.accessCode,!0)&&d.isTypeOf("string",e.name,!0)&&d.isTypeOf("string",e.data,!0)&&d.isTypeOf("string",e.customType,!0)&&d.isArrayOf("string",e.operatorUserIds,!0)&&d.isTypeOf("number",e.messageSurvivalSeconds,!0))(t)).throw(d.SendbirdError.invalidParameters);const{dispatcher:s,requestQueue:n}=d.Vault.of(this._iid),i=new Je(Object.assign({channelUrl:this.url},t)),a=yield n.send(i),{channel:r}=a.as(Xe);return this._update(r),s.dispatch(new P({channels:[r],context:{source:d.CollectionEventSource.EVENT_CHANNEL_UPDATED},isWebSocketEventComing:!0})),this}))}invite(e){return d.__awaiter(this,void 0,void 0,(function*(){return d.unless(e.every((e=>e instanceof d.User))).throw(d.SendbirdError.invalidParameters),this.inviteWithUserIds(e.map((e=>e.userId)))}))}inviteWithUserIds(e){return d.__awaiter(this,void 0,void 0,(function*(){d.unless(d.isArrayOf("string",e)).throw(d.SendbirdError.invalidParameters);const{dispatcher:t,requestQueue:s,sessionManager:n}=d.Vault.of(this._iid),i=new oe({channelUrl:this.url,userIds:e}),a=yield s.send(i),{channel:r}=a.as(le);return this._update(r),t.dispatch(new P({channels:[r],context:{source:d.CollectionEventSource.EVENT_CHANNEL_INVITED,inviter:n.currentUser,invitees:[]},isWebSocketEventComing:!0})),this}))}join(e){return d.__awaiter(this,void 0,void 0,(function*(){d.unless(d.isTypeOf("string",e,!0)).throw(d.SendbirdError.invalidParameters);const{dispatcher:t,sdkState:s,requestQueue:n}=d.Vault.of(this._iid),i=new se({channelUrl:this.url,userId:s.userId,accessCode:e}),a=yield n.send(i),{channel:r}=a.as(ne);return r.myMemberState=this.myMemberState=exports.MemberState.JOINED,this._update(r),t.dispatch(new P({channels:[r],context:{source:d.CollectionEventSource.EVENT_CHANNEL_JOINED,users:[]},isWebSocketEventComing:!0})),this}))}leave(e=!1){return d.__awaiter(this,void 0,void 0,(function*(){const{sdkState:t,requestQueue:s}=d.Vault.of(this._iid),n=new ae({channelUrl:this.url,userId:t.userId,shouldRemoveOperatorStatus:e});yield s.send(n),this.myMemberState=exports.MemberState.NONE}))}acceptInvitation(e){return d.__awaiter(this,void 0,void 0,(function*(){d.unless(d.isTypeOf("string",e,!0)).throw(d.SendbirdError.invalidParameters);const{dispatcher:t,sdkState:s,requestQueue:n}=d.Vault.of(this._iid),i=new Qe({channelUrl:this.url,userId:s.userId,accessCode:e}),a=yield n.send(i),{channel:r}=a.as(Ye);return r.myMemberState=this.myMemberState=exports.MemberState.JOINED,this._update(r),t.dispatch(new P({channels:[r],context:{source:d.CollectionEventSource.EVENT_CHANNEL_ACCEPTED_INVITE},isWebSocketEventComing:!0})),this}))}declineInvitation(){return d.__awaiter(this,void 0,void 0,(function*(){const{sdkState:e,requestQueue:t}=d.Vault.of(this._iid),s=new he({channelUrl:this.url,userId:e.userId});return yield t.send(s),this.myMemberState=exports.MemberState.NONE,this}))}sendUserMessage(e){const t=new h.MessageRequestHandler,{dispatcher:s}=d.Vault.of(this._iid),n=c.AutoResendManager.of(this._iid);return super.sendUserMessage(e).onPending((e=>{n.completeCurrentAndProcessNextAutoResend(e),t._trigger(e)})).onFailed(((e,s)=>{s&&n.completeCurrentAndProcessNextAutoResend(s),t._triggerFailed(e,s)})).onSucceeded((e=>{n.completeCurrentAndProcessNextAutoResend(e),this._updateLastMessage(e);Ne.of(this._iid).handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),s.dispatch(new P({channels:[this],context:{source:d.CollectionEventSource.EVENT_MESSAGE_SENT}})),t._trigger(e)})),t}updateUserMessage(e,t){const s=Object.create(null,{updateUserMessage:{get:()=>super.updateUserMessage}});return d.__awaiter(this,void 0,void 0,(function*(){const{dispatcher:n}=d.Vault.of(this._iid),i=yield s.updateUserMessage.call(this,e,t);let a=this._updateLastMessage(i),r=!1;if(this.lastPinnedMessage&&this.lastPinnedMessage.messageId===i.messageId&&(this.lastPinnedMessage=i,a=!0,r=!0),a){Ne.of(this._iid).handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),n.dispatch(new P({channels:[this],context:{source:r?d.CollectionEventSource.EVENT_PINNED_MESSAGE_UPDATED:d.CollectionEventSource.EVENT_MESSAGE_UPDATED}}))}if(r){Ne.of(this._iid).handlers.map((e=>{e.onPinnedMessageUpdated&&e.onPinnedMessageUpdated(this)}))}return n.dispatch(new d.MessageUpdateEventCommand({messages:[i],source:d.CollectionEventSource.EVENT_MESSAGE_UPDATED})),i}))}_autoResendUserMessage(e){const t=new h.MessageRequestHandler,{dispatcher:s}=d.Vault.of(this._iid),n=c.AutoResendManager.of(this._iid);return super._autoResendUserMessage(e).onPending((e=>{n.completeCurrentAndProcessNextAutoResend(e),t._trigger(e)})).onFailed(((e,s)=>{n.completeCurrentAndProcessNextAutoResend(s),t._triggerFailed(e,s)})).onSucceeded((e=>{const i=Ne.of(this._iid);n.completeCurrentAndProcessNextAutoResend(e),this._updateLastMessage(e),i.handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),s.dispatch(new P({channels:[this],context:{source:d.CollectionEventSource.EVENT_MESSAGE_SENT}})),t._trigger(e)})),t}sendFileMessage(e){const t=new h.MessageRequestHandler,{dispatcher:s}=d.Vault.of(this._iid),n=c.AutoResendManager.of(this._iid);return super.sendFileMessage(e).onPending((e=>{n.completeCurrentAndProcessNextAutoResend(e),t._trigger(e)})).onFailed(((e,s)=>{s&&n.completeCurrentAndProcessNextAutoResend(s),t._triggerFailed(e,s)})).onSucceeded((e=>{const i=Ne.of(this._iid);n.completeCurrentAndProcessNextAutoResend(e),this._updateLastMessage(e),i.handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),s.dispatch(new P({channels:[this],context:{source:d.CollectionEventSource.EVENT_MESSAGE_SENT}})),t._trigger(e)})),t}sendMultipleFilesMessage(e){const t=new h.MultipleFilesMessageRequestHandler,{dispatcher:s}=d.Vault.of(this._iid);return super.sendMultipleFilesMessage(e).onPending((e=>{t._trigger(e)})).onFailed(((e,s)=>{t._triggerFailed(e,s)})).onSucceeded((e=>{const n=Ne.of(this._iid);this._updateLastMessage(e),n.handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),s.dispatch(new P({channels:[this],context:{source:d.CollectionEventSource.EVENT_MESSAGE_SENT}})),t._trigger(e)})).onFileUploaded(((e,s,n,i)=>{t._triggerOnFileUploaded(e,s,n,i)})),t}updateFileMessage(e,t){const s=Object.create(null,{updateFileMessage:{get:()=>super.updateFileMessage}});return d.__awaiter(this,void 0,void 0,(function*(){const{dispatcher:n}=d.Vault.of(this._iid),i=yield s.updateFileMessage.call(this,e,t);let a=this._updateLastMessage(i),r=!1;if(this.lastPinnedMessage&&this.lastPinnedMessage.messageId===i.messageId&&(this.lastPinnedMessage=i,a=!0,r=!0),a){Ne.of(this._iid).handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),n.dispatch(new P({channels:[this],context:{source:r?d.CollectionEventSource.EVENT_PINNED_MESSAGE_UPDATED:d.CollectionEventSource.EVENT_MESSAGE_UPDATED}}))}if(r){Ne.of(this._iid).handlers.map((e=>{e.onPinnedMessageUpdated&&e.onPinnedMessageUpdated(this)}))}return n.dispatch(new d.MessageUpdateEventCommand({messages:[i],source:d.CollectionEventSource.EVENT_MESSAGE_UPDATED})),i}))}_autoResendFileMessage(e){const t=new h.MessageRequestHandler,{dispatcher:s}=d.Vault.of(this._iid),n=c.AutoResendManager.of(this._iid);return super._autoResendFileMessage(e).onPending((e=>{n.completeCurrentAndProcessNextAutoResend(e),t._trigger(e)})).onFailed(((e,s)=>{n.completeCurrentAndProcessNextAutoResend(s),t._triggerFailed(e,s)})).onSucceeded((e=>{const i=Ne.of(this._iid);n.completeCurrentAndProcessNextAutoResend(e),this._updateLastMessage(e),i.handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),s.dispatch(new P({channels:[this],context:{source:d.CollectionEventSource.EVENT_MESSAGE_SENT}})),t._trigger(e)})),t}deleteMessage(e){const t=Object.create(null,{deleteMessage:{get:()=>super.deleteMessage}});return d.__awaiter(this,void 0,void 0,(function*(){if(yield t.deleteMessage.call(this,e),0===e.messageId&&e instanceof h.SendableMessage){const{dispatcher:t}=d.Vault.of(this._iid);t.dispatch(new d.UnsentMessageRemoveEventCommand({reqId:e.reqId,source:d.CollectionEventSource.EVENT_MESSAGE_DELETED}))}}))}hide(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},ue),e);d.unless((e=>d.isTypeOf("boolean",e.hidePreviousMessages,!0)&&d.isTypeOf("boolean",e.allowAutoUnhide,!0))(t)).throw(d.SendbirdError.invalidParameters);const{dispatcher:s,sdkState:n,requestQueue:i}=d.Vault.of(this._iid),a=new _e(Object.assign({channelUrl:this.url,userId:n.userId},t)),r=yield i.send(a),{messageOffsetTimestamp:o}=r.as(pe);return this.hiddenState=t.allowAutoUnhide?exports.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE:exports.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE,t.hidePreviousMessages&&this._updateUnreadCount(0,0),o&&(this.messageOffsetTimestamp=o),s.dispatch(new P({channels:[this],context:{source:d.CollectionEventSource.EVENT_CHANNEL_HIDDEN},isWebSocketEventComing:!0})),this}))}unhide(){return d.__awaiter(this,void 0,void 0,(function*(){const{dispatcher:e,requestQueue:t}=d.Vault.of(this._iid),s=new et({channelUrl:this.url});return yield t.send(s),this.hiddenState=exports.HiddenState.UNHIDDEN,e.dispatch(new P({channels:[this],context:{source:d.CollectionEventSource.EVENT_CHANNEL_UNHIDDEN},isWebSocketEventComing:!0})),this}))}delete(){return d.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:e}=d.Vault.of(this._iid),t=new Ze({channelUrl:this.url});yield e.send(t)}))}markAsRead(){return d.__awaiter(this,void 0,void 0,(function*(){const{sdkState:e,dispatcher:t,requestQueue:s}=d.Vault.of(this._iid),n=new h.ReadRequestCommand({channelUrl:this.url}),i=yield s.send(n),{readStatus:a}=i.as(h.ReadEventCommand);if(this._updateUnreadMemberState(e.userId,a.readAt),this.unreadMessageCount>0||this.unreadMentionCount>0){this._updateUnreadCount(0,0);Ne.of(this._iid).handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)}))}t.dispatch(new P({channels:[this],context:{source:d.CollectionEventSource.EVENT_CHANNEL_READ}}))}))}markAsDelivered(){return d.__awaiter(this,void 0,void 0,(function*(){const{sdkState:e,requestQueue:t}=d.Vault.of(this._iid),s=new Se({channelUrl:this.url,userId:e.userId});yield t.send(s)}))}startTyping(){return d.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:e,typingIndicatorThrottle:t}=d.Vault.of(this._iid),s=(new Date).getTime();if(s-this._typingStarted>=t){this._typingStarted=s,this._typingEnded=0;const t=new ge({channelUrl:this.url,time:this._typingStarted});yield e.send(t)}}))}endTyping(){return d.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:e,typingIndicatorThrottle:t}=d.Vault.of(this._iid),s=(new Date).getTime();if(s-this._typingEnded>=t){this._typingStarted=0,this._typingEnded=s;const t=new Ee({channelUrl:this.url,time:this._typingStarted});yield e.send(t)}}))}createScheduledUserMessage(e){e=Object.assign(Object.assign({},h.ScheduledUserMessageCreateParamsDefault),e),d.unless(h.validateScheduledUserMessageCreateParams(e)).throw(d.SendbirdError.invalidParameters);const t=new h.MessageRequestHandler;return this._createScheduledUserMessage(e,t),t}updateScheduledUserMessage(e,t){return d.__awaiter(this,void 0,void 0,(function*(){const s=Object.assign(Object.assign({},rt),t);d.unless((e=>h.validateUserMessageUpdateParams(e)&&d.isTypeOf("number",e.scheduledAt,!0))(s)).throw(d.SendbirdError.invalidParameters);const{requestQueue:n}=d.Vault.of(this._iid),i=new dt(Object.assign({reqId:this._generateRequestId(),scheduledMessageId:e,channelType:this.channelType,channelUrl:this.url},s)),a=yield n.send(i),{message:r}=a.as(h.CreateScheduledUserMessageResponseCommand);return r}))}createScheduledFileMessage(e){e=Object.assign(Object.assign({},h.ScheduledFileMessageCreateParamsDefault),e),d.unless(h.validateScheduledFileMessageCreateParams(e)).throw(d.SendbirdError.invalidParameters);const t=Date.now(),s=this._generateRequestId(),n=new h.MessageRequestHandler;return d.sleep(h.PENDING_MESSAGE_DELAY).then((()=>{const i=this._createPendingScheduledFileMessage(e,s,t);d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){return n._trigger(i)}))))})),d.isFile(e.file)?this._uploadFileAndUpdateParams(e).then((()=>this._createScheduledFileMessage(e,n,s,t))):this._createScheduledFileMessage(e,n,s,t),n}updateScheduledFileMessage(e,t){return d.__awaiter(this,void 0,void 0,(function*(){const s=Object.assign(Object.assign({},at),t);d.unless((e=>h.validateBaseMessageUpdateParams(e)&&d.isTypeOf("number",e.scheduledAt,!0)&&(d.isFile(e.file)||d.isTypeOf("string",e.fileUrl))&&d.isTypeOf("string",e.fileName,!0)&&d.isTypeOf("string",e.mimeType,!0)&&d.isTypeOf("number",e.fileSize,!0)&&(null===e.thumbnailSizes||void 0===e.thumbnailSizes||e.thumbnailSizes.every((e=>d.isTypeOf("object",e)&&e.maxWidth>0&&e.maxHeight>0))))(s)).throw(d.SendbirdError.invalidParameters),d.isFile(s.file)&&(yield this._uploadFileAndUpdateParams(s));const n=new ot(Object.assign({reqId:this._generateRequestId(),scheduledMessageId:e,channelType:this.channelType,channelUrl:this.url},s)),{requestQueue:i}=d.Vault.of(this._iid),a=yield i.send(n),{message:r}=a.as(lt);return r}))}cancelScheduledMessage(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=new ht({scheduledMessageId:e,channelType:this.channelType,channelUrl:this.url}),{requestQueue:s}=d.Vault.of(this._iid);yield s.send(t)}))}sendScheduledMessageNow(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=new ct({scheduledMessageId:e,channelType:this.channelType,channelUrl:this.url}),{requestQueue:s}=d.Vault.of(this._iid);yield s.send(t)}))}getMyPushTriggerOption(){return d.__awaiter(this,void 0,void 0,(function*(){const{sdkState:e,requestQueue:t}=d.Vault.of(this._iid),s=new pt({userId:e.userId,channelUrl:this.url}),n=yield t.send(s),{pushTriggerOption:i}=n.as(mt);return this.myPushTriggerOption=i,i}))}setMyPushTriggerOption(e){return d.__awaiter(this,void 0,void 0,(function*(){d.unless(d.isEnumOf(d.PushTriggerOption,e)).throw(d.SendbirdError.invalidParameters);const{dispatcher:t,sdkState:s,requestQueue:n}=d.Vault.of(this._iid),i=new ut({userId:s.userId,channelUrl:this.url,pushTriggerOption:e}),a=yield n.send(i),{pushTriggerOption:r}=a.as(_t);return this.myPushTriggerOption=r,t.dispatch(new P({channels:[this],context:{source:d.CollectionEventSource.EVENT_CHANNEL_UPDATED},isWebSocketEventComing:!0})),r}))}setMyCountPreference(e){return d.__awaiter(this,void 0,void 0,(function*(){d.unless(d.isEnumOf(exports.CountPreference,e)).throw(d.SendbirdError.invalidParameters);const{dispatcher:t,sdkState:s,requestQueue:n}=d.Vault.of(this._iid),i=new tt({channelUrl:this.url,userId:s.userId,countPreference:e}),a=yield n.send(i),{countPreference:r}=a.as(st);return this.myCountPreference=r,this._updateUnreadCount(this.unreadMessageCount,this.unreadMentionCount),t.dispatch(new P({channels:[this],context:{source:d.CollectionEventSource.EVENT_CHANNEL_UPDATED},isWebSocketEventComing:!0})),r}))}resetMyHistory(){return d.__awaiter(this,void 0,void 0,(function*(){const{dispatcher:e,requestQueue:t,sdkState:s}=d.Vault.of(this._iid),n=new nt({channelUrl:this.url,locale:s.localeForChatbot}),i=yield t.send(n),{messageOffsetTimestamp:a}=i.as(it);return this.messageOffsetTimestamp=a,this.lastMessage&&this.lastMessage.createdAt<a&&(this.lastMessage=null),this._updateUnreadCount(0,0),this.totalUnreadReplyCount=0,e.dispatch(new P({channels:[this],context:{source:d.CollectionEventSource.EVENT_CHANNEL_RESET_HISTORY},isWebSocketEventComing:!0})),this}))}_uploadFileAndUpdateParams(e){return d.__awaiter(this,void 0,void 0,(function*(){if(d.isFile(e.file)){const{requestQueue:t}=d.Vault.of(this._iid),s=new h.UploadFileRequestCommand({file:e.file,channelUrl:this.url,thumbnailSizes:e.thumbnailSizes,requestId:this._generateRequestId()}),n=yield t.send(s),{url:i,fileSize:a=e.fileSize,thumbnails:r,requireAuth:o=!1}=n.as(h.UploadFileResponseCommand);e.fileUrl=i,e.fileSize=a,e.requireAuth=o,e._thumbnails=r}}))}resendMessage(e,t){var s;if(d.unless(e instanceof h.SendableMessage&&!e.scheduledInfo&&e.isResendable).throw(d.SendbirdError.invalidParameters),e.isUserMessage()){const t=null!==(s=e.messageParams)&&void 0!==s?s:h.createUserMessageCreateParamsFromFailedUserMessage(e),n=new h.MessageRequestHandler;return this._sendUserMessage(t,h.SendMessageRequestType.RESEND,e.reqId).onPending((e=>{n._trigger(e)})).onFailed(((e,t)=>{n._triggerFailed(e,t)})).onSucceeded((e=>{this._tryUpdateLastMessageAndCallEvents(this,e),n._trigger(e)})),n}if(e.isFileMessage()){const s=this._validateFailedFileMessageHasFile(e,t);d.unless(s).throw(d.SendbirdError.invalidParameters);const n=h.createFileMessageCreateParamsFromFailedFileMessage(e,t),i=new h.MessageRequestHandler;return this._sendFileMessage(n,h.SendMessageRequestType.RESEND,e.reqId).onPending((e=>{i._trigger(e)})).onFailed(((e,t)=>{i._triggerFailed(e,t)})).onSucceeded((e=>{this._tryUpdateLastMessageAndCallEvents(this,e),i._trigger(e)})),i}if(e.isMultipleFilesMessage()){const t=e.messageParams,s=new h.MultipleFilesMessageRequestHandler;return this._sendMultipleFilesMessage(t,h.SendMessageRequestType.RESEND,e.reqId).onPending((e=>{s._trigger(e)})).onFailed(((e,t)=>{s._triggerFailed(e,t)})).onSucceeded((e=>{this._tryUpdateLastMessageAndCallEvents(this,e),s._trigger(e)})).onFileUploaded(((e,t,n,i)=>{s._triggerOnFileUploaded(e,t,n,i)})),s}}copyMessage(e,t){if(d.unless(e instanceof h.BaseChannel&&t instanceof h.SendableMessage&&t.sendingStatus===d.SendingStatus.SUCCEEDED&&this.url===t.channelUrl&&!t.scheduledInfo).throw(d.SendbirdError.invalidParameters),t.isUserMessage()){d.unless(!t.poll).throw(d.SendbirdError.notSupportedError);const s=h.createUserMessageCreateParams(t),n=new h.MessageRequestHandler;return e._sendUserMessage(s).onPending((e=>{n._trigger(e)})).onFailed(((e,t)=>{n._triggerFailed(e,t)})).onSucceeded((t=>{e.isGroupChannel()&&this._tryUpdateLastMessageAndCallEvents(e,t),n._trigger(t)})),n}if(t.isFileMessage()){const s=h.createFileMessageCreateParams(t),n=new h.MessageRequestHandler;return e._sendFileMessage(s).onPending((e=>{n._trigger(e)})).onFailed(((e,t)=>{n._triggerFailed(e,t)})).onSucceeded((t=>{e.isGroupChannel()&&this._tryUpdateLastMessageAndCallEvents(e,t),n._trigger(t)})),n}if(t.isMultipleFilesMessage()){if(e.isGroupChannel()){const s=h.createMultipleFilesMessageCreateParams(t),n=new h.MultipleFilesMessageRequestHandler;return e._sendMultipleFilesMessage(s,h.SendMessageRequestType.COPY).onPending((e=>{n._trigger(e)})).onFailed(((e,t)=>{n._triggerFailed(e,t)})).onSucceeded((t=>{this._tryUpdateLastMessageAndCallEvents(e,t),n._trigger(t)})).onFileUploaded(((e,t,s,i)=>{n._triggerOnFileUploaded(e,t,s,i)})),n}throw d.SendbirdError.channelTypeNotSupportedError}}getMessageDeletionTimestamp(){return d.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:e,dispatcher:t}=d.Vault.of(this._iid),s=new gt({channelUrl:this.url,channelType:this.channelType}),n=(yield e.send(s)).as(Ct).messageDeletionTimestamp;return this._messageDeletionTimestamp=n,t.dispatch(new O({channel:this})),n}))}}exports.BaseMessageCollection=Ve,exports.DeliveryStatus=m,exports.GetTotalUnreadMessageCountRequestCommand=K,exports.GetTotalUnreadMessageCountResponseCommand=Q,exports.GroupChannel=ft,exports.GroupChannelChangeLogsParamsDefault=f,exports.GroupChannelCountParamsDefault=S,exports.GroupChannelCreateParamsDefault=E,exports.GroupChannelEventSource=I,exports.GroupChannelFilter=g,exports.GroupChannelListQuery=Me,exports.GroupChannelManager=Ne,exports.Member=p,exports.MemberListQuery=Ke,exports.MessageCollection=Ge,exports.MessageCollectionInitHandler=He,exports.TimeRange=Ae,exports.TotalUnreadMessageCountParamsDefault=N,exports.indexOfMessage=Te,exports.placeOfMessage=Ie,exports.shouldGiveEvent=x,exports.validateGroupChannelChangeLogsParams=M,exports.validateGroupChannelCountParams=y,exports.validateGroupChannelCreateParams=v,exports.validateTotalUnreadMessageCountParams=T;
