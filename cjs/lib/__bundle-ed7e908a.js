"use strict";var e,t=require("./__bundle-43187895.js");class s extends t.APIRequestCommand{constructor(e){if(super(),this.method=t.APIRequestMethod.POST,this.path=`${t.API_PATH_UPLOAD}`,this.params=t.deundefined({file:e.file,channel_url:e.channelUrl}),e.thumbnailSizes)for(let t=0;t<e.thumbnailSizes.length;t++){const{maxWidth:s,maxHeight:i}=e.thumbnailSizes[t];this.params[`thumbnail${t+1}`]=`${s},${i}`}this.requestId=e.requestId}}class i extends t.APIResponseCommand{constructor(e,t){var s,i,n;super(e,t),this.url=t.url,this.fileSize=null!==(s=t.file_size)&&void 0!==s?s:0,this.thumbnailSizes=null!==(i=t.thumbnails)&&void 0!==i?i:[],this.requireAuth=null!==(n=t.require_auth)&&void 0!==n&&n}}class n extends t.InstancedObject{constructor(e,s){var i,n,a;super(e),this.replyCount=0,this.lastRepliedAt=0,this.updatedAt=0,this.replyCount=null!==(i=s.reply_count)&&void 0!==i?i:0,this.mostRepliedUsers=s.most_replies&&t.isArrayOf("object",s.most_replies)?s.most_replies.map((e=>new t.User(this._iid,e))):[],this.lastRepliedAt=null!==(n=s.last_replied_at)&&void 0!==n?n:0,this.updatedAt=null!==(a=s.updated_at)&&void 0!==a?a:0}static payloadify(e){return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{reply_count:e.replyCount,most_replies:Array.isArray(e.mostRepliedUsers)?e.mostRepliedUsers.map((e=>t.User.payloadify(e))):[],last_replied_at:e.lastRepliedAt,updated_at:e.updatedAt})))}}exports.ReactionEventOperation=void 0,(e=exports.ReactionEventOperation||(exports.ReactionEventOperation={})).ADD="add",e.DELETE="delete";class a{constructor(e){this.messageId=0,this.operation=null,this.updatedAt=0;const s=t.isTypeOf("string",e.msg_id)?parseInt(e.msg_id):e.msg_id,i=e.user_id,n=e.operation?e.operation.toLowerCase():null,a=e.reaction,r=e.updated_at;s&&t.isTypeOf("string",i)&&t.isTypeOf("string",n)&&t.isEnumOf(exports.ReactionEventOperation,n)&&t.isTypeOf("string",a)&&a&&t.isTypeOf("number",r)&&(this.messageId=s,this.userId=i,this.key=a,this.operation=n,this.updatedAt=r)}}class r{constructor(e){var s;const i=e.key,n=null!==(s=[...e.user_ids])&&void 0!==s?s:[],a=e.updated_at;t.isTypeOf("string",i)&&i&&t.isArrayOf("string",n)&&n.length>0&&t.isTypeOf("number",a)&&(this.key=i,this.userIds=n,this.updatedAt=a);const r={};for(const e of this.userIds)r[e]=this.updatedAt;this._version=r}get isEmpty(){return 0===this.userIds.length}static payloadify(e){return t.deundefined(t.undefineNullProps({key:e.key,user_ids:e.userIds,updated_at:e.updatedAt}))}applyEvent(e){if(e.key===this.key&&this.updatedAt<=e.updatedAt){if(!this._version[e.userId]||this._version[e.userId]<=e.updatedAt){const t=this.userIds.indexOf(e.userId);switch(e.operation){case exports.ReactionEventOperation.ADD:t<0&&this.userIds.push(e.userId);break;case exports.ReactionEventOperation.DELETE:t>=0&&this.userIds.splice(t,1)}this._version[e.userId]=e.updatedAt}this.updatedAt=Math.max(this.updatedAt,e.updatedAt)}}}class o{constructor(e){this.secureUrl=null,this.type=null,this.width=0,this.height=0,this.alt=null,this.url=e.url,e.secure_url&&(this.secureUrl=e.secure_url),e.type&&(this.type=e.type),e.width&&(this.width=e.width),e.height&&(this.height=e.height),e.alt&&(this.alt=e.alt)}static payloadify(e){var s,i;return t.deundefined(t.undefineNullProps({url:e.url,secure_url:e.secureUrl,type:e.type,width:null!==(s=e.width)&&void 0!==s?s:0,height:null!==(i=e.height)&&void 0!==i?i:0,alt:e.alt}))}}class l{constructor(e){this.title=null,this.url=null,this.description=null,this.defaultImage=null,e["og:title"]&&(this.title=e["og:title"]),e["og:url"]&&(this.url=e["og:url"]),e["og:description"]&&(this.description=e["og:description"]),e["og:image"]&&(this.defaultImage=new o(e["og:image"]))}static payloadify(e){return t.deundefined(t.undefineNullProps({"og:title":e.title,"og:url":e.url,"og:description":e.description,"og:image":e.defaultImage?o.payloadify(e.defaultImage):null}))}}class d{constructor(e){var t,s;this.volume=0,this.name=null!==(t=e.name)&&void 0!==t?t:"default",this.volume=null!==(s=e.volume)&&void 0!==s?s:1}serialize(){return{name:this.name,volume:this.volume}}static payloadify(e){return t.deundefined(t.undefineNullProps({name:e.name,volume:e.volume}))}}class u extends t.User{constructor(e,s){var i;super(e,s),this.isBlockedByMe=!1,this.role=t.isEnumOf(t.Role,s.role)?s.role:t.Role.NONE,this.isBlockedByMe=null!==(i=s.is_blocked_by_me)&&void 0!==i&&i}static payloadify(e){return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{role:e.role,is_blocked_by_me:e.isBlockedByMe})))}}class c{constructor(e){this.key=e.key,this.value=t.isArrayOf("string",e.value)?[...e.value]:[]}static payloadify(e){var s;return t.deundefined(t.undefineNullProps({key:e.key,value:null!==(s=e.value)&&void 0!==s?s:[]}))}}const h=e=>{switch(e){case t.MessageType.BASE:return"";case t.MessageType.USER:return"MESG";case t.MessageType.FILE:return"FILE";case t.MessageType.ADMIN:return"ADMM"}};class p extends t.InstancedObject{constructor(e,s){var i,n,a,r,o,l,d,u,h,p;super(e),this.channelType=t.ChannelType.BASE,this.messageType=t.MessageType.BASE,this.mentionType=null,this.mentionedUsers=null,this.mentionedUserIds=null,this.metaArrays=[],this.extendedMessage={},this.createdAt=0,this.updatedAt=0,this.channelUrl=s.channel_url,this.channelType=t.isEnumOf(t.ChannelType,s.channel_type)?s.channel_type:t.ChannelType.GROUP,s.channel&&(s.channel.channel_url&&(this.channelUrl=s.channel.channel_url),s.channel.channel_type&&(this.channelType=s.channel.channel_type)),this.data=null!==(i=s.data)&&void 0!==i?i:"",this.customType=null!==(n=s.custom_type)&&void 0!==n?n:"",this.mentionType=t.isEnumOf(t.MentionType,s.mention_type)?s.mention_type:null,this.mentionedUsers=s.mentioned_users?s.mentioned_users.map((e=>new t.User(this._iid,e))):null,this.mentionedUserIds=null!==(a=s.mentioned_user_ids)&&void 0!==a?a:null,this.mentionedUsers&&!this.mentionedUserIds&&(this.mentionedUserIds=this.mentionedUsers.map((e=>e.userId))),this.mentionedMessageTemplate=null!==(r=s.mentioned_message_template)&&void 0!==r?r:"";const m=null!==(o=s.metaarray)&&void 0!==o?o:{},_=null!==(l=s.metaarray_key_order)&&void 0!==l?l:Object.keys(m).sort(((e,t)=>e.localeCompare(t)));this.metaArrays=[];for(let e=0;e<_.length;e++){const t=_[e];this.metaArrays.push(new c({key:t,value:m[t]||[]}))}s.sorted_metaarray&&(this.metaArrays=s.sorted_metaarray.map((e=>new c(e)))),this.extendedMessage=null!==(d=s.extended_message)&&void 0!==d?d:{},this.extendedMessagePayload=s.extended_message_payload,this.createdAt=null!==(h=null!==(u=s.created_at)&&void 0!==u?u:s.ts)&&void 0!==h?h:0,this.updatedAt=null!==(p=s.updated_at)&&void 0!==p?p:0}static payloadify(e){var s,i;return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{channel_url:e.channelUrl,channel_type:e.channelType,type:h(e.messageType),data:e.data,custom_type:e.customType,mention_type:e.mentionType,mentioned_user_ids:e.mentionedUserIds,mentioned_users:null===(s=e.mentionedUsers)||void 0===s?void 0:s.map((e=>t.User.payloadify(e))),mentioned_message_template:e.mentionedMessageTemplate,sorted_metaarray:null===(i=e.metaArrays)||void 0===i?void 0:i.map((e=>c.payloadify(e))),extended_message:e.extendedMessage,extended_message_payload:e.extendedMessagePayload,created_at:e.createdAt,updated_at:e.updatedAt})))}isIdentical(e){return!0}isEqual(e){return t.deepEqual(this,e)}isUserMessage(){return this.messageType===t.MessageType.USER}isFileMessage(){return this.messageType===t.MessageType.FILE&&!Object.prototype.hasOwnProperty.call(this,"fileInfoList")}isMultipleFilesMessage(){return this.messageType===t.MessageType.FILE&&Object.prototype.hasOwnProperty.call(this,"fileInfoList")}isAdminMessage(){return this.messageType===t.MessageType.ADMIN}serialize(){return t.serialize(this)}getMetaArraysByKeys(e){return this.metaArrays.filter((t=>e.includes(t.key)))}}class m extends t.APIRequestCommand{constructor(e){super(),this.method=t.APIRequestMethod.POST,this.path=t.getFormAPIPath(e.channelUrl,e.messageId),this.params=t.deundefined({forms:e.forms})}}var _,g;exports.ScheduledStatus=void 0,(_=exports.ScheduledStatus||(exports.ScheduledStatus={})).PENDING="pending",_.SENT="sent",_.FAILED="failed",_.CANCELED="canceled",exports.InternalScheduledStatus=void 0,(g=exports.InternalScheduledStatus||(exports.InternalScheduledStatus={})).PENDING="pending",g.IN_QUEUE="in_queue",g.SENT="sent",g.FAILED="failed",g.CANCELED="canceled",g.REMOVED="removed";class y extends p{constructor(e,t){var s,i,a,o,u,c,h;super(e,t),this.parentMessage=null,this.silent=!1,this.isOperatorMessage=!1,this.threadInfo=null,this.reactions=[],this.appleCriticalAlertOptions=null,this.scheduledInfo=null,this.suggestedReplies=null,this._isContinuousMessages=!1,this._scheduledStatus=null,this.messageId=null!==(i=null!==(s=t.msg_id)&&void 0!==s?s:t.message_id)&&void 0!==i?i:0,this.parentMessageId=null!==(a="string"==typeof t.parent_message_id?parseInt(t.parent_message_id):t.parent_message_id)&&void 0!==a?a:0,this.threadInfo=t.thread_info?new n(this._iid,t.thread_info):null,this.reactions=t.reactions?t.reactions.map((e=>new r(e))):[],this.ogMetaData=t.og_tag?new l(t.og_tag):null,this.silent=null!==(o=t.silent)&&void 0!==o&&o,this.isOperatorMessage=null!==(u=t.is_op_msg)&&void 0!==u&&u,this.appleCriticalAlertOptions=t.apple_critical_alert_options?new d(t.apple_critical_alert_options):null,"number"==typeof t.scheduled_message_id&&"number"==typeof t.scheduled_at&&t.scheduled_status&&(this.scheduledInfo={scheduledMessageId:t.scheduled_message_id,scheduledAt:t.scheduled_at},this._scheduledStatus=t.scheduled_status),this._isContinuousMessages=null!==(c=t.is_continuous_messages)&&void 0!==c&&c,this.suggestedReplies=null!==(h=t.suggested_replies)&&void 0!==h?h:null}static payloadify(e){var s,i;return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{message_id:e.messageId,parent_message_id:e.parentMessageId,thread_info:e.threadInfo?n.payloadify(e.threadInfo):null,reactions:e.reactions.map((e=>r.payloadify(e))),og_tag:e.ogMetaData?l.payloadify(e.ogMetaData):null,silent:e.silent,is_op_msg:e.isOperatorMessage,apple_critical_alert_options:e.appleCriticalAlertOptions?d.payloadify(e.appleCriticalAlertOptions):null,scheduled_message_id:null===(s=e.scheduledInfo)||void 0===s?void 0:s.scheduledMessageId,scheduled_at:null===(i=e.scheduledInfo)||void 0===i?void 0:i.scheduledAt,scheduled_status:e._scheduledStatus,suggested_replies:e.suggestedReplies})))}static _getParentMessageInfoPayload(e){return t.deundefined(t.undefineNullProps({type:h(e.messageType),ts:e.createdAt,user:e.sender?u.payloadify(e.sender):null,message:e.message,file:{url:e.plainUrl,name:e.name,type:e.type,require_auth:e.requireAuth}}))}isIdentical(e){return this.messageId===e.messageId}applyThreadInfoUpdateEvent(e){return this.messageId===e.targetMessageId&&(this.threadInfo=e.threadInfo),!1}applyReactionEvent(e){if(this.messageId===e.messageId){let t=!1;for(let s=0;s<this.reactions.length;s++)if(this.reactions[s].key===e.key){this.reactions[s].applyEvent(e),this.reactions[s].isEmpty&&this.reactions.splice(s,1),t=!0;break}t||"add"!==e.operation||this.reactions.push(new r(r.payloadify({key:e.key,userIds:[e.userId],updatedAt:e.updatedAt})))}}applyParentMessage(e){if(!this.parentMessage)return this.parentMessage=e,!0;if(this.parentMessageId===e.messageId){const t=this.parentMessage.updatedAt;if(e.updatedAt>=t)return this.parentMessage=e,!0}return!1}submitForm(e){return t.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:s,sdkState:i}=t.Vault.of(this._iid),n=new m({userId:i.userId,channelUrl:this.channelUrl,channelType:this.channelType,messageId:this.messageId,forms:[{form_key:e.formId,data:e.answers}]});yield s.send(n)}))}}class f extends y{constructor(e,s){var i,n,a,r;if(super(e,s),this.reqId="",this.replyToChannel=!1,this.errorCode=0,this.sender=s.user?new u(this._iid,s.user):s.sender_id,this.reqId=null!==(n=null!==(i=s.req_id)&&void 0!==i?i:s.request_id)&&void 0!==n?n:"",this.replyToChannel=null!==(a=s.reply_to_channel)&&void 0!==a&&a,s.request_state&&t.isEnumOf(t.SendingStatus,s.request_state)&&(this.sendingStatus=s.request_state),!this.sendingStatus)if(this.messageId>0)this.sendingStatus=t.SendingStatus.SUCCEEDED;else if(this.scheduledInfo)switch(s.scheduled_status&&(this._scheduledStatus=s.scheduled_status),s.scheduled_status){case exports.InternalScheduledStatus.SENT:case exports.InternalScheduledStatus.IN_QUEUE:this.sendingStatus=t.SendingStatus.SUCCEEDED;break;case exports.InternalScheduledStatus.PENDING:this.sendingStatus=t.SendingStatus.SCHEDULED;break;case exports.InternalScheduledStatus.FAILED:case exports.InternalScheduledStatus.REMOVED:this.sendingStatus=t.SendingStatus.FAILED;break;case exports.InternalScheduledStatus.CANCELED:this.sendingStatus=t.SendingStatus.CANCELED}else this.sendingStatus=t.SendingStatus.PENDING;this.errorCode=null!==(r=s.error_code)&&void 0!==r?r:0}static payloadify(e){return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{user:u.payloadify(e.sender),req_id:e.reqId,reply_to_channel:e.replyToChannel,request_state:e.sendingStatus,error_code:e.errorCode})))}get isResendable(){return(this.sendingStatus===t.SendingStatus.FAILED||this.sendingStatus===t.SendingStatus.CANCELED)&&t.isResendableError(this.errorCode)}isIdentical(e){return this.messageId>0&&e.messageId>0?this.messageId===e.messageId:this.reqId===e.reqId}}class v{constructor(e,t,s){var i,n;this.width=0,this.height=0,this.realWidth=0,this.realHeight=0,this._requireAuth=!1,this._iid=e,this.plainUrl=t.url,this.width=t.width,this.height=t.height,this.realWidth=null!==(i=t.real_width)&&void 0!==i?i:t.width,this.realHeight=null!==(n=t.real_height)&&void 0!==n?n:t.height,this._requireAuth=s}static payloadify(e){return t.deundefined(t.undefineNullProps({url:"",width:e.maxWidth,height:e.maxHeight,real_width:0,real_height:0}))}get url(){const{sessionManager:e}=t.Vault.of(this._iid);return this._requireAuth?`${this.plainUrl}?auth=${e.ekey}`:this.plainUrl}}const I={prevResultSize:0,nextResultSize:0,isInclusive:!1,reverse:!1,messageTypeFilter:t.MessageTypeFilter.ALL,customTypesFilter:void 0,senderUserIdsFilter:void 0,includeReactions:!1,includeMetaArray:!1,includeParentMessageInfo:!1},E=e=>t.isTypeOf("number",e.prevResultSize)&&t.isTypeOf("number",e.nextResultSize)&&t.isTypeOf("boolean",e.isInclusive)&&t.isTypeOf("boolean",e.reverse)&&t.isTypeOf("string",e.messageTypeFilter)&&t.isEnumOf(t.MessageTypeFilter,e.messageTypeFilter)&&t.isArrayOf("string",e.customTypesFilter,!0)&&t.isArrayOf("string",e.senderUserIdsFilter,!0)&&t.isTypeOf("boolean",e.includeMetaArray)&&t.isTypeOf("boolean",e.includeReactions)&&t.isTypeOf("boolean",e.includeParentMessageInfo);class T extends y{constructor(e,s){var i,n,a,r;if(super(e,s),this.translations={},this.message=null!==(i=s.message)&&void 0!==i?i:"",this.messageType=t.MessageType.ADMIN,this.translations=null!==(n=s.translations)&&void 0!==n?n:{},s.parent_message_info){const i=s.parent_message_info;this.parentMessage=N(e,t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},i),{message_id:this.parentMessageId,channel_url:this.channelUrl,channel_type:this.channelType,file:i.file,url:null===(a=i.file)||void 0===a?void 0:a.url,require_auth:null===(r=i.file)||void 0===r?void 0:r.require_auth}))))}}static payloadify(e){return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{message:e.message,translations:e.translations,parent_message_info:e.parentMessage?super._getParentMessageInfoPayload(e.parentMessage):null})))}getThreadedMessagesByTimestamp(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},I),s);t.unless(this.messageId>0&&t.isTypeOf("number",e)&&E(i)).throw(t.SendbirdError.invalidParameters);const n=_i.of(this._iid);return yield n.getThreadedMessagesByTimestamp(this,e,i)}))}}class b{constructor(e){var s,i;this.detail={},this.type=null!==(s=e.type)&&void 0!==s?s:"",this.vendor=null!==(i=e.vendor)&&void 0!==i?i:"",e.detail&&t.isTypeOf("object",e.detail)&&!Array.isArray(e.detail)&&(this.detail=e.detail)}static payloadify(e){return t.deundefined(t.undefineNullProps({type:e.type,vendor:e.vendor,detail:e.detail}))}}class S{constructor(e){this.status=e.status,e.original_message_info&&(this.originalMessageInfo={createdAt:e.original_message_info.ts,messageId:e.original_message_info.id})}static payloadify(e){return t.deundefined({status:e.status,original_message_info:e.originalMessageInfo?{id:e.originalMessageInfo.messageId,ts:e.originalMessageInfo.createdAt}:void 0})}}class M extends f{constructor(e,s){var i,n,a,r,o;if(super(e,s),this.message="",this.messageParams=null,this.translations={},this.translationTargetLanguages=[],this.messageSurvivalSeconds=-1,this.plugins=[],this._poll=null,this.message=s.message,this.messageType=t.MessageType.USER,this.translations=null!==(i=s.translations)&&void 0!==i?i:{},this.translationTargetLanguages=null!==(n=s.target_langs)&&void 0!==n?n:[],0===Object.keys(this.translations).length&&this.translationTargetLanguages.length>0)for(const e of this.translationTargetLanguages)this.translations[e]="";if(this.messageSurvivalSeconds=null!==(a=s.message_survival_seconds)&&void 0!==a?a:-1,this.plugins=s.plugins?s.plugins.map((e=>new b(e))):[],this._poll=s.poll?new t.Poll(this._iid,s.poll):null,s.parent_message_info){const i=s.parent_message_info;this.parentMessage=N(e,t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},i),{created_at:i.ts,message_id:this.parentMessageId,channel_url:this.channelUrl,channel_type:this.channelType,file:i.file,url:null===(r=i.file)||void 0===r?void 0:r.url,require_auth:null===(o=i.file)||void 0===o?void 0:o.require_auth}))))}s.review_info&&(this.messageReviewInfo=new S(s.review_info))}static payloadify(e){return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{message:e.message,translations:e.translations,message_survival_seconds:e.messageSurvivalSeconds,plugins:e.plugins.map((e=>b.payloadify(e))),poll:e._poll?t.Poll.payloadify(e._poll):null,parent_message_info:e.parentMessage?super._getParentMessageInfoPayload(e.parentMessage):null,review_info:e.messageReviewInfo?S.payloadify(e.messageReviewInfo):void 0})))}getThreadedMessagesByTimestamp(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},I),s);t.unless(this.messageId>0&&t.isTypeOf("number",e)&&E(i)).throw(t.SendbirdError.invalidParameters);const n=_i.of(this._iid);return yield n.getThreadedMessagesByTimestamp(this,e,i)}))}applyPoll(e){return!(this._poll&&this._poll.id===e.id&&this._poll.updatedAt>e.updatedAt)&&(this._poll=e,!0)}get poll(){return this._poll}}class O extends t.InstancedObject{constructor(e,t){var s,i,n,a,r;super(e),this.plainUrl="",this.fileName=null,this.mimeType=null,this.fileSize=0,this.thumbnails=[],this._requireAuth=!1,this.plainUrl=null!==(s=t.url)&&void 0!==s?s:"",this.fileName=null!==(i=t.file_name)&&void 0!==i?i:null,this.mimeType=null!==(n=t.file_type)&&void 0!==n?n:null,this.fileSize=null!==(a=t.file_size)&&void 0!==a?a:0,this._requireAuth=null!==(r=t.require_auth)&&void 0!==r&&r,this.thumbnails=t.thumbnails?t.thumbnails.map((e=>{var t;return new v(this._iid,"string"==typeof e?{url:e,width:0,height:0}:Object.assign(Object.assign({},e),{url:(null!==(t=e.url)&&void 0!==t?t:"").split("auth=")[0]}),this._requireAuth)})):[]}static payloadify(e){var s;return t.deundefined(t.undefineNullProps({url:e.plainUrl,file_name:e.fileName,file_type:e.mimeType,file_size:e.fileSize,thumbnails:null===(s=e.thumbnails)||void 0===s?void 0:s.map((e=>({url:e.url,width:e.width,height:e.height,real_width:e.realWidth,real_height:e.realHeight}))),require_auth:e._requireAuth}))}get url(){const{sessionManager:e}=t.Vault.of(this._iid);return this._requireAuth?`${this.plainUrl}?auth=${e.ekey}`:this.plainUrl}}class A extends f{constructor(e,s){var i,n,a,r,o;if(super(e,s),this.messageParams=null,this.fileInfoList=[],this.messageSurvivalSeconds=-1,this.messageType=t.MessageType.FILE,this.fileInfoList=null!==(n=null===(i=s.files)||void 0===i?void 0:i.map((t=>new O(e,t))))&&void 0!==n?n:[],this.messageSurvivalSeconds=null!==(a=s.message_survival_seconds)&&void 0!==a?a:-1,s.parent_message_info){const i=s.parent_message_info;this.parentMessage=N(e,t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},i),{created_at:i.ts,message_id:this.parentMessageId,channel_url:this.channelUrl,channel_type:this.channelType,file:i.file,url:null===(r=i.file)||void 0===r?void 0:r.url,require_auth:null===(o=i.file)||void 0===o?void 0:o.require_auth}))))}}getThreadedMessagesByTimestamp(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},I),s);t.unless(this.messageId>0&&t.isTypeOf("number",e)&&E(i)).throw(t.SendbirdError.invalidParameters);const n=_i.of(this._iid);return yield n.getThreadedMessagesByTimestamp(this,e,i)}))}static payloadify(e){return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{files:e.fileInfoList&&e.fileInfoList&&Array.isArray(e.fileInfoList)?e.fileInfoList.map((e=>O.payloadify(e))):null,message_survival_seconds:e.messageSurvivalSeconds,parent_message_info:e.parentMessage?super._getParentMessageInfoPayload(e.parentMessage):null})))}static _isMultipleFilesMessagePayload(e){const t=e.files;return Array.isArray(t)&&t.length>=2}static _isMultipleFilesMessageSerializedData(e){const t=e.fileInfoList;return Array.isArray(t)}}var C;exports.NotificationMessageStatus=void 0,(C=exports.NotificationMessageStatus||(exports.NotificationMessageStatus={})).SENT="SENT",C.READ="READ";class w extends p{constructor(e,s){var i;if(super(e,s),this.notificationData=null,this.notificationId=s.notification_message_id,this.messageType=t.MessageType.ADMIN,this.messageStatus=null!==(i=s.message_status)&&void 0!==i?i:exports.NotificationMessageStatus.SENT,0===this.extendedMessage.sub_type)try{const{label:e,tags:t=[],template_key:s,template_variables:i}=JSON.parse(this.extendedMessage.sub_data);this.notificationData={label:e,tags:t,templateKey:s,templateVariables:i}}catch(e){}}static payloadify(e){return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{notification_message_id:e.notificationId,message_status:e.messageStatus})))}isIdentical(e){return this.notificationId===e.notificationId}}const N=(e,t)=>{if(t.notification_message_id)return new w(e,t);switch(t.type){case"MESG":return new M(e,t);case"FILE":return A._isMultipleFilesMessagePayload(t)?new A(e,t):new P(e,t);case"ADMM":case"BRDM":return new T(e,t);default:return null}};class P extends f{constructor(e,s){var i,n,a,r,o,l,d,u,c,h,p,m,_,g;super(e,s),this.messageParams=null,this.plainUrl="",this.requireAuth=!1,this.thumbnails=[],this.messageSurvivalSeconds=-1,this.messageType=t.MessageType.FILE;const y=s.file;if(this.plainUrl=(null!==(n=null!==(i=null==y?void 0:y.url)&&void 0!==i?i:s.url)&&void 0!==n?n:"").split("?auth=")[0],this.name=null!==(r=null!==(a=null==y?void 0:y.name)&&void 0!==a?a:s.name)&&void 0!==r?r:"File",this.size=null!==(l=null!==(o=null==y?void 0:y.size)&&void 0!==o?o:s.size)&&void 0!==l?l:0,this.data=null!==(u=null!==(d=null==y?void 0:y.data)&&void 0!==d?d:s.custom)&&void 0!==u?u:"",this.type=y?null!==(c=y.type)&&void 0!==c?c:"":null!==(h=s.type)&&void 0!==h?h:"",this.requireAuth=null!==(p=s.require_auth)&&void 0!==p&&p,this.thumbnails=s.thumbnails?s.thumbnails.map((e=>{var t;return new v(this._iid,"string"==typeof e?{url:e,width:0,height:0}:Object.assign(Object.assign({},e),{url:(null!==(t=e.url)&&void 0!==t?t:"").split("auth=")[0]}),this.requireAuth)})):[],this.messageSurvivalSeconds=null!==(m=s.message_survival_seconds)&&void 0!==m?m:-1,s.parent_message_info){const i=s.parent_message_info;this.parentMessage=N(e,t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},i),{created_at:i.ts,message_id:this.parentMessageId,channel_url:this.channelUrl,channel_type:this.channelType,file:i.file,url:null===(_=i.file)||void 0===_?void 0:_.url,require_auth:null===(g=i.file)||void 0===g?void 0:g.require_auth}))))}}static payloadify(e){var s;return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{url:e.plainUrl,require_auth:e.requireAuth,file:{name:e.name,size:e.size,type:e.type,data:e.data},thumbnails:null===(s=e.thumbnails)||void 0===s?void 0:s.map((e=>({url:e.plainUrl,width:e.width,height:e.height,real_width:e.realWidth,real_height:e.realHeight}))),message_survival_seconds:e.messageSurvivalSeconds,parent_message_info:e.parentMessage?super._getParentMessageInfoPayload(e.parentMessage):null})))}get url(){const{sessionManager:e}=t.Vault.of(this._iid);return this.requireAuth?`${this.plainUrl}?auth=${e.ekey}`:this.plainUrl}getThreadedMessagesByTimestamp(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},I),s);t.unless(this.messageId>0&&t.isTypeOf("number",e)&&E(i)).throw(t.SendbirdError.invalidParameters);const n=_i.of(this._iid);return yield n.getThreadedMessagesByTimestamp(this,e,i)}))}}class U extends t.InstancedObject{static getPlainUrl(e){return e instanceof U?e._plainUrl:e.fileUrl}constructor(e,{file:t,fileUrl:s,fileName:i,fileSize:n,mimeType:a,thumbnailSizes:r,_uploadedMetaData:o}){super(e),this._plainUrl=s,this.file=t,this.fileName=i,this.fileSize=n,this.mimeType=a,this.thumbnailSizes=r,this._uploadedMetaData=o}get fileUrl(){var e;if(this._plainUrl&&(null===(e=this._uploadedMetaData)||void 0===e?void 0:e.requireAuth)){const{sessionManager:e}=t.Vault.of(this._iid);return`${this._plainUrl}?auth=${e.ekey}`}return this._plainUrl}set fileUrl(e){this._plainUrl=e}toJSON(){return{file:this.file,fileUrl:this._plainUrl,fileName:this.fileName,fileSize:this.fileSize,mimeType:this.mimeType,thumbnailSizes:this.thumbnailSizes,_uploadedMetaData:this._uploadedMetaData}}}class x extends t.WebSocketRequestCommand{constructor(e){var s,i,n;let a=[];e.mentionType===t.MentionType.USERS&&(e.mentionedUserIds?a=e.mentionedUserIds:e.mentionedUsers&&(a=e.mentionedUsers.map((e=>e.userId)))),super({code:"FILE",ackRequired:!0,payload:t.deundefined(t.undefineNullProps({channel_url:e.channelUrl,files:e.files?D(e.files):null,url:e.url,name:null!==(s=e.fileName)&&void 0!==s?s:"",type:null!==(i=e.mimeType)&&void 0!==i?i:"",size:null!==(n=e.fileSize)&&void 0!==n?n:0,custom:e.data,custom_type:e.customType,thumbnails:e.thumbnailSizes,require_auth:e.requireAuth,metaarray:e.metaArrays,mention_type:e.mentionType,mentioned_user_ids:a,push_option:e.pushNotificationDeliveryOption&&e.pushNotificationDeliveryOption!==t.PushNotificationDeliveryOption.DEFAULT?e.pushNotificationDeliveryOption:void 0,apple_critical_alert_options:e.appleCriticalAlertOptions?d.payloadify(e.appleCriticalAlertOptions):null,silent:e.silent,reply_to_channel:e.isReplyToChannel,parent_message_id:e.parentMessageId?e.parentMessageId:null,req_id:e.reqId,pin_message:e.isPinnedMessage}))})}}class R extends t.APIRequestCommand{constructor(e){var s,i;super();let n=[];e.mentionType===t.MentionType.USERS&&(e.mentionedUserIds?n=e.mentionedUserIds:e.mentionedUsers&&(n=e.mentionedUsers.map((e=>e.userId)))),this.method=t.APIRequestMethod.POST,this.path=`${t.getChannelApiPathByType(e.channelType)}/${encodeURIComponent(e.channelUrl)}/messages`,this.params=t.deundefined(t.undefineNullProps({message_type:t.MessageType.FILE,user_id:e.userId,files:e.files?D(e.files):null,url:e.fileUrl,mention_type:e.mentionType,mentioned_user_ids:n,file_name:e.fileName,file_size:e.fileSize,file_type:e.mimeType,data:e.data,custom_type:e.customType,thumbnails:null===(s=e.thumbnailSizes)||void 0===s?void 0:s.map((e=>v.payloadify(e))),require_auth:e.requireAuth,sorted_metaarray:null===(i=e.metaArrays)||void 0===i?void 0:i.map((e=>c.payloadify(e))),push_option:e.pushNotificationDeliveryOption,parent_message_id:e.parentMessageId?e.parentMessageId:null,apple_critical_alert_options:e.appleCriticalAlertOptions?d.payloadify(e.appleCriticalAlertOptions):null,reply_to_channel:e.isReplyToChannel,req_id:e.reqId,pin_message:e.isPinnedMessage}))}}class L extends t.WebSocketEventCommand{constructor(e,s,i){var n,a,r,o;super(e,"FILE",i),this.message=i.files&&i.files.length>=2?new A(e,i):new P(e,i);const{sdkState:l}=t.Vault.of(e);this.isMentioned=t.checkIfMentioned(this.message.mentionType,null!==(r=null!==(n=this.message.mentionedUserIds)&&void 0!==n?n:null===(a=this.message.mentionedUsers)||void 0===a?void 0:a.map((e=>e.userId)))&&void 0!==r?r:[],l.userId),this.forceUpdateLastMessage=null!==(o=i.force_update_last_message)&&void 0!==o&&o}}class k extends t.APIResponseCommand{constructor(e,s){var i,n,a,r;super(e,s),this.message=s.files&&s.files.length>=2?new A(e,s):new P(e,s);const{sdkState:o}=t.Vault.of(e);this.isMentioned=t.checkIfMentioned(this.message.mentionType,null!==(a=null!==(i=this.message.mentionedUserIds)&&void 0!==i?i:null===(n=this.message.mentionedUsers)||void 0===n?void 0:n.map((e=>e.userId)))&&void 0!==a?a:[],o.userId),this.forceUpdateLastMessage=null!==(r=s.force_update_last_message)&&void 0!==r&&r}}function D(e){return e.map((e=>{var s,i;return t.deundefined(t.undefineNullProps({url:U.getPlainUrl(e),file_name:e.fileName,file_type:e.mimeType,file_size:e.fileSize,thumbnails:null===(s=e.thumbnailSizes)||void 0===s?void 0:s.map((e=>v.payloadify(e))),require_auth:null===(i=e._uploadedMetaData)||void 0===i?void 0:i.requireAuth}))}))}var q;!function(e){e[e.PENDING=0]="PENDING",e[e.UPLOADING=1]="UPLOADING",e[e.UPLOADED=2]="UPLOADED",e[e.SENDING=3]="SENDING",e[e.FAILED=4]="FAILED"}(q||(q={}));class F{constructor(e,{sdkState:s,dispatcher:i,requestQueue:n,onlineDetector:a,cacheContext:r}){this._queueMap=new Map,this._iid=e,this._sdkState=s,this._requestQueue=n,this._cacheContext=r,this._dispatcher=i,this._dispatcher.on((e=>{e instanceof t.ConnectionStateChangeCommand&&(this._connectionState=e.stateType)})),this._onlineDetector=a}get _shouldSendThroughWebSocket(){return this._connectionState===t.ConnectionStateType.CONNECTED||this._connectionState===t.ConnectionStateType.CONNECTING||this._connectionState===t.ConnectionStateType.RECONNECTING}_sendFileMessage(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const t=this._createSendFileMessageRequestParams(e,s);if(this._shouldSendThroughWebSocket){const e=new x(t),s=yield this._requestQueue.send(e),{message:i}=s.as(L);return i}{const e=new R(Object.assign(Object.assign({},t),{userId:this._sdkState.userId})),s=yield this._requestQueue.send(e),{message:i}=s.as(k);return i}}))}_createSendFileMessageRequestParams(e,t){const s=Object.assign(Object.assign({},t.params),{channelUrl:e.url,channelType:e.channelType,reqId:t.requestId,url:""});if(t.multipleFileUploadInfo){const e=t.params;s.files=e.fileInfoList}else{const e=t.params;s.url=e.fileUrl,s.requireAuth=e.requireAuth}return s}_resolveMessageQueue(e){var s;return t.__awaiter(this,void 0,void 0,(function*(){const i=this._queueMap.get(e.url);if(i)if(i.isResolving)i.isResolveRequestPending=!0;else{i.isResolving=!0;const n=[];let a=!0;for(const r of i.messageQueue)switch(r.state){case q.PENDING:case q.UPLOADING:a=!1,n.push(r);break;case q.UPLOADED:if(a)try{r.state=q.SENDING;const s=yield this._sendFileMessage(e,r);r.deferred.resolve(s),yield t.sleep(100)}catch(e){r.deferred.reject(e)}else n.push(r);break;case q.FAILED:{const e=null!==(s=r.error)&&void 0!==s?s:t.SendbirdError.unknown;r.deferred.reject(e.code===t.SendbirdErrorCode.REQUEST_CANCELED?t.SendbirdError.fileUploadCanceled:e);break}}const r=i.isResolveRequestPending;i.messageQueue=n,i.isResolving=!1,i.isResolveRequestPending=!1,r&&(yield this._resolveMessageQueue(e))}}))}_uploadNextPendingItem(e){var s;return t.__awaiter(this,void 0,void 0,(function*(){const i=this._queueMap.get(e.url);if(i){const n=i.messageQueue.find((e=>e.state===q.PENDING));if(n){if(n.multipleFileUploadInfo){const{uploadIndex:a,uploadCount:r,requestHandler:o}=n.multipleFileUploadInfo,l=n.params,d=l.fileInfoList[a];t.isFile(d.file)&&!(null===(s=d._uploadedMetaData)||void 0===s?void 0:s.isUploaded)?yield this._tryUploadNextItemAndUpdateItemState(e,i,n):n.state=a<r-1?q.PENDING:q.UPLOADED;const u=l.fileInfoList[a],c=n.multipleFileUploadInfo.uploadIndex++;n.multipleFileUploadInfo.isCopy||null==o||o._triggerOnFileUploaded(n.requestId,c,u,n.error)}else{const s=n.params;t.isFile(s.file)?yield this._tryUploadNextItemAndUpdateItemState(e,i,n):(s.thumbnailSizes=[],n.state=q.UPLOADED)}this._uploadNextPendingItem(e),yield this._resolveMessageQueue(e)}}}))}_tryUploadNextItemAndUpdateItemState(e,s,i){return t.__awaiter(this,void 0,void 0,(function*(){const n=yield this._onlineDetector.isOnline(),{sessionManager:a}=t.Vault.of(this._iid);if(!a.currentUser||!n)return i.error=t.SendbirdError.connectionRequired,void(i.state=q.FAILED);if(s.uploadQueue.length<6){i.state=q.UPLOADING,s.uploadQueue.push(i);try{if(i.multipleFileUploadInfo){const{uploadIndex:t,uploadCount:s}=i.multipleFileUploadInfo,n=i.params;yield this._uploadNextFileForMultipleFilesItemAndUpdateParams(e,i,n),i.state=t<s-1?q.PENDING:q.UPLOADED}else{const t=i.params;yield this._uploadNextFileForSingleFileItemAndUpdateParams(e,i,t),i.state=q.UPLOADED}}catch(e){switch(e.code){case t.SendbirdErrorCode.REQUEST_FAILED:i.error=new t.SendbirdError({code:t.SendbirdErrorCode.NETWORK_ERROR,message:"Failed to upload a file."});break;case t.SendbirdErrorCode.REQUEST_CANCELED:i.error=t.SendbirdError.fileUploadCanceled;break;default:i.error=e}i.state=q.FAILED}this._dequeueUploadItem(s,i)}}))}_dequeueUploadItem(e,t){const s=e.uploadQueue.findIndex((e=>e.requestId===t.requestId));s>=0&&e.uploadQueue.splice(s,1)}_uploadNextFileForSingleFileItemAndUpdateParams(e,n,a){var r,o,l;return t.__awaiter(this,void 0,void 0,(function*(){const t=new s({file:a.file,channelUrl:e.url,thumbnailSizes:a.thumbnailSizes,requestId:n.requestId}),d=yield this._requestQueue.send(t),{url:u,fileSize:c=a.fileSize,thumbnailSizes:h=a.thumbnailSizes,requireAuth:p=!1}=d.as(i);a.fileName=null!==(r=a.fileName)&&void 0!==r?r:a.file.name,a.mimeType=null!==(o=a.mimeType)&&void 0!==o?o:a.file.type,a.fileSize=null!==(l=a.fileSize)&&void 0!==l?l:a.file.size,a.fileUrl=u,a.fileSize=c,a.thumbnailSizes=h,a.requireAuth=p}))}_uploadNextFileForMultipleFilesItemAndUpdateParams(e,n,a){var r,o,l;return t.__awaiter(this,void 0,void 0,(function*(){const{uploadIndex:t}=n.multipleFileUploadInfo,d=a.fileInfoList[t],u=new s({file:d.file,channelUrl:e.url,thumbnailSizes:d.thumbnailSizes,requestId:n.requestId}),c=yield this._requestQueue.send(u),{url:h,fileSize:p=d.fileSize,thumbnailSizes:m=d.thumbnailSizes,requireAuth:_=!1}=c.as(i);d.fileName=null!==(r=d.fileName)&&void 0!==r?r:d.file.name,d.mimeType=null!==(o=d.mimeType)&&void 0!==o?o:d.file.type,d.fileSize=null!==(l=d.fileSize)&&void 0!==l?l:d.file.size,d.file=void 0,d.fileUrl=h,d.fileSize=p,d.thumbnailSizes=m,d._uploadedMetaData=Object.assign(Object.assign({},d._uploadedMetaData),{requireAuth:_,isUploaded:!0}),d instanceof U||(a.fileInfoList[t]=new U(this._iid,d))}))}request(e,s,i,n={}){return t.__awaiter(this,void 0,void 0,(function*(){if(!this._queueMap.has(e.url)){const t={messageQueue:[],uploadQueue:[],isResolving:!1,isResolveRequestPending:!1};this._queueMap.set(e.url,t)}const a=this._queueMap.get(e.url),r=new t.Deferred,o={requestId:s,params:i,state:q.PENDING,deferred:r};if(function(e){return"fileInfoList"in e}(i)){const e=i,t=Object.assign({uploadIndex:0,uploadCount:e.fileInfoList.length},n);o.multipleFileUploadInfo=t}return a.messageQueue.push(o),this._uploadNextPendingItem(e),r.promise}))}cancel(e,s){const i=this._queueMap.get(e.url);if(i){const n=s?[i.messageQueue.find((e=>e.requestId===s))]:[...i.messageQueue];for(const s of n)if(s)switch(s.state){case q.PENDING:if(s.state=q.FAILED,s.error=t.SendbirdError.requestCanceled,s.multipleFileUploadInfo&&!s.multipleFileUploadInfo.isCopy){const{uploadIndex:e,requestHandler:i}=s.multipleFileUploadInfo,n=s.params.fileInfoList[e];null==i||i._triggerOnFileUploaded(s.requestId,e,n,t.SendbirdError.fileUploadCanceled)}this._resolveMessageQueue(e);break;case q.UPLOADING:this._requestQueue.cancel(s.requestId)}}}}const B={prevResultSize:0,nextResultSize:0,isInclusive:!1,reverse:!1,messageTypeFilter:t.MessageTypeFilter.ALL,customTypesFilter:void 0,senderUserIdsFilter:void 0,replyType:t.ReplyType.NONE,includeReactions:!1,includeMetaArray:!1,includeParentMessageInfo:!1,includeThreadInfo:!1,showSubchannelMessagesOnly:!1},j=e=>t.isTypeOf("number",e.prevResultSize)&&t.isTypeOf("number",e.nextResultSize)&&t.isTypeOf("boolean",e.isInclusive)&&t.isTypeOf("boolean",e.reverse)&&t.isTypeOf("string",e.messageTypeFilter)&&t.isEnumOf(t.MessageTypeFilter,e.messageTypeFilter)&&t.isArrayOf("string",e.customTypesFilter,!0)&&t.isArrayOf("string",e.senderUserIdsFilter,!0)&&t.isEnumOf(t.ReplyType,e.replyType)&&t.isTypeOf("boolean",e.includeMetaArray)&&t.isTypeOf("boolean",e.includeReactions)&&t.isTypeOf("boolean",e.includeParentMessageInfo)&&t.isTypeOf("boolean",e.includeThreadInfo)&&t.isTypeOf("boolean",e.showSubchannelMessagesOnly),z={replyType:t.ReplyType.NONE,includeReactions:!1,includeThreadInfo:!1,includeMetaArray:!1,includeParentMessageInfo:!1},V=e=>t.isEnumOf(t.ReplyType,e.replyType)&&t.isTypeOf("boolean",e.includeReactions)&&t.isTypeOf("boolean",e.includeMetaArray)&&t.isTypeOf("boolean",e.includeParentMessageInfo)&&t.isTypeOf("boolean",e.includeThreadInfo);class $ extends t.APIRequestCommand{constructor({channelType:e,channelUrl:s,messageId:i,includeMetaArray:n,includeReactions:a,includeThreadInfo:r,includeParentMessageInfo:o}){super(),this.method=t.APIRequestMethod.GET,this.path=`${t.getChannelApiPathByType(e)}/${encodeURIComponent(s)}/messages/${encodeURIComponent(i)}`,this.params={is_sdk:!0,with_sorted_meta_array:n,include_reactions:a,include_thread_info:r,include_parent_message_info:o,include_poll_details:!0}}}class Q extends t.APIResponseCommand{constructor(e,t){super(e,t),this.message=t?N(e,Object.assign({},t)):null}}class K extends t.APIRequestCommand{constructor({channelType:e,channelUrl:s,timestamp:i,token:n,prevResultSize:a,nextResultSize:r,isInclusive:o,reverse:l,messageTypeFilter:d,customTypesFilter:u,senderUserIdsFilter:c,replyType:h,includeMetaArray:p,includeReactions:m,parentMessageId:_,includeThreadInfo:g,includeParentMessageInfo:y,showSubchannelMessagesOnly:f,checkingHasNext:v,checkingContinuousMessages:I}){super(),this.method=t.APIRequestMethod.GET,this.path=`${t.getChannelApiPathByType(e)}/${encodeURIComponent(s)}/messages`,this.params=t.deundefined(t.undefineNullProps({is_sdk:!0,prev_limit:a,next_limit:r,include:o,reverse:l,message_ts:i,message_id:n,message_type:null!=d?d:null,custom_types:u,sender_ids:c,include_reply_type:h,with_sorted_meta_array:p,include_reactions:m,parent_message_id:_,include_thread_info:g,include_parent_message_info:y,show_subchannel_message_only:f,include_poll_details:!0,checking_has_next:v,checking_continuous_messages:I}))}}class G extends t.APIResponseCommand{constructor(e,t){super(e,t),void 0!==t.is_continuous_messages&&(this.isContinuousMessages=t.is_continuous_messages),void 0!==t.has_next&&(this.hasNext=t.has_next),this.messages=t.messages.map((t=>N(e,t)))}}class H extends t.APIRequestCommand{constructor({channelType:e,channelUrl:s,timestamp:i,token:n,replyType:a,includeMetaArray:r,includeReactions:o,includeThreadInfo:l,includeParentMessageInfo:d}){super(),this.method=t.APIRequestMethod.GET,this.path=`${t.getChannelApiPathByType(e)}/${encodeURIComponent(s)}/messages/changelogs`,this.params={change_ts:i,token:n,with_sorted_meta_array:r,include_reactions:o,include_thread_info:l,include_reply_type:a,include_parent_message_info:d,include_poll_details:!0}}}class W extends t.APIResponseCommand{constructor(e,t){super(e,t),this.updatedMessages=t.updated.map((t=>N(e,t))),this.deletedMessagesInfo=t.deleted.map((e=>({messageId:e.message_id,deletedAt:e.deleted_at}))),this.hasMore=t.has_more,this.nextToken=t.next}}class Y extends t.APIRequestCommand{constructor({channelUrl:e,scheduledMessageId:s}){super(),this.method=t.APIRequestMethod.GET,this.path=`${t.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(e)}/scheduled_messages/${encodeURIComponent(s)}`,this.params={}}}class J extends t.APIResponseCommand{constructor(e,t){super(e,t),this.message=t?N(e,Object.assign({},t)):null}}var X;exports.RestrictionType=void 0,(X=exports.RestrictionType||(exports.RestrictionType={})).MUTED="muted",X.BANNED="banned";class Z{constructor(e){var s,i,n,a;this.restrictionType=null,t.isEnumOf(exports.RestrictionType,e.restriction_type)&&(this.restrictionType=e.restriction_type),this.description=null!==(s=e.description)&&void 0!==s?s:null,this.endAt=null!==(n=null!==(i=e.end_at)&&void 0!==i?i:e.muted_end_at)&&void 0!==n?n:-1,this.remainingDuration=null!==(a=e.remaining_duration)&&void 0!==a?a:-1}static payloadify(e){return t.deundefined(t.undefineNullProps({restriction_type:e.restrictionType,description:e.description,end_at:e.endAt,remaining_duration:e.remainingDuration}))}}class ee extends t.User{constructor(e,t){super(e,t),this.restrictionInfo=new Z(t)}static payloadify(e){return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),Z.payloadify(e.restrictionInfo))))}}class te{constructor(){this._onPending=t.noop,this._onFailed=t.noop,this._onSucceeded=t.noop}_trigger(e){switch(null==e?void 0:e.sendingStatus){case t.SendingStatus.PENDING:0===e.errorCode&&this._onPending(e);break;case t.SendingStatus.SCHEDULED:case t.SendingStatus.SUCCEEDED:this._onSucceeded(e)}}_triggerFailed(e,s){switch(null==s?void 0:s.sendingStatus){case t.SendingStatus.FAILED:case t.SendingStatus.CANCELED:this._onFailed(e,s.scheduledInfo?null:s)}}onPending(e){return this._onPending=e,this}onFailed(e){return this._onFailed=e,this}onSucceeded(e){return this._onSucceeded=e,this}}const se={data:void 0,customType:void 0,mentionType:t.MentionType.USERS,mentionedUserIds:void 0,mentionedUsers:void 0,mentionedMessageTemplate:void 0,metaArrays:void 0,parentMessageId:void 0,isReplyToChannel:!1,pushNotificationDeliveryOption:void 0,appleCriticalAlertOptions:void 0,isPinnedMessage:!1},ie=e=>t.isTypeOf("string",e.data,!0)&&t.isTypeOf("string",e.customType,!0)&&t.isEnumOf(t.MentionType,e.mentionType)&&t.isArrayOf("string",e.mentionedUserIds,!0)&&t.isArrayOf(t.User,e.mentionedUsers,!0)&&t.isTypeOf("string",e.mentionedMessageTemplate,!0)&&t.isArrayOf(c,e.metaArrays,!0)&&t.isTypeOf("number",e.parentMessageId,!0)&&t.isTypeOf("boolean",e.isReplyToChannel)&&t.isEnumOf(t.PushNotificationDeliveryOption,e.pushNotificationDeliveryOption,!0)&&t.isTypeOf(d,e.appleCriticalAlertOptions,!0)&&t.isTypeOf("boolean",e.isPinnedMessage,!0),ne=e=>({isReplyToChannel:e.isReplyToChannel,pushNotificationDeliveryOption:e.pushNotificationDeliveryOption,pollId:e.pollId}),ae=Object.assign(Object.assign({},se),{message:"",translationTargetLanguages:void 0,pollId:void 0});function re(e){var s,i,n;return null!==(s=e.messageParams)&&void 0!==s?s:t.undefineNullProps(Object.assign(Object.assign({},e),{mentionType:e.mentionType,mentionedUserIds:null!==(i=e.mentionedUserIds)&&void 0!==i?i:null===(n=e.mentionedUsers)||void 0===n?void 0:n.map((e=>e.userId)),translationTargetLanguages:Object.keys(e.translations),pushNotificationDeliveryOption:t.PushNotificationDeliveryOption.DEFAULT,parentMessageId:null,isReplyToChannel:!1,isPinnedMessage:!1}))}const oe=e=>{var s;return t.deundefined(t.undefineNullProps({data:e.data,customType:e.customType,mentionType:e.mentionType,mentionedUsers:e.mentionedUsers,mentionedUserIds:e.mentionedUserIds,mentionedMessageTemplate:e.mentionedMessageTemplate,metaArrays:e.metaArrays,pollId:null===(s=e.poll)||void 0===s?void 0:s.id,parentMessageId:e.parentMessageId,appleCriticalAlertOptions:e.appleCriticalAlertOptions,message:e.message,translationTargetLanguages:Object.keys(e.translations)}))},le=e=>ie(e)&&t.isTypeOf("string",e.message)&&t.isArrayOf("string",e.translationTargetLanguages,!0)&&t.isTypeOf("number",e.pollId,!0);var de;!function(e){e.FILE="file",e.BLOB="blob",e.BLOB_LIKE_OBJECT="blobLikeObject",e.URL="url"}(de||(de={}));const ue=e=>"undefined"!=typeof window&&"Blob"in window&&"undefined"!=typeof Blob&&e instanceof Blob,ce=e=>e===de.BLOB||e===de.FILE,he=e=>({file:e.file,fileKey:e.fileKey,fileType:e.fileType,isReplyToChannel:e.isReplyToChannel,pushNotificationDeliveryOption:e.pushNotificationDeliveryOption}),pe=Object.assign(Object.assign({},se),{file:void 0,fileKey:void 0,fileUrl:void 0,fileName:void 0,fileType:void 0,fileSize:void 0,mimeType:void 0,thumbnailSizes:void 0,requireAuth:!1});function me(e){var s,i,n,a;return null!==(s=e.messageParams)&&void 0!==s?s:t.undefineNullProps(Object.assign(Object.assign({},e),{fileUrl:e.plainUrl,fileName:e.name,fileSize:e.size,mimeType:e.type,mentionType:e.mentionType,mentionedUserIds:null!==(i=e.mentionedUserIds)&&void 0!==i?i:null===(n=e.mentionedUsers)||void 0===n?void 0:n.map((e=>e.userId)),pushNotificationDeliveryOption:t.PushNotificationDeliveryOption.DEFAULT,parentMessageId:null,isReplyToChannel:!1,thumbnailSizes:null===(a=e.thumbnails)||void 0===a?void 0:a.map((e=>({maxWidth:e.width,maxHeight:e.height}))),requireAuth:e.requireAuth,isPinnedMessage:!1}))}const _e=(e,s)=>{var i;return e.messageParams?(!e.url&&t.isFile(s)&&(e.messageParams.file=s),e.messageParams):t.deundefined(t.undefineNullProps({data:e.data,customType:e.customType,mentionType:e.mentionType,mentionedUsers:e.mentionedUsers,mentionedUserIds:e.mentionedUserIds,metaArrays:e.metaArrays,parentMessageId:e.parentMessageId,appleCriticalAlertOptions:e.appleCriticalAlertOptions,file:s,fileUrl:e.url,fileName:e.name,fileSize:e.size,mimeType:e.type,thumbnailSizes:null===(i=e.thumbnails)||void 0===i?void 0:i.map((e=>({maxWidth:e.width,maxHeight:e.height})))}))},ge=e=>ie(e)&&(t.isFile(e.file)||t.isTypeOf("string",e.fileUrl))&&t.isTypeOf("string",e.fileName,!0)&&t.isTypeOf("string",e.mimeType,!0)&&t.isTypeOf("number",e.fileSize,!0)&&(null===e.thumbnailSizes||void 0===e.thumbnailSizes||Array.isArray(e.thumbnailSizes)&&e.thumbnailSizes.every((e=>t.isTypeOf("object",e)&&e.maxWidth>0&&e.maxHeight>0))),ye={data:void 0,customType:void 0,mentionType:t.MentionType.USERS,mentionedUserIds:void 0,mentionedUsers:void 0,mentionedMessageTemplate:void 0,metaArrays:void 0,pushNotificationDeliveryOption:void 0,appleCriticalAlertOptions:void 0},fe=e=>t.isTypeOf("string",e.data,!0)&&t.isTypeOf("string",e.customType,!0)&&t.isEnumOf(t.MentionType,e.mentionType)&&t.isArrayOf("string",e.mentionedUserIds,!0)&&t.isArrayOf(t.User,e.mentionedUsers,!0)&&t.isTypeOf("string",e.mentionedMessageTemplate,!0)&&t.isArrayOf(c,e.metaArrays,!0)&&t.isEnumOf(t.PushNotificationDeliveryOption,e.pushNotificationDeliveryOption,!0)&&t.isTypeOf(d,e.appleCriticalAlertOptions,!0),ve=Object.assign(Object.assign({},ye),{message:void 0,translationTargetLanguages:void 0,pollId:void 0}),Ie=e=>fe(e)&&t.isTypeOf("string",e.message,!0)&&t.isArrayOf("string",e.translationTargetLanguages,!0)&&t.isTypeOf("number",e.pollId,!0),Ee=Object.assign({},ye);class Te extends t.APIRequestCommand{constructor({channelUrl:e,channelType:s,token:i,limit:n}){super(),this.method=t.APIRequestMethod.GET,this.path=`${t.getChannelApiPathByType(s)}/${encodeURIComponent(e)}/operators`,this.params={token:i,limit:n}}}class be extends t.APIResponseCommand{constructor(e,s){super(e,s),this.operators=s.operators.map((s=>new t.User(e,s))),this.token=s.next}}class Se extends t.ChannelDataListQuery{constructor(e,t,s,i){super(e,t,s,i)}_validate(){return super._validate()}next(){return t.__awaiter(this,void 0,void 0,(function*(){if(this._validate()){if(this._isLoading)throw t.SendbirdError.queryInProgress;{const e=[];if(this._hasNext){this._isLoading=!0;const{requestQueue:e}=t.Vault.of(this._iid),s=new Te(Object.assign(Object.assign({},this),{channelUrl:this.channelUrl,token:this._token})),i=yield e.send(s),{operators:n,token:a}=i.as(be);return this._token=a,this._hasNext=!!a,this._isLoading=!1,n}return e}}throw t.SendbirdError.invalidParameters}))}}class Me extends t.ChannelDataListQuery{constructor(e,s,i,n){var a,r,o,l,d,u,c,h,p,m;super(e,s,i,n),this.reverse=!1,this.messageTypeFilter=t.MessageTypeFilter.ALL,this.customTypesFilter=null,this.senderUserIdsFilter=null,this.replyType=t.ReplyType.NONE,this.includeMetaArray=!1,this.includeReactions=!1,this.includeParentMessageInfo=!1,this.includeThreadInfo=!1,this.showSubchannelMessagesOnly=!1,this._edge=Number.MAX_SAFE_INTEGER,this.reverse=null!==(a=n.reverse)&&void 0!==a&&a,this.messageTypeFilter=null!==(r=n.messageTypeFilter)&&void 0!==r?r:t.MessageTypeFilter.ALL,this.customTypesFilter=null!==(o=n.customTypesFilter)&&void 0!==o?o:null,this.senderUserIdsFilter=null!==(l=n.senderUserIdsFilter)&&void 0!==l?l:null,this.replyType=null!==(d=n.replyType)&&void 0!==d?d:t.ReplyType.NONE,this.includeMetaArray=null!==(u=n.includeMetaArray)&&void 0!==u&&u,this.includeReactions=null!==(c=n.includeReactions)&&void 0!==c&&c,this.includeParentMessageInfo=null!==(h=n.includeParentMessageInfo)&&void 0!==h&&h,this.includeThreadInfo=null!==(p=n.includeThreadInfo)&&void 0!==p&&p,this.showSubchannelMessagesOnly=null!==(m=n.showSubchannelMessagesOnly)&&void 0!==m&&m}_validate(){return super._validate()&&t.isTypeOf("boolean",this.reverse)&&t.isEnumOf(t.MessageTypeFilter,this.messageTypeFilter)&&t.isEnumOf(t.ReplyType,this.replyType)&&t.isArrayOf("string",this.customTypesFilter,!0)&&t.isArrayOf("string",this.senderUserIdsFilter,!0)&&t.isTypeOf("boolean",this.includeMetaArray)&&t.isTypeOf("boolean",this.includeReactions)&&t.isTypeOf("boolean",this.includeParentMessageInfo)&&t.isTypeOf("boolean",this.includeThreadInfo)&&t.isTypeOf("boolean",this.showSubchannelMessagesOnly)}load(){return t.__awaiter(this,void 0,void 0,(function*(){if(this._validate()){if(this._isLoading)throw t.SendbirdError.queryInProgress;if(this._hasNext){this._isLoading=!0;const e=_i.of(this._iid),s=yield e.getMessagesByTimestamp(this.channelUrl,this.channelType,this._edge,t.undefineNullProps({prevResultSize:this.limit,nextResultSize:0,isInclusive:!1,reverse:this.reverse,messageTypeFilter:this.messageTypeFilter,customTypesFilter:this.customTypesFilter,replyType:this.replyType,senderUserIdsFilter:this.senderUserIdsFilter,includeReactions:this.includeReactions,includeMetaArray:this.includeMetaArray,includeParentMessageInfo:this.includeParentMessageInfo,includeThreadInfo:this.includeThreadInfo,showSubchannelMessagesOnly:this.showSubchannelMessagesOnly}));return this._edge=Math.min(Number.MAX_SAFE_INTEGER,...s.map((e=>e.createdAt))),this._hasNext=s.length>=this.limit,this._isLoading=!1,s}return[]}throw t.SendbirdError.invalidParameters}))}}class Oe extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,limit:n,token:a}=e;super(),this.method=t.APIRequestMethod.GET,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/mute`,this.params={limit:n,token:a}}}class Ae extends t.APIResponseCommand{constructor(e,t){super(e,t),this.mutedUsers=[];const{next:s,muted_list:i}=t;this.token=s,i&&i.length>0&&(this.mutedUsers=i.map((t=>new ee(e,t))))}}class Ce extends t.ChannelDataListQuery{constructor(e,t,s,i){super(e,t,s,i)}next(){return t.__awaiter(this,void 0,void 0,(function*(){if(this._validate()){if(this._isLoading)throw t.SendbirdError.queryInProgress;if(this._hasNext){this._isLoading=!0;const{requestQueue:e}=t.Vault.of(this._iid),s=new Oe(Object.assign(Object.assign({},this),{token:this._token})),i=yield e.send(s),{mutedUsers:n,token:a}=i.as(Ae);return this._token=a,this._hasNext=!!a,this._isLoading=!1,n}return[]}throw t.SendbirdError.invalidParameters}))}}class we extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,limit:n,token:a}=e;super(),this.method=t.APIRequestMethod.GET,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/ban`,this.params=t.deundefined({limit:n,token:a})}}class Ne extends t.APIResponseCommand{constructor(e,t){super(e,t),this.bannedUsers=[];const{next:s,banned_list:i}=t;this.token=s,i&&i.length>0&&(this.bannedUsers=i.map((t=>new ee(e,t.user))))}}class Pe extends t.ChannelDataListQuery{constructor(e,t,s,i){super(e,t,s,i)}_validate(){return super._validate()}next(){return t.__awaiter(this,void 0,void 0,(function*(){if(this._validate()){if(this._isLoading)throw t.SendbirdError.queryInProgress;if(this._hasNext){this._isLoading=!0;const{requestQueue:e}=t.Vault.of(this._iid),s=new we(Object.assign(Object.assign({},this),{token:this._token})),i=yield e.send(s),{bannedUsers:n,token:a}=i.as(Ne);return this._token=a,this._hasNext=!!a,this._isLoading=!1,n}return[]}throw t.SendbirdError.invalidParameters}))}}var Ue;exports.ReportCategory=void 0,(Ue=exports.ReportCategory||(exports.ReportCategory={})).SPAM="spam",Ue.HARASSING="harassing",Ue.SUSPICIOUS="suspicious",Ue.INAPPROPRIATE="inappropriate";class xe extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,operatorUserIds:n}=e;super(),this.method=t.APIRequestMethod.POST,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/operators`,this.params={operator_ids:n}}}class Re extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,operatorUserIds:n}=e;super(),this.method=t.APIRequestMethod.DELETE,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/operators`,this.params={operator_ids:n}}}class Le extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,userId:n}=e;super(),this.method=t.APIRequestMethod.GET,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/mute/${n}`}}class ke extends t.APIResponseCommand{constructor(e,t){super(e,t),this.isMuted=!1,this.startAt=0,this.endAt=0;const{is_muted:s,start_at:i,end_at:n,remaining_duration:a,description:r}=t;this.isMuted=s,this.startAt=i,this.endAt=n,this.remainingDuration=a,this.description=r}}class De extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,keys:n}=e;super(),this.method=t.APIRequestMethod.GET,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/metadata`,this.params={keys:n,include_ts:!0}}}class qe extends t.APIResponseCommand{constructor(e,t){super(e,t);const{metadata:s,ts:i}=t;this.metadata=s,this.ts=i}}class Fe extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,metadata:n}=e;super(),this.method=t.APIRequestMethod.POST,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/metadata`,this.params={metadata:n,include_ts:!0}}}class Be extends t.APIResponseCommand{constructor(e,t){var s,i;super(e,t),this.metaData=null!==(s=t.metadata)&&void 0!==s?s:{},this.ts=null!==(i=t.ts)&&void 0!==i?i:null}}class je extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,metadata:n,upsert:a}=e;super(),this.method=t.APIRequestMethod.PUT,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/metadata`,this.params={metadata:n,include_ts:!0,upsert:null!=a&&a}}}class ze extends t.APIResponseCommand{constructor(e,t){super(e,t);const{metadata:s,ts:i}=t;this.metadata=s,this.ts=i}}class Ve extends t.WebSocketEventCommand{constructor(e,t,s){super(e,"SYEV",s),s.data&&(this.created=s.data.created,this.updated=s.data.updated,this.deleted=s.data.deleted)}}class $e extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,key:n}=e;super(),this.method=t.APIRequestMethod.DELETE,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/metadata/${n}`,this.params={include_ts:!0}}}class Qe extends t.APIResponseCommand{constructor(e,t){super(e,t);const{ts:s}=t;this.ts=s}}class Ke extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i}=e;super(),this.method=t.APIRequestMethod.DELETE,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/metadata`,this.params={include_ts:!0}}}class Ge extends t.APIResponseCommand{constructor(e,t){super(e,t);const{ts:s}=t;this.ts=s}}class He extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,keys:n}=e;super(),this.method=t.APIRequestMethod.GET,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/metacounter`,this.params={keys:n}}}class We extends t.APIResponseCommand{constructor(e,t){super(e,t),this.metaCounter=t}}class Ye extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,metaCounter:n}=e;super(),this.method=t.APIRequestMethod.POST,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/metacounter`,this.params={metacounter:n}}}class Je extends t.APIResponseCommand{constructor(e,t){super(e,t),this.metaCounter=t}}class Xe extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,metaCounter:n,upsert:a=!1,mode:r="set"}=e;super(),this.method=t.APIRequestMethod.PUT,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/metacounter`,this.params={metacounter:n,upsert:a,mode:r}}}class Ze extends t.APIResponseCommand{constructor(e,t){super(e,t),this.metaCounter=t}}class et extends t.WebSocketEventCommand{constructor(e,t,s){super(e,"SYEV",s),s.data&&(this.created=s.data.created,this.updated=s.data.updated,this.deleted=s.data.deleted)}}class tt extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,key:n}=e;super(),this.method=t.APIRequestMethod.DELETE,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/metacounter/${n}`,this.params={}}}class st extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i}=e;super(),this.method=t.APIRequestMethod.DELETE,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/metacounter`,this.params={}}}class it extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,userId:n,seconds:a,description:r}=e;super(),this.method=t.APIRequestMethod.POST,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/mute`,this.params={user_id:n,seconds:a,description:r}}}class nt extends t.WebSocketEventCommand{constructor(e,t,s){super(e,"SYEV",s),this.user=new ee(e,s.data)}}class at extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,userId:n}=e;super(),this.method=t.APIRequestMethod.DELETE,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/mute/${encodeURIComponent(n)}`}}class rt extends t.WebSocketEventCommand{constructor(e,t,s){super(e,"SYEV",s),this.user=new ee(e,s.data)}}class ot extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,userId:n,seconds:a,description:r}=e;super(),this.method=t.APIRequestMethod.POST,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/ban`,this.params=t.deundefined({user_id:n,seconds:a,description:r})}}class lt extends t.WebSocketEventCommand{constructor(e,t,s){super(e,"SYEV",s),this.user=new ee(e,s.data),s.data.member_count&&(this.memberCount=s.data.member_count),s.data.joined_member_count&&(this.joinedMemberCount=s.data.joined_member_count)}}class dt extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,userId:n}=e;super(),this.method=t.APIRequestMethod.DELETE,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/ban/${encodeURIComponent(n)}`}}class ut extends t.WebSocketEventCommand{constructor(e,t,s){super(e,"SYEV",s),this.user=new ee(e,s.data)}}class ct extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,freezing:n}=e;super(),this.method=t.APIRequestMethod.PUT,this.path=`${t.getChannelApiPathByType(i)}/${encodeURIComponent(s)}/freeze`,this.params={freeze:n}}}class ht extends t.WebSocketEventCommand{constructor(e,t,s){super(e,"SYEV",s),this.freeze=s.data.freeze}}class pt extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,category:n,userId:a,description:r}=e;super(),this.method=t.APIRequestMethod.POST,this.path=`${t.getReportApiPathByType(i)}/${encodeURIComponent(s)}`,this.params={report_category:n,reporting_user_id:a,report_description:r}}}class mt extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,category:n,userId:a,offendingUserId:r,description:o}=e;super(),this.method=t.APIRequestMethod.POST,this.path=`${t.API_PATH_REPORT}/users/${r}`,this.params={channel_url:s,channel_type:i===t.ChannelType.OPEN?"open_channels":"group_channels",report_category:n,reporting_user_id:a,report_description:o}}}class _t extends t.APIRequestCommand{constructor(e){const{channelUrl:s,channelType:i,category:n,userId:a,offendingUserId:r,messageId:o,description:l}=e;super(),this.method=t.APIRequestMethod.POST,this.path=`${t.getReportApiPathByType(i)}/${encodeURIComponent(s)}/messages/${o}`,this.params={report_category:n,reporting_user_id:a,report_description:l,offending_user_id:r}}}class gt extends t.WebSocketRequestCommand{constructor(e){let s=[];e.mentionType===t.MentionType.USERS&&(e.mentionedUserIds?s=e.mentionedUserIds:e.mentionedUsers&&(s=e.mentionedUsers.map((e=>e.userId)))),super({code:"MESG",ackRequired:!0,payload:t.deundefined(t.undefineNullProps({channel_url:e.channelUrl,message:e.message,data:e.data,custom_type:e.customType,metaarray:e.metaArrays,mention_type:e.mentionType,mentioned_user_ids:s,mentioned_message_template:e.mentionedMessageTemplate,target_langs:e.translationTargetLanguages,push_option:e.pushNotificationDeliveryOption&&e.pushNotificationDeliveryOption!==t.PushNotificationDeliveryOption.DEFAULT?e.pushNotificationDeliveryOption:void 0,apple_critical_alert_options:e.appleCriticalAlertOptions,silent:e.silent,reply_to_channel:e.isReplyToChannel,parent_message_id:e.parentMessageId?e.parentMessageId:null,req_id:e.reqId,poll_id:e.pollId,pin_message:e.isPinnedMessage}))})}}class yt extends t.WebSocketEventCommand{constructor(e,s,i){var n,a,r,o;super(e,"MESG",i),this.message=new M(e,i);const{sdkState:l}=t.Vault.of(e);this.isMentioned=t.checkIfMentioned(this.message.mentionType,null!==(r=null!==(n=this.message.mentionedUserIds)&&void 0!==n?n:null===(a=this.message.mentionedUsers)||void 0===a?void 0:a.map((e=>e.userId)))&&void 0!==r?r:[],l.userId),this.forceUpdateLastMessage=null!==(o=i.force_update_last_message)&&void 0!==o&&o}}class ft extends t.WebSocketRequestCommand{constructor(e){let s=null;e.mentionType===t.MentionType.USERS&&(e.mentionedUserIds?s=e.mentionedUserIds:e.mentionedUsers&&(s=e.mentionedUsers.map((e=>e.userId)))),super({code:"MEDI",ackRequired:!0,payload:t.deundefined(t.undefineNullProps({channel_url:e.channelUrl,msg_id:e.messageId,message:e.message,data:e.data,custom_type:e.customType,metaarray:e.metaArrayParams,mention_type:e.mentionType,mentioned_user_ids:s,mentioned_message_template:e.mentionedMessageTemplate,apple_critical_alert_options:e.appleCriticalAlertOptions?d.payloadify(e.appleCriticalAlertOptions):null,poll_id:e.pollId}))})}}class vt extends t.WebSocketEventCommand{constructor(e,s,i){var n,a,r,o,l;super(e,"MEDI",i),this.message=new M(e,i);const{sdkState:d}=t.Vault.of(e);this.mentionCountChange=t.calculateMentionCountChange({mentionType:null===(n=i.old_values)||void 0===n?void 0:n.mention_type,mentionedUserIds:null!==(r=null===(a=i.old_values)||void 0===a?void 0:a.mentioned_user_ids)&&void 0!==r?r:[]},t.undefineNullProps({mentionType:this.message.mentionType,mentionedUserIds:null!==(o=this.message.mentionedUserIds)&&void 0!==o?o:null===(l=this.message.mentionedUsers)||void 0===l?void 0:l.map((e=>e.userId))}),d.userId)}}class It extends t.WebSocketRequestCommand{constructor(e){let s=null;e.mentionType===t.MentionType.USERS&&(e.mentionedUserIds?s=e.mentionedUserIds:e.mentionedUsers&&(s=e.mentionedUsers.map((e=>e.userId)))),super({code:"FEDI",ackRequired:!0,payload:t.deundefined(t.undefineNullProps({channel_url:e.channelUrl,msg_id:e.messageId,data:e.data,custom_type:e.customType,metaarray:e.metaArrayParams,mention_type:e.mentionType,mentioned_user_ids:s,apple_critical_alert_options:e.appleCriticalAlertOptions}))})}}class Et extends t.WebSocketEventCommand{constructor(e,s,i){var n,a,r,o,l;super(e,"FEDI",i),this.message=new P(e,i);const{sdkState:d}=t.Vault.of(e);this.mentionCountChange=t.calculateMentionCountChange({mentionType:null===(n=i.old_values)||void 0===n?void 0:n.mention_type,mentionedUserIds:null!==(r=null===(a=i.old_values)||void 0===a?void 0:a.mentioned_user_ids)&&void 0!==r?r:[]},t.undefineNullProps({mentionType:this.message.mentionType,mentionedUserIds:null!==(o=this.message.mentionedUserIds)&&void 0!==o?o:null===(l=this.message.mentionedUsers)||void 0===l?void 0:l.map((e=>e.userId))}),d.userId)}}class Tt extends t.APIRequestCommand{constructor(e){super(),this.method=t.APIRequestMethod.DELETE,this.path=`${t.getChannelApiPathByType(e.channelType)}/${e.channelUrl}/messages/${e.messageId}`}}class bt extends t.WebSocketEventCommand{constructor(e,t,s){super(e,"DELM",s),this.channelUrl=s.channel_url,this.channelType=s.channel_type,this.messageId=Number(s.msg_id)}}class St extends t.APIRequestCommand{constructor({channelType:e,channelUrl:s,messageId:i,reactionKey:n}){super(),this.method=t.APIRequestMethod.POST,this.path=`${t.getChannelApiPathByType(e)}/${encodeURIComponent(s)}/messages/${i}/reactions`,this.params={reaction:n}}}class Mt extends t.APIResponseCommand{constructor(e,t){super(e,t),this.reactionEvent=new a(t)}}class Ot extends t.APIRequestCommand{constructor({channelType:e,channelUrl:s,messageId:i,reactionKey:n}){super(),this.method=t.APIRequestMethod.DELETE,this.path=`${t.getChannelApiPathByType(e)}/${encodeURIComponent(s)}/messages/${i}/reactions`,this.params={reaction:n}}}class At extends t.APIResponseCommand{constructor(e,t){super(e,t),this.reactionEvent=new a(Object.assign({},t))}}class Ct extends t.APIRequestCommand{constructor({channelType:e,channelUrl:s,messageId:i,translationTargetLanguages:n}){super(),this.method=t.APIRequestMethod.POST,this.path=`${t.getChannelApiPathByType(e)}/${encodeURIComponent(s)}/messages/${encodeURIComponent(i)}/translation`,this.params={target_langs:n}}}class wt extends t.APIResponseCommand{constructor(e,t){super(e,t),this.message=new M(e,t)}}class Nt extends t.APIRequestCommand{constructor(e){var s;super();let i=[];e.mentionType===t.MentionType.USERS&&(e.mentionedUserIds?i=e.mentionedUserIds:e.mentionedUsers&&(i=e.mentionedUsers.map((e=>e.userId))));const{channelType:n,channelUrl:a}=e;this.method=t.APIRequestMethod.POST,this.path=`${t.getChannelApiPathByType(n)}/${encodeURIComponent(a)}/scheduled_messages`,this.params=t.deundefined(t.undefineNullProps({req_id:e.reqId,scheduled_at:e.scheduledAt,message_type:t.ServerSideMessageType.USER,message:e.message,custom_type:e.customType,data:e.data,mention_type:e.mentionType,mentioned_user_ids:i,sorted_metaarray:null===(s=e.metaArrays)||void 0===s?void 0:s.map((e=>c.payloadify(e))),apple_critical_alert_options:e.appleCriticalAlertOptions?d.payloadify(e.appleCriticalAlertOptions):null,target_langs:e.translationTargetLanguages,push_option:e.pushNotificationDeliveryOption}))}}class Pt extends t.APIResponseCommand{constructor(e,t){super(e,t),this.message=new M(e,t)}}class Ut extends t.APIRequestCommand{constructor(e){var s;super();let i=[];e.mentionType===t.MentionType.USERS&&(e.mentionedUserIds?i=e.mentionedUserIds:e.mentionedUsers&&(i=e.mentionedUsers.map((e=>e.userId))));const{channelType:n,channelUrl:a}=e;this.method=t.APIRequestMethod.POST,this.path=`${t.getChannelApiPathByType(n)}/${encodeURIComponent(a)}/scheduled_messages`,this.params=t.undefineNullProps({req_id:e.reqId,scheduled_at:e.scheduledAt,message_type:t.ServerSideMessageType.FILE,url:e.fileUrl,file_name:e.fileName,file_size:e.fileSize,file_type:e.mimeType,thumbnails:e.thumbnailSizes?e.thumbnailSizes.map((e=>v.payloadify(e))):[],custom_type:e.customType,data:e.data,require_auth:e.requireAuth,mention_type:e.mentionType,mentioned_user_ids:i,sorted_metaarray:null===(s=e.metaArrays)||void 0===s?void 0:s.map((e=>c.payloadify(e))),apple_critical_alert_options:e.appleCriticalAlertOptions?d.payloadify(e.appleCriticalAlertOptions):null,push_option:e.pushNotificationDeliveryOption})}}class xt extends t.APIResponseCommand{constructor(e,t){super(e,t),this.message=new P(e,t)}}class Rt extends t.APIRequestCommand{constructor({pollId:e,title:s,data:i,allowUserSuggestion:n,allowMultipleVotes:a,closeAt:r}){super(),this.method=t.APIRequestMethod.PUT,this.path=`${t.API_PATH_POLLS}/${encodeURIComponent(e)}`,this.params={title:s,data:i,allow_user_suggestion:n,allow_multiple_votes:a,close_at:r}}}class Lt extends t.APIResponseCommand{constructor(e,s){super(e,s),this.poll=new t.Poll(e,s)}}class kt extends t.APIRequestCommand{constructor({pollId:e}){super(),this.method=t.APIRequestMethod.DELETE,this.path=`${t.API_PATH_POLLS}/${encodeURIComponent(e)}`}}class Dt extends t.APIRequestCommand{constructor({pollId:e}){super(),this.method=t.APIRequestMethod.PUT,this.path=`${t.API_PATH_POLLS}/${encodeURIComponent(e)}/close`}}class qt extends t.APIResponseCommand{constructor(e,s){super(e,s),this.poll=new t.Poll(e,s)}}class Ft extends t.APIRequestCommand{constructor({channelUrl:e,channelType:s,pollId:i,optionText:n}){super(),this.method=t.APIRequestMethod.POST,this.path=`${t.API_PATH_POLLS}/${encodeURIComponent(i)}/options`,this.params={channel_url:e,channel_type:s,text:n}}}class Bt extends t.APIResponseCommand{constructor(e,s){super(e,s),this.poll=new t.Poll(e,s)}}class jt extends t.APIRequestCommand{constructor({pollId:e,pollOptionId:s,optionText:i}){super(),this.method=t.APIRequestMethod.PUT,this.path=`${t.API_PATH_POLLS}/${encodeURIComponent(e)}/options/${encodeURIComponent(s)}`,this.params={text:i}}}class zt extends t.APIResponseCommand{constructor(e,s){super(e,s),this.poll=new t.Poll(e,s)}}class Vt extends t.APIRequestCommand{constructor({pollId:e,pollOptionId:s}){super(),this.method=t.APIRequestMethod.DELETE,this.path=`${t.API_PATH_POLLS}/${encodeURIComponent(e)}/options/${encodeURIComponent(s)}`}}class $t extends t.WebSocketRequestCommand{constructor({reqId:e,channelType:s,channelUrl:i,pollId:n,pollOptionIds:a}){super({code:"VOTE",ackRequired:!0,payload:t.deundefined({req_id:e,channel_type:s===t.ChannelType.OPEN?"open_channels":"group_channels",channel_url:i,poll_id:n,option_ids:a})})}}class Qt extends t.WebSocketEventCommand{constructor(e,s,i){super(e,"VOTE",i),this.event=new t.PollVoteEvent(i),this.channelUrl=i.channel_url,this.channelType=i.channel_type}}const Kt="Message",Gt="NotificationMessage";const Ht=Object.assign(Object.assign({},se),{fileInfoList:[]}),Wt=e=>(t.isFile(e.file)||t.isTypeOf("string",e.fileUrl))&&t.isTypeOf("string",e.fileName,!0)&&t.isTypeOf("string",e.mimeType,!0)&&t.isTypeOf("number",e.fileSize,!0)&&(void 0===e.thumbnailSizes||Array.isArray(e.thumbnailSizes)&&e.thumbnailSizes.every((e=>e.maxWidth>0&&e.maxHeight>0)));class Yt extends te{constructor(){super(...arguments),this._onFileUploaded=t.noop}_triggerOnFileUploaded(e,t,s,i){this._onFileUploaded(e,t,s,i)}onFileUploaded(e){return this._onFileUploaded=e,this}onPending(e){return super.onPending(e),this}onFailed(e){return super.onFailed(e),this}onSucceeded(e){return super.onSucceeded(e),this}}var Jt;exports.SendMessageRequestType=void 0,(Jt=exports.SendMessageRequestType||(exports.SendMessageRequestType={})).SEND="send",Jt.RESEND="resend",Jt.COPY="copy";class Xt extends t.InstancedObject{get url(){return this._url}get name(){return this._name}set name(e){this._name=e}get createdAt(){return this._createdAt}toJSON(){return Object.assign(Object.assign({},this),{url:this._url,name:this._name,createdAt:this._createdAt})}constructor(e,s){var i,n,a,r,o,l;super(e),this._name="",this._createdAt=0,this.channelType=t.ChannelType.BASE,this.coverUrl="",this.customType="",this.data="",this.isFrozen=!1,this.isEphemeral=!1,this.creator=null,this._messageCollectionLastAccessedAt=0,this._url=s.channel_url,this._name=null!==(i=s.name)&&void 0!==i?i:"",this._createdAt=1e3*s.created_at,this.coverUrl=null!==(n=s.cover_url)&&void 0!==n?n:"",this.customType=null!==(a=s.custom_type)&&void 0!==a?a:"",this.data=null!==(r=s.data)&&void 0!==r?r:"",this.isFrozen=null!==(o=s.freeze)&&void 0!==o&&o,this.isEphemeral=null!==(l=s.is_ephemeral)&&void 0!==l&&l,this.creator=s.created_by?new t.User(this._iid,s.created_by):null,s.metadata&&Object.keys(s.metadata).length>0&&s.ts&&(this._cachedMetaData=new Map,Object.keys(s.metadata).forEach((e=>{this._cachedMetaData.set(e,{value:s.metadata[e],isRemoved:!1,updatedAt:s.ts})})))}static payloadify(e){return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{channel_url:e.url,name:e.name,cover_url:e.coverUrl,custom_type:e.customType,data:e.data,freeze:e.isFrozen,is_ephemeral:e.isEphemeral,created_by:e.creator?t.User.payloadify(e.creator):null,created_at:e.createdAt/1e3})))}isGroupChannel(){return this.channelType===t.ChannelType.GROUP}isOpenChannel(){return this.channelType===t.ChannelType.OPEN}isFeedChannel(){return this.channelType===t.ChannelType.FEED}get cachedMetaData(){const e={};return this._cachedMetaData?(this._cachedMetaData.forEach(((t,s)=>{t.isRemoved||(e[s]=t.value)})),e):e}get messageCollectionLastAccessedAt(){return this._messageCollectionLastAccessedAt}_updateMessageCollectionLastAccessedAt(){this._messageCollectionLastAccessedAt=Date.now()}_update(e){const s=t.deundefined(e);Object.assign(this,s)}_upsertCachedMetaData(e,t){Object.keys(e).forEach((s=>{this._cachedMetaData||(this._cachedMetaData=new Map);const i=this._cachedMetaData.get(s);(!i||i.updatedAt<=t)&&this._cachedMetaData.set(s,{value:e[s],isRemoved:!1,updatedAt:t})}))}_updateCachedMetaData(e,t){this._cachedMetaData?this._cachedMetaData.forEach(((s,i)=>{var n;s.updatedAt<=t&&this._cachedMetaData.set(i,{value:null!==(n=e[i])&&void 0!==n?n:s.value,isRemoved:!e[i],updatedAt:t})})):(this._cachedMetaData=new Map,Object.keys(e).forEach((s=>{this._cachedMetaData.set(s,{value:e[s],isRemoved:!1,updatedAt:t})})))}_removeFromCachedMetaData(e,t){this._cachedMetaData&&e.forEach((e=>{const s=this._cachedMetaData.get(e);s&&s.updatedAt<t&&(s.isRemoved=!0,s.updatedAt=t)}))}_runIfHandleableWithGroupChannel(e){this.isGroupChannel()?e(this):this.isFeedChannel()&&e(this.groupChannel)}_generateRequestId(){return`rq-${t.uuid()}`}isIdentical(e){return e&&this.url===e.url}isEqual(e){return t.deepEqual(this,e)}createOperatorListQuery(e={}){return new Se(this._iid,this.url,this.channelType,e)}createMutedUserListQuery(e={}){return new Ce(this._iid,this.url,this.channelType,e)}createBannedUserListQuery(e={}){return new Pe(this._iid,this.url,this.channelType,e)}createPreviousMessageListQuery(e={}){return new Me(this._iid,this.url,this.channelType,e)}addOperators(e){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(t.isArrayOf("string",e)).throw(t.SendbirdError.invalidParameters);const{requestQueue:s}=t.Vault.of(this._iid),i=new xe({channelUrl:this.url,channelType:this.channelType,operatorUserIds:e});yield s.send(i)}))}removeOperators(e){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(t.isArrayOf("string",e)).throw(t.SendbirdError.invalidParameters);const{requestQueue:s}=t.Vault.of(this._iid),i=new Re({channelUrl:this.url,channelType:this.channelType,operatorUserIds:e});yield s.send(i)}))}getMyMutedInfo(){return t.__awaiter(this,void 0,void 0,(function*(){const{sdkState:e,requestQueue:s}=t.Vault.of(this._iid),i=new Le({channelUrl:this.url,channelType:this.channelType,userId:e.userId}),n=yield s.send(i),{isMuted:a,startAt:r,endAt:o,remainingDuration:l,description:d}=n.as(ke);return{isMuted:a,startAt:r,endAt:o,remainingDuration:l,description:d}}))}getMetaData(e){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(t.isArrayOf("string",e)).throw(t.SendbirdError.invalidParameters);const{requestQueue:s}=t.Vault.of(this._iid),i=new De({channelUrl:this.url,channelType:this.channelType,keys:e}),n=yield s.send(i),{metadata:a,ts:r}=n.as(qe);return this._upsertCachedMetaData(a,r),a}))}getAllMetaData(){return t.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:e}=t.Vault.of(this._iid),s=new De({channelUrl:this.url,channelType:this.channelType,keys:[]}),i=yield e.send(s),{metadata:n,ts:a}=i.as(qe);return this._updateCachedMetaData(n,a),n}))}createMetaData(e){return t.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:s}=t.Vault.of(this._iid),i=new Fe({channelUrl:this.url,channelType:this.channelType,metadata:e}),n=yield s.send(i),{metaData:a}=n.as(Be);return this._upsertCachedMetaData(a,0),a}))}updateMetaData(e,s=!1){return t.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:i}=t.Vault.of(this._iid),n=new je({channelUrl:this.url,channelType:this.channelType,metadata:e,upsert:s}),a=yield i.send(n),{metadata:r,ts:o}=a.as(ze);return this._upsertCachedMetaData(r,o),r}))}deleteMetaData(e){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(t.isTypeOf("string",e)).throw(t.SendbirdError.invalidParameters);const{requestQueue:s}=t.Vault.of(this._iid),i=new $e({channelUrl:this.url,channelType:this.channelType,key:e}),n=yield s.send(i),{ts:a}=n.as(Qe);this._removeFromCachedMetaData([e],a)}))}deleteAllMetaData(){return t.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:e}=t.Vault.of(this._iid),s=new Ke({channelUrl:this.url,channelType:this.channelType}),i=yield e.send(s),{ts:n}=i.as(Ge);this._removeFromCachedMetaData([...this._cachedMetaData.keys()],n)}))}getMetaCounters(e){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(t.isArrayOf("string",e)).throw(t.SendbirdError.invalidParameters);const{requestQueue:s}=t.Vault.of(this._iid),i=new He({channelUrl:this.url,channelType:this.channelType,keys:e}),n=yield s.send(i),{metaCounter:a}=n.as(We);return a}))}getAllMetaCounters(){return t.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:e}=t.Vault.of(this._iid),s=new He({channelUrl:this.url,channelType:this.channelType,keys:[]}),i=yield e.send(s),{metaCounter:n}=i.as(We);return n}))}createMetaCounters(e){return t.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:s}=t.Vault.of(this._iid),i=new Ye({channelUrl:this.url,channelType:this.channelType,metaCounter:e}),n=yield s.send(i),{metaCounter:a}=n.as(Je);return a}))}updateMetaCounters(e,s=!1){return t.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:i}=t.Vault.of(this._iid),n=new Xe({channelUrl:this.url,channelType:this.channelType,metaCounter:e,upsert:s}),a=yield i.send(n),{metaCounter:r}=a.as(Ze);return r}))}increaseMetaCounters(e){return t.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:s}=t.Vault.of(this._iid),i=new Xe({channelUrl:this.url,channelType:this.channelType,metaCounter:e,upsert:!1,mode:"increase"}),n=yield s.send(i),{metaCounter:a}=n.as(Ze);return a}))}decreaseMetaCounters(e){return t.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:s}=t.Vault.of(this._iid),i=new Xe({channelUrl:this.url,channelType:this.channelType,metaCounter:e,upsert:!1,mode:"decrease"}),n=yield s.send(i),{metaCounter:a}=n.as(Ze);return a}))}deleteMetaCounter(e){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(t.isTypeOf("string",e)).throw(t.SendbirdError.invalidParameters);const{requestQueue:s}=t.Vault.of(this._iid),i=new tt({channelUrl:this.url,channelType:this.channelType,key:e});yield s.send(i)}))}deleteAllMetaCounters(){return t.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:e}=t.Vault.of(this._iid),s=new st({channelUrl:this.url,channelType:this.channelType});yield e.send(s)}))}muteUser(e,s,i){return t.__awaiter(this,void 0,void 0,(function*(){return this.muteUserWithUserId(e.userId,s,i)}))}muteUserWithUserId(e,s,i){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(t.isTypeOf("string",e)&&t.isTypeOf("number",s,!0)&&t.isTypeOf("string",i,!0)).throw(t.SendbirdError.invalidParameters);const{requestQueue:n}=t.Vault.of(this._iid),a=new it({channelUrl:this.url,channelType:this.channelType,userId:e,seconds:s,description:i});yield n.send(a)}))}unmuteUser(e){return t.__awaiter(this,void 0,void 0,(function*(){return this.unmuteUserWithUserId(e.userId)}))}unmuteUserWithUserId(e){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(t.isTypeOf("string",e)).throw(t.SendbirdError.invalidParameters);const{requestQueue:s}=t.Vault.of(this._iid),i=new at({channelUrl:this.url,channelType:this.channelType,userId:e});yield s.send(i)}))}banUser(e,s,i){return t.__awaiter(this,void 0,void 0,(function*(){return this.banUserWithUserId(e.userId,s,i)}))}banUserWithUserId(e,s,i){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(t.isTypeOf("string",e)&&t.isTypeOf("number",s,!0)&&t.isTypeOf("string",i,!0)).throw(t.SendbirdError.invalidParameters);const{requestQueue:n}=t.Vault.of(this._iid),a=new ot({channelUrl:this.url,channelType:this.channelType,userId:e,seconds:s,description:i});yield n.send(a)}))}unbanUser(e){return t.__awaiter(this,void 0,void 0,(function*(){return this.unbanUserWithUserId(e.userId)}))}unbanUserWithUserId(e){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(t.isTypeOf("string",e)).throw(t.SendbirdError.invalidParameters);const{requestQueue:s}=t.Vault.of(this._iid),i=new dt({channelUrl:this.url,channelType:this.channelType,userId:e});yield s.send(i)}))}freeze(){return t.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:e}=t.Vault.of(this._iid),s=new ct({channelUrl:this.url,channelType:this.channelType,freezing:!0});yield e.send(s),this.isFrozen=!0}))}unfreeze(){return t.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:e}=t.Vault.of(this._iid),s=new ct({channelUrl:this.url,channelType:this.channelType,freezing:!1});yield e.send(s),this.isFrozen=!1}))}getMessagesByMessageId(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},B),s);t.unless(t.isTypeOf("number",e)&&j(i)).throw(t.SendbirdError.invalidParameters);const n=_i.of(this._iid);return yield n.getMessagesByMessageId(this.url,this.channelType,e,i)}))}getMessagesByTimestamp(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},B),s);t.unless(t.isTypeOf("number",e)&&j(i)).throw(t.SendbirdError.invalidParameters);const n=_i.of(this._iid);return yield n.getMessagesByTimestamp(this.url,this.channelType,e,i)}))}getMessageChangeLogsSinceTimestamp(e,s={}){return t.__awaiter(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},z),s);t.unless(t.isTypeOf("number",e)&&V(i)).throw(t.SendbirdError.invalidParameters);const n=_i.of(this._iid);return yield n.getMessageChangelogs(this.url,this.channelType,e,i)}))}getMessageChangeLogsSinceToken(e,s={}){return t.__awaiter(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},z),s);t.unless(t.isTypeOf("string",e)&&V(i)).throw(t.SendbirdError.invalidParameters);const n=_i.of(this._iid);return yield n.getMessageChangelogs(this.url,this.channelType,e,i)}))}_createPendingSendableMessagePayload(e,s,i){var n;const{sessionManager:a}=t.Vault.of(this._iid);return t.deundefined(t.undefineNullProps({channel_url:this.url,channel_type:this.channelType,msg_id:0,parent_message_id:e.parentMessageId,data:e.data,custom_type:e.customType,mention_type:e.mentionType,sorted_metaarray:e.metaArrays?e.metaArrays.map((e=>c.payloadify(e))):null,apple_critical_alert_options:e.appleCriticalAlertOptions?d.payloadify(e.appleCriticalAlertOptions):null,created_at:i,user:a.currentUser?u.payloadify(a.currentUser):null,req_id:s,request_state:t.SendingStatus.PENDING,mentioned_user_ids:e.mentionedUserIds,mentioned_users:null===(n=e.mentionedUsers)||void 0===n?void 0:n.map((e=>t.User.payloadify(e)))}))}_createPendingUserMessage(e,s,i){const n={};if(e.translationTargetLanguages)for(const t of e.translationTargetLanguages)n[t]="";const a=t.deundefined(Object.assign(Object.assign({},this._createPendingSendableMessagePayload(e,s,i)),{type:t.MessageType.USER,message:e.message,translations:n})),r=new M(this._iid,a);return r.messageParams=e,r}_createPendingScheduledUserMessage(e,t,s){const i=this._createPendingUserMessage(e,t,s);return i.scheduledInfo={scheduledMessageId:0,scheduledAt:e.scheduledAt,scheduledMessageParams:e},i}_createPendingFileMessage(e,s,i){var n,a,r,o,l,d;const u=t.deundefined(Object.assign(Object.assign({},this._createPendingSendableMessagePayload(e,s,i)),{type:t.MessageType.FILE,url:e.fileUrl,file:{name:null!==(n=e.fileName)&&void 0!==n?n:null===(a=e.file)||void 0===a?void 0:a.name,size:null!==(r=e.fileSize)&&void 0!==r?r:null===(o=e.file)||void 0===o?void 0:o.size,type:null!==(l=e.mimeType)&&void 0!==l?l:null===(d=e.file)||void 0===d?void 0:d.type,data:e.data},thumbnails:e.thumbnailSizes?e.thumbnailSizes.map((e=>({url:"",width:e.maxWidth,height:e.maxHeight}))):[]})),c=new P(this._iid,u);return c.messageParams=e,c}_createPendingMultipleFilesMessage(e,s,i){const n=t.deundefined(Object.assign(Object.assign({},this._createPendingSendableMessagePayload(e,s,i)),{type:t.MessageType.FILE})),a=new A(this._iid,n);return a.messageParams=e,a}_validateFailedFileMessageHasFile(e,s){var i;return Boolean(e.url)||t.isFile(s)||t.isFile(null===(i=e.messageParams)||void 0===i?void 0:i.file)}_createPendingScheduledFileMessage(e,t,s){const i=this._createPendingFileMessage(e,t,s);return i.scheduledInfo={scheduledMessageId:0,scheduledAt:e.scheduledAt,scheduledMessageParams:e},i}_markMessageAsFailed(e,s,i=!1){e.errorCode=s.code,s.code===t.SendbirdErrorCode.REQUEST_CANCELED||s.code===t.SendbirdErrorCode.FILE_UPLOAD_CANCEL_FAILED?e.sendingStatus=t.SendingStatus.CANCELED:i||(e.sendingStatus=t.SendingStatus.FAILED)}sendUserMessage(e){const s=Object.assign(Object.assign({},ae),e);return t.unless(le(s)).throw(t.SendbirdError.invalidParameters),this._sendUserMessage(s)}_sendUserMessage(e,s=exports.SendMessageRequestType.SEND,i){const{dispatcher:n,requestQueue:a}=t.Vault.of(this._iid),r=null!=i?i:this._generateRequestId(),o=Date.now(),l=new te;return t.sleep(2).then((()=>{const i=this._createPendingUserMessage(e,r,o);n.dispatch(new t.MessageUpdateEventCommand({messages:[i],source:s===exports.SendMessageRequestType.RESEND?t.CollectionEventSource.LOCAL_MESSAGE_RESEND_STARTED:t.CollectionEventSource.EVENT_MESSAGE_SENT_PENDING})),t.runAsCallback((()=>t.__awaiter(this,void 0,void 0,(function*(){return l._trigger(i)}))));const d=new gt(Object.assign(Object.assign({},e),{channelUrl:this.url,channelType:this.channelType,reqId:r}));a.send(d).then((e=>{const{message:s}=e.as(yt);n.dispatch(new t.MessageUpdateEventCommand({messages:[s],source:t.CollectionEventSource.EVENT_MESSAGE_SENT_SUCCESS})),t.runAsCallback((()=>t.__awaiter(this,void 0,void 0,(function*(){return l._trigger(s)}))))})).catch((s=>{if(t.isThrowingOutside(s))throw s;t.sleep(2).then((()=>{const i=this._createPendingUserMessage(e,r,o),{cacheContext:a}=t.Vault.of(this._iid),d=a.localCacheEnabled&&a.localCacheConfig.enableAutoResend&&t.isAutoResendableError(s.code);this._markMessageAsFailed(i,s,d),n.dispatch(new t.MessageUpdateEventCommand({messages:[i],source:i.sendingStatus===t.SendingStatus.PENDING?t.CollectionEventSource.REQUEST_RESEND_MESSAGE:t.CollectionEventSource.EVENT_MESSAGE_SENT_FAILED})),t.runAsCallback((()=>t.__awaiter(this,void 0,void 0,(function*(){return l._triggerFailed(s,i)}))))}))}))})),l}_autoResendUserMessage(e){return t.unless(e instanceof M&&!!e.messageParams).throw(t.SendbirdError.invalidParameters),this._sendUserMessage(e.messageParams,exports.SendMessageRequestType.SEND,e.reqId)}resendUserMessage(e){var s;return t.__awaiter(this,void 0,void 0,(function*(){t.unless(e instanceof M&&!e.scheduledInfo).throw(t.SendbirdError.invalidParameters);const i=new t.Deferred,n=null!==(s=e.messageParams)&&void 0!==s?s:oe(e);return this._sendUserMessage(n,exports.SendMessageRequestType.RESEND,e.reqId).onFailed((e=>i.reject(e))).onSucceeded((e=>i.resolve(e))),i.promise}))}updateUserMessage(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},ve),s);t.unless(t.isTypeOf("number",e)&&Ie(i)).throw(t.SendbirdError.invalidParameters);const{requestQueue:n}=t.Vault.of(this._iid),a=new ft(Object.assign({channelType:this.channelType,channelUrl:this.url,messageId:e,metaArrayParams:i.metaArrays?{array:i.metaArrays,mode:"add",upsert:!0}:void 0},i)),r=yield n.send(a),{message:o}=r.as(vt);return o}))}copyUserMessage(e,s){var i,n,a;return t.__awaiter(this,void 0,void 0,(function*(){t.unless(e instanceof Xt&&s instanceof M&&s.sendingStatus===t.SendingStatus.SUCCEEDED&&this.url===s.channelUrl&&!s.scheduledInfo).throw(t.SendbirdError.invalidParameters),t.unless(!s.poll).throw(t.SendbirdError.notSupportedError);const r=new t.Deferred,o=null!==(i=s.messageParams)&&void 0!==i?i:t.undefineNullProps(Object.assign(Object.assign({},s),{mentionType:s.mentionType,mentionedUserIds:null!==(n=s.mentionedUserIds)&&void 0!==n?n:null===(a=s.mentionedUsers)||void 0===a?void 0:a.map((e=>e.userId)),translationTargetLanguages:Object.keys(s.translations),pushNotificationDeliveryOption:t.PushNotificationDeliveryOption.DEFAULT,parentMessageId:null,isReplyToChannel:!1,isPinnedMessage:!1}));return e._sendUserMessage(o).onSucceeded((e=>{r.resolve(e)})).onFailed((e=>r.reject(e))),r.promise}))}translateUserMessage(e,s){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(e instanceof M&&e.messageId>0&&t.isArrayOf("string",s)).throw(t.SendbirdError.invalidParameters);const{requestQueue:i}=t.Vault.of(this._iid),n=new Ct({channelType:this.channelType,channelUrl:this.url,messageId:e.messageId,translationTargetLanguages:s}),a=yield i.send(n),{message:r}=a.as(wt);return r}))}_createScheduledUserMessage(e,s){const{requestQueue:i}=t.Vault.of(this._iid),n=Date.now(),a=this._generateRequestId();t.sleep(2).then((()=>{const i=this._createPendingScheduledUserMessage(e,a,n);t.runAsCallback((()=>t.__awaiter(this,void 0,void 0,(function*(){return s._trigger(i)}))))}));const r=new Nt(Object.assign({reqId:a,channelType:this.channelType,channelUrl:this.url},e));i.send(r).then((e=>{const{message:i}=e.as(Pt);t.runAsCallback((()=>t.__awaiter(this,void 0,void 0,(function*(){return s._trigger(i)}))))})).catch((i=>{if(t.isThrowingOutside(i))throw i;t.sleep(2).then((()=>{const r=this._createPendingScheduledUserMessage(e,a,n);this._markMessageAsFailed(r,i),t.runAsCallback((()=>t.__awaiter(this,void 0,void 0,(function*(){return s._trigger(r)}))))}))}))}sendFileMessage(e){const s=Object.assign(Object.assign({},pe),e);return t.unless(ge(s)).throw(t.SendbirdError.invalidParameters),this._sendFileMessage(s)}sendMultipleFilesMessage(e){var s;const i=Object.assign(Object.assign({},Ht),e),n=t.Vault.of(this._iid);t.unless(((e,s=t.DEFAULT_MULTIPLE_FILES_MESSAGE_FILE_COUNT_LIMIT)=>ie(e)&&Array.isArray(e.fileInfoList)&&e.fileInfoList.length>=2&&e.fileInfoList.length<=s&&e.fileInfoList.every((e=>Wt(e))))(i,null===(s=n.appInfo)||void 0===s?void 0:s.multipleFilesMessageFileCountLimit)).throw(t.SendbirdError.invalidParameters);const a=!!e.fileInfoList.find((e=>{const t=n.appInfo.uploadSizeLimit;return e.file instanceof Blob&&e.file.size>t||e.fileSize>t}));return t.unless(!a).throw(t.SendbirdError.fileSizeLimitExceededError),this._sendMultipleFilesMessage(i)}_sendFileMessage(e,s=exports.SendMessageRequestType.SEND,i){const{dispatcher:n}=t.Vault.of(this._iid),{fileMessageQueue:a}=_i.of(this._iid),r=null!=i?i:this._generateRequestId(),o=Date.now(),l=new te;return t.sleep(2).then((()=>{const i=this._createPendingFileMessage(e,r,o);n.dispatch(new t.MessageUpdateEventCommand({messages:[i],source:s===exports.SendMessageRequestType.RESEND?t.CollectionEventSource.LOCAL_MESSAGE_RESEND_STARTED:t.CollectionEventSource.EVENT_MESSAGE_SENT_PENDING})),t.runAsCallback((()=>t.__awaiter(this,void 0,void 0,(function*(){return l._trigger(i)})))),a.request(this,r,e).then((e=>{n.dispatch(new t.MessageUpdateEventCommand({messages:[e],source:t.CollectionEventSource.EVENT_MESSAGE_SENT_SUCCESS})),t.runAsCallback((()=>t.__awaiter(this,void 0,void 0,(function*(){return l._trigger(e)}))))})).catch((s=>{if(t.isThrowingOutside(s))throw s;t.sleep(2).then((()=>{const i=this._createPendingFileMessage(e,r,o),{cacheContext:a}=t.Vault.of(this._iid),d=a.localCacheEnabled&&a.localCacheConfig.enableAutoResend&&t.isAutoResendableError(s.code);this._markMessageAsFailed(i,s,d),n.dispatch(new t.MessageUpdateEventCommand({messages:[i],source:i.sendingStatus===t.SendingStatus.PENDING?t.CollectionEventSource.REQUEST_RESEND_MESSAGE:s.code===t.SendbirdErrorCode.FILE_UPLOAD_CANCEL_FAILED?t.CollectionEventSource.LOCAL_MESSAGE_CANCELED:t.CollectionEventSource.EVENT_MESSAGE_SENT_FAILED})),t.runAsCallback((()=>t.__awaiter(this,void 0,void 0,(function*(){return l._triggerFailed(s,i)}))))}))}))})),l}_autoResendFileMessage(e){t.unless(e instanceof P&&!!e.messageParams).throw(t.SendbirdError.invalidParameters);const{logger:s}=t.Vault.of(this._iid);return s.debug("autoResendFileMessage pending",e),this._sendFileMessage(e.messageParams,exports.SendMessageRequestType.SEND,e.reqId).onFailed((e=>{s.debug("autoResendFileMessage failed",e)})).onSucceeded((e=>{s.debug("autoResendFileMessage success",e)}))}_sendMultipleFilesMessage(e,s,i){const{dispatcher:n}=t.Vault.of(this._iid),{fileMessageQueue:a}=_i.of(this._iid),r=null!=i?i:this._generateRequestId(),o=Date.now(),l=new Yt;return t.sleep(2).then((()=>{const i=this._createPendingMultipleFilesMessage(e,r,o);n.dispatch(new t.MessageUpdateEventCommand({messages:[i],source:s===exports.SendMessageRequestType.RESEND?t.CollectionEventSource.LOCAL_MESSAGE_RESEND_STARTED:t.CollectionEventSource.EVENT_MESSAGE_SENT_PENDING})),t.runAsCallback((()=>t.__awaiter(this,void 0,void 0,(function*(){return l._trigger(i)})))),a.request(this,r,e,{requestHandler:l,isCopy:s===exports.SendMessageRequestType.COPY}).then((e=>{n.dispatch(new t.MessageUpdateEventCommand({messages:[e],source:t.CollectionEventSource.EVENT_MESSAGE_SENT_SUCCESS})),t.runAsCallback((()=>t.__awaiter(this,void 0,void 0,(function*(){return l._trigger(e)}))))})).catch((s=>{if(t.isThrowingOutside(s))throw s;t.sleep(2).then((()=>{const i=this._createPendingMultipleFilesMessage(e,r,o);this._markMessageAsFailed(i,s),n.dispatch(new t.MessageUpdateEventCommand({messages:[i],source:t.CollectionEventSource.EVENT_MESSAGE_SENT_FAILED})),t.runAsCallback((()=>t.__awaiter(this,void 0,void 0,(function*(){return l._triggerFailed(s,i)}))))}))}))})),l}_createScheduledFileMessage(e,s,i,n){const{requestQueue:a}=t.Vault.of(this._iid),r=new Ut(Object.assign(Object.assign({reqId:i,channelType:this.channelType,channelUrl:this.url},e),{fileUrl:e.fileUrl,requireAuth:e.requireAuth}));a.send(r).then((e=>{const{message:i}=e.as(xt);t.runAsCallback((()=>t.__awaiter(this,void 0,void 0,(function*(){return s._trigger(i)}))))})).catch((a=>{if(t.isThrowingOutside(a))throw a;t.sleep(2).then((()=>{const r=this._createPendingScheduledFileMessage(e,i,n);this._markMessageAsFailed(r,a),t.runAsCallback((()=>t.__awaiter(this,void 0,void 0,(function*(){return s._triggerFailed(a,r)}))))}))}))}sendFileMessages(e){t.unless(e.every((e=>ge(Object.assign(Object.assign({},pe),e))))).throw(t.SendbirdError.invalidParameters);const s=new te;for(const t of e)this.sendFileMessage(t).onPending((e=>s._trigger(e))).onFailed(((e,t)=>s._triggerFailed(e,t))).onSucceeded((e=>s._trigger(e)));return s}resendFileMessage(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const i=this._validateFailedFileMessageHasFile(e,s);t.unless(e instanceof P&&i&&!e.scheduledInfo).throw(t.SendbirdError.invalidParameters);const n=new t.Deferred,a=_e(e,s);return this._sendFileMessage(a,exports.SendMessageRequestType.RESEND,e.reqId).onFailed((e=>n.reject(e))).onSucceeded((e=>n.resolve(e))),n.promise}))}resendMessage(e,s){var i,n;if(t.unless(e instanceof f&&!e.scheduledInfo&&e.isResendable).throw(t.SendbirdError.invalidParameters),e.isUserMessage()){const t=null!==(i=e.messageParams)&&void 0!==i?i:oe(e);return this._sendUserMessage(t,exports.SendMessageRequestType.RESEND,e.reqId)}if(e.isFileMessage()){const i=this._validateFailedFileMessageHasFile(e,s);t.unless(i).throw(t.SendbirdError.invalidParameters);const a=null!==(n=e.messageParams)&&void 0!==n?n:_e(e,s);return this._sendFileMessage(a,exports.SendMessageRequestType.RESEND,e.reqId)}if(e.isMultipleFilesMessage())throw t.SendbirdError.channelTypeNotSupportedError}updateFileMessage(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},Ee),s);t.unless(t.isTypeOf("number",e)&&(e=>fe(e))(i)).throw(t.SendbirdError.invalidParameters);const{requestQueue:n}=t.Vault.of(this._iid),a=new It(Object.assign({channelType:this.channelType,channelUrl:this.url,messageId:e,metaArrayParams:i.metaArrays?{array:i.metaArrays,mode:"add",upsert:!0}:void 0},i)),r=yield n.send(a),{message:o}=r.as(Et);return o}))}cancelUploadingFileMessage(e){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(t.isTypeOf("string",e)).throw(t.SendbirdError.invalidParameters);const{fileMessageQueue:s}=_i.of(this._iid);return s.cancel(this,e),!0}))}copyFileMessage(e,s){var i,n,a;return t.__awaiter(this,void 0,void 0,(function*(){t.unless(e instanceof Xt&&s instanceof P&&s.sendingStatus===t.SendingStatus.SUCCEEDED&&this.url===s.channelUrl&&!s.scheduledInfo).throw(t.SendbirdError.invalidParameters);const r=new t.Deferred,o=t.undefineNullProps(Object.assign(Object.assign({},s),{fileUrl:s.url,fileName:s.name,fileSize:s.size,mimeType:s.type,mentionType:s.mentionType,mentionedUserIds:null!==(i=s.mentionedUserIds)&&void 0!==i?i:null===(n=s.mentionedUsers)||void 0===n?void 0:n.map((e=>e.userId)),pushNotificationDeliveryOption:t.PushNotificationDeliveryOption.DEFAULT,parentMessageId:null,isReplyToChannel:!1,thumbnailSizes:null===(a=s.thumbnails)||void 0===a?void 0:a.map((e=>({maxWidth:e.width,maxHeight:e.height}))),requireAuth:s.requireAuth,isPinnedMessage:!1}));return e._sendFileMessage(o).onSucceeded((e=>r.resolve(e))).onFailed((e=>r.reject(e))),r.promise}))}copyMessage(e,s){t.unless(e instanceof Xt&&s instanceof f&&s.sendingStatus===t.SendingStatus.SUCCEEDED&&this.url===s.channelUrl&&!s.scheduledInfo).throw(t.SendbirdError.invalidParameters);const i=s,n=e;if(i.isUserMessage()){t.unless(!i.poll).throw(t.SendbirdError.notSupportedError);const e=re(i);return n._sendUserMessage(e)}if(i.isFileMessage()){const e=me(i);return n._sendFileMessage(e)}if(s.isMultipleFilesMessage())throw t.SendbirdError.channelTypeNotSupportedError}deleteMessage(e){return t.__awaiter(this,void 0,void 0,(function*(){if(t.unless(e instanceof y).throw(t.SendbirdError.invalidParameters),e.messageId>0){const{requestQueue:s}=t.Vault.of(this._iid),i=new Tt({channelType:this.channelType,channelUrl:this.url,messageId:e.messageId});yield s.send(i)}}))}addReaction(e,s){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(e instanceof y&&e.messageId>0&&t.isTypeOf("string",s)).throw(t.SendbirdError.invalidParameters);const{requestQueue:i}=t.Vault.of(this._iid),n=new St({channelType:this.channelType,channelUrl:this.url,messageId:e.messageId,reactionKey:s}),a=yield i.send(n),{reactionEvent:r}=a.as(Mt);return r}))}deleteReaction(e,s){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(e instanceof y&&e.messageId>0&&t.isTypeOf("string",s)).throw(t.SendbirdError.invalidParameters);const{requestQueue:i}=t.Vault.of(this._iid),n=new Ot({channelType:this.channelType,channelUrl:this.url,messageId:e.messageId,reactionKey:s}),a=yield i.send(n),{reactionEvent:r}=a.as(At);return r}))}_updateUserMessageMetaArray(e,s,i,n){return t.__awaiter(this,void 0,void 0,(function*(){const{dispatcher:a,requestQueue:r}=t.Vault.of(this._iid),o=new ft({channelType:this.channelType,channelUrl:this.url,messageId:e,metaArrayParams:{array:s,mode:i,upsert:n}}),l=yield r.send(o),{message:d}=l.as(vt);return a.dispatch(new t.MessageUpdateEventCommand({messages:[d],source:t.CollectionEventSource.EVENT_MESSAGE_UPDATED})),d}))}_updateFileMessageMetaArray(e,s,i,n){return t.__awaiter(this,void 0,void 0,(function*(){const{dispatcher:a,requestQueue:r}=t.Vault.of(this._iid),o=new It({channelType:this.channelType,channelUrl:this.url,messageId:e,metaArrayParams:{array:s,mode:i,upsert:n}}),l=yield r.send(o),{message:d}=l.as(Et);return a.dispatch(new t.MessageUpdateEventCommand({messages:[d],source:t.CollectionEventSource.EVENT_MESSAGE_UPDATED})),d}))}createMessageMetaArrayKeys(e,s){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(e instanceof y&&e.messageId>0&&t.isArrayOf("string",s)).throw(t.SendbirdError.invalidParameters);const i=s.map((e=>new c({key:e})));return e instanceof P?this._updateFileMessageMetaArray(e.messageId,i,"add",!0):this._updateUserMessageMetaArray(e.messageId,i,"add",!0)}))}deleteMessageMetaArrayKeys(e,s){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(e instanceof y&&e.messageId>0&&t.isArrayOf("string",s)).throw(t.SendbirdError.invalidParameters);const i=s.map((e=>new c({key:e})));return e instanceof P?this._updateFileMessageMetaArray(e.messageId,i,"remove",!0):this._updateUserMessageMetaArray(e.messageId,i,"remove",!0)}))}addMessageMetaArrayValues(e,s){return t.__awaiter(this,void 0,void 0,(function*(){return t.unless(e instanceof y&&e.messageId>0&&s.every((e=>e instanceof c))).throw(t.SendbirdError.invalidParameters),e instanceof P?this._updateFileMessageMetaArray(e.messageId,s,"add",!0):this._updateUserMessageMetaArray(e.messageId,s,"add",!0)}))}removeMessageMetaArrayValues(e,s){return t.__awaiter(this,void 0,void 0,(function*(){return t.unless(e instanceof y&&e.messageId>0&&s.every((e=>e instanceof c))).throw(t.SendbirdError.invalidParameters),e instanceof P?this._updateFileMessageMetaArray(e.messageId,s,"remove",!0):this._updateUserMessageMetaArray(e.messageId,s,"remove",!0)}))}report(e,s){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(t.isEnumOf(exports.ReportCategory,e)&&t.isTypeOf("string",s)).throw(t.SendbirdError.invalidParameters);const{sdkState:i,requestQueue:n}=t.Vault.of(this._iid),a=new pt({channelUrl:this.url,channelType:this.channelType,userId:i.userId,category:e,description:s});yield n.send(a)}))}reportUser(e,s,i){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(e instanceof t.User&&t.isEnumOf(exports.ReportCategory,s)&&t.isTypeOf("string",i)).throw(t.SendbirdError.invalidParameters);const{sdkState:n,requestQueue:a}=t.Vault.of(this._iid),r=new mt({channelUrl:this.url,channelType:this.channelType,userId:n.userId,offendingUserId:e.userId,category:s,description:i});yield a.send(r)}))}reportMessage(e,s,i){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(e instanceof f&&t.isEnumOf(exports.ReportCategory,s)&&t.isTypeOf("string",i)).throw(t.SendbirdError.invalidParameters);const{sdkState:n,requestQueue:a}=t.Vault.of(this._iid),r=new _t({channelUrl:this.url,channelType:this.channelType,userId:n.userId,offendingUserId:e.sender.userId,messageId:e.messageId,category:s,description:i});yield a.send(r)}))}updatePoll(e,s){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(t.isTypeOf("number",e)&&(e=>t.isTypeOf("string",e.title,!0)&&t.validatePollData(e.data)&&t.isTypeOf("boolean",e.allowUserSuggestion,!0)&&t.isTypeOf("boolean",e.allowMultipleVotes,!0)&&t.isTypeOf("number",e.closeAt,!0))(s)).throw(t.SendbirdError.invalidParameters);const{requestQueue:i}=t.Vault.of(this._iid),n=new Rt(Object.assign({pollId:e},s)),a=yield i.send(n),{poll:r}=a.as(Lt);return r}))}deletePoll(e){return t.__awaiter(this,void 0,void 0,(function*(){const s=t.isTypeOf("number",e);t.unless(s).throw(t.SendbirdError.invalidParameters);const{requestQueue:i}=t.Vault.of(this._iid),n=new kt({pollId:e});yield i.send(n)}))}closePoll(e){return t.__awaiter(this,void 0,void 0,(function*(){const s=t.isTypeOf("number",e);t.unless(s).throw(t.SendbirdError.invalidParameters);const{requestQueue:i}=t.Vault.of(this._iid),n=new Dt({pollId:e}),a=yield i.send(n),{poll:r}=a.as(qt);return r}))}addPollOption(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const i=t.isTypeOf("number",e)&&t.isTypeOf("string",s)&&""!==s.trim();t.unless(i).throw(t.SendbirdError.invalidParameters);const{requestQueue:n}=t.Vault.of(this._iid),a=new Ft({channelUrl:this.url,channelType:this.channelType,pollId:e,optionText:s}),r=yield n.send(a),{poll:o}=r.as(Bt);return o}))}updatePollOption(e,s,i){return t.__awaiter(this,void 0,void 0,(function*(){const n=t.isTypeOf("number",e)&&t.isTypeOf("number",s)&&t.isTypeOf("string",i)&&""!==i.trim();t.unless(n).throw(t.SendbirdError.invalidParameters);const{requestQueue:a}=t.Vault.of(this._iid),r=new jt({pollId:e,pollOptionId:s,optionText:i}),o=yield a.send(r),{poll:l}=o.as(zt);return l}))}deletePollOption(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const i=t.isTypeOf("number",e)&&t.isTypeOf("number",s);t.unless(i).throw(t.SendbirdError.invalidParameters);const{requestQueue:n}=t.Vault.of(this._iid),a=new Vt({pollId:e,pollOptionId:s});yield n.send(a)}))}votePoll(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const i=t.isTypeOf("number",e)&&t.isArrayOf("number",s);t.unless(i).throw(t.SendbirdError.invalidParameters);const{requestQueue:n,dispatcher:a}=t.Vault.of(this._iid),r=new $t({reqId:this._generateRequestId(),channelUrl:this.url,channelType:this.channelType,pollId:e,pollOptionIds:s}),o=yield n.send(r),{event:l}=o.as(Qt);return a.dispatch(new t.PollVoteInternalEventCommand({event:l,source:t.CollectionEventSource.EVENT_POLL_VOTED})),l}))}getPollChangeLogsSinceTimestamp(e){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(t.isTypeOf("number",e)).throw(t.SendbirdError.invalidParameters);const s=t.PollManager.of(this._iid);return yield s.getPollChangeLogs(this.url,this.channelType,e)}))}getPollChangeLogsSinceToken(e){return t.__awaiter(this,void 0,void 0,(function*(){t.unless(t.isTypeOf("string",e,!0));const s=t.PollManager.of(this._iid);return yield s.getPollChangeLogs(this.url,this.channelType,e)}))}createPollListQuery(e=10){return new t.PollListQuery(this._iid,{channelUrl:this.url,channelType:this.channelType,limit:e})}createPollVoterListQuery(e,s,i=20){return new t.PollVoterListQuery(this._iid,{channelUrl:this.url,channelType:this.channelType,pollId:e,pollOptionId:s,limit:i})}}const Zt={};class es{constructor({dbname:e,itemSizeLimit:t=1048576,cacheLimit:s=256,blockHashBase:i=2,blockHashMultiplier:n=10,blockHashConstant:a=11,transactionApplyDelay:r=200,disableLogger:o=!1}){return Zt[e]||(this.itemSizeLimit=t,this.cacheLimit=s,this.blockHashBase=i,this.blockHashMultiplier=n,this.blockHashConstant=a,this.transactionApplyDelay=r,this.disableLogger=o,Zt[e]=this),Zt[e]}static get(e){return Zt[e]}}var ts,ss;!function(e){e[e.UNKNOWN_ERROR=6e7]="UNKNOWN_ERROR",e[e.STORE_NOT_DEFINED=61001e3]="STORE_NOT_DEFINED",e[e.STORE_NOT_AVAILABLE=61001001]="STORE_NOT_AVAILABLE",e[e.STORE_NOT_AVAILABLE_IN_PRIVATE_BROWSING=61001002]="STORE_NOT_AVAILABLE_IN_PRIVATE_BROWSING",e[e.STORE_IS_FULL=61001003]="STORE_IS_FULL",e[e.STORE_NOT_INITIALIZED=61001004]="STORE_NOT_INITIALIZED",e[e.STORE_INVALID_KEY_TYPE=61002e3]="STORE_INVALID_KEY_TYPE",e[e.STORE_BROKEN_INTEGRITY=61002001]="STORE_BROKEN_INTEGRITY",e[e.STORE_BROKEN_BLOB=61002002]="STORE_BROKEN_BLOB",e[e.STORE_ENCRYPTION_INVALID=61002003]="STORE_ENCRYPTION_INVALID",e[e.STORE_ITEM_SIZE_LIMIT_EXCEEDED=61017e3]="STORE_ITEM_SIZE_LIMIT_EXCEEDED",e[e.STORE_READ_FAILED=61017001]="STORE_READ_FAILED",e[e.STORE_WRITE_FAILED=61017002]="STORE_WRITE_FAILED",e[e.DATABASE_SCHEMA_NOT_ON_UPGRADE=62002e3]="DATABASE_SCHEMA_NOT_ON_UPGRADE",e[e.COLLECTION_NOT_READY=63001e3]="COLLECTION_NOT_READY",e[e.COLLECTION_KEY_NOT_MATCH=63002e3]="COLLECTION_KEY_NOT_MATCH",e[e.COLLECTION_QUERY_NOT_VALID=63002001]="COLLECTION_QUERY_NOT_VALID",e[e.COLLECTION_KEY_NOT_FOUND=63004e3]="COLLECTION_KEY_NOT_FOUND",e[e.COLLECTION_KEY_NOT_GIVEN=63004001]="COLLECTION_KEY_NOT_GIVEN",e[e.COLLECTION_INSERT_DUPLICATE=63009e3]="COLLECTION_INSERT_DUPLICATE",e[e.COLLECTION_WRITE_FAILED=63017e3]="COLLECTION_WRITE_FAILED",e[e.COLLECTION_ITEM_SIZE_LIMIT_EXCEEDED=63017001]="COLLECTION_ITEM_SIZE_LIMIT_EXCEEDED",e[e.INDEX_TABLE_IS_REQUIRED=65001e3]="INDEX_TABLE_IS_REQUIRED",e[e.INDEX_TYPE_NOT_MATCH=65002e3]="INDEX_TYPE_NOT_MATCH",e[e.COMPARE_TYPE_NOT_MATCH=69002001]="COMPARE_TYPE_NOT_MATCH",e[e.CIRCULAR_REFERENCE_FOUND=69002002]="CIRCULAR_REFERENCE_FOUND"}(ts||(ts={}));class is extends Error{constructor({code:e=ts.UNKNOWN_ERROR,message:t="Unknown error occurred."}){super(t),this.code=e,Object.setPrototypeOf(this,is.prototype)}static get storeNotDefined(){return new is({code:ts.STORE_NOT_DEFINED,message:"Store is not defined. Specify the store on NestDB()"})}static get storeNotAvailable(){return new is({code:ts.STORE_NOT_AVAILABLE,message:"Store is not available. Check your environment settings."})}static get storeNotAvailableInPrivateBrowsing(){return new is({code:ts.STORE_NOT_AVAILABLE_IN_PRIVATE_BROWSING,message:"Store is not available because it is in private browsing."})}static get storeIsFull(){return new is({code:ts.STORE_IS_FULL,message:"Store is full."})}static get storeNotInitialized(){return new is({code:ts.STORE_NOT_INITIALIZED,message:"Store is not initialized."})}static get storeKeyTypeIsInvalid(){return new is({code:ts.STORE_INVALID_KEY_TYPE,message:"Store key should be string type."})}static get storeBrokenIntegrity(){return new is({code:ts.STORE_BROKEN_INTEGRITY,message:"Data should be in a store but it does not. Integrity is broken."})}static get storeBrokenBlob(){return new is({code:ts.STORE_BROKEN_BLOB,message:"Data should be in a store but it does not. Blob data is broken."})}static get storeEncryptionInvalid(){return new is({code:ts.STORE_ENCRYPTION_INVALID,message:"Encryption algorithm has changed. All the store should reset."})}static get storeItemSizeExceeded(){return new is({code:ts.STORE_ITEM_SIZE_LIMIT_EXCEEDED,message:"The size of the item exceeds the limit that the store allows."})}static get storeReadFailed(){return new is({code:ts.STORE_READ_FAILED,message:"Failed to read from store."})}static get storeWriteFailed(){return new is({code:ts.STORE_WRITE_FAILED,message:"Failed to write to store."})}static get databaseSchemaNotOnUpgrade(){return new is({code:ts.DATABASE_SCHEMA_NOT_ON_UPGRADE,message:"Committing schema is not allowed when upgrade is not running."})}static get collectionNotReady(){return new is({code:ts.COLLECTION_NOT_READY,message:"Collection is not ready due to an error during initialization."})}static get collectionKeyNotMatch(){return new is({code:ts.COLLECTION_KEY_NOT_MATCH,message:"keyName of collection could not change."})}static get collectionQueryNotValid(){return new is({code:ts.COLLECTION_QUERY_NOT_VALID,message:"Query parameter is not a valid format."})}static get collectionInsertDuplicate(){return new is({code:ts.COLLECTION_INSERT_DUPLICATE,message:"The key already exists."})}static get collectionKeyNotFound(){return new is({code:ts.COLLECTION_KEY_NOT_FOUND,message:"The key is not found."})}static get collectionKeyNotGiven(){return new is({code:ts.COLLECTION_KEY_NOT_GIVEN,message:"The item should contain [keyName] property."})}static get collectionWriteFailed(){return new is({code:ts.COLLECTION_WRITE_FAILED,message:"Failed to write an item."})}static get collectionItemSizeExceeded(){return new is({code:ts.COLLECTION_ITEM_SIZE_LIMIT_EXCEEDED,message:"The size of the item exceeds the limit that a collection allows."})}static get indexTableIsRequired(){return new is({code:ts.INDEX_TABLE_IS_REQUIRED,message:"Index table is required."})}static get indexTypesNotMatch(){return new is({code:ts.INDEX_TYPE_NOT_MATCH,message:"Indexed column should have primitive type."})}static get compareTypesNotMatch(){return new is({code:ts.COMPARE_TYPE_NOT_MATCH,message:"Values to compare have different types."})}static get circularReferenceFound(){return new is({code:ts.CIRCULAR_REFERENCE_FOUND,message:"Cannot handle circular referenced object."})}}!function(e){e.INIT="init",e.READY="ready",e.CLOSED="closed"}(ss||(ss={}));const ns=(e,t=new WeakMap)=>{if("object"==typeof e&&null!==e){if(t.has(e))throw is.circularReferenceFound;{let s;if(t.set(e,!0),Array.isArray(e))s=e.map((e=>ns(e,t)));else if(e instanceof RegExp)s=e;else if(e instanceof Date)s=e;else{s={};for(const i in e)s[i]=ns(e[i],t)}return t.delete(e),s}}return e},as=(e,t)=>{if(null==t)return 1;if(null==e)return-1;if(typeof e!=typeof t)throw is.compareTypesNotMatch;let s=0;switch(typeof e){case"boolean":case"number":s=e-t;break;case"string":s=e.localeCompare(t)}return s},rs=(e,t)=>{let s=0;for(let t=0;t<e.length;t++)s=e.charCodeAt(t)+(s<<6)+(s<<16)-s;return(s>>>0)%t},os=e=>new Promise((t=>{setTimeout((()=>t()),e)})),ls=(e,t)=>{if(!t)return!1;if("function"!=typeof e){for(const s in e)if(["/and","&&"].includes(s)){if(e[s].some((e=>!ls(e,t))))return!1}else if(["/or","||"].includes(s)){if(e[s].every((e=>!ls(e,t))))return!1}else if("/where"===s){if(!(0,e[s])(t))return!1}else{const i=s;if("object"==typeof e[i]){const s=e[i];for(const e in s)switch(e){case"/eq":case"=":if(t[i]!==s[e])return!1;break;case"/neq":case"!=":if(t[i]===s[e])return!1;break;case"/gt":case">":{const n=t[i],a=s[e];if(!(as(n,a)>0))return!1;break}case"/gte":case">=":{const n=t[i],a=s[e];if(!(as(n,a)>=0))return!1;break}case"/lt":case"<":{const n=t[i],a=s[e];if(!(as(n,a)<0))return!1;break}case"/lte":case"<=":{const n=t[i],a=s[e];if(!(as(n,a)<=0))return!1;break}case"/in":{const n=t[i];if(!s[e].includes(n))return!1;break}case"/nin":{const n=t[i];if(s[e].includes(n))return!1;break}case"/contain":{const n=t[i],a=s[e];if(!n.includes(a))return!1;break}case"/regex":{const n=t[i];if(!s[e].test(n))return!1;break}case"/where":{const n=t[i];if(!(0,s[e])(n))return!1;break}}}else if("function"==typeof e[i]){if(!e[i](t[i]))return!1}else if(e[i]!==t[i])return!1}return!0}return e(t)},ds=()=>{},us=()=>Promise.resolve(),cs=e=>e,hs=(e,t)=>{t()};var ps;!function(e){e[e.FORWARD=0]="FORWARD",e[e.BACKWARD=1]="BACKWARD"}(ps||(ps={}));class ms{constructor({initialPrevValue:e=null,initialNextValue:t=null,iterator:s,map:i=cs,backward:n=us,forward:a=us,complete:r=ds}){this._prevValue=e,this._nextValue=t,this._error=null,this._map=i,this._backward=n,this._forward=a,this._iterator=s,this._complete=r}get prevValue(){return this._map(this._prevValue)}get nextValue(){return this._map(this._nextValue)}get error(){return this._error}get hasPrevious(){return!!this._prevValue}get hasNext(){return!!this._nextValue}prev(){return t.__awaiter(this,void 0,void 0,(function*(){if(this.hasPrevious){try{const e=this._prevValue;this._prevValue=(yield this._backward())||null,this._nextValue=e}catch(e){this._error=e}return yield this._iterator(this)}this._complete()}))}next(){return t.__awaiter(this,void 0,void 0,(function*(){if(this.hasNext){try{const e=this._nextValue;this._nextValue=(yield this._forward())||null,this._prevValue=e}catch(e){this._error=e}return yield this._iterator(this)}this._complete()}))}stop(){this._prevValue=null,this._nextValue=null,this._complete()}}class _s{constructor({condition:e={},backward:t=!1,blockManager:s,indexer:i}){this.condition=e,this.backward=t,this._blockManager=s,this._indexer=i}findOptimizedStartPosition(){const e=["=","/eq",">",">=","/gt","/gte"],t=["=","/eq","<","<=","/lt","/lte"];if(this.backward){let s=this._indexer.origin.length-1;if("function"!=typeof this.condition)for(const i in this._indexer.fields){let n=this._indexer.fields[i],a=1;if("-"===n[0]&&(n=n.slice(1),a=-1),this.condition[n])if("object"==typeof this.condition[n]){const r=a>0?t:e;for(const e in this.condition[n])if(r.includes(e))for(let t=s;t>=0;t--)if(a*as(this._indexer.origin[t].columnValues[i],this.condition[n][e])<=0){s=t;break}}else for(let e=s;e>=0;e--)if(a*as(this._indexer.origin[e].columnValues[i],this.condition[n])<=0){s=e;break}}return Math.min(s+1,this._indexer.origin.length-1)}{let s=0;if("function"!=typeof this.condition)for(let i=0;i<this._indexer.fields.length;i++){let n=this._indexer.fields[i],a=1;if("-"===n[0]&&(n=n.slice(1),a=-1),this.condition[n])if("object"==typeof this.condition[n])Object.keys(this.condition[n]).forEach((r=>{if((a>0?e:t).includes(r))for(let e=s;e<this._indexer.origin.length;e++)if(a*as(this._indexer.origin[e].columnValues[i],this.condition[n][r])>=0){s=e;break}}));else for(let e=s;e<this._indexer.origin.length;e++)if(a*as(this._indexer.origin[e].columnValues[i],this.condition[n])>=0){s=e;break}}return Math.max(s-1,0)}}each(e){return t.__awaiter(this,void 0,void 0,(function*(){let s=this.findOptimizedStartPosition(),i=0;this.backward&&this._indexer.origin[s]&&(i=this._indexer.origin[s].keys.length-1);const n=()=>{if(this._indexer.origin[s]){if(!this._indexer.origin[s].keys[++i]){if(!this._indexer.origin[++s])return!1;i=0}return!0}return!1},a=()=>{if(this._indexer.origin[s]){if(!this._indexer.origin[s].keys[--i]){if(!this._indexer.origin[--s])return!1;i=this._indexer.origin[s].keys.length-1}return!0}return!1};let r=null;if(this._indexer.origin[s]){const e=this.backward?a:n;do{const e=yield this._blockManager.getFromBlock(this._indexer.origin[s].keys[i]);if(e&&ls(this.condition,e)){r=e;break}}while(e())}return yield new Promise((o=>{const l=new ms({initialNextValue:ns(r),iterator:e,forward:()=>t.__awaiter(this,void 0,void 0,(function*(){const e=this.backward?a:n;for(;e();){const e=yield this._blockManager.getFromBlock(this._indexer.origin[s].keys[i]);if(e&&ls(this.condition,e))return ns(e)}return null})),backward:()=>t.__awaiter(this,void 0,void 0,(function*(){const e=this.backward?n:a;for(;e();){const e=yield this._blockManager.getFromBlock(this._indexer.origin[s].keys[i]);if(e&&ls(this.condition,e))return ns(e)}return null})),complete:o});e(l)}))}))}}class gs{constructor({condition:e={},backward:t=!1,mutex:s,blockManager:i,indexer:n}){this._mutex=s,this._iterator=new _s({condition:e,backward:t,blockManager:i,indexer:n})}fetch(e={}){return t.__awaiter(this,void 0,void 0,(function*(){let s=Math.max(e.offset||0,0);const i="number"==typeof e.limit?e.limit:Number.MAX_SAFE_INTEGER;if(0===i)return[];if(i<0)throw is.collectionQueryNotValid;try{const e=[];return yield this._mutex.lock(),yield this._iterator.each((n=>t.__awaiter(this,void 0,void 0,(function*(){n.error?n.stop():n.hasNext?0===s?(e.push(n.nextValue),0<i&&i<=e.length?n.stop():n.next()):(s--,n.next()):n.stop()})))),this._mutex.unlock(),e}catch(e){throw this._mutex.unlock(),e}}))}count(){return t.__awaiter(this,void 0,void 0,(function*(){try{let e=0;return yield this._mutex.lock(),yield this._iterator.each((s=>t.__awaiter(this,void 0,void 0,(function*(){s.error?s.stop():s.hasNext?(e++,s.next()):s.stop()})))),this._mutex.unlock(),e}catch(e){throw this._mutex.unlock(),e}}))}}const ys=e=>`nest@${e}`,fs=(e,t)=>`${ys(e)}/${t}`,vs=(e,t)=>`${fs(e,t)}.metadata`,Is=(e,t)=>`${fs(e,t)}/block.`,Es=(e,t)=>`${fs(e,t)}/blob.`;class Ts{constructor({dbname:e,collectionName:t,store:s}){this.dbname=e,this.collectionName=t,this.store=s}get(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield this.store.get(e);if(t){const{data:e,type:s}=t;if("undefined"!=typeof fetch){const t=yield fetch(e);return yield t.blob()}{const t=512,i=[],n=atob(e.split(",")[1]);for(let e=0;e<n.length;e+=t){const s=n.slice(e,e+t),a=new Array(s.length);for(let e=0;e<s.length;e++)a[e]=s.charCodeAt(e);i.push(new Uint8Array(a))}return new Blob(i,{type:s})}}return null}))}save(e,s=`${Date.now()}`){return t.__awaiter(this,void 0,void 0,(function*(){const{blobId:t,data:i,type:n}=yield new Promise((t=>{const i=((e,t,s,i=0)=>`${Es(e,t)}${s}.${i}`)(this.dbname,this.collectionName,s),n=new FileReader;n.onload=()=>{t({blobId:i,data:n.result,type:e.type})},n.readAsDataURL(e)}));return yield this.store.set({key:t,value:{data:i,type:n}}),t}))}remove(e){return t.__awaiter(this,void 0,void 0,(function*(){yield this.store.remove(e)}))}clear(){return t.__awaiter(this,void 0,void 0,(function*(){const e=Es(this.dbname,this.collectionName),s=yield this.store.getAllKeys();yield Promise.all(s.filter((t=>t.startsWith(e))).map((e=>t.__awaiter(this,void 0,void 0,(function*(){return yield this.store.remove(e)})))))}))}}var bs,Ss,Ms;!function(e){e[e.COMMIT=0]="COMMIT",e[e.WRITE=1]="WRITE",e[e.ERROR=2]="ERROR"}(bs||(bs={})),function(e){e.PENDING="pending",e.PERSISTENT="persistent",e.VOLATILE="volatile"}(Ss||(Ss={})),function(e){e[e.NO_CACHE=0]="NO_CACHE",e[e.DEFAULT=1]="DEFAULT",e[e.PERSISTENT=2]="PERSISTENT"}(Ms||(Ms={}));const Os=[Ss.PENDING,Ss.VOLATILE],As={};class Cs{constructor({dbname:e,limit:t=256}){return As[e]||(this.dbname=e,this._items=[],this._limit=t,As[e]=this),As[e]}static get(e){return As[e]}get items(){return this._items}find(e,s,i=Ms.DEFAULT){return t.__awaiter(this,void 0,void 0,(function*(){let t=this.get(s);if(t)i===Ms.PERSISTENT&&(t.state=Ss.PERSISTENT);else{const n=yield e.get(s);n&&(t={key:s,value:n,state:i===Ms.PERSISTENT?Ss.PERSISTENT:Ss.VOLATILE},this.put(t))}return t}))}get(e,t=Ms.DEFAULT){const s=this._items.map((e=>e.key)).indexOf(e);if(s>-1){const e=this._items[s];return t===Ms.PERSISTENT&&(e.state=Ss.PERSISTENT),t!==Ms.NO_CACHE&&this.put(e),e}return null}put(e){if(this._limit>0){const t=this._items.map((e=>e.key)).indexOf(e.key);if(t>-1)Os.includes(this._items[t].state)&&Os.includes(e.state)?(this._items.splice(t,1),this._items.push(e)):(this._items[t].state=e.state,this._items[t].value=e.value);else{this._items.push(e);const t=this._items.filter((e=>e.state===Ss.VOLATILE));let s=t.length-this._limit;if(s>0){const e=[];for(const t of this._items)t.state===Ss.VOLATILE&&s>0?s--:e.push(t);this._items=e}}}}remove(e){const t=this._items.map((e=>e.key)).indexOf(e);t>-1&&this._items.splice(t,1)}clearByCondition(e){this._items=this._items.filter((t=>!e(t)))}clear(e=!1){this._items=e?[]:this._items.filter((e=>e.state!==Ss.VOLATILE))}}class ws{constructor({dbname:e,collectionName:t,store:s}){this._requests=[],this._onCommit=new Map,this._onWrite=new Map,this._onError=new Map,this.dbname=e,this.collectionName=t,this.metadataKey=((e,t)=>`${fs(e,t)}/trans.metadata`)(e,t),this.recordsetKey=((e,t)=>`${fs(e,t)}/trans.recordset`)(e,t),this._store=s}get generation(){return this._metadata?this._metadata.generation:0}get requestCount(){return this._requests.length}_getReducedRecordset(e=[]){return t.__awaiter(this,void 0,void 0,(function*(){const t=(yield this._store.get(this.recordsetKey))||[];return t.push(...e),this._reduceRecordSet(t)}))}_reduceRecordSet(e){const t=[],s={};for(let i=e.length-1;i>=0;i--){const n=e[i],a=[];for(let e=n.requests.length-1;e>=0;e--){const t=n.requests[e],i=t.data;s[i.key]||(a.unshift(t),s[i.key]=!0)}a.length>0&&(n.requests=a,t.unshift(n))}return t}_applyRecord(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const t=Cs.get(this.dbname),{generation:i,requests:n}=s;let a=null;try{const e=yield this._store.setMany(n.map((e=>Object.assign(Object.assign({},e.data),{generation:i}))));for(let s=0;s<n.length;s++)if(e[s]instanceof Error){a||(a=e[s]);const{data:i}=n[s];t.put(Object.assign(Object.assign({},i),{state:Ss.PERSISTENT}))}}catch(e){a=e}if(a)this._onError.forEach((e=>{a&&e(a)}));else{const t=e.filter((e=>e.generation!==i));yield this._store.set({key:this.recordsetKey,value:t}),this._onWrite.forEach((e=>{e(n.map((e=>e.data)))}))}}))}init(){return t.__awaiter(this,void 0,void 0,(function*(){this._metadata=(yield this._store.get(this.metadataKey))||{generation:1};const e=yield this._getReducedRecordset();for(const t of e)yield this._applyRecord(e,t)}))}on(e,t,s){switch(e){case bs.COMMIT:this._onCommit.set(t,s);break;case bs.WRITE:this._onWrite.set(t,s);break;case bs.ERROR:this._onError.set(t,s)}}requestWrite(e,t){this._requests.push({data:e,options:t});Cs.get(this.dbname).put(Object.assign({state:Ss.PENDING},e))}requestMultipleWrite(e,t){const s=Cs.get(this.dbname);for(const i of e)this._requests.push({data:i,options:t}),s.put(Object.assign({state:Ss.PENDING},i))}clear(){return t.__awaiter(this,void 0,void 0,(function*(){Cs.get(this.dbname).clearByCondition((e=>e.state===Ss.PENDING)),this._requests=[]}))}commit(){return t.__awaiter(this,void 0,void 0,(function*(){const e=this._requests;if(e.length>0){const t=[],s={};for(let i=e.length-1;i>=0;i--){const n=e[i],a=n.data;s[a.key]||(s[a.key]=!0,t.unshift(n))}const i={generation:this.generation,requests:t},n=yield this._getReducedRecordset([i]);yield this._store.set({key:this.recordsetKey,value:n}),this._metadata.generation++,yield this._store.set({key:this.metadataKey,value:this._metadata});const a=Cs.get(this.dbname);for(let e=0;e<t.length;e++){const{data:s,options:i}=t[e];a.put(Object.assign(Object.assign({},s),{state:i&&i.persistent?Ss.PERSISTENT:Ss.VOLATILE}))}this._requests=[],this._onCommit.forEach((t=>{t(e.map((e=>e.data)))}));const r=es.get(this.dbname);setTimeout((()=>{try{this._applyRecord(n,i)}catch(e){this._onError.forEach((t=>t(e)))}}),r.transactionApplyDelay)}}))}}class Ns{constructor({blockId:e,keyName:t,items:s=[],limit:i}){this.blockId=e,this.keyName=t,this.limit=i,this._items=[...s]}static createFromCacheItem(e){return e?new Ns(e.value):null}get isEmpty(){return 0===this._items.length}get items(){return this._items}serialize(){return{blockId:this.blockId,keyName:this.keyName,limit:this.limit,items:this._items}}getItemByKey(e){const t=this._items.find((t=>{const s=t[this.keyName];return e===s}));return null!=t?t:null}has(e){return this._items.map((e=>e[this.keyName])).includes(e)}add(e){const t=this._items.map((e=>e[this.keyName])).indexOf(e[this.keyName]);return t<0?this._items.length<this.limit&&(this._items.push(e),!0):(this._items[t]=e,!0)}remove(e){for(const t in this._items)if(this._items[t][this.keyName]===e)return this._items.splice(parseInt(t),1),!0;return!1}clear(){this._items=[]}}class Ps{constructor({dbname:e,collectionName:t,metadata:s,hashFunction:i=rs,transaction:n,store:a}){this.dbname=e,this.collectionName=t,this.hashFunction=i,this.metadata=s,this._transaction=n,this._store=a}get keyName(){return this.metadata.keyName}createBlockId(e,t=this.metadata.blockLevel){return s=this.dbname,i=this.collectionName,n=t,a=`${((e,t,s)=>{const i=s.base*Math.pow(s.multiplier,t)+s.constant;return(s.hashFunction||rs)(e,i)})(e,t,{hashFunction:this.hashFunction,base:this.metadata.blockHashBase,multiplier:this.metadata.blockHashMultiplier,constant:this.metadata.blockHashConstant})}`,`${Is(s,i)}${n}.${a}`;var s,i,n,a}_findBlock(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=Cs.get(this.dbname);for(let s=this.metadata.blockLevel;s>0;s--){const i=this.createBlockId(e,s),n=yield t.find(this._store,i);if(n){const t=Ns.createFromCacheItem(n);if(null==t?void 0:t.getItemByKey(e))return t}}return null}))}getFromBlock(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield this._findBlock(e);return t?t.getItemByKey(e):null}))}putToBlock(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const t=es.get(this.dbname),i=this.createBlockId(e),n=Math.floor(this._store.itemSizeLimit/t.itemSizeLimit),a=Cs.get(this.dbname),r=yield a.find(this._store,i),o=r?Ns.createFromCacheItem(r):new Ns({blockId:i,keyName:this.keyName,items:[],limit:n});return!!(null==o?void 0:o.add(s))&&(this._transaction.requestWrite({key:o.blockId,value:o.serialize()}),!0)}))}removeFromBlock(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield this._findBlock(e);return!(!t||!t.remove(e))&&(this._transaction.requestWrite({key:t.blockId,value:t.serialize()}),!0)}))}clearAllBlocks(){return t.__awaiter(this,void 0,void 0,(function*(){const e=Is(this.dbname,this.collectionName),t=(yield this._store.getAllKeys()).filter((t=>t.startsWith(e)));yield this._store.removeMany(t),yield this._transaction.clear();Cs.get(this.dbname).clearByCondition((t=>t.key.startsWith(e)))}))}}const Us=e=>{const t=typeof e;return null===e||"undefined"===t||"boolean"===t||"number"===t||"string"===t},xs={};class Rs{constructor({dbname:e,collectionName:t,keyName:s,fields:i,transaction:n,store:a}){this._origin=[],this._table=[];const r=((e,t,s)=>`${fs(e,t)}/index.${s}`)(e,t,i.join(">"));return xs[r]||(this.dbname=e,this.collectionName=t,this.keyName=s,this.fields=i,this.indexerKey=r,this._transaction=n,this._store=a,this._transaction.on(bs.COMMIT,this.indexerKey,(()=>this.commit())),this._transaction.on(bs.ERROR,this.indexerKey,(()=>this.abort()))),xs[r]}static createKey(e){return e.join(">")}static parseKey(e){return e.split(">")}static clearIndexerMap(){for(const e in xs)delete xs[e]}_addItem(e){const t=e[this.keyName],s=this.getColumnValues(e),[i,n]=this.indexOf(s);return n?!this._table[i].keys.includes(t)&&(this._table[i].keys.push(t),!0):(this._table.splice(i,0,{columnValues:s,keys:[t]}),!0)}_removeItem(e){const t=e[this.keyName],s=this.getColumnValues(e),[i,n]=this.indexOf(s);if(n){const e=this._table[i].keys.indexOf(t);if(e>-1)return this._table[i].keys.splice(e,1),0===this._table[i].keys.length&&this._table.splice(i,1),!0}return!1}get origin(){return this._origin}get table(){return this._table}getColumnValues(e){const t=[];for(let s of this.fields){if("-"===s[0]&&(s=s.slice(1)),!Us(e[s]))throw is.indexTypesNotMatch;t.push(e[s])}return t}diff(e,t){for(const s in this.fields){const i="-"===this.fields[s][0]?-1:1,n=as(e[s],t[s]);if(0!==n)return i*n}return 0}indexOf(e){if(this._table.length>0){let t=0,s=this._table.length-1;for(;t<=s;){const i=Math.floor((t+s)/2),n=this.diff(e,this._table[i].columnValues);if(n>0)t=i+1;else{if(!(n<0))return[i,!0];s=i-1}}return[t,!1]}return[0,!1]}ensure(){return t.__awaiter(this,void 0,void 0,(function*(){const e=Cs.get(this.dbname),t=yield e.find(this._store,this.indexerKey,Ms.PERSISTENT);if(t)this._origin=t.value,this._table=ns(this._origin);else{const t=Is(this.dbname,this.collectionName),s=yield this._store.getAllKeys();for(const i of s)if(i.startsWith(t)){const t=yield e.find(this._store,i,Ms.NO_CACHE),s=Ns.createFromCacheItem(t);if(s)for(const e of s.items)this._addItem(e)}this._transaction.requestWrite({key:this.indexerKey,value:this._table},{persistent:!0})}xs[this.indexerKey]=this}))}drop(){return t.__awaiter(this,void 0,void 0,(function*(){Cs.get(this.dbname).remove(this.indexerKey),yield this._store.remove(this.indexerKey),delete xs[this.indexerKey]}))}addItem(e){return t.__awaiter(this,void 0,void 0,(function*(){this._addItem(e)&&this._transaction.requestWrite({key:this.indexerKey,value:this._table},{persistent:!0})}))}removeItem(e){return t.__awaiter(this,void 0,void 0,(function*(){this._removeItem(e)&&this._transaction.requestWrite({key:this.indexerKey,value:this._table},{persistent:!0})}))}clear(){return t.__awaiter(this,void 0,void 0,(function*(){this._table=[],this._transaction.requestWrite({key:this.indexerKey,value:this._table},{persistent:!0})}))}commit(){this._origin=this._table,this._table=ns(this._origin)}abort(){this._table=ns(this._origin)}}const Ls=()=>"undefined"!=typeof document&&"undefined"!=typeof navigator&&"ReactNative"!==navigator.product,ks=()=>{let e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(t=>{const s=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?s:3&s|8).toString(16)}))};var Ds,qs;!function(e){e[e.PROCESSING=0]="PROCESSING",e[e.DONE=1]="DONE"}(Ds||(Ds={})),function(e){e.NEWNODE="newnode",e.REMOVENODE="removenode",e.CLAIM_HOST="claimhost",e.SYNC_HOST="synchost",e.REQUEST_LOCK="requestlock",e.ACQUIRE_LOCK="acquirelock",e.RELEASE_LOCK="releaselock"}(qs||(qs={}));const Fs={};class Bs{constructor(e,t={}){return this._state=Ds.PROCESSING,this._queue=[],this._activationQueue=[],Fs[e]&&!t.forceCreate||(this.nodeId=ks(),this.key=e,Ls()&&(t.startAsInvisible?this.registerNode():"visible"===document.visibilityState?this.claimHost():this.registerNode(),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&this.claimHost()})),window.addEventListener("message",(e=>{const t=e.data,{nodeId:s,requestId:i,key:n,op:a,data:r}=t;if(s!==this.nodeId&&n===this.key)switch(a){case qs.NEWNODE:this._sendSync();break;case qs.CLAIM_HOST:this._sendSync(),this._hostId=s;break;case qs.SYNC_HOST:if(!this.isInSync){this._activationTimeout&&clearTimeout(this._activationTimeout);const{currentItemRequestId:e,queue:t}=r;for(const e of t){this._queue.findIndex((t=>t.requestId===e.requestId))<0&&this._requestLock({nodeId:e.nodeId,requestId:e.requestId,key:this.key,op:qs.REQUEST_LOCK,ts:e.ts})}this._currentItem=this._queue.find((t=>t.requestId===e)),this._completeSync()}break;case qs.REMOVENODE:this._queue=this._queue.filter((e=>e.nodeId!==t.nodeId)),this._currentItem&&this._currentItem.nodeId===t.nodeId&&(this._currentItem=void 0,this._acquire(this._queue[0]));break;case qs.REQUEST_LOCK:this._requestLock(t);break;case qs.ACQUIRE_LOCK:{const e=this._queue.find((e=>e.requestId===i));this._acquire(e);break}case qs.RELEASE_LOCK:this._release(i)}})),window.addEventListener("beforeunload",(()=>{this._send(qs.REMOVENODE)}))),Fs[e]=this),Fs[e]}get locked(){return!!this._currentItem}get isHost(){return this._hostId===this.nodeId}get isInSync(){return this._state==Ds.DONE}_send(e,t={}){var s;const i={nodeId:this.nodeId,requestId:null!==(s=null==t?void 0:t.requestId)&&void 0!==s?s:ks(),key:this.key,op:e,data:t.data,ts:Date.now()};return Ls()&&window.postMessage(i,"*"),i}_acquire(e){e?(this._currentItem=e,this._currentItem.onAcquired&&this._currentItem.onAcquired(e.requestId)):this._currentItem=void 0}_release(e){if(this._currentItem&&this._currentItem.requestId===e){const t=this._currentItem;this._currentItem=void 0,t.nodeId===this.nodeId&&this._send(qs.RELEASE_LOCK,{requestId:t.requestId});const s=this._queue.findIndex((t=>t.requestId===e));s>-1&&this._queue.splice(s,1),t.onReleased&&t.onReleased(e)}}_requestLock(e){return new Promise((t=>{const s={nodeId:e.nodeId,requestId:e.requestId,ts:e.ts,onAcquired:e=>{this.isHost&&this._send(qs.ACQUIRE_LOCK,{requestId:e}),t()},onReleased:()=>{this._acquire(this._queue[0])}};let i=!1;for(const e in this._queue)if(this._queue[e].ts>s.ts){this._queue.splice(parseInt(e),0,s),i=!0;break}i||this._queue.push(s),this._currentItem||this._acquire(this._queue[0])}))}_sendSync(){var e;this.isHost&&this._send(qs.SYNC_HOST,{data:{currentItemRequestId:null===(e=this._currentItem)||void 0===e?void 0:e.requestId,queue:this._queue.map((e=>({nodeId:e.nodeId,requestId:e.requestId,ts:e.ts})))}})}_waitUntilSyncCompleted(){return t.__awaiter(this,void 0,void 0,(function*(){if(this.isHost&&!this.isInSync)return new Promise((e=>{this._activationQueue.push(e)}))}))}_waitSync(){this.isInSync||(this._activationTimeout=setTimeout((()=>{this._completeSync()}),8))}_completeSync(){this.isInSync||(this._state=Ds.DONE,this._activationQueue.forEach((e=>e())),this._activationQueue=[])}registerNode(){this._send(qs.NEWNODE),this._waitSync()}claimHost(){this._hostId=this.nodeId,this._send(qs.CLAIM_HOST),this._waitSync()}lock(){return t.__awaiter(this,void 0,void 0,(function*(){yield this._waitUntilSyncCompleted();const e=this._send(qs.REQUEST_LOCK);yield this._requestLock(e)}))}unlock(){var e;(null===(e=this._currentItem)||void 0===e?void 0:e.requestId)&&this._release(this._currentItem.requestId)}}class js{constructor({dbname:e,collectionName:t,keyName:s,keyHash:i,indexes:n,store:a}){this._state=ss.INIT,this._indexers=[],this.dbname=e,this.name=t,this.keyName=s,this.indexes=[[s],...n.filter((e=>Rs.createKey(e)!==this.keyName))],this._keyHash=i,this._store=a,this._mutex=new Bs(((e,t)=>`${fs(e,t)}.lock`)(e,t)),this._blobContainer=new Ts({dbname:e,collectionName:t,store:a}),this._transaction=new ws({dbname:e,collectionName:t,store:a})}static metadataOf(e,s,i){return t.__awaiter(this,void 0,void 0,(function*(){const t=vs(e,s);return yield i.get(t)}))}get state(){return this._state}get isReady(){return this._state===ss.READY}init(){return t.__awaiter(this,void 0,void 0,(function*(){yield this._mutex.lock();try{const e=es.get(this.dbname),t=yield js.metadataOf(this.dbname,this.name,this._store);this._metadata=t||{keyName:this.keyName,blockLevel:1,blockHashBase:e.blockHashBase,blockHashMultiplier:e.blockHashMultiplier,blockHashConstant:e.blockHashConstant,indexes:this.indexes},yield this._transaction.init(),this._blockManager=new Ps({dbname:this.dbname,collectionName:this.name,hashFunction:this._keyHash,metadata:this._metadata,transaction:this._transaction,store:this._store});const s=[...this.indexes],i=[],n=s.map((e=>Rs.createKey(e))),a=t?t.indexes.map((e=>Rs.createKey(e))):[];for(const e of a)n.includes(e)||i.push(Rs.parseKey(e));const r=[];if(r.push(...s.map((e=>{const t=new Rs({dbname:this.dbname,collectionName:this.name,keyName:this.keyName,fields:e,transaction:this._transaction,store:this._store});return this._indexers.push(t),t.ensure()}))),r.push(...i.map((e=>new Rs({dbname:this.dbname,collectionName:this.name,keyName:this.keyName,fields:e,transaction:this._transaction,store:this._store}).drop()))),yield Promise.all(r),yield this._transaction.commit(),n.sort().join(",")!==a.sort().join(",")){const e=vs(this.dbname,this.name);this._metadata.indexes=s,yield this._store.set({key:e,value:this._metadata})}this._state=ss.READY,this._mutex.unlock()}catch(e){throw this._mutex.unlock(),e}}))}close(){this._state=ss.CLOSED}_hasPropertyOfKeyName(e){const t=e[this.keyName];return"string"==typeof t&&!!t}_getIndexerBy(e=null){e||(e=[this.keyName]);const t=Rs.createKey(e);for(const e of this._indexers)if(t===Rs.createKey(e.fields))return e;throw is.indexTableIsRequired}_upgradeBlockLevel(){return t.__awaiter(this,void 0,void 0,(function*(){const e=vs(this.dbname,this.name);this._metadata.blockLevel++,yield this._store.set({key:e,value:this._metadata})}))}_requestInsert(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=e[this.keyName];if(yield this._blockManager.getFromBlock(t))throw is.collectionInsertDuplicate;(yield this._blockManager.putToBlock(t,e))||(yield this._upgradeBlockLevel(),yield this._blockManager.putToBlock(t,e));for(const t of this._indexers)yield t.addItem(e)}))}_requestUpsert(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=e[this.keyName],s=yield this._blockManager.getFromBlock(t);if(s){yield this._blockManager.putToBlock(t,e);for(const t of this._indexers)0!==t.diff(t.getColumnValues(s),t.getColumnValues(e))&&(yield t.removeItem(s),yield t.addItem(e))}else{(yield this._blockManager.putToBlock(t,e))||(yield this._upgradeBlockLevel(),yield this._blockManager.putToBlock(t,e));for(const t of this._indexers)yield t.addItem(e)}}))}_requestUpdate(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=e[this.keyName],s=yield this._blockManager.getFromBlock(t);if(s){yield this._blockManager.putToBlock(t,e);for(const t of this._indexers)0!==t.diff(t.getColumnValues(s),t.getColumnValues(e))&&(yield t.removeItem(s),yield t.addItem(e))}}))}_requestRemove(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield this._blockManager.getFromBlock(e);if(t){yield this._blockManager.removeFromBlock(e);for(const e of this._indexers)yield e.removeItem(t)}}))}_requestClear(){return t.__awaiter(this,void 0,void 0,(function*(){yield this._blockManager.clearAllBlocks();for(const e of this._indexers)yield e.clear()}))}getByKey(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw is.collectionNotReady;yield this._mutex.lock();try{const t=yield this._blockManager.getFromBlock(e);return this._mutex.unlock(),ns(t)}catch(e){throw this._mutex.unlock(),e}}))}query(e={}){if(this.isReady)return new gs({condition:e.where,mutex:this._mutex,blockManager:this._blockManager,indexer:this._getIndexerBy(e.index),backward:!!e.backward});throw is.collectionNotReady}insertOne(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw is.collectionNotReady;yield this._mutex.lock();try{if(!this._hasPropertyOfKeyName(e))throw is.collectionKeyNotGiven;return yield this._requestInsert(ns(e)),yield this._transaction.commit(),this._mutex.unlock(),e}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}insertMany(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw is.collectionNotReady;yield this._mutex.lock();try{if(e.some((e=>!this._hasPropertyOfKeyName(e))))throw is.collectionKeyNotGiven;for(const t of e)yield this._requestInsert(ns(t));return yield this._transaction.commit(),this._mutex.unlock(),e}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}upsertOne(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw is.collectionNotReady;yield this._mutex.lock();try{if(!this._hasPropertyOfKeyName(e))throw is.collectionKeyNotGiven;return yield this._requestUpsert(ns(e)),yield this._transaction.commit(),this._mutex.unlock(),e}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}upsertMany(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw is.collectionNotReady;yield this._mutex.lock();try{if(e.some((e=>!this._hasPropertyOfKeyName(e))))throw is.collectionKeyNotGiven;for(const t of e)yield this._requestUpsert(ns(t));return yield this._transaction.commit(),this._mutex.unlock(),e}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}update(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw is.collectionNotReady;yield this._mutex.lock();try{if(!this._hasPropertyOfKeyName(e))throw is.collectionKeyNotGiven;return yield this._requestUpdate(ns(e)),yield this._transaction.commit(),this._mutex.unlock(),e}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}updateIf(e,s){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw this._transaction.clear(),is.collectionNotReady;yield this._mutex.lock();try{const{where:i={},index:n=null,backward:a=!1}=e,r=[],o=new _s({condition:i,blockManager:this._blockManager,backward:a,indexer:this._getIndexerBy(n)});yield o.each((e=>t.__awaiter(this,void 0,void 0,(function*(){if(e.error)throw e.stop(),e.error;if(e.hasNext){const t=e.nextValue;if(ls(i,t)&&s.set){if("function"!=typeof s.set)for(const e in s.set)t[e]=s.set[e];else s.set(t);r.push(t)}e.next()}else e.stop()}))));for(const e of r)yield this._requestUpdate(ns(e));return yield this._transaction.commit(),this._mutex.unlock(),r}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}remove(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw is.collectionNotReady;yield this._mutex.lock();try{yield this._requestRemove(e),yield this._transaction.commit(),this._mutex.unlock()}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}removeIf(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw this._transaction.clear(),is.collectionNotReady;yield this._mutex.lock();try{const{where:s={},index:i=null,backward:n=!1}=e,a=[],r=new _s({condition:s,blockManager:this._blockManager,backward:n,indexer:this._getIndexerBy(i)});yield r.each((e=>t.__awaiter(this,void 0,void 0,(function*(){if(e.error)throw e.stop(),e.error;if(e.hasNext){const t=e.nextValue;if(ls(s,t)){const e=t[this.keyName];a.push(e)}e.next()}else e.stop()}))));for(const e of a)yield this._requestRemove(e);return yield this._transaction.commit(),this._mutex.unlock(),a}catch(e){throw this._mutex.unlock(),e}}))}clear(){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw is.collectionNotReady;yield this._mutex.lock();try{yield this._requestClear(),yield this._transaction.commit(),this._mutex.unlock()}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}getBlob(e){return t.__awaiter(this,void 0,void 0,(function*(){return yield this._blobContainer.get(e)}))}saveBlob(e,s){return t.__awaiter(this,void 0,void 0,(function*(){return yield this._blobContainer.save(e,s)}))}removeBlob(e){return t.__awaiter(this,void 0,void 0,(function*(){yield this._blobContainer.remove(e)}))}removeAllBlobs(){return t.__awaiter(this,void 0,void 0,(function*(){yield this._blobContainer.clear()}))}}const zs="[NESTDB]";let Vs=!0;class $s{static off(){Vs=!1}static log(...e){Vs&&console.log(`${zs}[LOG]`,...e)}static warning(...e){Vs&&console.warn(`${zs}[WARNING]`,...e)}static error(...e){Vs&&console.error(`${zs}[ERROR]`,...e)}}const Qs=[{},{a:700400,n:"error"}];class Ks{constructor(e){var s,i,n;this.encryption=null!==(s=e.encryption)&&void 0!==s?s:t.DEFAULT_ENCRYPTION,this.itemSizeLimit=null!==(i=e.itemSizeLimit)&&void 0!==i?i:4194304,this.metadataBuffer=null!==(n=e.metadataBuffer)&&void 0!==n?n:256}get _encryptionCheckKey(){return`${this.dbname}.encrypt`}get _reservedKeys(){return[this._encryptionCheckKey]}_getRawKey(e,t=""){return`${e}${t}`}_generateShardPostfixArray(e=1){return[...Array(e).keys()]}_shardify(e){const{key:t,value:s}=e,i=JSON.stringify(this.encryption.encrypt(s)),n=Math.ceil(i.length/this.adjustedItemSizeLimit);return this._generateShardPostfixArray(n).map((e=>{const s={key:this._getRawKey(t,`.${e}`),data:i.substring(e*this.adjustedItemSizeLimit,(e+1)*this.adjustedItemSizeLimit)};return 0===e&&(s.metadata={shards:n}),s}))}_resetIfEncryptionChanged(){return t.__awaiter(this,void 0,void 0,(function*(){const e=yield this.get(this._encryptionCheckKey),t={encrypted:Qs.map((e=>{var t;return null===(t=this.encryption)||void 0===t?void 0:t.encrypt(e)}))};if(e&&e.encrypted&&Array.isArray(e.encrypted))for(const s in e.encrypted){if(JSON.stringify(e.encrypted[s])!==JSON.stringify(t.encrypted[s])){$s.warning("Encryption algorithm has changed. Stored data would be cleared."),yield this.clear();break}}else yield this.clear();yield this.set({key:this._encryptionCheckKey,value:t})}))}get adjustedItemSizeLimit(){return Math.max(this.itemSizeLimit-this.metadataBuffer,4)}usage(){return t.__awaiter(this,void 0,void 0,(function*(){let e=0;const t=yield this._getAllRawKeys();for(const s of t){const t=yield this._getRaw(s);t&&(e+=JSON.stringify(t).length)}return e}))}getAllKeys(){return t.__awaiter(this,void 0,void 0,(function*(){return(yield this._getAllRawKeys()).filter((e=>e.endsWith(".0"))).map((e=>e.replace(/\.0$/,""))).filter((e=>!this._reservedKeys.includes(e)))}))}get(e){return t.__awaiter(this,void 0,void 0,(function*(){const s=this._getRawKey(e,".0"),i=yield this._getRaw(s);if(i)try{const{data:s,metadata:n}=i,a=(null==n?void 0:n.shards)&&n.shards>1?yield Promise.all(this._generateShardPostfixArray(null==n?void 0:n.shards).map((i=>t.__awaiter(this,void 0,void 0,(function*(){if(i>0){const t=this._getRawKey(e,`.${i}`),s=yield this._getRaw(t);if(!s)throw is.storeBrokenIntegrity;return s.data}return s}))))):[s];return this.encryption.decrypt(JSON.parse(a.join("")))}catch(e){return null}return null}))}set(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=this._shardify(e);return yield this._setRaw(t),Object.assign({},e.value)}))}setMany(e){return t.__awaiter(this,void 0,void 0,(function*(){return yield this._setRaw([].concat(...e.map((e=>this._shardify(e))))),e.map((e=>e.value))}))}remove(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=this._getRawKey(e,".0"),s=yield this._getRaw(t);if(s){const{metadata:t}=s;return yield this._removeRaw(this._generateShardPostfixArray(null==t?void 0:t.shards).map((t=>this._getRawKey(e,`.${t}`)))),!0}return!1}))}removeMany(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=[];for(const s of e){const e=this._getRawKey(s,".0"),i=yield this._getRaw(e);if(i){const{metadata:e}=i;t.push(...this._generateShardPostfixArray(null==e?void 0:e.shards).map((e=>this._getRawKey(s,`.${e}`))))}}return t.length>0&&(yield this._removeRaw(t)),e}))}}const Gs=1,Hs={};class Ws extends Ks{constructor(e={}){var t;super(Object.assign(Object.assign({},e),{itemSizeLimit:null!==(t=e.itemSizeLimit)&&void 0!==t?t:4194304}));const{delay:s=Gs}=e;this.delay=s,this.observer={}}get rawData(){return Hs[this.dbname]}set rawData(e){Hs[this.dbname]=e}_getAllRawKeys(){return t.__awaiter(this,void 0,void 0,(function*(){if(Hs[this.dbname])return Object.keys(Hs[this.dbname]);throw is.storeNotAvailable}))}_getRaw(e){return t.__awaiter(this,void 0,void 0,(function*(){if(Hs[this.dbname])return yield os(this.delay),Hs[this.dbname][e]?Object.assign({key:e},Hs[this.dbname][e]):null;throw is.storeNotAvailable}))}_setRaw(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!Hs[this.dbname])throw is.storeNotAvailable;yield os(this.delay);for(const t of e){const{key:e,data:s,metadata:i}=t;Hs[this.dbname][e]=Object.freeze({data:s,metadata:i})}}))}_removeRaw(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!Hs[this.dbname])throw is.storeNotAvailable;yield os(this.delay);for(const t of e)Hs[this.dbname][t]&&delete Hs[this.dbname][t]}))}observe(e,t,s){this.observer[e]||(this.observer[e]={}),t.forEach((t=>this.observer[e][t]=s))}checkAvailability(){return t.__awaiter(this,void 0,void 0,(function*(){}))}init(e){return t.__awaiter(this,void 0,void 0,(function*(){this.dbname=e,Hs[this.dbname]||(Hs[this.dbname]={}),yield this._resetIfEncryptionChanged()}))}set(e){const s=Object.create(null,{set:{get:()=>super.set}});return t.__awaiter(this,void 0,void 0,(function*(){const t=this.observer[e.key];if(t&&"function"==typeof t.set){const e=t.set();if(e)throw e}return s.set.call(this,e)}))}setMany(e){const s=Object.create(null,{setMany:{get:()=>super.setMany}});return t.__awaiter(this,void 0,void 0,(function*(){for(const t of e){const e=this.observer[t.key];if(e&&"function"==typeof e.set){const t=e.set();if(t)throw t}}return s.setMany.call(this,e)}))}clear(){return t.__awaiter(this,void 0,void 0,(function*(){yield os(this.delay),Hs[this.dbname]={}}))}}const Ys="NestDBStore";var Js;!function(e){e[e.UNINITIALIZED=0]="UNINITIALIZED",e[e.OPENING=1]="OPENING",e[e.OPEN=2]="OPEN",e[e.CLOSED=3]="CLOSED"}(Js||(Js={}));var Xs,Zs;exports.NestDBState=void 0,(Xs=exports.NestDBState||(exports.NestDBState={})).INIT="INIT",Xs.OPENING="OPENING",Xs.OPENED="OPENED",Xs.CLOSED="CLOSED";class ei{constructor(){this.messageTypeFilter=t.MessageTypeFilter.ALL,this.customTypesFilter=null,this.senderUserIdsFilter=null,this.replyType=t.ReplyType.NONE}clone(){const e=new ei,t=JSON.parse(JSON.stringify(this));return Object.keys(t).forEach((s=>{e[s]=t[s]})),e}match(e){switch(this.messageTypeFilter){case t.MessageTypeFilter.USER:if(e.messageType!==t.MessageType.USER)return!1;break;case t.MessageTypeFilter.FILE:if(e.messageType!==t.MessageType.FILE)return!1;break;case t.MessageTypeFilter.ADMIN:if(e.messageType!==t.MessageType.ADMIN)return!1}if(this.customTypesFilter&&this.customTypesFilter.length>0&&!this.customTypesFilter.includes("*")&&!this.customTypesFilter.includes(e.customType))return!1;if(this.senderUserIdsFilter&&this.senderUserIdsFilter.length>0){if(!(e instanceof f))return!1;if(!this.senderUserIdsFilter.includes(e.sender.userId))return!1}if(e instanceof y)switch(this.replyType){case t.ReplyType.NONE:if(e.parentMessageId>0)return!1;break;case t.ReplyType.ONLY_REPLY_TO_CHANNEL:if(e instanceof f&&e.parentMessageId>0&&!e.replyToChannel)return!1}return!0}}exports.MessageListOrder=void 0,(Zs=exports.MessageListOrder||(exports.MessageListOrder={})).CHANNEL_LATEST="channel_latest",Zs.NEWEST_CHILD_MESSAGE="newest_child_message";const ti=e=>{switch(e){case exports.MessageListOrder.CHANNEL_LATEST:return["channelUrl","-createdAt","-messageId"];case exports.MessageListOrder.NEWEST_CHILD_MESSAGE:return["channelUrl","-parentMessageId","-createdAt","-messageId"]}},si=()=>["channelUrl","-createdAt","-notificationId"],ii=Object.assign(Object.assign({},ae),{scheduledAt:void 0}),ni=Object.assign(Object.assign({},se),{scheduledAt:0,file:void 0,fileUrl:void 0,fileName:void 0,mimeType:void 0,fileSize:void 0,thumbnailSizes:void 0,requireAuth:!1}),ai="UnsentMessage",ri={};class oi extends t.InstancedObject{get _cacheContext(){return t.Vault.of(this._iid).cacheContext}constructor(e){super(e),this._mutex=new Bs("unsendmessagecache.lock"),ri[e]=this}static of(e,t=!1){return ri[e]&&!t||(ri[e]=new oi(e)),ri[e]}get collection(){const{nestdb:e}=this._cacheContext,s=null==e?void 0:e.collection(ai);if(!s)throw t.SendbirdError.databaseError;return s}get localCacheEnabled(){const{localCacheEnabled:e}=this._cacheContext;return e&&!!this.collection}_serialize(e){if(e.messageId>0)throw t.SendbirdError.invalidParameters;const s=Object.assign({},e.serialize());var i;return e instanceof M?(e.messageParams&&(s.messageParams=ne(e.messageParams)),e.scheduledInfo&&e.scheduledInfo.scheduledMessageParams&&(s.scheduledInfo.scheduledMessageParams=(i=e.scheduledInfo.scheduledMessageParams,Object.assign(Object.assign({},ne(i)),{scheduledAt:i.scheduledAt})))):e instanceof P?(e.messageParams&&(s.messageParams=he(e.messageParams)),e.scheduledInfo&&e.scheduledInfo.scheduledMessageParams&&(s.scheduledInfo.scheduledMessageParams=(e=>Object.assign(Object.assign({},he(e)),{scheduledAt:e.scheduledAt}))(e.scheduledInfo.scheduledMessageParams))):e instanceof A&&e.messageParams&&(s.messageParams=(e=>t.deundefined({fileInfoList:e.fileInfoList,isReplyToChannel:e.isReplyToChannel,pushNotificationDeliveryOption:e.pushNotificationDeliveryOption}))(e.messageParams)),s}_deserialize(e){e=Object.assign(Object.assign({},e),{messageId:parseInt(e.messageId)});return _i.of(this._iid).buildMessageFromSerializedData(e)}_deserializeWithMessageCreateParams(e){var s,i,n;return t.__awaiter(this,void 0,void 0,(function*(){const a=_i.of(this._iid),r=this._deserialize(e);if(e.messageParams)if(r instanceof M){const t=e.messageParams;r.messageParams=a.buildUserMessageCreateParamsFromSerializedData(t,r)}else if(r instanceof P){const t=e.messageParams;t.fileKey&&"string"==typeof t.fileKey&&ce(null!==(s=t.fileType)&&void 0!==s?s:"")&&(t.file=null!==(i=yield this.collection.getBlob(t.fileKey))&&void 0!==i?i:void 0),r.messageParams=a.buildFileMessageCreateParamsFromSerializedData(t,r)}else if(r instanceof A){const s=e.messageParams;s&&s.fileInfoList&&(r.messageParams=a.buildMultipleFilesMessageCreateParamsFromSerializedData(s,r),yield Promise.all(r.messageParams.fileInfoList.map((e=>t.__awaiter(this,void 0,void 0,(function*(){var t,s,i,n;"string"==typeof(null===(t=e._uploadedMetaData)||void 0===t?void 0:t.fileKey)&&ce(null!==(i=null===(s=e._uploadedMetaData)||void 0===s?void 0:s.fileType)&&void 0!==i?i:"")&&(e.file=null!==(n=yield this.collection.getBlob(e._uploadedMetaData.fileKey))&&void 0!==n?n:void 0)}))))))}if(r.scheduledInfo&&e.scheduledInfo&&e.scheduledInfo.scheduledMessageParams)if(r instanceof M){const t=e.scheduledInfo.scheduledMessageParams;r.scheduledInfo.scheduledMessageParams=a.buildScheduledUserMessageCreateParamsFromSerializedData(t,r)}else if(r instanceof P){const t=e.scheduledInfo.scheduledMessageParams;t.fileKey&&"string"==typeof t.fileKey&&"string"==typeof t.fileType&&ce(t.fileType)&&(t.file=null!==(n=yield this.collection.getBlob(t.fileKey))&&void 0!==n?n:void 0),r.scheduledInfo.scheduledMessageParams=a.buildScheduledFileMessageCreateParamsFromSerializedData(t,r)}return r}))}_getFileInfoBlobKey(e,t){return`${e}.${t}`}get(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const t=yield this.collection.getByKey(`${e}`);if(t)return this._deserializeWithMessageCreateParams(t)}}))}fetch({channelUrl:e,filter:s=new ei,order:i=exports.MessageListOrder.CHANNEL_LATEST,sendingStatus:n,backward:a=!1,parentMessageId:r}){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const o=ti(i),l={"/where":e=>!!(i!==exports.MessageListOrder.NEWEST_CHILD_MESSAGE||r&&0!==e.parentMessageId&&e.parentMessageId===r)&&s.match(this._deserialize(e))};e&&(l.channelUrl=e),n&&(l.sendingStatus=n);const d={where:l,index:o,backward:a},u=yield this.collection.query(d),c=yield u.fetch({});return Promise.all(c.map((e=>t.__awaiter(this,void 0,void 0,(function*(){return yield this._deserializeWithMessageCreateParams(e)})))))}return[]}))}getAllChildMessages(e,s=new ei){return t.__awaiter(this,void 0,void 0,(function*(){return yield this.fetch({filter:s,order:exports.MessageListOrder.NEWEST_CHILD_MESSAGE,channelUrl:e.channelUrl,backward:!1,parentMessageId:e.messageId})}))}upsert(e){return t.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield Promise.all(e.map((e=>t.__awaiter(this,void 0,void 0,(function*(){(e instanceof P||e instanceof A)&&(yield this._mutex.lock(),yield this.saveBlob(e),yield this._mutex.unlock());const t=this._serialize(e);yield this.collection.upsertOne(t)}))))))}))}upsertChildMessages(e){return t.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield Promise.all(e.map((e=>t.__awaiter(this,void 0,void 0,(function*(){let t=[];e.threadInfo&&e.threadInfo.replyCount>0&&(t=yield this.getAllChildMessages(e)),t.length>0&&(t.forEach((t=>t.applyParentMessage(e))),yield this.upsert(t))}))))))}))}remove(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled)for(const t of e)yield this.collection.remove(t)}))}removeMessagesOfChannel(e){return t.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield this.collection.removeIf({where:{channelUrl:e}}))}))}clear(){return t.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield this.collection.clear())}))}saveBlob(e){return t.__awaiter(this,void 0,void 0,(function*(){if(e instanceof P){if(e.messageParams){const t=e.messageParams;if(t.file&&ue(t.file)){const s=yield this.collection.saveBlob(t.file,e.reqId);t.fileKey=s,t.fileType=de.BLOB}}if(e.scheduledInfo&&e.scheduledInfo.scheduledMessageParams){const t=e.scheduledInfo.scheduledMessageParams;if(t.file&&ue(t.file)){const s=yield this.collection.saveBlob(t.file,e.reqId);t.fileKey=s,t.fileType=de.BLOB}}}else if(e instanceof A){const s=e.messageParams;s&&s.fileInfoList&&Array.isArray(s.fileInfoList)&&(yield Promise.all(s.fileInfoList.map(((s,i)=>t.__awaiter(this,void 0,void 0,(function*(){if(s.file&&ue(s.file)){const t=yield this.collection.saveBlob(s.file,this._getFileInfoBlobKey(e.reqId,i));s._uploadedMetaData||(s._uploadedMetaData={}),s._uploadedMetaData.fileKey=t,s._uploadedMetaData.fileType=de.BLOB}}))))))}}))}}const li={};class di extends t.InstancedObject{get _sdkState(){return t.Vault.of(this._iid).sdkState}get _cacheContext(){return t.Vault.of(this._iid).cacheContext}get _unsentMessageCache(){return oi.of(this._iid)}constructor(e){super(e),li[e]=this}static of(e,t=!1){return li[e]&&!t||(li[e]=new di(e)),li[e]}get collection(){const{nestdb:e}=this._cacheContext;return t.unless(!!e).throw(t.SendbirdError.databaseError),e.collection(Kt)}get localCacheEnabled(){const{localCacheEnabled:e}=this._cacheContext;return e&&!!this.collection}_serialize(e){return Object.assign(Object.assign({},e.serialize()),{messageId:`${e.messageId}`})}_deserialize(e){e=Object.assign(Object.assign({},e),{messageId:parseInt(e.messageId)});return _i.of(this._iid).buildMessageFromSerializedData(e)}get(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const t=yield this.collection.getByKey(`${e}`);if(t)return this._deserialize(t)}}))}fetch({channelUrl:e,token:s,limit:i=100,filter:n=new ei,order:a=exports.MessageListOrder.CHANNEL_LATEST,backward:r=!1,parentMessageId:o,isPollOnly:l=!1,exactMatch:d=!1,inclusive:u=!0}){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const c=ti(a),h={where:{channelUrl:e,"/where":e=>{if(s)switch(a){case exports.MessageListOrder.CHANNEL_LATEST:if(d&&e.createdAt!==s)return!1;if(r){if(u&&e.createdAt<s||!u&&e.createdAt<=s)return!1}else if(u&&e.createdAt>s||!u&&e.createdAt>=s)return!1;break;case exports.MessageListOrder.NEWEST_CHILD_MESSAGE:if(!o||0===e.parentMessageId||e.parentMessageId!==o)return!1}return!(l&&!e._poll)&&n.match(this._deserialize(e))}},index:c,backward:r},p=yield this.collection.query(h),m=yield p.fetch({limit:null!=i?i:void 0});return Promise.all(m.map((e=>t.__awaiter(this,void 0,void 0,(function*(){return this._deserialize(e)})))))}return[]}))}getAllChildMessages(e,s=new ei){return t.__awaiter(this,void 0,void 0,(function*(){return yield this.fetch({channelUrl:e.channelUrl,token:Date.now(),limit:null,backward:!1,filter:s,order:exports.MessageListOrder.NEWEST_CHILD_MESSAGE,parentMessageId:e.messageId})}))}upsert(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){yield this.saveBlobs(e);const t=e.map((e=>this._serialize(e)));yield this.collection.upsertMany(t),yield this.upsertChildMessages(e),yield this._unsentMessageCache.upsertChildMessages(e)}}))}upsertChildMessages(e){return t.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield Promise.all(e.map((e=>t.__awaiter(this,void 0,void 0,(function*(){var t;let s=[];(null===(t=e.threadInfo)||void 0===t?void 0:t.replyCount)&&e.threadInfo.replyCount>0&&(s=yield this.getAllChildMessages(e)),s.length>0&&(s.forEach((t=>t.applyParentMessage(e))),yield this.upsert(s))}))))))}))}remove(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled)for(const t of e)yield this.collection.remove(`${t}`)}))}removeMessagesOfChannel(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){yield this.collection.removeIf({where:{channelUrl:e},index:ti(exports.MessageListOrder.CHANNEL_LATEST)});const{preference:t}=this._cacheContext;yield t.remove(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/sync`),yield t.remove(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/sync.meta`),yield t.remove(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/changelogs`),yield t.remove(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/changelogs.meta`)}}))}removeUnderOffset(e,s){return t.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield this.collection.removeIf({where:{channelUrl:e,createdAt:{"<":s}},index:ti(exports.MessageListOrder.CHANNEL_LATEST)}))}))}clear(){return t.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield this.collection.clear())}))}countBetween(e,s,i){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const t=ti(exports.MessageListOrder.CHANNEL_LATEST),n=this.collection.query({where:{channelUrl:e,"/where":e=>{const t=this._deserialize(e);return i.includes(t.createdAt)&&s.match(t)}},index:t});return yield n.count()}return 0}))}saveBlobs(e){return t.__awaiter(this,void 0,void 0,(function*(){yield Promise.all(e.map((e=>t.__awaiter(this,void 0,void 0,(function*(){if(e instanceof P&&e.messageParams){const t=e.messageParams;if(t.file&&ue(t.file)){const s=yield this.collection.saveBlob(t.file,e.reqId);t.fileKey=s}}})))))}))}_getGroupChannelPreferenceSize(e){return t.__awaiter(this,void 0,void 0,(function*(){let t=0;const{preference:s}=this._cacheContext,i=yield s.get(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/sync`),n=yield s.get(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/sync.meta`),a=yield s.get(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/changelogs`),r=yield s.get(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/changelogs.meta`);return i&&(t+=JSON.stringify(i).length),n&&(t+=JSON.stringify(n).length),a&&(t+=JSON.stringify(a).length),r&&(t+=JSON.stringify(r).length),t}))}}const ui={};class ci extends t.InstancedObject{get _sdkState(){return t.Vault.of(this._iid).sdkState}get _cacheContext(){return t.Vault.of(this._iid).cacheContext}constructor(e){super(e),ui[e]=this}static of(e,t=!1){return ui[e]&&!t||(ui[e]=new ci(e)),ui[e]}get collection(){const{nestdb:e}=this._cacheContext;return t.unless(!!e).throw(t.SendbirdError.databaseError),e.collection(Gt)}get localCacheEnabled(){const{localCacheEnabled:e}=this._cacheContext;return e&&!!this.collection}_serialize(e){return Object.assign({},e.serialize())}_deserialize(e){return _i.of(this._iid).buildMessageFromSerializedData(e)}get(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const t=yield this.collection.getByKey(e);if(t)return this._deserialize(t)}}))}fetch({channelUrl:e,token:s,limit:i=100,filter:n=new ei,backward:a=!1,exactMatch:r=!1,inclusive:o=!0}){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const t={where:{channelUrl:e,"/where":e=>{if(s){if(r&&e.createdAt!==s)return!1;if(a){if(o&&e.createdAt<s||!o&&e.createdAt<=s)return!1}else if(o&&e.createdAt>s||!o&&e.createdAt>=s)return!1}return n.match(this._deserialize(e))}},index:["channelUrl","-createdAt","-notificationId"],backward:a},l=yield this.collection.query(t);return(yield l.fetch({limit:null!=i?i:void 0})).map((e=>this._deserialize(e)))}return[]}))}upsert(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const t=e.map((e=>this._serialize(e)));yield this.collection.upsertMany(t)}}))}remove(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled)for(const t of e)yield this.collection.remove(t)}))}markAsReadByTimestamp(e,s){return t.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield this.collection.updateIf({where:{channelUrl:e,messageStatus:exports.NotificationMessageStatus.SENT,createdAt:{"<":s}}},{set:{messageStatus:exports.NotificationMessageStatus.READ}}))}))}markAsReadByMessageIds(e,s){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){return(yield this.collection.updateIf({where:{channelUrl:e,notificationId:{"/in":s},messageStatus:exports.NotificationMessageStatus.SENT}},{set:{messageStatus:exports.NotificationMessageStatus.READ}})).length}return 0}))}removeMessagesOfChannel(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){yield this.collection.removeIf({where:{channelUrl:e},index:["channelUrl","-createdAt","-notificationId"]});const{preference:t}=this._cacheContext;yield t.remove(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/sync`),yield t.remove(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/sync.meta`),yield t.remove(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/changelogs`),yield t.remove(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/changelogs.meta`)}}))}removeUnderOffset(e,s){return t.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield this.collection.removeIf({where:{channelUrl:e,createdAt:{"<":s}},index:ti(exports.MessageListOrder.CHANNEL_LATEST)}))}))}clear(){return t.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield this.collection.clear())}))}countBetween(e,s,i){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const t=["channelUrl","-createdAt","-notificationId"],n=this.collection.query({where:{channelUrl:e,"/where":e=>{const t=this._deserialize(e);return i.includes(t.createdAt)&&s.match(t)}},index:t});return yield n.count()}return 0}))}}const hi={};class pi extends t.InstancedObject{get _cacheContext(){return t.Vault.of(this._iid).cacheContext}get _dispatcher(){return t.Vault.of(this._iid).dispatcher}get _messageCache(){return di.of(this._iid)}get _unsentMessageCache(){return oi.of(this._iid)}get _notificationCache(){return ci.of(this._iid)}constructor(e){super(e),this._observers=new Map,this._dispatcherContext=this._dispatcher.on((e=>t.__awaiter(this,void 0,void 0,(function*(){if(e instanceof t.MessageUpdateEventCommand){const{messages:s,source:i,isWebSocketEventComing:n}=e,a=s.filter((e=>e instanceof y&&e.messageId>0)),r=s.filter((e=>e instanceof y&&0===e.messageId)),o=s.filter((e=>e instanceof w));a.length>0&&(yield t.runOrNothing((()=>t.__awaiter(this,void 0,void 0,(function*(){yield this._messageCache.upsert(a),yield this._unsentMessageCache.remove(a.map((e=>e instanceof f?e.reqId:null)).filter((e=>null!==e)))})))),n||this._broadcastUpdateEvent(a,i)),r.length>0&&(yield t.runOrNothing((()=>t.__awaiter(this,void 0,void 0,(function*(){yield this._unsentMessageCache.upsert(r)})))),n||this._broadcastUpdateEvent(r,i)),o.length>0&&(yield t.runOrNothing((()=>t.__awaiter(this,void 0,void 0,(function*(){yield this._notificationCache.upsert(o)})))),n||this._broadcastUpdateEvent(o,i))}else if(e instanceof t.MessageRemoveEventCommand){const{messageIds:s,source:i,isWebSocketEventComing:n}=e,a=s.filter((e=>"number"==typeof e)),r=s.filter((e=>"string"==typeof e));yield t.runOrNothing((()=>t.__awaiter(this,void 0,void 0,(function*(){a.length>0&&(yield this._messageCache.remove(a)),r.length>0&&(yield this._notificationCache.remove(r))})))),n||this._broadcastRemoveEvent(s,i)}else if(e instanceof t.UnsentMessageRemoveEventCommand){const{reqId:s,source:i}=e;yield t.runOrNothing((()=>t.__awaiter(this,void 0,void 0,(function*(){yield this._unsentMessageCache.remove([s])})))),this._broadcastRemoveUnsentEvent(s,i)}else if(e instanceof t.PollChangeLogEventCommand){const{polls:s,source:i}=e;if(this._cacheContext.localCacheEnabled){const e=s.map((e=>e.messageId)),i=(yield Promise.all(e.map((e=>this._messageCache.get(e))))).filter((e=>e));i.length>0&&s.forEach((e=>{const t=i.find((t=>t.messageId===e.messageId));t&&t.applyPoll(e)})),yield t.runOrNothing((()=>t.__awaiter(this,void 0,void 0,(function*(){return yield this._messageCache.upsert(i)}))))}this._broadcastPollChangeLogEvent(s,i)}else if(e instanceof t.PollUpdateInternalEventCommand){const{event:s,source:i}=e,n=yield this._messageCache.get(s.messageId);n&&n.isUserMessage()&&n.poll&&n.poll.applyPollUpdateEvent(s)&&(yield t.runOrNothing((()=>t.__awaiter(this,void 0,void 0,(function*(){return yield this._messageCache.upsert([n])}))))),this._broadcastPollUpdateEvent(s,i)}else if(e instanceof t.PollVoteInternalEventCommand){const{event:s,source:i}=e,n=yield this._messageCache.get(s.messageId);n&&n.isUserMessage()&&n.poll&&n.poll.applyPollVoteEvent(s)&&(yield t.runOrNothing((()=>t.__awaiter(this,void 0,void 0,(function*(){return yield this._messageCache.upsert([n])}))))),this._broadcastPollVoteEvent(s,i)}}))))}static of(e,t=!1){var s;return hi[e]&&!t||(hi[e]&&(null===(s=hi[e]._dispatcherContext)||void 0===s||s.close()),hi[e]=new pi(e)),hi[e]}_broadcastUpdateEvent(e,t){for(const s of this._observers.values())s.onUpdate&&s.onUpdate(e,t)}_broadcastPollChangeLogEvent(e,t){for(const s of this._observers.values())s.onPollChangeLogUpdate&&s.onPollChangeLogUpdate(e,t)}_broadcastPollUpdateEvent(e,t){for(const s of this._observers.values())s.onPollUpdate&&s.onPollUpdate(e,t)}_broadcastPollVoteEvent(e,t){for(const s of this._observers.values())s.onPollVote&&s.onPollVote(e,t)}_broadcastRemoveEvent(e,t){for(const s of this._observers.values())s.onRemove&&s.onRemove(e,t)}_broadcastRemoveUnsentEvent(e,t){for(const s of this._observers.values())s.onRemoveUnsent&&s.onRemoveUnsent(e,t)}subscribe(e,t){this._observers.set(e,t)}unsubscribe(e){this._observers.delete(e)}unsubscribeAll(){this._observers.clear()}}const mi={};class _i{constructor(e,{sdkState:t,dispatcher:s,requestQueue:i,onlineDetector:n,cacheContext:a}){this._iid=e,this._sdkState=t,this._requestQueue=i,this._dispatcher=s,this._cacheContext=a,di.of(e),oi.of(e),pi.of(e),this.fileMessageQueue=new F(e,{sdkState:t,dispatcher:s,requestQueue:i,onlineDetector:n,cacheContext:a}),mi[e]=this}static of(e){return mi[e]}buildMessageFromSerializedData(e){const s=t.deserialize(e);if(s.notificationId)return new w(this._iid,w.payloadify(s));switch(s.messageType){case t.MessageType.USER:return new M(this._iid,M.payloadify(s));case t.MessageType.FILE:return A._isMultipleFilesMessageSerializedData(s)?new A(this._iid,A.payloadify(s)):new P(this._iid,P.payloadify(s));case t.MessageType.ADMIN:return new T(this._iid,T.payloadify(s))}throw t.SendbirdError.invalidParameters}buildUserMessageCreateParamsFromSerializedData(e,s){return t.deundefined(t.undefineNullProps({data:s.data,customType:s.customType,mentionType:s.mentionType,mentionedUserIds:s.mentionedUserIds,mentionedUsers:s.mentionedUsers,mentionedMessageTemplate:s.mentionedMessageTemplate,metaArrays:s.metaArrays,parentMessageId:s.parentMessageId,isReplyToChannel:e.isReplyToChannel,pushNotificationDeliveryOption:e.pushNotificationDeliveryOption,appleCriticalAlertOptions:s.appleCriticalAlertOptions,reqId:s.reqId,message:s.message,translationTargetLanguages:Object.keys(s.translations),pollId:e.pollId}))}buildFileMessageCreateParamsFromSerializedData(e,s){var i;return t.deundefined(t.undefineNullProps({data:s.data,customType:s.customType,mentionType:s.mentionType,mentionedUserIds:s.mentionedUserIds,mentionedUsers:s.mentionedUsers,mentionedMessageTemplate:s.mentionedMessageTemplate,metaArrays:s.metaArrays,parentMessageId:s.parentMessageId,isReplyToChannel:e.isReplyToChannel,pushNotificationDeliveryOption:e.pushNotificationDeliveryOption,appleCriticalAlertOptions:s.appleCriticalAlertOptions,reqId:s.reqId,file:e.file,fileKey:e.fileKey,fileUrl:s.plainUrl,fileName:s.name,fileSize:s.size,mimeType:s.type,thumbnailSizes:null===(i=s.thumbnails)||void 0===i?void 0:i.map((e=>({maxWidth:e.width,maxHeight:e.height}))),fileType:e.fileType,requireAuth:s.requireAuth}))}buildMultipleFilesMessageCreateParamsFromSerializedData(e,s){return t.deundefined({data:s.data,customType:s.customType,mentionType:s.mentionType,mentionedUserIds:s.mentionedUserIds,mentionedUsers:s.mentionedUsers,mentionedMessageTemplate:s.mentionedMessageTemplate,metaArrays:s.metaArrays,parentMessageId:s.parentMessageId,isReplyToChannel:e.isReplyToChannel,pushNotificationDeliveryOption:e.pushNotificationDeliveryOption,appleCriticalAlertOptions:s.appleCriticalAlertOptions,reqId:s.reqId,fileInfoList:e.fileInfoList.map((e=>new U(this._iid,e)))})}buildScheduledUserMessageCreateParamsFromSerializedData(e,t){return Object.assign(Object.assign({},this.buildUserMessageCreateParamsFromSerializedData(e,t)),{scheduledAt:e.scheduledAt})}buildScheduledFileMessageCreateParamsFromSerializedData(e,t){return Object.assign(Object.assign({},this.buildFileMessageCreateParamsFromSerializedData(e,t)),{scheduledAt:e.scheduledAt})}buildSenderFromSerializedData(e){const s=t.deserialize(e);return new u(this._iid,u.payloadify(s))}getMessage(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=new $(e),s=yield this._requestQueue.send(t),{message:i}=s.as(Q);return i}))}getScheduledMessage(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=new Y(e),s=yield this._requestQueue.send(t),{message:i}=s.as(J);return i}))}getMessagesByMessageId(e,s,i,n,a=t.CollectionEventSource.REQUEST_MESSAGE){return t.__awaiter(this,void 0,void 0,(function*(){const r=new K(Object.assign(Object.assign({channelType:s,channelUrl:e,token:String(i)},B),n)),o=yield this._requestQueue.send(r),{messages:l}=o.as(G);return this._dispatcher.dispatch(new t.MessageUpdateEventCommand({messages:l,source:a})),l}))}getMessagesByTimestamp(e,s,i,n,a=t.CollectionEventSource.REQUEST_MESSAGE){return t.__awaiter(this,void 0,void 0,(function*(){const r=new K(Object.assign(Object.assign({channelType:s,channelUrl:e,timestamp:i},B),n)),o=yield this._requestQueue.send(r),{messages:l}=o.as(G);return this._dispatcher.dispatch(new t.MessageUpdateEventCommand({messages:l,source:a})),l}))}_getMessagesByTimestampForCollection(e,s,i,n,a=t.CollectionEventSource.REQUEST_MESSAGE,r,o){return t.__awaiter(this,void 0,void 0,(function*(){const l=new K(Object.assign(Object.assign(Object.assign({channelType:s,channelUrl:e,timestamp:i},B),n),{checkingHasNext:r,checkingContinuousMessages:o})),d=yield this._requestQueue.send(l),{messages:u,isContinuousMessages:c,hasNext:h}=d.as(G);return this._dispatcher.dispatch(new t.MessageUpdateEventCommand({messages:u,source:a})),{messages:u,isContinuousMessages:c,hasNext:h}}))}getThreadedMessagesByTimestamp(e,s,i,n=t.CollectionEventSource.REQUEST_THREADED_MESSAGE){return t.__awaiter(this,void 0,void 0,(function*(){const a=new K(Object.assign(Object.assign(Object.assign({channelUrl:e.channelUrl,channelType:e.channelType,timestamp:s},I),i),{replyType:t.ReplyType.ALL,parentMessageId:e.messageId,includeThreadInfo:!0})),r=yield this._requestQueue.send(a),{messages:o}=r.as(G),l=o.slice(1);return l.forEach((t=>{t.parentMessage=e})),this._dispatcher.dispatch(new t.MessageUpdateEventCommand({messages:l,source:n})),{parentMessage:o[0],threadedMessages:l}}))}getMessageChangelogs(e,s,i,n,a=t.CollectionEventSource.REQUEST_MESSAGE_CHANGELOGS){return t.__awaiter(this,void 0,void 0,(function*(){const r=new H(t.deundefined(t.undefineNullProps(Object.assign(Object.assign({channelType:s,channelUrl:e,timestamp:"number"==typeof i?i:null,token:"string"==typeof i?i:null},z),n)))),o=yield this._requestQueue.send(r),{updatedMessages:l,deletedMessagesInfo:d,hasMore:u,nextToken:c}=o.as(W),h=d.map((e=>e.messageId));return l.length>0&&this._dispatcher.dispatch(new t.MessageUpdateEventCommand({messages:l,source:a})),h.length>0&&this._dispatcher.dispatch(new t.MessageRemoveEventCommand({messageIds:h,source:a})),{updatedMessages:l,deletedMessageIds:h,hasMore:u,token:c}}))}}class gi extends t.InstancedObject{constructor(e,s){super(e),this.targetMessageId=0;const i=s.thread_info,a=s.parent_message_id,r=s.channel_url,o=s.channel_type;i&&t.isTypeOf("object",i)&&t.isTypeOf("number",a)&&t.isTypeOf("string",r)&&t.isTypeOf("string",o)&&(this.threadInfo=new n(e,i),this.targetMessageId=a,this.channelUrl=r,this.channelType=o)}}const yi={channelUrl:"",channelType:t.ChannelType.BASE,messageId:0,includeReactions:!1,includeMetaArray:!1,includeParentMessageInfo:!1,includeThreadInfo:!1};class fi extends t.APIRequestCommand{constructor({channelCustomType:e,keyword:s,limit:i,reverse:n,exactMatch:a,channelUrl:r,order:o,messageTimestampFrom:l,messageTimestampTo:d,advancedQuery:u,targetFields:c,nextToken:h}){super(),this.method=t.APIRequestMethod.GET,this.path=`${t.API_PATH_SEARCH}/messages`,this.params={custom_type:e,query:s,limit:i,reverse:n,exact_match:a,channel_url:r,message_ts_from:l,message_ts_to:d,sort_field:o,advanced_query:u,target_fields:c,after:h}}}class vi extends t.APIResponseCommand{constructor(e,t){super(e,t),this.messages=t.results.map((t=>N(e,t))),this.hasNext=t.has_next,this.nextToken=t.end_cursor,this.totalCount=t.total_count}}var Ii;exports.MessageSearchOrder=void 0,(Ii=exports.MessageSearchOrder||(exports.MessageSearchOrder={})).SCORE="score",Ii.TIMESTAMP="ts";class Ei extends t.BaseListQuery{constructor(e,t){var s,i,n,a,r,o,l,d,u;super(e,t),this.keyword="",this.reverse=!1,this.exactMatch=!1,this.channelUrl="",this.channelCustomType="",this.messageTimestampFrom=null,this.messageTimestampTo=null,this.order=exports.MessageSearchOrder.SCORE,this.advancedQuery=!1,this.targetFields=null,this._nextToken="",this.totalCount=-1,this.keyword=t.keyword,this.reverse=null!==(s=t.reverse)&&void 0!==s&&s,this.exactMatch=null!==(i=t.exactMatch)&&void 0!==i&&i,this.channelUrl=null!==(n=t.channelUrl)&&void 0!==n?n:"",this.channelCustomType=null!==(a=t.channelCustomType)&&void 0!==a?a:"",this.messageTimestampFrom=null!==(r=t.messageTimestampFrom)&&void 0!==r?r:null,this.messageTimestampTo=null!==(o=t.messageTimestampTo)&&void 0!==o?o:null,this.order=null!==(l=t.order)&&void 0!==l?l:exports.MessageSearchOrder.SCORE,this.advancedQuery=null!==(d=t.advancedQuery)&&void 0!==d&&d,this.targetFields=null!==(u=t.targetFields)&&void 0!==u?u:null}_validate(){return super._validate()&&t.isTypeOf("string",this.keyword)&&this.keyword.length>0&&t.isTypeOf("boolean",this.reverse)&&t.isTypeOf("boolean",this.exactMatch)&&t.isTypeOf("string",this.channelUrl)&&t.isTypeOf("string",this.channelCustomType)&&(t.isTypeOf("number",this.messageTimestampFrom)||null===this.messageTimestampFrom)&&(t.isTypeOf("number",this.messageTimestampTo)||null===this.messageTimestampTo)&&t.isEnumOf(exports.MessageSearchOrder,this.order)&&t.isTypeOf("boolean",this.advancedQuery)&&t.isArrayOf("string",this.targetFields,!0)}next(){return t.__awaiter(this,void 0,void 0,(function*(){if(this._validate()){if(this._isLoading)throw t.SendbirdError.queryInProgress;if(this._hasNext){this._isLoading=!0;const{requestQueue:e}=t.Vault.of(this._iid),s=new fi(t.undefineNullProps(Object.assign(Object.assign({},this),{nextToken:this._nextToken?this._nextToken:null}))),i=yield e.send(s),{messages:n,hasNext:a,nextToken:r,totalCount:o}=i.as(vi);return this._nextToken=r,this._hasNext=a,this._isLoading=!1,this.totalCount=o,n}return[]}throw t.SendbirdError.invalidParameters}))}}exports.AdminMessage=T,exports.AppleCriticalAlertOptions=d,exports.BanUserEventCommand=lt,exports.BannedUserListQuery=Pe,exports.BaseChannel=Xt,exports.BaseMessage=y,exports.BaseMessageUpdateParamsDefault=ye,exports.BaseStore=Ks,exports.Config=es,exports.CreateScheduledUserMessageResponseCommand=Pt,exports.DEFAULT_FEED_LIMIT=100,exports.DEFAULT_GROUPCHANNEL_LIMIT=100,exports.DEFAULT_MESSAGE_LIMIT=100,exports.DEFAULT_NOTIFICATION_LIMIT=100,exports.DeleteMessageEventCommand=bt,exports.FileMessage=P,exports.FileMessageEventCommand=L,exports.FreezeEventCommand=ht,exports.IndexedDbStore=class extends Ks{constructor(e={}){var t;super(Object.assign(Object.assign({},e),{itemSizeLimit:null!==(t=e.itemSizeLimit)&&void 0!==t?t:104857600})),this._storeName=Ys,this._state=Js.UNINITIALIZED,this._openJobQueue=[],this._window="undefined"!=typeof window?window:void 0,this._indexedDb=this._window?this._window.indexedDB||this._window.mozIndexedDB||this._window.webkitIndexedDB||this._window.msIndexedDB:void 0}get state(){return this._state}_openDatabase(e){return new Promise(((t,s)=>{if(this._indexedDb){this._state=Js.OPENING;const i=this._indexedDb.open(e);i.addEventListener("upgradeneeded",(e=>{e.target.result.createObjectStore(Ys,{keyPath:"key"})})),i.addEventListener("success",(s=>{this._state=Js.OPEN,this._database=s.target.result,this._openJobQueue.forEach((e=>e())),this._openJobQueue=[],this._database.onclose=()=>{this._database=void 0,this._state=Js.OPENING,setTimeout((()=>{this._openDatabase(e)}),5)},t(this._database)})),i.addEventListener("error",(e=>{this._state=Js.UNINITIALIZED,s(e.target.error)}))}else s(is.storeNotAvailable)}))}_getObjectStore(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this._database)return this._database.transaction(this._storeName,e).objectStore(this._storeName);switch(this._state){case Js.UNINITIALIZED:case Js.OPEN:throw is.storeNotInitialized;case Js.OPENING:case Js.CLOSED:return new Promise((t=>{this._openJobQueue.push((()=>t(this._getObjectStore(e))))}));default:return yield this._getObjectStore(e)}}))}_getAllRawKeys(){return t.__awaiter(this,void 0,void 0,(function*(){const e=yield this._getObjectStore("readonly");return yield new Promise(((t,s)=>{const i=e.getAllKeys();i.addEventListener("success",(e=>{t(e.target.result)})),i.addEventListener("error",(e=>s(e.target.error)))}))}))}_getRaw(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield this._getObjectStore("readonly");return yield new Promise(((s,i)=>{const n=t.get(e);n.addEventListener("success",(e=>{var t;s(null===(t=null==e?void 0:e.target)||void 0===t?void 0:t.result)})),n.addEventListener("error",(e=>i(e.target.error)))}))}))}_setRaw(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield this._getObjectStore("readwrite");yield Promise.all(e.map((e=>new Promise(((s,i)=>{const n=t.put(e);n.addEventListener("success",(e=>{s(e.target.result)})),n.addEventListener("error",(()=>{i("Failed to write.")}))})))))}))}_removeRaw(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield this._getObjectStore("readwrite");yield Promise.all(e.map((e=>new Promise(((s,i)=>{const n=t.delete(e);n.addEventListener("success",(()=>s(e))),n.addEventListener("error",(e=>i(e.target.error)))})))))}))}_triggerDatabaseClose(){this._database&&this._database.onclose&&this._database.onclose(new Event("dummy"))}checkAvailability(){return t.__awaiter(this,void 0,void 0,(function*(){const e="undefined"!=typeof window?window:null;if(!((null==e?void 0:e.indexedDB)||(null==e?void 0:e.mozIndexedDB)||(null==e?void 0:e.webkitIndexedDB)||(null==e?void 0:e.msIndexedDB)))throw is.storeNotAvailable;if(this._indexedDb=e.indexedDB||e.mozIndexedDB||e.webkitIndexedDB||e.msIndexedDB,!this._window||!Ls())throw is.storeNotAvailable;if(Ls()&&navigator.userAgent&&navigator.userAgent.includes("Edge/")){if(!this._window.indexedDB&&(e.PointerEvent||e.MSPointerEvent))throw is.storeNotAvailableInPrivateBrowsing}else yield new Promise(((e,t)=>{if(this._indexedDb)try{const s=this._indexedDb.open("_testMozilla");s.onerror=()=>t(is.storeNotAvailableInPrivateBrowsing),s.onsuccess=()=>e()}catch(e){t(is.storeNotAvailableInPrivateBrowsing)}else t(is.storeNotAvailable)}))}))}init(e){return t.__awaiter(this,void 0,void 0,(function*(){this.dbname=e,yield this.checkAvailability(),yield this._openDatabase(e),yield this._resetIfEncryptionChanged()}))}clear(){return t.__awaiter(this,void 0,void 0,(function*(){const e=yield this._getObjectStore("readwrite");return yield new Promise(((t,s)=>{const i=e.clear();i.addEventListener("success",(()=>t())),i.addEventListener("error",(e=>s(e.target.error)))}))}))}},exports.MemoryStore=Ws,exports.MessageBroadcast=pi,exports.MessageCache=di,exports.MessageFilter=ei,exports.MessageManager=_i,exports.MessageMetaArray=c,exports.MessageRequestHandler=te,exports.MessageRetrievalParamsDefault=yi,exports.MessageReviewInfo=S,exports.MessageSearchQuery=Ei,exports.MultipleFilesMessage=A,exports.MultipleFilesMessageRequestHandler=Yt,exports.MuteUserEventCommand=nt,exports.MutedUserListQuery=Ce,exports.NESTDB_FEEDCHANNEL_COLLECTION_KEY="url",exports.NESTDB_FEEDCHANNEL_COLLECTION_NAME="FeedChannel",exports.NESTDB_GROUPCHANNEL_COLLECTION_KEY="url",exports.NESTDB_GROUPCHANNEL_COLLECTION_NAME="GroupChannel",exports.NESTDB_MESSAGE_COLLECTION_KEY="messageId",exports.NESTDB_MESSAGE_COLLECTION_NAME=Kt,exports.NESTDB_NOTIFICATION_COLLECTION_KEY="notificationId",exports.NESTDB_NOTIFICATION_COLLECTION_NAME=Gt,exports.NESTDB_POLL_COLLECTION_KEY="pollId",exports.NESTDB_POLL_COLLECTION_NAME="Poll",exports.NESTDB_UNSENT_MESSAGE_COLLECTION_KEY="reqId",exports.NESTDB_UNSENT_MESSAGE_COLLECTION_NAME=ai,exports.NestDB=class{constructor({name:e,version:t,store:s,config:i}){this.name=e,this._version=t,this._state=exports.NestDBState.INIT,this._config=i||new es({dbname:e}),this._store=s,this._event={success:ds,error:ds,storeReplaced:ds,upgrade:hs},this._collections=new Map,this._globalMutex=new Bs(`${this.name}.lock`),this._config.disableLogger&&$s.off(),new Cs({dbname:e,limit:this._config.cacheLimit})}get version(){return this._version}get state(){return this._state}get store(){return this._store}estimateUsage(){return t.__awaiter(this,void 0,void 0,(function*(){return yield(e=this._store,t.__awaiter(void 0,void 0,void 0,(function*(){return yield e.usage()})));var e}))}commitSchema(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this._state!==exports.NestDBState.OPENING)throw is.databaseSchemaNotOnUpgrade;yield Promise.all(e.map((e=>t.__awaiter(this,void 0,void 0,(function*(){const{collectionName:t,keyName:s,index:i=[]}=e;this._collections.has(t)||this._collections.set(t,new js({dbname:this.name,collectionName:t,keyName:s,indexes:i,store:this._store}));const n=this._collections.get(t);n&&(yield n.init())})))))}))}open(){var e;return t.__awaiter(this,void 0,void 0,(function*(){if(yield this._globalMutex.lock(),this._state!==exports.NestDBState.OPENED){this._state=exports.NestDBState.OPENING;try{yield this._store.init(this.name);const i=(s=this.name,`${ys(s)}.metadata`),n={version:0,collectionNames:[]},a=null!==(e=yield this._store.get(i))&&void 0!==e?e:n;return new Promise(((e,s)=>{const n=e=>{a.version<this._version?this._event.upgrade(a.version,(s=>t.__awaiter(this,void 0,void 0,(function*(){if(s)e({continued:!1,err:s});else{a.version++,a.collectionNames=Array.from(this._collections.keys());try{yield this._store.set({key:i,value:a}),e({continued:!0})}catch(t){e({continued:!1,err:t})}}})))):e({continued:!1})},r=i=>{const{continued:o=!1,err:l=null}=i;if(o)setTimeout((()=>n(r)),10);else if(l)$s.error(l.message),this._globalMutex.unlock(),this._event.error(l),s(l);else{const i=[];a.collectionNames.forEach((e=>{const s=this._collections.get(e);s&&s.state===ss.READY||i.push((()=>t.__awaiter(this,void 0,void 0,(function*(){const t=yield js.metadataOf(this.name,e,this._store);if(t){const s=new js({dbname:this.name,collectionName:e,keyName:t.keyName,indexes:t.indexes,store:this._store});this._collections.set(e,s),yield s.init()}})))())})),Promise.all(i).then((()=>{this._state=exports.NestDBState.OPENED,this._globalMutex.unlock(),this._event.success(),e()})).catch((e=>{$s.error(e.message),this._globalMutex.unlock(),this._event.error(e),s(e)}))}};n(r)}))}catch(e){switch(e.code){case ts.STORE_NOT_AVAILABLE_IN_PRIVATE_BROWSING:$s.warning("Access to the local storage is not allowed. Switched to MemoryStore automatically."),this._store=new Ws({}),this._globalMutex.unlock(),this._event.error(e),this._event.storeReplaced(this._store),yield this.open();break;case ts.STORE_NOT_AVAILABLE:$s.warning("IndexedDB is not available in this environment. Switched to MemoryStore automatically. Consider using other store to save data persistently (e.g. AsyncStorage)."),this._store=new Ws({}),this._globalMutex.unlock(),this._event.error(e),this._event.storeReplaced(this._store),yield this.open();break;default:throw $s.error(e.message),this._globalMutex.unlock(),this._event.error(e),e}}}var s}))}close(){this._collections.forEach((e=>e.close())),this._state=exports.NestDBState.CLOSED}clear(){return t.__awaiter(this,void 0,void 0,(function*(){yield Promise.all(Array.from(this._collections.values()).map((e=>e.clear())))}))}reset(){return t.__awaiter(this,void 0,void 0,(function*(){this.close();const e=Cs.get(this.name);e&&e.clearByCondition((e=>e.key.startsWith(ys(this.name)))),yield this._store.clear()}))}on(e,t){this._event[e]=t}off(e){if("function"==typeof this._event[e])if("upgrade"===e)this._event[e]=hs;else this._event[e]=ds}collection(e){const t=this._collections.get(e);if(t)return t;throw is.collectionNotReady}},exports.NestDBError=is,exports.NotificationMessage=w,exports.NotificationMessageCache=ci,exports.OGImage=o,exports.OGMetaData=l,exports.OperatorListQuery=Se,exports.PENDING_MESSAGE_DELAY=2,exports.Plugin=b,exports.PollVoteEventCommand=Qt,exports.PreviousMessageListQuery=Me,exports.Reaction=r,exports.ReactionEvent=a,exports.RestrictedUser=ee,exports.RestrictionInfo=Z,exports.ScheduledFileMessageCreateParamsDefault=ni,exports.ScheduledUserMessageCreateParamsDefault=ii,exports.SendableMessage=f,exports.Sender=u,exports.ThreadInfo=n,exports.ThreadInfoUpdateEvent=gi,exports.Thumbnail=v,exports.UnbanUserEventCommand=ut,exports.UnmuteUserEventCommand=rt,exports.UnsentMessageCache=oi,exports.UpdateFileMessageEventCommand=Et,exports.UpdateMetaCounterEventCommand=et,exports.UpdateMetaDataEventCommand=Ve,exports.UpdateUserMessageEventCommand=vt,exports.UploadFileRequestCommand=s,exports.UploadFileResponseCommand=i,exports.UploadedFileInfo=O,exports.UserMessage=M,exports.UserMessageEventCommand=yt,exports.UserMessageUpdateParamsDefault=ve,exports.createFileMessageCreateParams=me,exports.createFileMessageCreateParamsFromFailedFileMessage=_e,exports.createMultipleFilesMessageCreateParams=function(e){var s,i,n;return null!==(s=e.messageParams)&&void 0!==s?s:t.undefineNullProps(Object.assign(Object.assign({},e),{isReplyToChannel:!1,mentionedUserIds:null!==(i=e.mentionedUserIds)&&void 0!==i?i:null===(n=e.mentionedUsers)||void 0===n?void 0:n.map((e=>e.userId)),pushNotificationDeliveryOption:t.PushNotificationDeliveryOption.DEFAULT,isPinnedMessage:!1,fileInfoList:e.fileInfoList.map((e=>{var t;return{fileUrl:e.plainUrl,fileName:e.fileName,fileSize:e.fileSize,mimeType:e.mimeType,thumbnailSizes:null===(t=e.thumbnails)||void 0===t?void 0:t.map((e=>({maxWidth:e.width,maxHeight:e.height}))),_uploadedMetaData:{requireAuth:e._requireAuth,isUploaded:!0}}}))}))},exports.createUserMessageCreateParams=re,exports.createUserMessageCreateParamsFromFailedUserMessage=oe,exports.getMessageIndexBy=ti,exports.getNotificationMessageIndexBy=si,exports.parseMessagePayload=N,exports.payloadifyMessage=e=>{if(e.notificationId)return w.payloadify(e);switch(e.messageType){case t.MessageType.USER:return M.payloadify(e);case t.MessageType.FILE:return e.fileInfoList?A.payloadify(e):P.payloadify(e);case t.MessageType.ADMIN:return T.payloadify(e);default:throw t.SendbirdError.unknown}},exports.validateBaseMessageUpdateParams=fe,exports.validateMessageRetrievalParams=e=>t.isTypeOf("string",e.channelUrl)&&t.isEnumOf(t.ChannelType,e.channelType)&&t.isTypeOf("number",e.messageId)&&t.isTypeOf("boolean",e.includeReactions,!0)&&t.isTypeOf("boolean",e.includeMetaArray,!0)&&t.isTypeOf("boolean",e.includeParentMessageInfo,!0)&&t.isTypeOf("boolean",e.includeThreadInfo,!0),exports.validateScheduledFileMessageCreateParams=e=>ie(e)&&t.isTypeOf("number",e.scheduledAt)&&(t.isFile(e.file)||t.isTypeOf("string",e.fileUrl))&&t.isTypeOf("string",e.fileName,!0)&&t.isTypeOf("string",e.mimeType,!0)&&t.isTypeOf("number",e.fileSize,!0)&&(null===e.thumbnailSizes||void 0===e.thumbnailSizes||e.thumbnailSizes.every((e=>t.isTypeOf("object",e)&&e.maxWidth>0&&e.maxHeight>0))),exports.validateScheduledUserMessageCreateParams=e=>le(e)&&t.isTypeOf("number",e.scheduledAt,!0),exports.validateUserMessageUpdateParams=Ie;
